(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,54008,(e,t,i)=>{"use strict";function r(e,t,i){i=i||2;var r,d,f,m,v,x,_,b=t&&t.length,w=b?t[0]*i:e.length,k=s(e,0,w,i,!0),P=[];if(!k||k.next===k.prev)return P;if(b&&(k=function(e,t,i,r){var o,u,h,d,f,m=[];for(o=0,u=t.length;o<u;o++)h=t[o]*r,d=o<u-1?t[o+1]*r:e.length,(f=s(e,h,d,r,!1))===f.next&&(f.steiner=!0),m.push(function(e){var t=e,i=e;do(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next;while(t!==e)return i}(f));for(m.sort(a),o=0;o<m.length;o++)i=function(e,t){var i=function(e,t){var i,r,s,n=t,a=e.x,o=e.y,u=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var h=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(h<=a&&h>u&&(u=h,s=n.x<n.next.x?n:n.next,h===a))return s}n=n.next}while(n!==t)if(!s)return null;var d,f=s,g=s.x,m=s.y,y=1/0;n=s;do{a>=n.x&&n.x>=g&&a!==n.x&&l(o<m?a:u,o,g,m,o<m?u:a,o,n.x,n.y)&&(d=Math.abs(o-n.y)/(a-n.x),p(n,e)&&(d<y||d===y&&(n.x>s.x||n.x===s.x&&(i=s,r=n,0>c(i.prev,i,r.prev)&&0>c(r.next,i,i.next))))&&(s=n,y=d)),n=n.next}while(n!==f)return s}(e,t);if(!i)return t;var r=g(i,e);return n(r,r.next),n(i,i.next)}(m[o],i);return i}(e,t,k,i)),e.length>80*i){r=f=e[0],d=m=e[1];for(var S=i;S<w;S+=i)v=e[S],x=e[S+1],v<r&&(r=v),x<d&&(d=x),v>f&&(f=v),x>m&&(m=x);_=0!==(_=Math.max(f-r,m-d))?32767/_:0}return function e(t,i,r,s,a,d,f){if(t){!f&&d&&function(e,t,i,r){var s=e;do 0===s.z&&(s.z=o(s.x,s.y,t,i,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==e)s.prevZ.nextZ=null,s.prevZ=null,function(e){var t,i,r,s,n,a,o,l,c=1;do{for(i=e,e=null,n=null,a=0;i;){for(a++,r=i,o=0,t=0;t<c&&(o++,r=r.nextZ);t++);for(l=c;o>0||l>0&&r;)0!==o&&(0===l||!r||i.z<=r.z)?(s=i,i=i.nextZ,o--):(s=r,r=r.nextZ,l--),n?n.nextZ=s:e=s,s.prevZ=n,n=s;i=r}n.nextZ=null,c*=2}while(a>1)}(s)}(t,s,a,d);for(var m,v,x=t;t.prev!==t.next;){if(m=t.prev,v=t.next,d?function(e,t,i,r){var s=e.prev,n=e.next;if(c(s,e,n)>=0)return!1;for(var a=s.x,u=e.x,h=n.x,d=s.y,f=e.y,p=n.y,g=a<u?a<h?a:h:u<h?u:h,m=d<f?d<p?d:p:f<p?f:p,y=a>u?a>h?a:h:u>h?u:h,v=d>f?d>p?d:p:f>p?f:p,x=o(g,m,t,i,r),_=o(y,v,t,i,r),b=e.prevZ,w=e.nextZ;b&&b.z>=x&&w&&w.z<=_;){if(b.x>=g&&b.x<=y&&b.y>=m&&b.y<=v&&b!==s&&b!==n&&l(a,d,u,f,h,p,b.x,b.y)&&c(b.prev,b,b.next)>=0||(b=b.prevZ,w.x>=g&&w.x<=y&&w.y>=m&&w.y<=v&&w!==s&&w!==n&&l(a,d,u,f,h,p,w.x,w.y)&&c(w.prev,w,w.next)>=0))return!1;w=w.nextZ}for(;b&&b.z>=x;){if(b.x>=g&&b.x<=y&&b.y>=m&&b.y<=v&&b!==s&&b!==n&&l(a,d,u,f,h,p,b.x,b.y)&&c(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;w&&w.z<=_;){if(w.x>=g&&w.x<=y&&w.y>=m&&w.y<=v&&w!==s&&w!==n&&l(a,d,u,f,h,p,w.x,w.y)&&c(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}(t,s,a,d):function(e){var t=e.prev,i=e.next;if(c(t,e,i)>=0)return!1;for(var r=t.x,s=e.x,n=i.x,a=t.y,o=e.y,u=i.y,h=r<s?r<n?r:n:s<n?s:n,d=a<o?a<u?a:u:o<u?o:u,f=r>s?r>n?r:n:s>n?s:n,p=a>o?a>u?a:u:o>u?o:u,g=i.next;g!==t;){if(g.x>=h&&g.x<=f&&g.y>=d&&g.y<=p&&l(r,a,s,o,n,u,g.x,g.y)&&c(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}(t)){i.push(m.i/r|0),i.push(t.i/r|0),i.push(v.i/r|0),y(t),t=v.next,x=v.next;continue}if((t=v)===x){f?1===f?e(t=function(e,t,i){var r=e;do{var s=r.prev,a=r.next.next;!u(s,a)&&h(s,r,r.next,a)&&p(s,a)&&p(a,s)&&(t.push(s.i/i|0),t.push(r.i/i|0),t.push(a.i/i|0),y(r),y(r.next),r=e=a),r=r.next}while(r!==e)return n(r)}(n(t),i,r),i,r,s,a,d,2):2===f&&function(t,i,r,s,a,o){var l=t;do{for(var d,f,m=l.next.next;m!==l.prev;){if(l.i!==m.i&&(d=l,f=m,d.next.i!==f.i&&d.prev.i!==f.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&h(i,i.next,e,t))return!0;i=i.next}while(i!==e)return!1}(d,f)&&(p(d,f)&&p(f,d)&&function(e,t){var i=e,r=!1,s=(e.x+t.x)/2,n=(e.y+t.y)/2;do i.y>n!=i.next.y>n&&i.next.y!==i.y&&s<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next;while(i!==e)return r}(d,f)&&(c(d.prev,d,f.prev)||c(d,f.prev,f))||u(d,f)&&c(d.prev,d,d.next)>0&&c(f.prev,f,f.next)>0))){var y=g(l,m);l=n(l,l.next),y=n(y,y.next),e(l,i,r,s,a,o,0),e(y,i,r,s,a,o,0);return}m=m.next}l=l.next}while(l!==t)}(t,i,r,s,a,d):e(n(t),i,r,s,a,d,1);break}}}}(k,P,i,r,d,_,0),P}function s(e,t,i,r,s){var n,a;if(s===x(e,t,i,r)>0)for(n=t;n<i;n+=r)a=m(n,e[n],e[n+1],a);else for(n=i-r;n>=t;n-=r)a=m(n,e[n],e[n+1],a);return a&&u(a,a.next)&&(y(a),a=a.next),a}function n(e,t){if(!e)return e;t||(t=e);var i,r=e;do if(i=!1,!r.steiner&&(u(r,r.next)||0===c(r.prev,r,r.next))){if(y(r),(r=t=r.prev)===r.next)break;i=!0}else r=r.next;while(i||r!==t)return t}function a(e,t){return e.x-t.x}function o(e,t,i,r,s){return(e=((e=((e=((e=((e=(e-i)*s|0)|e<<8)&0xff00ff)|e<<4)&0xf0f0f0f)|e<<2)&0x33333333)|e<<1)&0x55555555)|(t=((t=((t=((t=((t=(t-r)*s|0)|t<<8)&0xff00ff)|t<<4)&0xf0f0f0f)|t<<2)&0x33333333)|t<<1)&0x55555555)<<1}function l(e,t,i,r,s,n,a,o){return(s-a)*(t-o)>=(e-a)*(n-o)&&(e-a)*(r-o)>=(i-a)*(t-o)&&(i-a)*(n-o)>=(s-a)*(r-o)}function c(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function u(e,t){return e.x===t.x&&e.y===t.y}function h(e,t,i,r){var s=f(c(e,t,i)),n=f(c(e,t,r)),a=f(c(i,r,e)),o=f(c(i,r,t));return!!(s!==n&&a!==o||0===s&&d(e,i,t)||0===n&&d(e,r,t)||0===a&&d(i,e,r)||0===o&&d(i,t,r))}function d(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function f(e){return e>0?1:e<0?-1:0}function p(e,t){return 0>c(e.prev,e,e.next)?c(e,t,e.next)>=0&&c(e,e.prev,t)>=0:0>c(e,t,e.prev)||0>c(e,e.next,t)}function g(e,t){var i=new v(e.i,e.x,e.y),r=new v(t.i,t.x,t.y),s=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,r.next=i,i.prev=r,n.next=r,r.prev=n,r}function m(e,t,i,r){var s=new v(e,t,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function y(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function v(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function x(e,t,i,r){for(var s=0,n=t,a=i-r;n<i;n+=r)s+=(e[a]-e[n])*(e[n+1]+e[a+1]),a=n;return s}t.exports=r,t.exports.default=r,r.deviation=function(e,t,i,r){var s=t&&t.length,n=s?t[0]*i:e.length,a=Math.abs(x(e,0,n,i));if(s)for(var o=0,l=t.length;o<l;o++){var c=t[o]*i,u=o<l-1?t[o+1]*i:e.length;a-=Math.abs(x(e,c,u,i))}var h=0;for(o=0;o<r.length;o+=3){var d=r[o]*i,f=r[o+1]*i,p=r[o+2]*i;h+=Math.abs((e[d]-e[p])*(e[f+1]-e[d+1])-(e[d]-e[f])*(e[p+1]-e[d+1]))}return 0===a&&0===h?0:Math.abs((h-a)/a)},r.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,s=0;s<e.length;s++){for(var n=0;n<e[s].length;n++)for(var a=0;a<t;a++)i.vertices.push(e[s][n][a]);s>0&&(r+=e[s-1].length,i.holes.push(r))}return i}},52683,e=>{"use strict";let t,i,r,s,n,a,o,l,c,u,h,d,f,p;var g,m,y,v,x,_,b,w,k,P,S,T,C,M,A,I,E,L,O,R,N,j=e.i(43476),D=e.i(71645),z=e.i(55274),F=e.i(75254);let B=(0,F.default)("chart-line",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]),U=(0,F.default)("map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]),$=(0,F.default)("workflow",[["rect",{width:"8",height:"8",x:"3",y:"3",rx:"2",key:"by2w9f"}],["path",{d:"M7 11v4a2 2 0 0 0 2 2h4",key:"xkn7yn"}],["rect",{width:"8",height:"8",x:"13",y:"13",rx:"2",key:"1cgmvn"}]]);var V=e.i(237),W=e.i(1725),G=e.i(72526),q=e.i(55706),H=e.i(29228),Z=e.i(31195),Y=e.i(34239),X=e.i(85183),K=e.i(93230);let J=1,Q=1;class ee{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(e){let{delay:t=0,duration:i=1/0,rate:r=1,repeat:s=1}=e,n=J++,a={time:0,delay:t,duration:i,rate:r,repeat:s};return this._setChannelTime(a,this.time),this.channels.set(n,a),n}removeChannel(e){for(let[t,i]of(this.channels.delete(e),this.animations))i.channel===e&&this.detachAnimation(t)}isFinished(e){let t=this.channels.get(e);return void 0!==t&&this.time>=t.delay+t.duration*t.repeat}getTime(e){if(void 0===e)return this.time;let t=this.channels.get(e);return void 0===t?-1:t.time}setTime(e){for(let t of(this.time=Math.max(0,e),this.channels.values()))this._setChannelTime(t,this.time);for(let e of this.animations.values()){let{animation:t,channel:i}=e;t.setTime(this.getTime(i))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){let i=Q++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(-1===this.lastEngineTime&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){let i=t-e.delay;i>=e.duration*e.repeat?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}}function et(e,t){if(!e)throw Error(t||"shadertools: assertion failed.")}let ei={number:{type:"number",validate:(e,t)=>Number.isFinite(e)&&"object"==typeof t&&(void 0===t.max||e<=t.max)&&(void 0===t.min||e>=t.min)},array:{type:"array",validate:(e,t)=>Array.isArray(e)||ArrayBuffer.isView(e)}};function er(e){return Array.isArray(e)||ArrayBuffer.isView(e)?"array":typeof e}let es={vertex:`\
#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,fragment:`\
#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`},en=/void\s+main\s*\([^)]*\)\s*\{\n?/,ea=/}\n?[^{}]*$/,eo=[],el="__LUMA_INJECT_DECLARATIONS__";function ec(e,t,i,r=!1){let s="vertex"===t;for(let t in i){let r=i[t];r.sort((e,t)=>e.order-t.order),eo.length=r.length;for(let e=0,t=r.length;e<t;++e)eo[e]=r[e].injection;let n=`${eo.join("\n")}
`;switch(t){case"vs:#decl":s&&(e=e.replace(el,n));break;case"vs:#main-start":s&&(e=e.replace(en,e=>e+n));break;case"vs:#main-end":s&&(e=e.replace(ea,e=>n+e));break;case"fs:#decl":s||(e=e.replace(el,n));break;case"fs:#main-start":s||(e=e.replace(en,e=>e+n));break;case"fs:#main-end":s||(e=e.replace(ea,e=>n+e));break;default:e=e.replace(t,e=>e+n)}}return e=e.replace(el,""),r&&(e=e.replace(/\}\s*$/,e=>e+es[t])),e}function eu(e){e.map(e=>(function(e){var t;if(e.instance)return;eu(e.dependencies||[]);let{propTypes:i={},deprecations:r=[],inject:s={}}=e,n={normalizedInjections:function(e){let t={vertex:{},fragment:{}};for(let i in e){let r=e[i];"string"==typeof r&&(r={order:0,injection:r}),t[function(e){let t=e.slice(0,2);switch(t){case"vs":return"vertex";case"fs":return"fragment";default:throw Error(t)}}(i)][i]=r}return t}(s),parsedDeprecations:((t=r).forEach(e=>{"function"===e.type?e.regex=RegExp(`\\b${e.old}\\(`):e.regex=RegExp(`${e.type} ${e.old};`)}),t)};i&&(n.propValidators=function(e){let t={};for(let[i,r]of Object.entries(e))t[i]=function(e){let t=er(e);if("object"!==t)return{value:e,...ei[t],type:t};if("object"==typeof e)return e?void 0!==e.type?{...e,...ei[e.type],type:e.type}:void 0===e.value?{type:"object",value:e}:(t=er(e.value),{...e,...ei[t],type:t}):{type:"object",value:null};throw Error("props")}(r);return t}(i)),e.instance=n;let a={};i&&(a=Object.entries(i).reduce((e,[t,i])=>{let r=i?.value;return r&&(e[t]=r),e},{})),e.defaultUniforms={...e.defaultUniforms,...a}})(e))}function eh(e,t,i){e.deprecations?.forEach(e=>{e.regex?.test(t)&&(e.deprecated?i.deprecated(e.old,e.new)():i.removed(e.old,e.new)())})}function ed(e){eu(e);let t={},i={};!function e(t){let{modules:i,level:r,moduleMap:s,moduleDepth:n}=t;if(r>=5)throw Error("Possible loop in shader dependency graph");for(let e of i)s[e.name]=e,(void 0===n[e.name]||n[e.name]<r)&&(n[e.name]=r);for(let t of i)t.dependencies&&e({modules:t.dependencies,level:r+1,moduleMap:s,moduleDepth:n})}({modules:e,level:0,moduleMap:t,moduleDepth:i});let r=Object.keys(i).sort((e,t)=>i[t]-i[e]).map(e=>t[e]);return eu(r),r}let ef=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,"#version 300 es\n"],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],ep=[...ef,[ey("attribute"),"in $1"],[ey("varying"),"out $1"]],eg=[...ef,[ey("varying"),"in $1"]];function em(e,t){for(let[i,r]of t)e=e.replace(i,r);return e}function ey(e){return RegExp(`\\b${e}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function ev(e,t){let i="";for(let r in e){let s=e[r];if(i+=`void ${s.signature} {
`,s.header&&(i+=`  ${s.header}`),t[r]){let e=t[r];for(let t of(e.sort((e,t)=>e.order-t.order),e))i+=`  ${t.injection}
`}s.footer&&(i+=`  ${s.footer}`),i+="}\n"}return i}function ex(e){let t={vertex:{},fragment:{}};for(let i of e){let e,r;"string"!=typeof i?r=(e=i).hook:(e={},r=i);let[s,n]=(r=r.trim()).split(":"),a=r.replace(/\(.+/,""),o=Object.assign(e,{signature:n});switch(s){case"vs":t.vertex[a]=o;break;case"fs":t.fragment[a]=o;break;default:throw Error(s)}}return t}let e_=`

${el}
`,eb=`\
precision highp float;
`;function ew(e,t){let{source:i,stage:r,language:s="glsl",modules:n,defines:a={},hookFunctions:o=[],inject:l={},prologue:c=!0,log:u}=t;et("string"==typeof i,"shader source must be a string");let h="glsl"===s?({name:function(e,t="unnamed"){let i=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(e);return i?i[1]:t}(i,void 0),language:"glsl",version:function(e){let t=100,i=e.match(/[^\s]+/g);if(i&&i.length>=2&&"#version"===i[0]){let e=parseInt(i[1],10);Number.isFinite(e)&&(t=e)}if(100!==t&&300!==t)throw Error(`Invalid GLSL version ${t}`);return t}(i)}).version:-1,d=e.shaderLanguageVersion,f=100===h?"#version 100":"#version 300 es",p=i.split("\n").slice(1).join("\n"),g={};n.forEach(e=>{Object.assign(g,e.defines)}),Object.assign(g,a);let m="";switch(s){case"wgsl":break;case"glsl":m=c?`\
${f}

// ----- PROLOGUE -------------------------
#define SHADER_TYPE_${r.toUpperCase()}

${function(e){switch(e?.gpu.toLowerCase()){case"apple":return`\
#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`\
#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`\
#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`\
#define AMD_GPU
`;default:return`\
#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}(e)}
${"fragment"===r?eb:""}

// ----- APPLICATION DEFINES -------------------------

${function(e={}){let t="";for(let i in e){let r=e[i];(r||Number.isFinite(r))&&(t+=`#define ${i.toUpperCase()} ${e[i]}
`)}return t}(g)}

`:`${f}
`}let y=ex(o),v={},x={},_={};for(let e in l){let t="string"==typeof l[e]?{injection:l[e],order:0}:l[e],i=/^(v|f)s:(#)?([\w-]+)$/.exec(e);if(i){let r=i[2],s=i[3];r?"decl"===s?x[e]=[t]:_[e]=[t]:v[e]=[t]}else _[e]=[t]}for(let e of n){u&&eh(e,p,u),m+=eP(e,r);let t=e.instance?.normalizedInjections[r]||{};for(let e in t){let i=/^(v|f)s:#([\w-]+)$/.exec(e);if(i){let r="decl"===i[2]?x:_;r[e]=r[e]||[],r[e].push(t[e])}else v[e]=v[e]||[],v[e].push(t[e])}}return m+="// ----- MAIN SHADER SOURCE -------------------------",m+=e_,m=ec(m,r,x)+ev(y[r],v)+p,m=ec(m,r,_),"glsl"===s&&h!==d&&(m=function(e,t){if(300!==Number(e.match(/^#version[ \t]+(\d+)/m)?.[1]||100))throw Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(t){case"vertex":return em(e,ep);case"fragment":return em(e,eg);default:throw Error(t)}}(m,r)),m.trim()}function ek(e){return function(t){let i={};for(let r of e){let e=r.getUniforms?.(t,i);Object.assign(i,e)}return i}}function eP(e,t){let i;switch(t){case"vertex":i=e.vs||"";break;case"fragment":i=e.fs||"";break;case"wgsl":i=e.source||"";break;default:et(!1)}if(!e.name)throw Error("Shader module must have a name");let r=e.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),s=`\
// ----- MODULE ${e.name} ---------------

`;return"wgsl"!==t&&(s+=`#define MODULE_${r}
`),s+=`${i}
`}let eS=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,eT=/^\s*\#\s*endif\s*$/;class eC{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return eC.defaultShaderAssembler=eC.defaultShaderAssembler||new eC,eC.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===("string"==typeof e?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){let t="string"==typeof e?e:e.name;this._defaultModules=this._defaultModules.filter(e=>e.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){var t;let i,r=this._getModuleList(e.modules),s=this._hookFunctions,{source:n,getUniforms:a}=(i=ed((t={...e,source:e.source,modules:r,hookFunctions:s}).modules||[]),{source:function(e,t){let{source:i,stage:r,modules:s,hookFunctions:n=[],inject:a={},log:o}=t;et("string"==typeof i,"shader source must be a string");let l="",c=ex(n),u={},h={},d={};for(let e in a){let t="string"==typeof a[e]?{injection:a[e],order:0}:a[e],i=/^(v|f)s:(#)?([\w-]+)$/.exec(e);if(i){let r=i[2],s=i[3];r?"decl"===s?h[e]=[t]:d[e]=[t]:u[e]=[t]}else d[e]=[t]}for(let e of s){o&&eh(e,i,o),l+=eP(e,"wgsl");let t=e.injections?.[r]||{};for(let e in t){let i=/^(v|f)s:#([\w-]+)$/.exec(e);if(i){let r="decl"===i[2]?h:d;r[e]=r[e]||[],r[e].push(t[e])}else u[e]=u[e]||[],u[e].push(t[e])}}return l+=e_,l=ec(l,r,h)+ev(c[r],u)+i,l=ec(l,r,d)}(t.platformInfo,{...t,source:t.source,stage:"vertex",modules:i}),getUniforms:ek(i)});return{source:"wgsl"===e.platformInfo.shaderLanguage?function(e,t){let i=e.split("\n"),r=[],s=!0;for(let e of i){let t=e.match(eS),i=e.match(eT);t?(t[1],s=!1):i?s=!0:s&&r.push(e)}return r.join("\n")}(n):n,getUniforms:a,modules:r}}assembleGLSLShaderPair(e){let t=this._getModuleList(e.modules),i=this._hookFunctions;return{...function(e){let{vs:t,fs:i}=e,r=ed(e.modules||[]);return{vs:ew(e.platformInfo,{...e,source:t,stage:"vertex",modules:r}),fs:ew(e.platformInfo,{...e,source:i,stage:"fragment",modules:r}),getUniforms:ek(r)}}({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:i}),modules:t}}_getModuleList(e=[]){let t=Array(this._defaultModules.length+e.length),i={},r=0;for(let e=0,s=this._defaultModules.length;e<s;++e){let s=this._defaultModules[e],n=s.name;t[r++]=s,i[n]=!0}for(let s=0,n=e.length;s<n;++s){let n=e[s],a=n.name;i[a]||(t[r++]=n,i[a]=!0)}return t.length=r,eu(t),t}}var eM=e.i(12828);let eA=`\
precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,eI=`\
// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  pointLightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`;(g=T||(T={}))[g.POINT=0]="POINT",g[g.DIRECTIONAL=1]="DIRECTIONAL";let eE={props:{},uniforms:{},name:"lighting",defines:{},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:T.POINT,directionalLightCount:0,pointLightCount:0,ambientColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:eI,vs:eA,fs:eA,getUniforms:function(e,t={}){if(!(e=e?{...e}:e))return{...eE.defaultUniforms};e.lights&&(e={...e,...function(e){let t={pointLights:[],directionalLights:[]};for(let i of e||[])switch(i.type){case"ambient":t.ambientLight=i;break;case"directional":t.directionalLights?.push(i);break;case"point":t.pointLights?.push(i)}return t}(e.lights),lights:void 0});let{ambientLight:i,pointLights:r,directionalLights:s}=e||{};if(!(i||r&&r.length>0||s&&s.length>0))return{...eE.defaultUniforms,enabled:0};let n={...eE.defaultUniforms,...t,...function({ambientLight:e,pointLights:t=[],directionalLights:i=[]}){let r={};r.ambientColor=eL(e);let s=0;for(let e of t){r.lightType=T.POINT;let t=s;r[`lightColor${t}`]=eL(e),r[`lightPosition${t}`]=e.position,r[`lightAttenuation${t}`]=e.attenuation||[1,0,0],s++}for(let e of i){r.lightType=T.DIRECTIONAL;let t=s;r[`lightColor${t}`]=eL(e),r[`lightDirection${t}`]=e.direction,s++}return s>5&&eM.log.warn("MAX_LIGHTS exceeded")(),r.directionalLightCount=i.length,r.pointLightCount=t.length,r}({ambientLight:i,pointLights:r,directionalLights:s})};return void 0!==e.enabled&&(n.enabled=+!!e.enabled),n}};function eL(e={}){let{color:t=[0,0,0],intensity:i=1}=e;return t.map(e=>e*i/255)}let eO=`\
uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,eR=`\
#define MAX_LIGHTS 3

uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,eN=`\
struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`,ej={props:{},name:"gouraudMaterial",vs:eR.replace("phongMaterial","gouraudMaterial"),fs:eO.replace("phongMaterial","gouraudMaterial"),source:eN.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:!0},dependencies:[eE],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(e){let t={...e};return t.specularColor&&(t.specularColor=t.specularColor.map(e=>e/255)),{...ej.defaultUniforms,...t}}},eD={name:"phongMaterial",dependencies:[eE],source:eN,vs:eO,fs:eR,defines:{LIGHTING_FRAGMENT:!0},uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(e){let t={...e};return t.specularColor&&(t.specularColor=t.specularColor.map(e=>e/255)),{...eD.defaultUniforms,...t}}},ez=`\
uniform layerUniforms {
  uniform float opacity;
} layer;
`,eF={name:"layer",vs:ez,fs:ez,getUniforms:e=>({opacity:Math.pow(e.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},eB={name:"color",dependencies:[],source:`

struct ColorUniforms {
  opacity: f32,
};

var<private> color: ColorUniforms = ColorUniforms(1.0);
// TODO (kaapp) avoiding binding index collisions to handle layer opacity 
// requires some thought.
// @group(0) @binding(0) var<uniform> color: ColorUniforms;

@must_use
fn deckgl_premultiplied_alpha(fragColor: vec4<f32>) -> vec4<f32> {
    return vec4(fragColor.rgb * fragColor.a, fragColor.a); 
};
`,getUniforms:e=>({}),uniformTypes:{opacity:"f32"}},eU="#define SMOOTH_EDGE_RADIUS 0.5",e$={name:"geometry",source:`\
const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,vs:`\
${eU}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,fs:`\
${eU}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`},eV=`\
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,eW="undefined"!=typeof Float32Array?Float32Array:Array,eG=Math.random;function eq(e){return e>=0?Math.round(e):e%.5==0?Math.floor(e):Math.round(e)}function eH(){let e=new eW(16);return eW!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function eZ(e){let t=new eW(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function eY(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function eX(e,t,i,r,s,n,a,o,l,c,u,h,d,f,p,g){let m=new eW(16);return m[0]=e,m[1]=t,m[2]=i,m[3]=r,m[4]=s,m[5]=n,m[6]=a,m[7]=o,m[8]=l,m[9]=c,m[10]=u,m[11]=h,m[12]=d,m[13]=f,m[14]=p,m[15]=g,m}function eK(e,t,i,r,s,n,a,o,l,c,u,h,d,f,p,g,m){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=a,e[6]=o,e[7]=l,e[8]=c,e[9]=u,e[10]=h,e[11]=d,e[12]=f,e[13]=p,e[14]=g,e[15]=m,e}function eJ(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function eQ(e,t){if(e===t){let i=t[1],r=t[2],s=t[3],n=t[6],a=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=n,e[11]=t[14],e[12]=s,e[13]=a,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function e0(e,t){let i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],f=t[11],p=t[12],g=t[13],m=t[14],y=t[15],v=i*o-r*a,x=i*l-s*a,_=i*c-n*a,b=r*l-s*o,w=r*c-n*o,k=s*c-n*l,P=u*g-h*p,S=u*m-d*p,T=u*y-f*p,C=h*m-d*g,M=h*y-f*g,A=d*y-f*m,I=v*A-x*M+_*C+b*T-w*S+k*P;return I?(I=1/I,e[0]=(o*A-l*M+c*C)*I,e[1]=(s*M-r*A-n*C)*I,e[2]=(g*k-m*w+y*b)*I,e[3]=(d*w-h*k-f*b)*I,e[4]=(l*T-a*A-c*S)*I,e[5]=(i*A-s*T+n*S)*I,e[6]=(m*_-p*k-y*x)*I,e[7]=(u*k-d*_+f*x)*I,e[8]=(a*M-o*T+c*P)*I,e[9]=(r*T-i*M-n*P)*I,e[10]=(p*w-g*_+y*v)*I,e[11]=(h*_-u*w-f*v)*I,e[12]=(o*S-a*C-l*P)*I,e[13]=(i*C-r*S+s*P)*I,e[14]=(g*x-p*b-m*v)*I,e[15]=(u*b-h*x+d*v)*I,e):null}function e1(e,t){let i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],f=t[11],p=t[12],g=t[13],m=t[14],y=t[15],v=i*o-r*a,x=i*l-s*a,_=i*c-n*a,b=r*l-s*o,w=r*c-n*o,k=s*c-n*l,P=u*g-h*p,S=u*m-d*p,T=u*y-f*p,C=h*m-d*g,M=h*y-f*g,A=d*y-f*m;return e[0]=o*A-l*M+c*C,e[1]=s*M-r*A-n*C,e[2]=g*k-m*w+y*b,e[3]=d*w-h*k-f*b,e[4]=l*T-a*A-c*S,e[5]=i*A-s*T+n*S,e[6]=m*_-p*k-y*x,e[7]=u*k-d*_+f*x,e[8]=a*M-o*T+c*P,e[9]=r*T-i*M-n*P,e[10]=p*w-g*_+y*v,e[11]=h*_-u*w-f*v,e[12]=o*S-a*C-l*P,e[13]=i*C-r*S+s*P,e[14]=g*x-p*b-m*v,e[15]=u*b-h*x+d*v,e}function e2(e){let t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5],o=e[6],l=e[7],c=e[8],u=e[9],h=e[10],d=e[11],f=e[12],p=e[13],g=e[14],m=e[15],y=t*a-i*n,v=t*o-r*n,x=i*o-r*a,_=c*p-u*f,b=c*g-h*f,w=u*g-h*p;return l*(t*w-i*b+r*_)-s*(n*w-a*b+o*_)+m*(c*x-u*v+h*y)-d*(f*x-p*v+g*y)}function e3(e,t,i){let r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],f=t[10],p=t[11],g=t[12],m=t[13],y=t[14],v=t[15],x=i[0],_=i[1],b=i[2],w=i[3];return e[0]=x*r+_*o+b*h+w*g,e[1]=x*s+_*l+b*d+w*m,e[2]=x*n+_*c+b*f+w*y,e[3]=x*a+_*u+b*p+w*v,x=i[4],_=i[5],b=i[6],w=i[7],e[4]=x*r+_*o+b*h+w*g,e[5]=x*s+_*l+b*d+w*m,e[6]=x*n+_*c+b*f+w*y,e[7]=x*a+_*u+b*p+w*v,x=i[8],_=i[9],b=i[10],w=i[11],e[8]=x*r+_*o+b*h+w*g,e[9]=x*s+_*l+b*d+w*m,e[10]=x*n+_*c+b*f+w*y,e[11]=x*a+_*u+b*p+w*v,x=i[12],_=i[13],b=i[14],w=i[15],e[12]=x*r+_*o+b*h+w*g,e[13]=x*s+_*l+b*d+w*m,e[14]=x*n+_*c+b*f+w*y,e[15]=x*a+_*u+b*p+w*v,e}function e4(e,t,i){let r,s,n,a,o,l,c,u,h,d,f,p,g=i[0],m=i[1],y=i[2];return t===e?(e[12]=t[0]*g+t[4]*m+t[8]*y+t[12],e[13]=t[1]*g+t[5]*m+t[9]*y+t[13],e[14]=t[2]*g+t[6]*m+t[10]*y+t[14],e[15]=t[3]*g+t[7]*m+t[11]*y+t[15]):(r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],f=t[10],p=t[11],e[0]=r,e[1]=s,e[2]=n,e[3]=a,e[4]=o,e[5]=l,e[6]=c,e[7]=u,e[8]=h,e[9]=d,e[10]=f,e[11]=p,e[12]=r*g+o*m+h*y+t[12],e[13]=s*g+l*m+d*y+t[13],e[14]=n*g+c*m+f*y+t[14],e[15]=a*g+u*m+p*y+t[15]),e}function e6(e,t,i){let r=i[0],s=i[1],n=i[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function e5(e,t,i,r){let s,n,a,o,l,c,u,h,d,f,p,g,m,y,v,x,_,b,w,k,P,S,T,C,M=r[0],A=r[1],I=r[2],E=Math.sqrt(M*M+A*A+I*I);return E<1e-6?null:(M*=E=1/E,A*=E,I*=E,n=Math.sin(i),a=1-(s=Math.cos(i)),o=t[0],l=t[1],c=t[2],u=t[3],h=t[4],d=t[5],f=t[6],p=t[7],g=t[8],m=t[9],y=t[10],v=t[11],x=M*M*a+s,_=A*M*a+I*n,b=I*M*a-A*n,w=M*A*a-I*n,k=A*A*a+s,P=I*A*a+M*n,S=M*I*a+A*n,T=A*I*a-M*n,C=I*I*a+s,e[0]=o*x+h*_+g*b,e[1]=l*x+d*_+m*b,e[2]=c*x+f*_+y*b,e[3]=u*x+p*_+v*b,e[4]=o*w+h*k+g*P,e[5]=l*w+d*k+m*P,e[6]=c*w+f*k+y*P,e[7]=u*w+p*k+v*P,e[8]=o*S+h*T+g*C,e[9]=l*S+d*T+m*C,e[10]=c*S+f*T+y*C,e[11]=u*S+p*T+v*C,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function e8(e,t,i){let r=Math.sin(i),s=Math.cos(i),n=t[4],a=t[5],o=t[6],l=t[7],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*s+c*r,e[5]=a*s+u*r,e[6]=o*s+h*r,e[7]=l*s+d*r,e[8]=c*s-n*r,e[9]=u*s-a*r,e[10]=h*s-o*r,e[11]=d*s-l*r,e}function e7(e,t,i){let r=Math.sin(i),s=Math.cos(i),n=t[0],a=t[1],o=t[2],l=t[3],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s-c*r,e[1]=a*s-u*r,e[2]=o*s-h*r,e[3]=l*s-d*r,e[8]=n*r+c*s,e[9]=a*r+u*s,e[10]=o*r+h*s,e[11]=l*r+d*s,e}function e9(e,t,i){let r=Math.sin(i),s=Math.cos(i),n=t[0],a=t[1],o=t[2],l=t[3],c=t[4],u=t[5],h=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s+c*r,e[1]=a*s+u*r,e[2]=o*s+h*r,e[3]=l*s+d*r,e[4]=c*s-n*r,e[5]=u*s-a*r,e[6]=h*s-o*r,e[7]=d*s-l*r,e}function te(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function tt(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ti(e,t,i){let r,s,n,a=i[0],o=i[1],l=i[2],c=Math.sqrt(a*a+o*o+l*l);return c<1e-6?null:(a*=c=1/c,o*=c,l*=c,s=Math.sin(t),n=1-(r=Math.cos(t)),e[0]=a*a*n+r,e[1]=o*a*n+l*s,e[2]=l*a*n-o*s,e[3]=0,e[4]=a*o*n-l*s,e[5]=o*o*n+r,e[6]=l*o*n+a*s,e[7]=0,e[8]=a*l*n+o*s,e[9]=o*l*n-a*s,e[10]=l*l*n+r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function tr(e,t){let i=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ts(e,t){let i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function tn(e,t){let i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ta(e,t,i){let r=t[0],s=t[1],n=t[2],a=t[3],o=r+r,l=s+s,c=n+n,u=r*o,h=r*l,d=r*c,f=s*l,p=s*c,g=n*c,m=a*o,y=a*l,v=a*c;return e[0]=1-(f+g),e[1]=h+v,e[2]=d-y,e[3]=0,e[4]=h-v,e[5]=1-(u+g),e[6]=p+m,e[7]=0,e[8]=d+y,e[9]=p-m,e[10]=1-(u+f),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function to(e,t){let i=new eW(3),r=-t[0],s=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=r*r+s*s+n*n+a*a;return h>0?(i[0]=(o*a+u*r+l*n-c*s)*2/h,i[1]=(l*a+u*s+c*r-o*n)*2/h,i[2]=(c*a+u*n+o*s-l*r)*2/h):(i[0]=(o*a+u*r+l*n-c*s)*2,i[1]=(l*a+u*s+c*r-o*n)*2,i[2]=(c*a+u*n+o*s-l*r)*2),ta(e,t,i),e}function tl(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function tc(e,t){let i=t[0],r=t[1],s=t[2],n=t[4],a=t[5],o=t[6],l=t[8],c=t[9],u=t[10];return e[0]=Math.sqrt(i*i+r*r+s*s),e[1]=Math.sqrt(n*n+a*a+o*o),e[2]=Math.sqrt(l*l+c*c+u*u),e}function tu(e,t){let i=new eW(3);tc(i,t);let r=1/i[0],s=1/i[1],n=1/i[2],a=t[0]*r,o=t[1]*s,l=t[2]*n,c=t[4]*r,u=t[5]*s,h=t[6]*n,d=t[8]*r,f=t[9]*s,p=t[10]*n,g=a+u+p,m=0;return g>0?(m=2*Math.sqrt(g+1),e[3]=.25*m,e[0]=(h-f)/m,e[1]=(d-l)/m,e[2]=(o-c)/m):a>u&&a>p?(m=2*Math.sqrt(1+a-u-p),e[3]=(h-f)/m,e[0]=.25*m,e[1]=(o+c)/m,e[2]=(d+l)/m):u>p?(m=2*Math.sqrt(1+u-a-p),e[3]=(d-l)/m,e[0]=(o+c)/m,e[1]=.25*m,e[2]=(h+f)/m):(m=2*Math.sqrt(1+p-a-u),e[3]=(o-c)/m,e[0]=(d+l)/m,e[1]=(h+f)/m,e[2]=.25*m),e}function th(e,t,i,r){t[0]=r[12],t[1]=r[13],t[2]=r[14];let s=r[0],n=r[1],a=r[2],o=r[4],l=r[5],c=r[6],u=r[8],h=r[9],d=r[10];i[0]=Math.sqrt(s*s+n*n+a*a),i[1]=Math.sqrt(o*o+l*l+c*c),i[2]=Math.sqrt(u*u+h*h+d*d);let f=1/i[0],p=1/i[1],g=1/i[2],m=s*f,y=n*p,v=a*g,x=o*f,_=l*p,b=c*g,w=u*f,k=h*p,P=d*g,S=m+_+P,T=0;return S>0?(T=2*Math.sqrt(S+1),e[3]=.25*T,e[0]=(b-k)/T,e[1]=(w-v)/T,e[2]=(y-x)/T):m>_&&m>P?(T=2*Math.sqrt(1+m-_-P),e[3]=(b-k)/T,e[0]=.25*T,e[1]=(y+x)/T,e[2]=(w+v)/T):_>P?(T=2*Math.sqrt(1+_-m-P),e[3]=(w-v)/T,e[0]=(y+x)/T,e[1]=.25*T,e[2]=(b+k)/T):(T=2*Math.sqrt(1+P-m-_),e[3]=(y-x)/T,e[0]=(w+v)/T,e[1]=(b+k)/T,e[2]=.25*T),e}function td(e,t,i,r){let s=t[0],n=t[1],a=t[2],o=t[3],l=s+s,c=n+n,u=a+a,h=s*l,d=s*c,f=s*u,p=n*c,g=n*u,m=a*u,y=o*l,v=o*c,x=o*u,_=r[0],b=r[1],w=r[2];return e[0]=(1-(p+m))*_,e[1]=(d+x)*_,e[2]=(f-v)*_,e[3]=0,e[4]=(d-x)*b,e[5]=(1-(h+m))*b,e[6]=(g+y)*b,e[7]=0,e[8]=(f+v)*w,e[9]=(g-y)*w,e[10]=(1-(h+p))*w,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function tf(e,t,i,r,s){let n=t[0],a=t[1],o=t[2],l=t[3],c=n+n,u=a+a,h=o+o,d=n*c,f=n*u,p=n*h,g=a*u,m=a*h,y=o*h,v=l*c,x=l*u,_=l*h,b=r[0],w=r[1],k=r[2],P=s[0],S=s[1],T=s[2],C=(1-(g+y))*b,M=(f+_)*b,A=(p-x)*b,I=(f-_)*w,E=(1-(d+y))*w,L=(m+v)*w,O=(p+x)*k,R=(m-v)*k,N=(1-(d+g))*k;return e[0]=C,e[1]=M,e[2]=A,e[3]=0,e[4]=I,e[5]=E,e[6]=L,e[7]=0,e[8]=O,e[9]=R,e[10]=N,e[11]=0,e[12]=i[0]+P-(C*P+I*S+O*T),e[13]=i[1]+S-(M*P+E*S+R*T),e[14]=i[2]+T-(A*P+L*S+N*T),e[15]=1,e}function tp(e,t){let i=t[0],r=t[1],s=t[2],n=t[3],a=i+i,o=r+r,l=s+s,c=i*a,u=r*a,h=r*o,d=s*a,f=s*o,p=s*l,g=n*a,m=n*o,y=n*l;return e[0]=1-h-p,e[1]=u+y,e[2]=d-m,e[3]=0,e[4]=u-y,e[5]=1-c-p,e[6]=f+g,e[7]=0,e[8]=d+m,e[9]=f-g,e[10]=1-c-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function tg(e,t,i,r,s,n,a){let o=1/(i-t),l=1/(s-r),c=1/(n-a);return e[0]=2*n*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(i+t)*o,e[9]=(s+r)*l,e[10]=(a+n)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*n*2*c,e[15]=0,e}function tm(e,t,i,r,s){let n=1/Math.tan(t/2);if(e[0]=n/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0){let t=1/(r-s);e[10]=(s+r)*t,e[14]=2*s*r*t}else e[10]=-1,e[14]=-2*r;return e}function ty(e,t,i,r,s){let n=1/Math.tan(t/2);if(e[0]=n/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0){let t=1/(r-s);e[10]=s*t,e[14]=s*r*t}else e[10]=-1,e[14]=-r;return e}function tv(e,t,i,r){let s=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),o=Math.tan(t.rightDegrees*Math.PI/180),l=2/(a+o),c=2/(s+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-((a-o)*l*.5),e[9]=(s-n)*c*.5,e[10]=r/(i-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*i/(i-r),e[15]=0,e}function tx(e,t,i,r,s,n,a){let o=1/(t-i),l=1/(r-s),c=1/(n-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*o,e[13]=(s+r)*l,e[14]=(a+n)*c,e[15]=1,e}function t_(e,t,i,r,s,n,a){let o=1/(t-i),l=1/(r-s),c=1/(n-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=c,e[11]=0,e[12]=(t+i)*o,e[13]=(s+r)*l,e[14]=n*c,e[15]=1,e}function tb(e,t,i,r){let s,n,a,o,l,c,u,h,d,f,p=t[0],g=t[1],m=t[2],y=r[0],v=r[1],x=r[2],_=i[0],b=i[1],w=i[2];return 1e-6>Math.abs(p-_)&&1e-6>Math.abs(g-b)&&1e-6>Math.abs(m-w)?eJ(e):(s=1/Math.sqrt((h=p-_)*h+(d=g-b)*d+(f=m-w)*f),h*=s,d*=s,f*=s,(s=Math.sqrt((n=v*f-x*d)*n+(a=x*h-y*f)*a+(o=y*d-v*h)*o))?(n*=s=1/s,a*=s,o*=s):(n=0,a=0,o=0),(s=Math.sqrt((l=d*o-f*a)*l+(c=f*n-h*o)*c+(u=h*a-d*n)*u))?(l*=s=1/s,c*=s,u*=s):(l=0,c=0,u=0),e[0]=n,e[1]=l,e[2]=h,e[3]=0,e[4]=a,e[5]=c,e[6]=d,e[7]=0,e[8]=o,e[9]=u,e[10]=f,e[11]=0,e[12]=-(n*p+a*g+o*m),e[13]=-(l*p+c*g+u*m),e[14]=-(h*p+d*g+f*m),e[15]=1,e)}function tw(e,t,i,r){let s=t[0],n=t[1],a=t[2],o=r[0],l=r[1],c=r[2],u=s-i[0],h=n-i[1],d=a-i[2],f=u*u+h*h+d*d;f>0&&(u*=f=1/Math.sqrt(f),h*=f,d*=f);let p=l*d-c*h,g=c*u-o*d,m=o*h-l*u;return(f=p*p+g*g+m*m)>0&&(p*=f=1/Math.sqrt(f),g*=f,m*=f),e[0]=p,e[1]=g,e[2]=m,e[3]=0,e[4]=h*m-d*g,e[5]=d*p-u*m,e[6]=u*g-h*p,e[7]=0,e[8]=u,e[9]=h,e[10]=d,e[11]=0,e[12]=s,e[13]=n,e[14]=a,e[15]=1,e}function tk(e){return`mat4(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]}, ${e[4]}, ${e[5]}, ${e[6]}, ${e[7]}, ${e[8]}, ${e[9]}, ${e[10]}, ${e[11]}, ${e[12]}, ${e[13]}, ${e[14]}, ${e[15]})`}function tP(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]+e[4]*e[4]+e[5]*e[5]+e[6]*e[6]+e[7]*e[7]+e[8]*e[8]+e[9]*e[9]+e[10]*e[10]+e[11]*e[11]+e[12]*e[12]+e[13]*e[13]+e[14]*e[14]+e[15]*e[15])}function tS(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e[9]=t[9]+i[9],e[10]=t[10]+i[10],e[11]=t[11]+i[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]+i[15],e}function tT(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e[9]=t[9]-i[9],e[10]=t[10]-i[10],e[11]=t[11]-i[11],e[12]=t[12]-i[12],e[13]=t[13]-i[13],e[14]=t[14]-i[14],e[15]=t[15]-i[15],e}function tC(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12]*i,e[13]=t[13]*i,e[14]=t[14]*i,e[15]=t[15]*i,e}function tM(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e[9]=t[9]+i[9]*r,e[10]=t[10]+i[10]*r,e[11]=t[11]+i[11]*r,e[12]=t[12]+i[12]*r,e[13]=t[13]+i[13]*r,e[14]=t[14]+i[14]*r,e[15]=t[15]+i[15]*r,e}function tA(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function tI(e,t){let i=e[0],r=e[1],s=e[2],n=e[3],a=e[4],o=e[5],l=e[6],c=e[7],u=e[8],h=e[9],d=e[10],f=e[11],p=e[12],g=e[13],m=e[14],y=e[15],v=t[0],x=t[1],_=t[2],b=t[3],w=t[4],k=t[5],P=t[6],S=t[7],T=t[8],C=t[9],M=t[10],A=t[11],I=t[12],E=t[13],L=t[14],O=t[15];return Math.abs(i-v)<=1e-6*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(r-x)<=1e-6*Math.max(1,Math.abs(r),Math.abs(x))&&Math.abs(s-_)<=1e-6*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(n-b)<=1e-6*Math.max(1,Math.abs(n),Math.abs(b))&&Math.abs(a-w)<=1e-6*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(o-k)<=1e-6*Math.max(1,Math.abs(o),Math.abs(k))&&Math.abs(l-P)<=1e-6*Math.max(1,Math.abs(l),Math.abs(P))&&Math.abs(c-S)<=1e-6*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(u-T)<=1e-6*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(h-C)<=1e-6*Math.max(1,Math.abs(h),Math.abs(C))&&Math.abs(d-M)<=1e-6*Math.max(1,Math.abs(d),Math.abs(M))&&Math.abs(f-A)<=1e-6*Math.max(1,Math.abs(f),Math.abs(A))&&Math.abs(p-I)<=1e-6*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(g-E)<=1e-6*Math.max(1,Math.abs(g),Math.abs(E))&&Math.abs(m-L)<=1e-6*Math.max(1,Math.abs(m),Math.abs(L))&&Math.abs(y-O)<=1e-6*Math.max(1,Math.abs(y),Math.abs(O))}e.s(["add",()=>tS,"adjoint",()=>e1,"clone",()=>eZ,"copy",()=>eY,"create",()=>eH,"decompose",()=>th,"determinant",()=>e2,"equals",()=>tI,"exactEquals",()=>tA,"frob",()=>tP,"fromQuat",()=>tp,"fromQuat2",()=>to,"fromRotation",()=>ti,"fromRotationTranslation",()=>ta,"fromRotationTranslationScale",()=>td,"fromRotationTranslationScaleOrigin",()=>tf,"fromScaling",()=>tt,"fromTranslation",()=>te,"fromValues",()=>eX,"fromXRotation",()=>tr,"fromYRotation",()=>ts,"fromZRotation",()=>tn,"frustum",()=>tg,"getRotation",()=>tu,"getScaling",()=>tc,"getTranslation",()=>tl,"identity",()=>eJ,"invert",()=>e0,"lookAt",()=>tb,"mul",0,e3,"multiply",()=>e3,"multiplyScalar",()=>tC,"multiplyScalarAndAdd",()=>tM,"ortho",0,tx,"orthoNO",()=>tx,"orthoZO",()=>t_,"perspective",0,tm,"perspectiveFromFieldOfView",()=>tv,"perspectiveNO",()=>tm,"perspectiveZO",()=>ty,"rotate",()=>e5,"rotateX",()=>e8,"rotateY",()=>e7,"rotateZ",()=>e9,"scale",()=>e6,"set",()=>eK,"str",()=>tk,"sub",0,tT,"subtract",()=>tT,"targetTo",()=>tw,"translate",()=>e4,"transpose",()=>eQ],32664);var tE=e.i(32664),tE=tE;function tL(){let e=new eW(4);return eW!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function tO(e){let t=new eW(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function tR(e,t,i,r){let s=new eW(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function tN(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function tj(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function tD(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function tz(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function tF(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e}function tB(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e}function tU(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function t$(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function tV(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e}function tW(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e}function tG(e,t){return e[0]=eq(t[0]),e[1]=eq(t[1]),e[2]=eq(t[2]),e[3]=eq(t[3]),e}function tq(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function tH(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}function tZ(e,t){let i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return Math.sqrt(i*i+r*r+s*s+n*n)}function tY(e,t){let i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return i*i+r*r+s*s+n*n}function tX(e){let t=e[0],i=e[1],r=e[2],s=e[3];return Math.sqrt(t*t+i*i+r*r+s*s)}function tK(e){let t=e[0],i=e[1],r=e[2],s=e[3];return t*t+i*i+r*r+s*s}function tJ(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function tQ(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function t0(e,t){let i=t[0],r=t[1],s=t[2],n=t[3],a=i*i+r*r+s*s+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=i*a,e[1]=r*a,e[2]=s*a,e[3]=n*a,e}function t1(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function t2(e,t,i,r){let s=i[0]*r[1]-i[1]*r[0],n=i[0]*r[2]-i[2]*r[0],a=i[0]*r[3]-i[3]*r[0],o=i[1]*r[2]-i[2]*r[1],l=i[1]*r[3]-i[3]*r[1],c=i[2]*r[3]-i[3]*r[2],u=t[0],h=t[1],d=t[2],f=t[3];return e[0]=h*c-d*l+f*o,e[1]=-(u*c)+d*a-f*n,e[2]=u*l-h*a+f*s,e[3]=-(u*o)+h*n-d*s,e}function t3(e,t,i,r){let s=t[0],n=t[1],a=t[2],o=t[3];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=a+r*(i[2]-a),e[3]=o+r*(i[3]-o),e}function t4(e,t){let i,r,s,n,a,o;t=void 0===t?1:t;do a=(i=2*eG()-1)*i+(r=2*eG()-1)*r;while(a>=1)do o=(s=2*eG()-1)*s+(n=2*eG()-1)*n;while(o>=1)let l=Math.sqrt((1-a)/o);return e[0]=t*i,e[1]=t*r,e[2]=t*s*l,e[3]=t*n*l,e}function t6(e,t,i){let r=t[0],s=t[1],n=t[2],a=t[3];return e[0]=i[0]*r+i[4]*s+i[8]*n+i[12]*a,e[1]=i[1]*r+i[5]*s+i[9]*n+i[13]*a,e[2]=i[2]*r+i[6]*s+i[10]*n+i[14]*a,e[3]=i[3]*r+i[7]*s+i[11]*n+i[15]*a,e}function t5(e,t,i){let r=t[0],s=t[1],n=t[2],a=i[0],o=i[1],l=i[2],c=i[3],u=c*r+o*n-l*s,h=c*s+l*r-a*n,d=c*n+a*s-o*r,f=-a*r-o*s-l*n;return e[0]=u*c+-(f*a)+-(h*l)- -(d*o),e[1]=h*c+-(f*o)+-(d*a)- -(u*l),e[2]=d*c+-(f*l)+-(u*o)- -(h*a),e[3]=t[3],e}function t8(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function t7(e){return`vec4(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`}function t9(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function ie(e,t){let i=e[0],r=e[1],s=e[2],n=e[3],a=t[0],o=t[1],l=t[2],c=t[3];return Math.abs(i-a)<=1e-6*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=1e-6*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-l)<=1e-6*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=1e-6*Math.max(1,Math.abs(n),Math.abs(c))}let it=(o=tL(),function(e,t,i,r,s,n){let a,l;for(t||(t=4),i||(i=0),l=r?Math.min(r*t+i,e.length):e.length,a=i;a<l;a+=t)o[0]=e[a],o[1]=e[a+1],o[2]=e[a+2],o[3]=e[a+3],s(o,o,n),e[a]=o[0],e[a+1]=o[1],e[a+2]=o[2],e[a+3]=o[3];return e});e.s(["add",()=>tD,"ceil",()=>tU,"clone",()=>tO,"copy",()=>tN,"create",()=>tL,"cross",()=>t2,"dist",0,tZ,"distance",()=>tZ,"div",0,tB,"divide",()=>tB,"dot",()=>t1,"equals",()=>ie,"exactEquals",()=>t9,"floor",()=>t$,"forEach",0,it,"fromValues",()=>tR,"inverse",()=>tQ,"len",0,tX,"length",()=>tX,"lerp",()=>t3,"max",()=>tW,"min",()=>tV,"mul",0,tF,"multiply",()=>tF,"negate",()=>tJ,"normalize",()=>t0,"random",()=>t4,"round",()=>tG,"scale",()=>tq,"scaleAndAdd",()=>tH,"set",()=>tj,"sqrDist",0,tY,"sqrLen",0,tK,"squaredDistance",()=>tY,"squaredLength",()=>tK,"str",()=>t7,"sub",0,tz,"subtract",()=>tz,"transformMat4",()=>t6,"transformQuat",()=>t5,"zero",()=>t8],22642);var ii=e.i(22642),ii=ii,ir=e.i(85612);let is=new ir.Log({id:"deck"});(m=C||(C={}))[m.Start=1]="Start",m[m.Move=2]="Move",m[m.End=4]="End",m[m.Cancel=8]="Cancel",(y=M||(M={}))[y.None=0]="None",y[y.Left=1]="Left",y[y.Right=2]="Right",y[y.Up=4]="Up",y[y.Down=8]="Down",y[y.Horizontal=3]="Horizontal",y[y.Vertical=12]="Vertical",y[y.All=15]="All",(v=A||(A={}))[v.Possible=1]="Possible",v[v.Began=2]="Began",v[v.Changed=4]="Changed",v[v.Ended=8]="Ended",v[v.Recognized=8]="Recognized",v[v.Cancelled=16]="Cancelled",v[v.Failed=32]="Failed";let ia="manipulation",io="none",il="pan-x",ic="pan-y";class iu{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){"compute"===e&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(let t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));var t=e.join(" ");if(t.includes(io))return io;let i=t.includes(il),r=t.includes(ic);return i&&r?io:i||r?i?il:ic:t.includes(ia)?ia:"auto"}}function ih(e){return e.trim().split(/\s+/g)}function id(e,t,i){if(e)for(let r of ih(t))e.addEventListener(r,i,!1)}function ip(e,t,i){if(e)for(let r of ih(t))e.removeEventListener(r,i,!1)}function ig(e){return(e.ownerDocument||e).defaultView}function im(e){let t=e.length;if(1===t)return{x:Math.round(e[0].clientX),y:Math.round(e[0].clientY)};let i=0,r=0,s=0;for(;s<t;)i+=e[s].clientX,r+=e[s].clientY,s++;return{x:Math.round(i/t),y:Math.round(r/t)}}function iy(e){let t=[],i=0;for(;i<e.pointers.length;)t[i]={clientX:Math.round(e.pointers[i].clientX),clientY:Math.round(e.pointers[i].clientY)},i++;return{timeStamp:Date.now(),pointers:t,center:im(t),deltaX:e.deltaX,deltaY:e.deltaY}}function iv(e,t){let i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function ix(e,t){let i=t.clientX-e.clientX,r=t.clientY-e.clientY;return Math.sqrt(i*i+r*r)}function i_(e,t){let i=t.clientX-e.clientX;return 180*Math.atan2(t.clientY-e.clientY,i)/Math.PI}function ib(e,t){return e===t?M.None:Math.abs(e)>=Math.abs(t)?e<0?M.Left:M.Right:t<0?M.Up:M.Down}function iw(e,t,i){return{x:t/e||0,y:i/e||0}}class ik{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=e=>{this.manager.options.enable&&this.handler(e)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){var i;let r,s,n,a,o;i=this.manager,r=t.pointers.length,s=t.changedPointers.length,n=e&C.Start&&r-s==0,a=e&(C.End|C.Cancel)&&r-s==0,t.isFirst=!!n,t.isFinal=!!a,n&&(i.session={}),t.eventType=e,o=function(e,t){var i,r;let s,n,a,o,l,{session:c}=e,{pointers:u}=t,{length:h}=u;c.firstInput||(c.firstInput=iy(t)),h>1&&!c.firstMultiple?c.firstMultiple=iy(t):1===h&&(c.firstMultiple=!1);let{firstInput:d,firstMultiple:f}=c,p=f?f.center:d.center,g=t.center=im(u);t.timeStamp=Date.now(),t.deltaTime=t.timeStamp-d.timeStamp,s=g.x-p.x,t.angle=180*Math.atan2(g.y-p.y,s)/Math.PI,t.distance=iv(p,g);let{deltaX:m,deltaY:y}=(n=t.center,a=c.offsetDelta,o=c.prevDelta,l=c.prevInput,(t.eventType===C.Start||l?.eventType===C.End)&&(o=c.prevDelta={x:l?.deltaX||0,y:l?.deltaY||0},a=c.offsetDelta={x:n.x,y:n.y}),{deltaX:o.x+(n.x-a.x),deltaY:o.y+(n.y-a.y)});t.deltaX=m,t.deltaY=y,t.offsetDirection=ib(t.deltaX,t.deltaY);let v=iw(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=v.x,t.overallVelocityY=v.y,t.overallVelocity=Math.abs(v.x)>Math.abs(v.y)?v.x:v.y,t.scale=f?(i=f.pointers,ix(u[0],u[1])/ix(i[0],i[1])):1,t.rotation=f?(r=f.pointers,i_(u[1],u[0])-i_(r[1],r[0])):0,t.maxPointers=c.prevInput?t.pointers.length>c.prevInput.maxPointers?t.pointers.length:c.prevInput.maxPointers:t.pointers.length;let x=e.element;return function(e,t){let i=e;for(;i;){if(i===t)return!0;i=i.parentNode}return!1}(t.srcEvent.target,x)&&(x=t.srcEvent.target),t.target=x,!function(e,t){let i,r,s,n,a=e.lastInterval||t,o=t.timeStamp-a.timeStamp;if(t.eventType!==C.Cancel&&(o>25||void 0===a.velocity)){let l=t.deltaX-a.deltaX,c=t.deltaY-a.deltaY,u=iw(o,l,c);r=u.x,s=u.y,i=Math.abs(u.x)>Math.abs(u.y)?u.x:u.y,n=ib(l,c),e.lastInterval=t}else i=a.velocity,r=a.velocityX,s=a.velocityY,n=a.direction;t.velocity=i,t.velocityX=r,t.velocityY=s,t.direction=n}(c,t),t}(i,t),i.emit("hammer.input",o),i.recognize(o),i.session.prevInput=o}init(){id(this.element,this.evEl,this.domHandler),id(this.target,this.evTarget,this.domHandler),id(ig(this.element),this.evWin,this.domHandler)}destroy(){ip(this.element,this.evEl,this.domHandler),ip(this.target,this.evTarget,this.domHandler),ip(ig(this.element),this.evWin,this.domHandler)}}let iP={pointerdown:C.Start,pointermove:C.Move,pointerup:C.End,pointercancel:C.Cancel,pointerout:C.Cancel};class iS extends ik{constructor(e){super(e),this.evEl="pointerdown",this.evWin="pointermove pointerup pointercancel",this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){let{store:t}=this,i=!1,r=iP[e.type],s=e.pointerType,n="touch"===s,a=t.findIndex(t=>t.pointerId===e.pointerId);r&C.Start&&(e.buttons||n)?a<0&&(t.push(e),a=t.length-1):r&(C.End|C.Cancel)&&(i=!0),!(a<0)&&(t[a]=e,this.callback(r,{pointers:t,changedPointers:[e],eventType:r,pointerType:s,srcEvent:e}),i&&t.splice(a,1))}}let iT=["","webkit","Moz","MS","ms","o"],iC={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class iM{constructor(e,t){this.options={...iC,...t,cssProps:{...iC.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new iS(this),this.touchAction=new iu(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?2:1}recognize(e){let t,{session:i}=this;if(i.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let{recognizers:r}=this,{curRecognizer:s}=i;(!s||s&&s.state&A.Recognized)&&(s=i.curRecognizer=null);let n=0;for(;n<r.length;)t=r[n],2!==i.stopped&&(!s||t===s||t.canRecognizeWith(s))?t.recognize(e):t.reset(),!s&&t.state&(A.Began|A.Changed|A.Ended)&&(s=i.curRecognizer=t),n++}get(e){let{recognizers:t}=this;for(let i=0;i<t.length;i++)if(t[i].options.event===e)return t[i];return null}add(e){if(Array.isArray(e)){for(let t of e)this.add(t);return this}let t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(let t of e)this.remove(t);return this}let t="string"==typeof e?this.get(e):e;if(t){let{recognizers:e}=this,i=e.indexOf(t);-1!==i&&(e.splice(i,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;let{handlers:i}=this;for(let r of ih(e))i[r]=i[r]||[],i[r].push(t)}off(e,t){if(!e)return;let{handlers:i}=this;for(let r of ih(e))t?i[r]&&i[r].splice(i[r].indexOf(t),1):delete i[r]}emit(e,t){let i=this.handlers[e]&&this.handlers[e].slice();if(!i||!i.length)return;t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};let r=0;for(;r<i.length;)i[r](t),r++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){let{element:t}=this;if(t){for(let[i,r]of Object.entries(this.options.cssProps)){let s=function(e,t){let i=t[0].toUpperCase()+t.slice(1);for(let r of iT){let s=r?r+i:t;if(s in e)return s}}(t.style,i);e?(this.oldCssProps[s]=t.style[s],t.style[s]=r):t.style[s]=this.oldCssProps[s]||""}e||(this.oldCssProps={})}}}let iA=1;function iI(e){return e&A.Cancelled?"cancel":e&A.Ended?"end":e&A.Changed?"move":e&A.Began?"start":""}class iE{constructor(e){this.options=e,this.id=iA++,this.state=A.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){let t;if(Array.isArray(e)){for(let t of e)this.recognizeWith(t);return this}if("string"==typeof e){if(!(t=this.manager.get(e)))throw Error(`Cannot find recognizer ${e}`)}else t=e;let{simultaneous:i}=this;return i[t.id]||(i[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){let t;if(Array.isArray(e)){for(let t of e)this.dropRecognizeWith(t);return this}return(t="string"==typeof e?this.manager.get(e):e)&&delete this.simultaneous[t.id],this}requireFailure(e){let t;if(Array.isArray(e)){for(let t of e)this.requireFailure(t);return this}if("string"==typeof e){if(!(t=this.manager.get(e)))throw Error(`Cannot find recognizer ${e}`)}else t=e;let{requireFail:i}=this;return -1===i.indexOf(t)&&(i.push(t),t.requireFailure(this)),this}dropRequireFailure(e){let t;if(Array.isArray(e)){for(let t of e)this.dropRequireFailure(t);return this}if(t="string"==typeof e?this.manager.get(e):e){let e=this.requireFail.indexOf(t);e>-1&&this.requireFail.splice(e,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;let{state:t}=this;t<A.Ended&&this.manager.emit(this.options.event+iI(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=A.Ended&&this.manager.emit(this.options.event+iI(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=A.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(A.Failed|A.Possible)))return!1;e++}return!0}recognize(e){let t={...e};if(!this.options.enable){this.reset(),this.state=A.Failed;return}this.state&(A.Recognized|A.Cancelled|A.Failed)&&(this.state=A.Possible),this.state=this.process(t),this.state&(A.Began|A.Changed|A.Ended|A.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class iL extends iE{attrTest(e){let t=this.options.pointers;return 0===t||e.pointers.length===t}process(e){let{state:t}=this,{eventType:i}=e,r=t&(A.Began|A.Changed),s=this.attrTest(e);return r&&(i&C.Cancel||!s)?t|A.Cancelled:r||s?i&C.End?t|A.Ended:t&A.Began?t|A.Changed:A.Began:A.Failed}}class iO extends iE{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[ia]}process(e){let{options:t}=this,i=e.pointers.length===t.pointers,r=e.distance<t.threshold,s=e.deltaTime<t.time;if(this.reset(),e.eventType&C.Start&&0===this.count)return this.failTimeout();if(r&&s&&i){if(e.eventType!==C.End)return this.failTimeout();let i=!this.pTime||e.timeStamp-this.pTime<t.interval,r=!this.pCenter||iv(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,r&&i?this.count+=1:this.count=1,this._input=e,0==this.count%t.taps)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=A.Recognized,this.tryEmit(this._input)},t.interval),A.Began):A.Recognized}return A.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=A.Failed},this.options.interval),A.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===A.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}let iR=["","start","move","end","cancel","up","down","left","right"];class iN extends iL{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:M.All,...e}),this.pX=null,this.pY=null}getTouchAction(){let{options:{direction:e}}=this,t=[];return e&M.Horizontal&&t.push(ic),e&M.Vertical&&t.push(il),t}getEventNames(){return iR.map(e=>this.options.event+e)}directionTest(e){let{options:t}=this,i=!0,{distance:r}=e,{direction:s}=e,n=e.deltaX,a=e.deltaY;return s&t.direction||(t.direction&M.Horizontal?(s=0===n?M.None:n<0?M.Left:M.Right,i=n!==this.pX,r=Math.abs(e.deltaX)):(s=0===a?M.None:a<0?M.Up:M.Down,i=a!==this.pY,r=Math.abs(e.deltaY))),e.direction=s,i&&r>t.threshold&&!!(s&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&A.Began)||!(this.state&A.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;let t=M[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}let ij=["","start","move","end","cancel","in","out"];class iD{constructor(e,t,i){this.element=e,this.callback=t,this.options=i}}let iz="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"";"undefined"!=typeof window?window:e.g,e.g;let iF=-1!==iz.indexOf("firefox");class iB extends iD{constructor(e,t,i){super(e,t,{enable:!0,...i}),this.handleEvent=e=>{if(!this.options.enable)return;let t=e.deltaY;globalThis.WheelEvent&&(iF&&e.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(t/=globalThis.devicePixelRatio),e.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(t*=40)),0!==t&&t%4.000244140625==0&&(t=Math.floor(t/4.000244140625)),e.shiftKey&&t&&(t*=.25),this.callback({type:"wheel",center:{x:e.clientX,y:e.clientY},delta:-t,srcEvent:e,pointerType:"mouse",target:e.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){"wheel"===e&&(this.options.enable=t)}}let iU=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class i$ extends iD{constructor(e,t,i){super(e,t,{enable:!0,...i}),this.handleEvent=e=>{this.handleOverEvent(e),this.handleOutEvent(e),this.handleEnterEvent(e),this.handleLeaveEvent(e),this.handleMoveEvent(e)},this.pressed=!1;const{enable:r}=this.options;this.enableMoveEvent=r,this.enableLeaveEvent=r,this.enableEnterEvent=r,this.enableOutEvent=r,this.enableOverEvent=r,iU.forEach(t=>e.addEventListener(t,this.handleEvent))}destroy(){iU.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t}}handleOverEvent(e){this.enableOverEvent&&"mouseover"===e.type&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&"mouseout"===e.type&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&"mouseenter"===e.type&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&"mouseleave"===e.type&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":0===e.buttons&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}let iV=["keydown","keyup"];class iW extends iD{constructor(e,t,i){super(e,t,{enable:!0,tabIndex:0,...i}),this.handleEvent=e=>{let t=e.target||e.srcElement;("INPUT"!==t.tagName||"text"!==t.type)&&"TEXTAREA"!==t.tagName&&(this.enableDownEvent&&"keydown"===e.type&&this.callback({type:"keydown",srcEvent:e,key:e.key,target:e.target}),this.enableUpEvent&&"keyup"===e.type&&this.callback({type:"keyup",srcEvent:e,key:e.key,target:e.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",iV.forEach(t=>e.addEventListener(t,this.handleEvent))}destroy(){iV.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){"keydown"===e&&(this.enableDownEvent=t),"keyup"===e&&(this.enableUpEvent=t)}}class iG extends iD{constructor(e,t,i){super(e,t,i),this.handleEvent=e=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){"contextmenu"===e&&(this.options.enable=t)}}let iq={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4},iH={srcElement:"root",priority:0};class iZ{constructor(e,t){this.handleEvent=e=>{if(this.isEmpty())return;let t=this._normalizeEvent(e),i=e.srcEvent.target;for(;i&&i!==t.rootElement;){if(this._emit(t,i),t.handled)return;i=i.parentNode}this._emit(t,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,r=!1,s=!1){let{handlers:n,handlersByElement:a}=this,o={...iH,...i},l=a.get(o.srcElement);l||(l=[],a.set(o.srcElement,l));let c={type:e,handler:t,srcElement:o.srcElement,priority:o.priority};r&&(c.once=!0),s&&(c.passive=!0),n.push(c),this._active=this._active||!c.passive;let u=l.length-1;for(;u>=0&&!(l[u].priority>=c.priority);)u--;l.splice(u+1,0,c)}remove(e,t){let{handlers:i,handlersByElement:r}=this;for(let s=i.length-1;s>=0;s--){let n=i[s];if(n.type===e&&n.handler===t){i.splice(s,1);let e=r.get(n.srcElement);e.splice(e.indexOf(n),1),0===e.length&&r.delete(n.srcElement)}}this._active=i.some(e=>!e.passive)}_emit(e,t){let i=this.handlersByElement.get(t);if(i){let t=!1,r=()=>{e.handled=!0},s=()=>{e.handled=!0,t=!0},n=[];for(let a=0;a<i.length;a++){let{type:o,handler:l,once:c}=i[a];if(l({...e,type:o,stopPropagation:r,stopImmediatePropagation:s}),c&&n.push(i[a]),t)break}for(let e=0;e<n.length;e++){let{type:t,handler:i}=n[e];this.remove(t,i)}}}_normalizeEvent(e){let t=this.eventManager.getElement();return{...e,...function(e){let t=iq[e.srcEvent.type];if(!t)return null;let{buttons:i,button:r}=e.srcEvent,s=!1,n=!1,a=!1;return 2===t?(s=!!(1&i),n=!!(4&i),a=!!(2&i)):(s=0===r,n=1===r,a=2===r),{leftButton:s,middleButton:n,rightButton:a}}(e),...function(e,t){let i=e.center;if(!i)return null;let r=t.getBoundingClientRect(),s=r.width/t.offsetWidth||1,n=r.height/t.offsetHeight||1,a={x:(i.x-r.left-t.clientLeft)/s,y:(i.y-r.top-t.clientTop)/n};return{center:i,offsetCenter:a}}(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}class iY{constructor(e=null,t={}){if(this._onBasicInput=e=>{this.manager.emit(e.srcEvent.type,e)},this._onOtherEvent=e=>{this.manager.emit(e.type,e)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!e)return;for(const t of(this.manager=new iM(e,this.options),this.options.recognizers)){const{recognizer:e,recognizeWith:i,requireFailure:r}=function(e){let t;if("recognizer"in e)return e;let i=Array.isArray(e)?[...e]:[e];return{recognizer:t="function"==typeof i[0]?new(i.shift())(i.shift()||{}):i.shift(),recognizeWith:"string"==typeof i[0]?[i[0]]:i[0],requireFailure:"string"==typeof i[1]?[i[1]]:i[1]}}(t);this.manager.add(e),i&&e.recognizeWith(i),r&&e.requireFailure(r)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new iB(e,this._onOtherEvent,{enable:!1}),this.moveInput=new i$(e,this._onOtherEvent,{enable:!1}),this.keyInput=new iW(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new iG(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){let{manager:i}=this;if(!i)return;let r=i.get(e);r&&(r.set({enable:t}),i.touchAction.update()),this.wheelInput?.enableEventType(e,t),this.moveInput?.enableEventType(e,t),this.keyInput?.enableEventType(e,t),this.contextmenuInput?.enableEventType(e,t)}_addEventHandler(e,t,i,r,s){if("string"!=typeof e){for(let[n,a]of(i=t,Object.entries(e)))this._addEventHandler(n,a,i,r,s);return}let{manager:n,events:a}=this;if(!n)return;let o=a.get(e);!o&&(o=new iZ(this,this._getRecognizerName(e)||e),a.set(e,o),n&&n.on(e,o.handleEvent)),o.add(e,t,i,r,s),o.isEmpty()||this._toggleRecognizer(o.recognizerName,!0)}_removeEventHandler(e,t){if("string"!=typeof e){for(let[t,i]of Object.entries(e))this._removeEventHandler(t,i);return}let{events:i}=this,r=i.get(e);if(r&&(r.remove(e,t),r.isEmpty())){let{recognizerName:e}=r,t=!1;for(let r of i.values())if(r.recognizerName===e&&!r.isEmpty()){t=!0;break}t||this._toggleRecognizer(e,!1)}}_getRecognizerName(e){return this.manager.recognizers.find(t=>t.getEventNames().includes(e))?.options.event}}let iX={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(iX,"IDENTITY",{get:()=>(is.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});let iK={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},iJ={common:0,meters:1,pixels:2},iQ={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},i0={multipan:[iN,{threshold:10,direction:M.Vertical,pointers:2}],pinch:[class extends iL{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[io]}getEventNames(){return ij.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&A.Began))}emit(e){if(1!==e.scale){let t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}},{},null,["multipan"]],pan:[iN,{threshold:1},["pinch"],["multipan"]],dblclick:[iO,{event:"dblclick",taps:2}],click:[iO,{event:"click"},null,["dblclick"]]};function i1(e){let t,i={};return r=>{for(let s in r)if(!function(e,t){if(e===t)return!0;if(Array.isArray(e)){let i=e.length;if(!t||t.length!==i)return!1;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0}return!1}(r[s],i[s])){t=e(r),i=r;break}return t}}let i2=[0,0,0,0],i3=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],i4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],i6=[0,0,0],i5=[0,0,0],i8=i1(function({viewport:e,devicePixelRatio:t,coordinateSystem:i,coordinateOrigin:r}){let{projectionCenter:s,viewProjectionMatrix:n,originCommon:a,cameraPosCommon:o,shaderCoordinateOrigin:l,geospatialOrigin:c}=function(e,t,i){let{viewMatrixUncentered:r,projectionMatrix:s}=e,{viewMatrix:n,viewProjectionMatrix:a}=e,o=i2,l=i2,c=e.cameraPosition,{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:d}=i7(e,t,i);return d&&(l=e.projectPosition(u||h),c=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],l[3]=1,o=ii.transformMat4([],l,a),n=r||n,a=tE.multiply([],s,n),a=tE.multiply([],a,i3)),{viewMatrix:n,viewProjectionMatrix:a,projectionCenter:o,originCommon:l,cameraPosCommon:c,shaderCoordinateOrigin:h,geospatialOrigin:u}}(e,i,r),u=e.getDistanceScales(),h=[e.width*t,e.height*t],d=ii.transformMat4([],[0,0,-e.focalDistance,1],e.projectionMatrix)[3]||1,f={coordinateSystem:i,projectionMode:e.projectionMode,coordinateOrigin:l,commonOrigin:a.slice(0,3),center:s,pseudoMeters:!!e._pseudoMeters,viewportSize:h,devicePixelRatio:t,focalDistance:d,commonUnitsPerMeter:u.unitsPerMeter,commonUnitsPerWorldUnit:u.unitsPerMeter,commonUnitsPerWorldUnit2:i6,scale:e.scale,wrapLongitude:!1,viewProjectionMatrix:n,modelMatrix:i4,cameraPosition:o};if(c){let t=e.getDistanceScales(c);switch(i){case iX.METER_OFFSETS:f.commonUnitsPerWorldUnit=t.unitsPerMeter,f.commonUnitsPerWorldUnit2=t.unitsPerMeter2;break;case iX.LNGLAT:case iX.LNGLAT_OFFSETS:e._pseudoMeters||(f.commonUnitsPerMeter=t.unitsPerMeter),f.commonUnitsPerWorldUnit=t.unitsPerDegree,f.commonUnitsPerWorldUnit2=t.unitsPerDegree2;break;case iX.CARTESIAN:f.commonUnitsPerWorldUnit=[1,1,t.unitsPerMeter[2]],f.commonUnitsPerWorldUnit2=[0,0,t.unitsPerMeter2[2]]}}return f});function i7(e,t,i=i5){let r;i.length<3&&(i=[i[0],i[1],0]);let s=i,n=!0;switch(r=t===iX.LNGLAT_OFFSETS||t===iX.METER_OFFSETS?i:e.isGeospatial?[Math.fround(e.longitude),Math.fround(e.latitude),0]:null,e.projectionMode){case iK.WEB_MERCATOR:(t===iX.LNGLAT||t===iX.CARTESIAN)&&(r=[0,0,0],n=!1);break;case iK.WEB_MERCATOR_AUTO_OFFSET:t===iX.LNGLAT?s=r:t===iX.CARTESIAN&&(s=[Math.fround(e.center[0]),Math.fround(e.center[1]),0],r=e.unprojectPosition(s),s[0]-=i[0],s[1]-=i[1],s[2]-=i[2]);break;case iK.IDENTITY:(s=e.position.map(Math.fround))[2]=s[2]||0;break;case iK.GLOBE:n=!1,r=null;break;default:n=!1}return{geospatialOrigin:r,shaderCoordinateOrigin:s,offsetMode:n}}let i9=Object.keys(iX).map(e=>`const COORDINATE_SYSTEM_${e}: i32 = ${iX[e]};`).join(""),re=Object.keys(iK).map(e=>`const PROJECTION_MODE_${e}: i32 = ${iK[e]};`).join(""),rt=Object.keys(iJ).map(e=>`const UNIT_${e.toUpperCase()}: i32 = ${iJ[e]};`).join(""),ri=`\
${i9}
${re}
${rt}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,rr=`\
${ri}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the zaxis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,rs=Object.keys(iX).map(e=>`const int COORDINATE_SYSTEM_${e} = ${iX[e]};`).join(""),rn=Object.keys(iK).map(e=>`const int PROJECTION_MODE_${e} = ${iK[e]};`).join(""),ra=Object.keys(iJ).map(e=>`const int UNIT_${e.toUpperCase()} = ${iJ[e]};`).join(""),ro={},rl={name:"project",dependencies:[{name:"fp32",vs:eV},e$],source:rr,vs:`\
${rs}
${rn}
${ra}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,getUniforms:function(e=ro){return"viewport"in e?function({viewport:e,devicePixelRatio:t=1,modelMatrix:i=null,coordinateSystem:r=iX.DEFAULT,coordinateOrigin:s=i5,autoWrapLongitude:n=!1}){r===iX.DEFAULT&&(r=e.isGeospatial?iX.LNGLAT:iX.CARTESIAN);let a=i8({viewport:e,devicePixelRatio:t,coordinateSystem:r,coordinateOrigin:s});return a.wrapLongitude=n,a.modelMatrix=i||i4,a}(e):{}},uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},rc={name:"project32",dependencies:[rl],source:`\
// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,vs:`\
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`};globalThis.mathgl=globalThis.mathgl||{config:{EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1}};let ru=globalThis.mathgl.config;function rh(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}function rd(e,t,i){return function(e,t,i){if(rh(e)){i=i||(e.clone?e.clone():Array(e.length));for(let r=0;r<i.length&&r<e.length;++r){let s="number"==typeof e?e:e[r];i[r]=t(s,r,i)}return i}return t(e)}(e,e=>Math.max(t,Math.min(i,e)))}function rf(e,t,i){return rh(e)?e.map((e,r)=>rf(e,t[r],i)):i*t+(1-i)*e}function rp(e,t,i){let r=ru.EPSILON;i&&(ru.EPSILON=i);try{if(e===t)return!0;if(rh(e)&&rh(t)){if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(!rp(e[i],t[i]))return!1;return!0}if(e&&e.equals)return e.equals(t);if(t&&t.equals)return t.equals(e);if("number"==typeof e&&"number"==typeof t)return Math.abs(e-t)<=ru.EPSILON*Math.max(1,Math.abs(e),Math.abs(t));return!1}finally{ru.EPSILON=r}}class rg extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:rh(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ru)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+function(e,{precision:t=ru.precision}={}){return e=Math.round(e/ru.EPSILON)*ru.EPSILON,`${parseFloat(e.toPrecision(t))}`}(this[i],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!rp(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(void 0===i)return this.lerp(this,e,t);for(let r=0;r<this.ELEMENTS;++r){let s=e[r],n="number"==typeof t?t:t[r];this[r]=s+i*(n-s)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]+=t[e];return this.check()}subtract(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]-=t[e];return this.check()}scale(e){if("number"==typeof e)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(ru.debug&&!this.validate())throw Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}}function rm(e){if(!Number.isFinite(e))throw Error(`Invalid number ${JSON.stringify(e)}`);return e}function ry(e,t,i=""){if(ru.debug&&!function(e,t){if(e.length!==t)return!1;for(let t=0;t<e.length;++t)if(!Number.isFinite(e[t]))return!1;return!0}(e,t))throw Error(`math.gl: ${i} some fields set to invalid numbers'`);return e}function rv(e,t){if(!e)throw Error(`math.gl assertion ${t}`)}class rx extends rg{get x(){return this[0]}set x(e){this[0]=rm(e)}get y(){return this[1]}set y(e){this[1]=rm(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){let r=this[i]-e[i];t+=r*r}return rm(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return rm(t)}normalize(){let e=this.magnitude();if(0!==e)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]*=t[e];return this.check()}divide(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t[e];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return rv(e>=0&&e<this.ELEMENTS,"index is out of range"),rm(this[e])}setComponent(e,t){return rv(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}function r_(){let e=new eW(3);return eW!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function rb(e){let t=new eW(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function rw(e){let t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)}function rk(e,t,i){let r=new eW(3);return r[0]=e,r[1]=t,r[2]=i,r}function rP(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function rS(e,t,i,r){return e[0]=t,e[1]=i,e[2]=r,e}function rT(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function rC(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function rM(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function rA(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e}function rI(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function rE(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function rL(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e}function rO(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e}function rR(e,t){return e[0]=eq(t[0]),e[1]=eq(t[1]),e[2]=eq(t[2]),e}function rN(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function rj(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e}function rD(e,t){let i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(i*i+r*r+s*s)}function rz(e,t){let i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function rF(e){let t=e[0],i=e[1],r=e[2];return t*t+i*i+r*r}function rB(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function rU(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function r$(e,t){let i=t[0],r=t[1],s=t[2],n=i*i+r*r+s*s;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function rV(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function rW(e,t,i){let r=t[0],s=t[1],n=t[2],a=i[0],o=i[1],l=i[2];return e[0]=s*l-n*o,e[1]=n*a-r*l,e[2]=r*o-s*a,e}function rG(e,t,i,r){let s=t[0],n=t[1],a=t[2];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=a+r*(i[2]-a),e}function rq(e,t,i,r){let s=Math.acos(Math.min(Math.max(rV(t,i),-1),1)),n=Math.sin(s),a=Math.sin((1-r)*s)/n,o=Math.sin(r*s)/n;return e[0]=a*t[0]+o*i[0],e[1]=a*t[1]+o*i[1],e[2]=a*t[2]+o*i[2],e}function rH(e,t,i,r,s,n){let a=n*n,o=a*(2*n-3)+1,l=a*(n-2)+n,c=a*(n-1),u=a*(3-2*n);return e[0]=t[0]*o+i[0]*l+r[0]*c+s[0]*u,e[1]=t[1]*o+i[1]*l+r[1]*c+s[1]*u,e[2]=t[2]*o+i[2]*l+r[2]*c+s[2]*u,e}function rZ(e,t,i,r,s,n){let a=1-n,o=a*a,l=n*n,c=o*a,u=3*n*o,h=3*l*a,d=l*n;return e[0]=t[0]*c+i[0]*u+r[0]*h+s[0]*d,e[1]=t[1]*c+i[1]*u+r[1]*h+s[1]*d,e[2]=t[2]*c+i[2]*u+r[2]*h+s[2]*d,e}function rY(e,t){t=void 0===t?1:t;let i=2*eG()*Math.PI,r=2*eG()-1,s=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(i)*s,e[1]=Math.sin(i)*s,e[2]=r*t,e}function rX(e,t,i){let r=t[0],s=t[1],n=t[2],a=i[3]*r+i[7]*s+i[11]*n+i[15];return a=a||1,e[0]=(i[0]*r+i[4]*s+i[8]*n+i[12])/a,e[1]=(i[1]*r+i[5]*s+i[9]*n+i[13])/a,e[2]=(i[2]*r+i[6]*s+i[10]*n+i[14])/a,e}function rK(e,t,i){let r=t[0],s=t[1],n=t[2];return e[0]=r*i[0]+s*i[3]+n*i[6],e[1]=r*i[1]+s*i[4]+n*i[7],e[2]=r*i[2]+s*i[5]+n*i[8],e}function rJ(e,t,i){let r=i[0],s=i[1],n=i[2],a=i[3],o=t[0],l=t[1],c=t[2],u=s*c-n*l,h=n*o-r*c,d=r*l-s*o,f=s*d-n*h,p=n*u-r*d,g=r*h-s*u,m=2*a;return u*=m,h*=m,d*=m,f*=2,p*=2,g*=2,e[0]=o+u+f,e[1]=l+h+p,e[2]=c+d+g,e}function rQ(e,t,i,r){let s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0],n[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),n[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function r0(e,t,i,r){let s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),n[1]=s[1],n[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function r1(e,t,i,r){let s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),n[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),n[2]=s[2],e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function r2(e,t){let i=e[0],r=e[1],s=e[2],n=t[0],a=t[1],o=t[2],l=Math.sqrt((i*i+r*r+s*s)*(n*n+a*a+o*o));return Math.acos(Math.min(Math.max(l&&rV(e,t)/l,-1),1))}function r3(e){return e[0]=0,e[1]=0,e[2]=0,e}function r4(e){return`vec3(${e[0]}, ${e[1]}, ${e[2]})`}function r6(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function r5(e,t){let i=e[0],r=e[1],s=e[2],n=t[0],a=t[1],o=t[2];return Math.abs(i-n)<=1e-6*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-a)<=1e-6*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-o)<=1e-6*Math.max(1,Math.abs(s),Math.abs(o))}let r8=(l=r_(),function(e,t,i,r,s,n){let a,o;for(t||(t=3),i||(i=0),o=r?Math.min(r*t+i,e.length):e.length,a=i;a<o;a+=t)l[0]=e[a],l[1]=e[a+1],l[2]=e[a+2],s(l,l,n),e[a]=l[0],e[a+1]=l[1],e[a+2]=l[2];return e});function r7(e,t,i){let r=t[0],s=t[1],n=t[2],a=i[3]*r+i[7]*s+i[11]*n||1;return e[0]=(i[0]*r+i[4]*s+i[8]*n)/a,e[1]=(i[1]*r+i[5]*s+i[9]*n)/a,e[2]=(i[2]*r+i[6]*s+i[10]*n)/a,e}function r9(e,t,i){let r=t[0],s=t[1],n=t[2];return e[0]=i[0]*r+i[3]*s+i[6]*n,e[1]=i[1]*r+i[4]*s+i[7]*n,e[2]=i[2]*r+i[5]*s+i[8]*n,e[3]=t[3],e}e.s(["add",()=>rT,"angle",()=>r2,"bezier",()=>rZ,"ceil",()=>rI,"clone",()=>rb,"copy",()=>rP,"create",()=>r_,"cross",()=>rW,"dist",0,rD,"distance",()=>rD,"div",0,rA,"divide",()=>rA,"dot",()=>rV,"equals",()=>r5,"exactEquals",()=>r6,"floor",()=>rE,"forEach",0,r8,"fromValues",()=>rk,"hermite",()=>rH,"inverse",()=>rU,"len",0,rw,"length",()=>rw,"lerp",()=>rG,"max",()=>rO,"min",()=>rL,"mul",0,rM,"multiply",()=>rM,"negate",()=>rB,"normalize",()=>r$,"random",()=>rY,"rotateX",()=>rQ,"rotateY",()=>r0,"rotateZ",()=>r1,"round",()=>rR,"scale",()=>rN,"scaleAndAdd",()=>rj,"set",()=>rS,"slerp",()=>rq,"sqrDist",0,rz,"sqrLen",0,rF,"squaredDistance",()=>rz,"squaredLength",()=>rF,"str",()=>r4,"sub",0,rC,"subtract",()=>rC,"transformMat3",()=>rK,"transformMat4",()=>rX,"transformQuat",()=>rJ,"zero",()=>r3],93311);let se=[0,0,0];class st extends rx{static get ZERO(){return t||Object.freeze(t=new st(0,0,0)),t}constructor(e=0,t=0,i=0){super(-0,-0,-0),1==arguments.length&&rh(e)?this.copy(e):(ru.debug&&(rm(e),rm(t),rm(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return ru.debug&&(rm(e.x),rm(e.y),rm(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=rm(e)}angle(e){return r2(this,e)}cross(e){return rW(this,this,e),this.check()}rotateX({radians:e,origin:t=se}){return rQ(this,this,t,e),this.check()}rotateY({radians:e,origin:t=se}){return r0(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=se}){return r1(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return rX(this,this,e),this.check()}transformAsVector(e){return r7(this,this,e),this.check()}transformByMatrix3(e){return rK(this,this,e),this.check()}transformByMatrix2(e){let t,i;return t=this[0],i=this[1],this[0]=e[0]*t+e[2]*i,this[1]=e[1]*t+e[3]*i,this[2]=this[2],this.check()}transformByQuaternion(e){return rJ(this,this,e),this.check()}}class si extends rg{toString(){let e="[";if(ru.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=` ${this[i*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+"]"}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=rm(i),this}getColumn(e,t=Array(this.RANK).fill(-0)){let i=e*this.RANK;for(let e=0;e<this.RANK;++e)t[e]=this[i+e];return t}setColumn(e,t){let i=e*this.RANK;for(let e=0;e<this.RANK;++e)this[i+e]=t[e];return this}}function sr(){let e=new eW(2);return eW!=Float32Array&&(e[0]=0,e[1]=0),e}function ss(e){let t=new eW(2);return t[0]=e[0],t[1]=e[1],t}function sn(e,t){let i=new eW(2);return i[0]=e,i[1]=t,i}function sa(e,t){return e[0]=t[0],e[1]=t[1],e}function so(e,t,i){return e[0]=t,e[1]=i,e}function sl(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function sc(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function su(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function sh(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function sd(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function sf(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function sp(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e}function sg(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e}function sm(e,t){return e[0]=eq(t[0]),e[1]=eq(t[1]),e}function sy(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function sv(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e}function sx(e,t){let i=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(i*i+r*r)}function s_(e,t){let i=t[0]-e[0],r=t[1]-e[1];return i*i+r*r}function sb(e){let t=e[0],i=e[1];return Math.sqrt(t*t+i*i)}function sw(e){let t=e[0],i=e[1];return t*t+i*i}function sk(e,t){return e[0]=-t[0],e[1]=-t[1],e}function sP(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function sS(e,t){let i=t[0],r=t[1],s=i*i+r*r;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e}function sT(e,t){return e[0]*t[0]+e[1]*t[1]}function sC(e,t,i){let r=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=r,e}function sM(e,t,i,r){let s=t[0],n=t[1];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e}function sA(e,t){t=void 0===t?1:t;let i=2*eG()*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e}function sI(e,t,i){let r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s,e[1]=i[1]*r+i[3]*s,e}function sE(e,t,i){let r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s+i[4],e[1]=i[1]*r+i[3]*s+i[5],e}function sL(e,t,i){let r=t[0],s=t[1];return e[0]=i[0]*r+i[3]*s+i[6],e[1]=i[1]*r+i[4]*s+i[7],e}function sO(e,t,i){let r=t[0],s=t[1];return e[0]=i[0]*r+i[4]*s+i[12],e[1]=i[1]*r+i[5]*s+i[13],e}function sR(e,t,i,r){let s=t[0]-i[0],n=t[1]-i[1],a=Math.sin(r),o=Math.cos(r);return e[0]=s*o-n*a+i[0],e[1]=s*a+n*o+i[1],e}function sN(e,t){let i=e[0],r=e[1],s=t[0],n=t[1],a=Math.sqrt((i*i+r*r)*(s*s+n*n));return Math.acos(Math.min(Math.max(a&&(i*s+r*n)/a,-1),1))}function sj(e){return e[0]=0,e[1]=0,e}function sD(e){return`vec2(${e[0]}, ${e[1]})`}function sz(e,t){return e[0]===t[0]&&e[1]===t[1]}function sF(e,t){let i=e[0],r=e[1],s=t[0],n=t[1];return Math.abs(i-s)<=1e-6*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-n)<=1e-6*Math.max(1,Math.abs(r),Math.abs(n))}let sB=(c=sr(),function(e,t,i,r,s,n){let a,o;for(t||(t=2),i||(i=0),o=r?Math.min(r*t+i,e.length):e.length,a=i;a<o;a+=t)c[0]=e[a],c[1]=e[a+1],s(c,c,n),e[a]=c[0],e[a+1]=c[1];return e});e.s(["add",()=>sl,"angle",()=>sN,"ceil",()=>sd,"clone",()=>ss,"copy",()=>sa,"create",()=>sr,"cross",()=>sC,"dist",0,sx,"distance",()=>sx,"div",0,sh,"divide",()=>sh,"dot",()=>sT,"equals",()=>sF,"exactEquals",()=>sz,"floor",()=>sf,"forEach",0,sB,"fromValues",()=>sn,"inverse",()=>sP,"len",0,sb,"length",()=>sb,"lerp",()=>sM,"max",()=>sg,"min",()=>sp,"mul",0,su,"multiply",()=>su,"negate",()=>sk,"normalize",()=>sS,"random",()=>sA,"rotate",()=>sR,"round",()=>sm,"scale",()=>sy,"scaleAndAdd",()=>sv,"set",()=>so,"sqrDist",0,s_,"sqrLen",0,sw,"squaredDistance",()=>s_,"squaredLength",()=>sw,"str",()=>sD,"sub",0,sc,"subtract",()=>sc,"transformMat2",()=>sI,"transformMat2d",()=>sE,"transformMat3",()=>sL,"transformMat4",()=>sO,"zero",()=>sj],60113),(x=I||(I={}))[x.COL0ROW0=0]="COL0ROW0",x[x.COL0ROW1=1]="COL0ROW1",x[x.COL0ROW2=2]="COL0ROW2",x[x.COL0ROW3=3]="COL0ROW3",x[x.COL1ROW0=4]="COL1ROW0",x[x.COL1ROW1=5]="COL1ROW1",x[x.COL1ROW2=6]="COL1ROW2",x[x.COL1ROW3=7]="COL1ROW3",x[x.COL2ROW0=8]="COL2ROW0",x[x.COL2ROW1=9]="COL2ROW1",x[x.COL2ROW2=10]="COL2ROW2",x[x.COL2ROW3=11]="COL2ROW3",x[x.COL3ROW0=12]="COL3ROW0",x[x.COL3ROW1=13]="COL3ROW1",x[x.COL3ROW2=14]="COL3ROW2",x[x.COL3ROW3=15]="COL3ROW3";let sU=45*Math.PI/180,s$=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class sV extends si{static get IDENTITY(){return r||Object.freeze(r=new sV),r}static get ZERO(){return i||Object.freeze(i=new sV([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),i}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return I}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1==arguments.length&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,r,s,n,a,o,l,c,u,h,d,f,p,g){return this[0]=e,this[1]=t,this[2]=i,this[3]=r,this[4]=s,this[5]=n,this[6]=a,this[7]=o,this[8]=l,this[9]=c,this[10]=u,this[11]=h,this[12]=d,this[13]=f,this[14]=p,this[15]=g,this.check()}setRowMajor(e,t,i,r,s,n,a,o,l,c,u,h,d,f,p,g){return this[0]=e,this[1]=s,this[2]=l,this[3]=d,this[4]=t,this[5]=n,this[6]=c,this[7]=f,this[8]=i,this[9]=a,this[10]=u,this[11]=p,this[12]=r,this[13]=o,this[14]=h,this[15]=g,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(s$)}fromObject(e){return this.check()}fromQuaternion(e){return tp(this,e),this.check()}frustum(e){var t,i,r,s,n,a;let{left:o,right:l,bottom:c,top:u,near:h=.1,far:d=500}=e;return d===1/0?(t=this,i=o,r=l,s=c,n=u,a=h,t[0]=2*a/(r-i),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*a/(n-s),t[6]=0,t[7]=0,t[8]=(r+i)/(r-i),t[9]=(n+s)/(n-s),t[10]=-1,t[11]=-1,t[12]=0,t[13]=0,t[14]=-2*a,t[15]=0):tg(this,o,l,c,u,h,d),this.check()}lookAt(e){let{eye:t,center:i=[0,0,0],up:r=[0,1,0]}=e;return tb(this,t,i,r),this.check()}ortho(e){let{left:t,right:i,bottom:r,top:s,near:n=.1,far:a=500}=e;return tx(this,t,i,r,s,n,a),this.check()}orthographic(e){let{fovy:t=sU,aspect:i=1,focalDistance:r=1,near:s=.1,far:n=500}=e;sW(t);let a=r*Math.tan(t/2),o=a*i;return this.ortho({left:-o,right:o,bottom:-a,top:a,near:s,far:n})}perspective(e){let{fovy:t=45*Math.PI/180,aspect:i=1,near:r=.1,far:s=500}=e;return sW(t),tm(this,t,i,r,s),this.check()}determinant(){return e2(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),r=1/i[0],s=1/i[1],n=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*s,e[2]=this[2]*n,e[3]=0,e[4]=this[4]*r,e[5]=this[5]*s,e[6]=this[6]*n,e[7]=0,e[8]=this[8]*r,e[9]=this[9]*s,e[10]=this[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),r=1/i[0],s=1/i[1],n=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*s,e[2]=this[2]*n,e[3]=this[4]*r,e[4]=this[5]*s,e[5]=this[6]*n,e[6]=this[8]*r,e[7]=this[9]*s,e[8]=this[10]*n,e}transpose(){return eQ(this,this),this.check()}invert(){return e0(this,this),this.check()}multiplyLeft(e){return e3(this,e,this),this.check()}multiplyRight(e){return e3(this,this,e),this.check()}rotateX(e){return e8(this,this,e),this.check()}rotateY(e){return e7(this,this,e),this.check()}rotateZ(e){return e9(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return e5(this,this,e,t),this.check()}scale(e){return e6(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return e4(this,this,e),this.check()}transform(e,t){return 4===e.length?(ry(t=t6(t||[-0,-0,-0,-0],e,this),4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let i,{length:r}=e;switch(r){case 2:i=sO(t||[-0,-0],e,this);break;case 3:i=rX(t||[-0,-0,-0],e,this);break;default:throw Error("Illegal vector")}return ry(i,e.length),i}transformAsVector(e,t){let i;switch(e.length){case 2:var r;let s,n,a;r=t||[-0,-0],s=e[0],n=e[1],a=this[3]*s+this[7]*n||1,r[0]=(this[0]*s+this[4]*n)/a,r[1]=(this[1]*s+this[5]*n)/a,i=r;break;case 3:i=r7(t||[-0,-0,-0],e,this);break;default:throw Error("Illegal vector")}return ry(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}}function sW(e){if(e>2*Math.PI)throw Error("expected radians")}var ii=ii;function sG(e,t){let i=ii.transformMat4([],t,e);return ii.scale(i,i,1/i[3]),i}function sq(e,t){let i=e%t;return i<0?t+i:i}function sH(e,t,i){return e<t?t:e>i?i:e}let sZ=Math.log2||function(e){return Math.log(e)*Math.LOG2E};var tE=tE,sY=e.i(60113),sY=sY,sX=e.i(93311),sX=sX;function sK(e,t){if(!e)throw Error(t||"@math.gl/web-mercator: assertion failed.")}let sJ=Math.PI,sQ=sJ/4,s0=sJ/180,s1=180/sJ;function s2(e){let[t,i]=e;sK(Number.isFinite(t)),sK(Number.isFinite(i)&&i>=-90&&i<=90,"invalid latitude");let r=512*(sJ+Math.log(Math.tan(sQ+i*s0*.5)))/(2*sJ);return[512*(t*s0+sJ)/(2*sJ),r]}function s3(e){let[t,i]=e,r=2*(Math.atan(Math.exp(i/512*(2*sJ)-sJ))-sQ);return[(t/512*(2*sJ)-sJ)*s1,r*s1]}function s4(e){return 512/4003e4/Math.cos(e*s0)}function s6(e){let{latitude:t,longitude:i,highPrecision:r=!1}=e;sK(Number.isFinite(t)&&Number.isFinite(i));let s=Math.cos(t*s0),n=512/360/s,a=512/4003e4/s,o={unitsPerMeter:[a,a,a],metersPerUnit:[1/a,1/a,1/a],unitsPerDegree:[512/360,n,a],degreesPerUnit:[1/(512/360),1/n,1/a]};if(r){let e=s0*Math.tan(t*s0)/s,i=512/4003e4*e,r=i/n*a;o.unitsPerDegree2=[0,512/360*e/2,i],o.unitsPerMeter2=[r,0,r]}return o}function s5(e,t){let[i,r,s]=e,[n,a,o]=t,{unitsPerMeter:l,unitsPerMeter2:c}=s6({longitude:i,latitude:r,highPrecision:!0}),u=s2(e);u[0]+=n*(l[0]+c[0]*a),u[1]+=a*(l[1]+c[1]*a);let h=s3(u);return Number.isFinite(s)||Number.isFinite(o)?[h[0],h[1],(s||0)+(o||0)]:h}function s8(e){return 2*Math.atan(.5/e)*s1}function s7(e){return .5/Math.tan(.5*e*s0)}function s9(e,t){let[i,r,s=0]=e;return sK(Number.isFinite(i)&&Number.isFinite(r)&&Number.isFinite(s)),sG(t,[i,r,s,1])}function ne(e,t,i=0){let[r,s,n]=e;if(sK(Number.isFinite(r)&&Number.isFinite(s),"invalid pixel coordinate"),Number.isFinite(n))return sG(t,[r,s,n,1]);let a=sG(t,[r,s,0,1]),o=sG(t,[r,s,1,1]),l=a[2],c=o[2];return sY.lerp([],a,o,l===c?0:((i||0)-l)/(c-l))}var sY=sY;let nt=Math.PI/180;function ni(e,t,i){let{pixelUnprojectionMatrix:r}=e,s=sG(r,[t,0,1,1]),n=sG(r,[t,e.height,1,1]),a=(i*e.distanceScales.unitsPerMeter[2]-s[2])/(n[2]-s[2]),o=s3(sY.lerp([],s,n,a));return o.push(i),o}var tE=tE,sY=sY,sX=sX,sY=sY;let nr=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,ns=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,nn=`
${nr}
${ns}
`,na=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,no=`
${nr}
${na}
`,nl=i1(function({viewport:e,center:t}){return new sV(e.viewProjectionMatrix).invert().transform(t)}),nc=i1(function({viewport:e,shadowMatrices:t}){let i=[],r=e.pixelUnprojectionMatrix,s=e.isGeospatial?void 0:1,n=[[0,0,s],[e.width,0,s],[0,e.height,s],[e.width,e.height,s],[0,0,-1],[e.width,0,-1],[0,e.height,-1],[e.width,e.height,-1]].map(e=>(function(e,t){let[i,r,s]=e,n=ne([i,r,s],t);return Number.isFinite(s)?n:[n[0],n[1],0]})(e,r));for(let r of t){let t=r.clone().translate(new st(e.center).negate()),s=n.map(e=>t.transform(e)),a=new sV().ortho({left:Math.min(...s.map(e=>e[0])),right:Math.max(...s.map(e=>e[0])),bottom:Math.min(...s.map(e=>e[1])),top:Math.max(...s.map(e=>e[1])),near:Math.min(...s.map(e=>-e[2])),far:Math.max(...s.map(e=>-e[2]))});i.push(a.multiplyRight(r))}return i}),nu=[0,0,0,1],nh=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],nd={name:"shadow",dependencies:[rl],vs:nn,fs:no,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:function(e){let{shadowEnabled:t=!0,project:i}=e;if(!t||!i||!e.shadowMatrices||!e.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:e.dummyShadowMap,shadow_uShadowMap1:e.dummyShadowMap};let r=rl.getUniforms(i),s=nl({viewport:i.viewport,center:r.center}),n=[],a=nc({shadowMatrices:e.shadowMatrices,viewport:i.viewport}).slice();for(let t=0;t<e.shadowMatrices.length;t++){let e=a[t],o=e.clone().translate(new st(i.viewport.center).negate());r.coordinateSystem===iX.LNGLAT&&r.projectionMode===iK.WEB_MERCATOR?(a[t]=o,n[t]=s):(a[t]=e.clone().multiplyRight(nh),n[t]=o.transform(s))}let o={drawShadowMap:!!e.drawToShadowMap,useShadowMap:!!e.shadowMaps&&e.shadowMaps.length>0,color:e.shadowColor||nu,lightId:e.shadowLightId||0,lightCount:e.shadowMatrices.length,shadow_uShadowMap0:e.dummyShadowMap,shadow_uShadowMap1:e.dummyShadowMap};for(let e=0;e<a.length;e++)o[`viewProjectionMatrix${e}`]=a[e],o[`projectCenter${e}`]=n[e];for(let t=0;t<2;t++)o[`shadow_uShadowMap${t}`]=e.shadowMaps&&e.shadowMaps[t]||e.dummyShadowMap;return o},uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},nf={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:[0,1,1,1]},vs:`\
uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,fs:`\
uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,getUniforms:function(e={},t){let i={};if(void 0===e.highlightedObjectColor||(null===e.highlightedObjectColor?i.isHighlightActive=!1:(i.isHighlightActive=!0,i.highlightedObjectColor=e.highlightedObjectColor.slice(0,3))),e.highlightColor){let t=Array.from(e.highlightColor,e=>e/255);Number.isFinite(t[3])||(t[3]=1),i.highlightColor=t}return void 0!==e.isActive&&(i.isActive=!!e.isActive,i.isAttribute=!!e.isAttribute),void 0!==e.useFloatColors&&(i.useFloatColors=!!e.useFloatColors),i}},np={...nf,defaultUniforms:{...nf.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},ng=[e$],nm=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],ny=[],nv=Symbol.for("component"),nx=Symbol.for("propTypes"),n_=Symbol.for("deprecatedProps"),nb=Symbol.for("asyncPropDefaults"),nw=Symbol.for("asyncPropOriginal"),nk=Symbol.for("asyncPropResolved");var nP=e.i(47167);let nS={};function nT(e){nS=e}function nC(e,t,i,r){is.level>0&&nS[e]&&nS[e].call(null,t,i,r)}function nM(e,t=()=>!0){return Array.isArray(e)?function e(t,i,r){let s=-1;for(;++s<t.length;){let n=t[s];Array.isArray(n)?e(n,i,r):i(n)&&r.push(n)}return r}(e,t,[]):t(e)?[e]:[]}e.i(23635);var nA=e.i(9685);let nI=e=>null!==e&&"object"==typeof e,nE=e=>nI(e)&&e.constructor===({}).constructor,nL=e=>"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json,nO=e=>"undefined"!=typeof Blob&&e instanceof Blob,nR=e=>{let t,i;return t=e,"undefined"!=typeof ReadableStream&&t instanceof ReadableStream||nI(t)&&"function"==typeof t.tee&&"function"==typeof t.cancel&&"function"==typeof t.getReader||nI(i=e)&&"function"==typeof i.read&&"function"==typeof i.pipe&&"boolean"==typeof i.readable};function nN(e,t){if(!e)throw Error(t||"loader assertion failed.")}function nj(e){return!!e&&(Array.isArray(e)&&(e=e[0]),Array.isArray(e?.extensions))}function nD(e){let t;return nN(e,"null loader"),nN(nj(e),"invalid loader"),Array.isArray(e)&&(t=e[1],e={...e=e[0],options:{...e.options,...t}}),(e?.parseTextSync||e?.parseText)&&(e.text=!0),e.text||(e.binary=!0),e}let nz={};class nF extends Error{constructor(e,t){super(e),this.reason=t.reason,this.url=t.url,this.response=t.response}reason;url;response}let nB=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,nU=/^([-\w.]+\/[-\w.+]+)/;function n$(e,t){return e.toLowerCase()===t.toLowerCase()}function nV(e){let t=nB.exec(e);return t?t[1]:""}let nW=/\?.*/;function nG(e){return e.replace(nW,"")}function nq(e){return nL(e)?e.url:nO(e)?e.name||"":"string"==typeof e?e:""}function nH(e){if(nL(e)){let t,i=e.headers.get("content-type")||"",r=nG(e.url);return((t=nU.exec(i))?t[1]:i)||nV(r)}return nO(e)?e.type||"":"string"==typeof e?nV(e):""}async function nZ(e){var t;if(nL(e))return e;let i={},r=nL(t=e)?t.headers["content-length"]||-1:nO(t)?t.size:"string"==typeof t?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1;r>=0&&(i["content-length"]=String(r));let s=nq(e),n=nH(e);n&&(i["content-type"]=n);let a=await nK(e);a&&(i["x-first-bytes"]=a),"string"==typeof e&&(e=new TextEncoder().encode(e));let o=new Response(e,{headers:i});return Object.defineProperty(o,"url",{value:s}),o}async function nY(e){if(!e.ok)throw await nX(e)}async function nX(e){let t=function(e){if(e.length<50)return e;let t=e.slice(e.length-15),i=e.substr(0,32);return`${i}...${t}`}(e.url),i=`Failed to fetch resource (${e.status}) ${e.statusText}: ${t}`;i=i.length>100?`${i.slice(0,100)}...`:i;let r={reason:e.statusText,url:e.url,response:e};try{let t=e.headers.get("Content-Type");r.reason=!e.bodyUsed&&t?.includes("application/json")?await e.json():await e.text()}catch(e){}return new nF(i,r)}async function nK(e){if("string"==typeof e)return`data:,${e.slice(0,5)}`;if(e instanceof Blob){let t=e.slice(0,5);return await new Promise(e=>{let i=new FileReader;i.onload=t=>e(t?.target?.result),i.readAsDataURL(t)})}if(e instanceof ArrayBuffer){let t=function(e){let t="",i=new Uint8Array(e);for(let e=0;e<i.byteLength;e++)t+=String.fromCharCode(i[e]);return btoa(t)}(e.slice(0,5));return`data:base64,${t}`}return null}async function nJ(e,t){if("string"==typeof e){var i;let r=function(e){for(let t in nz)if(e.startsWith(t)){let i=nz[t];e=e.replace(t,i)}return e.startsWith("http://")||e.startsWith("https://")||(e=`${e}`),e}(e);return!((i=r).startsWith("http:")||i.startsWith("https:"))&&!r.startsWith("data:")&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(r,t):await fetch(r,t)}return await nZ(e)}let nQ="4.3.3",n0=nQ[0]>="0"&&nQ[0]<="9"?`v${nQ}`:"",n1=(u=new ir.Log({id:"loaders.gl"}),globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=u,globalThis.loaders.version=n0,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=u,u),n2=new ir.Log({id:"loaders.gl"});class n3{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}let n4={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:e.g,document:"undefined"!=typeof document&&document};n4.self||n4.window||n4.global,n4.window||n4.self||n4.global,n4.global||n4.self||n4.window,n4.document;let n6=("object"!=typeof nP.default||"[object process]"!==String(nP.default),!0),n5=void 0!==nP.default&&nP.default.version&&/v([0-9]*)/.exec(nP.default.version);n5&&parseFloat(n5[1]);let n8={fetch:null,mimeType:void 0,nothrow:!1,log:new class{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}},useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:n6,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},n7={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function n9(){globalThis.loaders=globalThis.loaders||{};let{loaders:e}=globalThis;return e._state||(e._state={}),e._state}function ae(){let e=n9();return e.globalOptions=e.globalOptions||{...n8},e.globalOptions}function at(e,t,i,r,s){let n=t||"Top level",a=t?`${t}.`:"";for(let o in e){let l=!t&&nI(e[o]),c="baseUri"===o&&!t,u="workerUrl"===o&&t;if(!(o in i)&&!c&&!u){if(o in r)n2.warn(`${n} loader option '${a}${o}' no longer supported, use '${r[o]}'`)();else if(!l){let e=function(e,t){let i=e.toLowerCase(),r="";for(let s of t)for(let t in s.options){if(e===t)return`Did you mean '${s.id}.${t}'?`;let n=t.toLowerCase();(i.startsWith(n)||n.startsWith(i))&&(r=r||`Did you mean '${s.id}.${t}'?`)}return r}(o,s);n2.warn(`${n} loader option '${a}${o}' not recognized. ${e}`)()}}}}function ai(e,t){for(let i in t)i in t&&(nE(t[i])&&nE(e[i])?e[i]={...e[i],...t[i]}:e[i]=t[i])}function ar(e,t){let i=ae(),r=e||i;return"function"==typeof r.fetch?r.fetch:nI(r.fetch)?e=>nJ(e,r.fetch):t?.fetch?t?.fetch:nJ}let as={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:e.g,document:"undefined"!=typeof document&&document};as.self||as.window||as.global,as.window||as.self||as.global,as.global||as.self||as.window,as.document;let an="object"!=typeof nP.default||"[object process]"!==String(nP.default)||!0,aa="undefined"!=typeof window&&void 0!==window.orientation,ao=void 0!==nP.default&&nP.default.version&&/v([0-9]*)/.exec(nP.default.version);ao&&parseFloat(ao[1]);class al{terminate(){}}function ac(e,t){if(!e)throw Error(t||"loaders.gl assertion failed.")}let au=new Map;function ah(e){let t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function ad(e){return!!e&&!!(e instanceof ArrayBuffer||"undefined"!=typeof MessagePort&&e instanceof MessagePort||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)}let af=()=>{};class ap{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return"undefined"!=typeof Worker&&an||!an}constructor(e){const{name:t,source:i,url:r}=e;ac(i||r),this.name=t,this.source=i,this.url=r,this.onMessage=af,this.onError=e=>console.log(e),this.worker=an?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=af,this.onError=af,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||function e(t,i=!0,r){let s=r||new Set;if(t){if(ad(t))s.add(t);else if(ad(t.buffer))s.add(t.buffer);else if(ArrayBuffer.isView(t));else if(i&&"object"==typeof t)for(let r in t)e(t[r],i,s)}return void 0===r?Array.from(s):[]}(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),Error(t)}_createBrowserWorker(){var e,t,i;let r;this._loadableURL=(ac((e={source:this.source,url:this.url}).source&&!e.url||!e.source&&e.url),(r=au.get(e.source||e.url))||(e.url&&(r=(t=e.url).startsWith("http")?ah((i=t,`\
try {
  importScripts('${i}');
} catch (error) {
  console.error(error);
  throw error;
}`)):t,au.set(e.url,r)),e.source&&(r=ah(e.source),au.set(e.source,r))),ac(r),r);let s=new Worker(this._loadableURL,{name:this.name});return s.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(Error("No data received"))},s.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},s.onmessageerror=e=>console.error(e),s}_createNodeWorker(){let e;if(this.url)e=new al(this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`,{eval:!1});else if(this.source)e=new al(this.source,{eval:!0});else throw Error("no worker");return e.on("message",e=>{this.onMessage(e)}),e.on("error",e=>{this.onError(e)}),e.on("exit",e=>{}),e}}class ag{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,t){this.name=e,this.workerThread=t,this.result=new Promise((e,t)=>{this._resolve=e,this._reject=t})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){ac(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){ac(this.isRunning),this.isRunning=!1,this._reject(e)}}class am{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return ap.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e,t=(e,t,i)=>e.done(i),i=(e,t)=>e.error(t)){let r=new Promise(r=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:r}),this));return this._startQueuedJob(),await r}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let i=new ag(t.name,e);e.onMessage=e=>t.onMessage(i,e.type,e.payload),e.onError=e=>t.onError(i,e),t.onStart(i);try{await i.result}catch(e){console.error(`Worker exception: ${e}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!an||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){return this.idleQueue.length>0?this.idleQueue.shift()||null:this.count<this._getMaxConcurrency()?(this.count++,new ap({name:`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`,source:this.source,url:this.url})):null}_getMaxConcurrency(){return aa?this.maxMobileConcurrency:this.maxConcurrency}}let ay={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class av{props;workerPools=new Map;static _workerFarm;static isSupported(){return ap.isSupported()}static getWorkerFarm(e={}){return av._workerFarm=av._workerFarm||new av({}),av._workerFarm.setProps(e),av._workerFarm}constructor(e){this.props={...ay},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){for(let t of(this.props={...this.props,...e},this.workerPools.values()))t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:i,url:r}=e,s=this.workerPools.get(t);return s||((s=new am({name:t,source:i,url:r})).setProps(this._getWorkerPoolProps()),this.workerPools.set(t,s)),s}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}let ax=(globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version);async function a_(e,t,i,r,s){let n=e.id,a=function(e,t={}){let i=t[e.id]||{},r=an?`${e.id}-worker.js`:`${e.id}-worker-node.js`,s=i.workerUrl;if(s||"compression"!==e.id||(s=t.workerUrl),"test"===t._workerType&&(s=an?`modules/${e.module}/dist/${r}`:`modules/${e.module}/src/workers/${e.id}-worker-node.ts`),!s){let t=e.version;"latest"===t&&(t="latest");let i=t?`@${t}`:"";s=`https://unpkg.com/@loaders.gl/${e.module}${i}/dist/${r}`}return ac(s),s}(e,i),o=av.getWorkerFarm(i).getWorkerPool({name:n,url:a});i=JSON.parse(JSON.stringify(i)),r=JSON.parse(JSON.stringify(r||{}));let l=await o.startJob("process-on-worker",ab.bind(null,s));l.postMessage("process",{input:t,options:i,context:r});let c=await l.result;return await c.result}async function ab(e,t,i,r){switch(i){case"done":t.done(r);break;case"error":t.error(Error(r.error));break;case"process":let{id:s,input:n,options:a}=r;try{let i=await e(n,a);t.postMessage("done",{id:s,result:i})}catch(i){let e=i instanceof Error?i.message:"unknown error";t.postMessage("error",{id:s,error:e})}break;default:console.warn(`parse-with-worker unknown message ${i}`)}}async function aw(e){let t=[];for await(let i of e)t.push(i);return function(...e){var t=e;let i=t.map(e=>e instanceof ArrayBuffer?new Uint8Array(e):e),r=new Uint8Array(i.reduce((e,t)=>e+t.byteLength,0)),s=0;for(let e of i)r.set(e,s),s+=e.byteLength;return r.buffer}(...t)}async function*ak(e,t){let i=t?.chunkSize||1048576,r=0;for(;r<e.size;){let t=r+i,s=await e.slice(r,t).arrayBuffer();r=t,yield s}}function aP(e){if(e&&"object"==typeof e&&e.isBuffer||e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if("string"==typeof e)return new TextEncoder().encode(e).buffer;if(e&&"object"==typeof e&&e._toArrayBuffer)return e._toArrayBuffer();throw Error("toArrayBuffer")}function aS(e,t){return n6?aT(e,t):aC(e,t)}async function*aT(e,t){let i,r=e.getReader();try{for(;;){let e=i||r.read();t?._streamReadAhead&&(i=r.read());let{done:s,value:n}=await e;if(s)return;yield aP(n)}}catch(e){r.releaseLock()}}async function*aC(e,t){for await(let t of e)yield aP(t)}let aM="Cannot convert supplied data type";async function aA(e,t,i){let r,s,n=e instanceof ArrayBuffer||ArrayBuffer.isView(e);if("string"==typeof e||n){let i;var a=e;if(t.text&&"string"==typeof a)return a;if((i=a)&&"object"==typeof i&&i.isBuffer&&(a=a.buffer),a instanceof ArrayBuffer){let e=a;return t.text&&!t.binary?new TextDecoder("utf8").decode(e):e}if(ArrayBuffer.isView(a)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(a);let e=a.buffer,i=a.byteLength||a.length;return(0!==a.byteOffset||i!==e.byteLength)&&(e=e.slice(a.byteOffset,a.byteOffset+i)),e}throw Error(aM)}if(nO(e)&&(e=await nZ(e)),nL(e)){let i=e;return await nY(i),t.binary?await i.arrayBuffer():await i.text()}if(nR(e)&&(e=function(e,t){if("string"==typeof e)return function*(e,t){let i=t?.chunkSize||262144,r=0,s=new TextEncoder;for(;r<e.length;){let t=Math.min(e.length-r,i),n=e.slice(r,r+t);r+=t,yield s.encode(n)}}(e,t);if(e instanceof ArrayBuffer)return function*(e,t={}){let{chunkSize:i=262144}=t,r=0;for(;r<e.byteLength;){let t=Math.min(e.byteLength-r,i),s=new ArrayBuffer(t),n=new Uint8Array(e,r,t);new Uint8Array(s).set(n),r+=t,yield s}}(e,t);if(nO(e))return ak(e,t);if(nR(e))return aS(e,t);if(nL(e))return aS(e.body,t);throw Error("makeIterator")}(e,i)),(r=e)&&"function"==typeof r[Symbol.iterator]||(s=e)&&"function"==typeof s[Symbol.asyncIterator])return aw(e);throw Error(aM)}function aI(e){let t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(t+1):""}function aE(e){let t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(0,t):""}function aL(...e){return(e=e.map((t,i)=>(i&&(t=t.replace(RegExp("^/"),"")),i!==e.length-1&&(t=t.replace(RegExp("/$"),"")),t))).join("/")}function aO(...e){let t,i=[];for(let t=0;t<e.length;t++)i[t]=e[t];let r="",s=!1;for(let e=i.length-1;e>=-1&&!s;e--){let n;e>=0?n=i[e]:(void 0===t&&(t=function(){if(void 0!==nP.default&&void 0!==nP.default.cwd)return nP.default.cwd();let e=window.location?.pathname;return e?.slice(0,e.lastIndexOf("/")+1)||""}()),n=t),0!==n.length&&(r=`${n}/${r}`,s=n.charCodeAt(0)===aR)}return(r=function(e,t){let i,r="",s=-1,n=0,a=!1;for(let o=0;o<=e.length;++o){if(o<e.length)i=e.charCodeAt(o);else if(i===aR)break;else i=aR;if(i===aR){if(s===o-1||1===n);else if(s!==o-1&&2===n){if(r.length<2||!a||46!==r.charCodeAt(r.length-1)||46!==r.charCodeAt(r.length-2)){if(r.length>2){let e=r.length-1,t=e;for(;t>=0&&r.charCodeAt(t)!==aR;--t);if(t!==e){r=-1===t?"":r.slice(0,t),s=o,n=0,a=!1;continue}}else if(2===r.length||1===r.length){r="",s=o,n=0,a=!1;continue}}t&&(r.length>0?r+="/..":r="..",a=!0)}else{let t=e.slice(s+1,o);r.length>0?r+=`/${t}`:r=t,a=!1}s=o,n=0}else 46===i&&-1!==n?++n:n=-1}return r}(r,!s),s)?`/${r}`:r.length>0?r:"."}let aR=47;e.s(["dirname",()=>aE,"filename",()=>aI,"join",()=>aL,"resolve",()=>aO],73276);var aN=e.i(73276),aN=aN,aN=aN;let aj=()=>{let e=n9();return e.loaderRegistry=e.loaderRegistry||[],e.loaderRegistry},aD=/\.([^.]+)$/;async function az(e,t=[],i,r){if(!aB(e))return null;let s=aF(e,t,{...i,nothrow:!0},r);if(s)return s;if(nO(e)&&(s=aF(e=await e.slice(0,10).arrayBuffer(),t,i,r)),!s&&!i?.nothrow)throw Error(aU(e));return s}function aF(e,t=[],i,r){var s,n,a,o,l,c;let u,h,d,f,p,g,m;if(!aB(e))return null;if(t&&!Array.isArray(t))return nD(t);let y=[];t&&(y=y.concat(t)),i?.ignoreRegisteredLoaders||y.push(...aj()),function(e){for(let t of e)nD(t)}(y);let v=(s=e,n=y,a=i,o=r,u=nq(s),h=nH(s),d=nG(u)||o?.url,f=null,p="",a?.mimeType&&(f=a$(n,a?.mimeType),p=`match forced by supplied MIME type ${a?.mimeType}`),f=f||(l=n,(m=(g=(c=d)&&aD.exec(c))&&g[1])?function(e,t){for(let i of(t=t.toLowerCase(),e))for(let e of i.extensions)if(e.toLowerCase()===t)return i;return null}(l,m):null),p=p||(f?`matched url ${d}`:""),f=f||a$(n,h),p=p||(f?`matched MIME type ${h}`:""),f=f||function(e,t){if(!t)return null;for(let i of e)if("string"==typeof t){if(function(e,t){return t.testText?t.testText(e):(Array.isArray(t.tests)?t.tests:[t.tests]).some(t=>e.startsWith(t))}(t,i))return i}else if(ArrayBuffer.isView(t)){if(aV(t.buffer,t.byteOffset,i))return i}else if(t instanceof ArrayBuffer&&aV(t,0,i))return i;return null}(n,s),p=p||(f?`matched initial data ${aW(s)}`:""),a?.fallbackMimeType&&(f=f||a$(n,a?.fallbackMimeType),p=p||(f?`matched fallback MIME type ${h}`:"")),p&&n1.log(1,`selectLoader selected ${f?.name}: ${p}.`),f);if(!v&&!i?.nothrow)throw Error(aU(e));return v}function aB(e){return!(e instanceof Response)||204!==e.status}function aU(e){let t=nq(e),i=nH(e),r="No valid loader found (";r+=(t?`${aN.filename(t)}, `:"no url provided, ")+`MIME type: ${i?`"${i}"`:"not provided"}, `;let s=e?aW(e):"";return r+((s?` first bytes: "${s}"`:"first bytes: not available")+")")}function a$(e,t){for(let i of e)if(i.mimeTypes?.some(e=>n$(t,e))||n$(t,`application/x.${i.id}`))return i;return null}function aV(e,t,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some(i=>(function(e,t,i,r){if(r instanceof ArrayBuffer)return function(e,t,i){if(i=i||e.byteLength,e.byteLength<i||t.byteLength<i)return!1;let r=new Uint8Array(e),s=new Uint8Array(t);for(let e=0;e<r.length;++e)if(r[e]!==s[e])return!1;return!0}(r,e,r.byteLength);switch(typeof r){case"function":return r(e);case"string":let s=aG(e,t,r.length);return r===s;default:return!1}})(e,t,0,i))}function aW(e,t=5){return"string"==typeof e?e.slice(0,t):ArrayBuffer.isView(e)?aG(e.buffer,e.byteOffset,t):e instanceof ArrayBuffer?aG(e,0,t):""}function aG(e,t,i){if(e.byteLength<t+i)return"";let r=new DataView(e),s="";for(let e=0;e<i;e++)s+=String.fromCharCode(r.getUint8(t+e));return s}async function aq(e,t,i,r){var s,n,a,o,l,c,u;let h;!t||Array.isArray(t)||nj(t)||(r=void 0,i=t,t=void 0),e=await e,i=i||{};let d=nq(e),f=function(e,t){let i;if(e&&!Array.isArray(e))return e;if(e&&(i=Array.isArray(e)?e:[e]),t&&t.loaders){let e=Array.isArray(t.loaders)?t.loaders:[t.loaders];i=i?[...i,...e]:e}return i&&i.length?i:void 0}(t,r),p=await az(e,f,i);if(!p)return null;return function(e,t){for(let i of(at(e,null,n8,n7,t),t)){let r=e&&e[i.id]||{},s=i.options&&i.options[i.id]||{},n=i.deprecatedOptions&&i.deprecatedOptions[i.id]||{};at(r,i.id,s,n,t)}}(s=i,n=Array.isArray(n=(n=f)||[])?n:[n]),r=function(e,t,i){if(i)return i;let r={fetch:ar(t,e),...e};if(r.url){let e,t=nG(r.url);r.baseUrl=t,e=r.url.match(nW),r.queryString=e&&e[0],r.filename=aN.filename(t),r.baseUrl=aN.dirname(t)}return Array.isArray(r.loaders)||(r.loaders=null),r}({url:d,_parse:aq,loaders:f},(a=p,o=s,l=d,c=h={...a.options||{}},!(u=l)||"baseUri"in c||(c.baseUri=u),null===h.log&&(h.log=new n3),ai(h,ae()),ai(h,o),i=h),r||null),await aH(p,e,i,r)}async function aH(e,t,i,r){var s;if(!function(e,t=ax){ac(e,"no worker provided");e.version}(e),i=function e(t,i,r=0){if(r>3)return i;let s={...t};for(let[t,n]of Object.entries(i))n&&"object"==typeof n&&!Array.isArray(n)?s[t]=e(s[t]||{},i[t],r+1):s[t]=i[t];return s}(e.options||{},i),nL(t)){let e=t,{ok:i,redirected:s,status:n,statusText:a,type:o,url:l}=e;r.response={headers:Object.fromEntries(e.headers.entries()),ok:i,redirected:s,status:n,statusText:a,type:o,url:l}}if(t=await aA(t,e,i),e.parseTextSync&&"string"==typeof t)return e.parseTextSync(t,i,r);if(s=i,av.isSupported()&&(an||s?._nodeWorkers)&&e.worker&&s?.worker)return await a_(e,t,i,r,aq);if(e.parseText&&"string"==typeof t)return await e.parseText(t,i,r);if(e.parse)return await e.parse(t,i,r);throw ac(!e.parseSync),Error(`${e.id} loader - no parser found and worker is disabled`)}async function aZ(e,t,i,r){let s,n;Array.isArray(t)||nj(t)?(s=t,n=i):(s=[],n=t);let a=ar(n),o=e;return"string"==typeof e&&(o=await a(e)),nO(e)&&(o=await a(e)),Array.isArray(s),await aq(o,s,n)}class aY{constructor(e,t,i){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;let i=++this._loadCount,r=e;for(let t of("string"==typeof e&&(r=aZ(e)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(e=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=e)}).catch(e=>{this._loadCount===i&&(this.isLoaded=!0,this._error=e||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e),this._subscribers))t.onChange(this.getData())}}class aX{constructor(e){this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:e.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return!!e.startsWith(this.protocol)||e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:r=!0}){let s=this._resources[e];s?s.setData(t,i):(s=new aY(e,t,this._context),this._resources[e]=s),s.persistent=r}remove(e){let t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){let t=this._consumers[e];if(t){for(let e in t){let i=t[e],r=this._resources[i.resourceId];r&&r.unsubscribe(i)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:r="default"}){let{_resources:s,protocol:n}=this;e.startsWith(n)&&(s[e=e.replace(n,"")]||this.add({resourceId:e,data:null,persistent:!1}));let a=s[e];if(this._track(i,r,a,t),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let e in this._resources)this._resources[e].delete()}_track(e,t,i,r){let s=this._consumers,n=s[e]=s[e]||{},a=n[t],o=a&&a.resourceId&&this._resources[a.resourceId];o&&(o.unsubscribe(a),this.prune()),i&&(a?(a.onChange=r,a.resourceId=i.id):a={onChange:r,resourceId:i.id},n[t]=a,i.subscribe(a))}_prune(){for(let e of(this._pruneRequest=null,Object.keys(this._resources))){let t=this._resources[e];t.persistent||t.inUse()||(t.delete(),delete this._resources[e])}}}let aK=new class{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:r,padding:s=0,copy:n=!1,initialize:a=!1,maxCount:o}){let l=r||e&&e.constructor||Float32Array,c=t*i+s;if(ArrayBuffer.isView(e)){if(c<=e.length)return e;if(c*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new l(e.buffer,0,c)}let u=1/0;o&&(u=o*i+s);let h=this._allocate(l,c,a,u);return e&&n?h.set(e):a||h.fill(0,0,4),this._release(e),h}release(e){this._release(e)}_allocate(e,t,i,r){let s=Math.max(Math.ceil(t*this.opts.overAlloc),1);s>r&&(s=r);let n=this._pool,a=e.BYTES_PER_ELEMENT*s,o=n.findIndex(e=>e.byteLength>=a);if(o>=0){let t=new e(n.splice(o,1)[0],0,s);return i&&t.fill(0),t}return new e(s)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:i}=e,{byteLength:r}=i,s=t.findIndex(e=>e.byteLength>=r);s<0?t.push(i):(s>0||t.length<this.opts.poolSize)&&t.splice(s,0,i),t.length>this.opts.poolSize&&t.shift()}};function aJ(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}let aQ=new st;function a0(e,t,i,r){aQ.set(e,t,i);let s=aQ.len();return{distance:r/s,normal:new st(-e/s,-t/s,-i/s)}}function a1(e,t){let{size:i=1,startIndex:r=0}=t,n=void 0!==t.endIndex?t.endIndex:e.length,a=(n-r)/i;s=aK.allocate(s,a,{type:Float32Array,size:2*i});let o=r,l=0;for(;o<n;){for(let t=0;t<i;t++){let r=e[o++];s[l+t]=r,s[l+t+i]=r-Math.fround(r)}l+=2*i}return s.subarray(0,a*i*2)}function a2(e){let t=null,i=!1;for(let r of e)r&&(t?(i||(t=[[t[0][0],t[0][1]],[t[1][0],t[1][1]]],i=!0),t[0][0]=Math.min(t[0][0],r[0][0]),t[0][1]=Math.min(t[0][1],r[0][1]),t[1][0]=Math.max(t[1][0],r[1][0]),t[1][1]=Math.max(t[1][1],r[1][1])):t=r);return t}var tE=tE;let a3=Math.PI/180,a4=aJ(),a6=[0,0,0],a5={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};class a8{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||a5,this.focalDistance=e.focalDistance||1,this.position=e.position||a6,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?iK.WEB_MERCATOR:iK.WEB_MERCATOR_AUTO_OFFSET:iK.IDENTITY}equals(e){return e instanceof a8&&(this===e||e.width===this.width&&e.height===this.height&&e.scale===this.scale&&rp(e.projectionMatrix,this.projectionMatrix)&&rp(e.viewMatrix,this.viewMatrix))}project(e,{topLeft:t=!0}={}){let i=s9(this.projectPosition(e),this.pixelProjectionMatrix),[r,s]=i,n=t?s:this.height-s;return 2===e.length?[r,n]:[r,n,i[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[r,s,n]=e,a=t?s:this.height-s,o=i&&i*this.distanceScales.unitsPerMeter[2],l=ne([r,a,n],this.pixelUnprojectionMatrix,o),[c,u,h]=this.unprojectPosition(l);return Number.isFinite(n)?[c,u,h]:Number.isFinite(i)?[c,u,i]:[c,u]}projectPosition(e){let[t,i]=this.projectFlat(e);return[t,i,(e[2]||0)*this.distanceScales.unitsPerMeter[2]]}unprojectPosition(e){let[t,i]=this.unprojectFlat(e);return[t,i,(e[2]||0)*this.distanceScales.metersPerUnit[2]]}projectFlat(e){if(this.isGeospatial){let t=s2(e);return t[1]=rd(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?s3(e):e}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,0],t),r=this.unproject([this.width,0],t),s=this.unproject([0,this.height],t),n=this.unproject([this.width,this.height],t);return[Math.min(i[0],r[0],s[0],n[0]),Math.min(i[1],r[1],s[1],n[1]),Math.max(i[0],r[0],s[0],n[0]),Math.max(i[1],r[1],s[1],n[1])]}getDistanceScales(e){return e&&this.isGeospatial?s6({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:r=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+r}getFrustumPlanes(){var e;return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,{left:a0((e=this.viewProjectionMatrix)[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]),right:a0(e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]),bottom:a0(e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]),top:a0(e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]),near:a0(e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]),far:a0(e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14])}),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){let t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=function(e){let{latitude:t}=e;return sK(Number.isFinite(t)),sZ(4003e4*Math.cos(t*s0))-9}({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||s6({latitude:i,longitude:t}));let r=Math.pow(2,this.zoom);this.scale=r;let{position:s,modelMatrix:n}=e,a=a6;if(s&&(a=n?new sV(n).transformAsVector(s,[]):s),this.isGeospatial){let e=this.projectPosition([t,i,0]);this.center=new st(a).scale(this.distanceScales.unitsPerMeter).add(e)}else this.center=this.projectPosition(a)}_initMatrices(e){var t;let{viewMatrix:i=a4,projectionMatrix:r=null,orthographic:s=!1,fovyRadians:n,fovy:a=75,near:o=.1,far:l=1e3,padding:c=null,focalDistance:u=1}=e;this.viewMatrixUncentered=i,this.viewMatrix=new sV().multiplyRight(i).translate(new st(this.center).negate()),this.projectionMatrix=r||function({width:e,height:t,orthographic:i,fovyRadians:r,focalDistance:s,padding:n,near:a,far:o}){let l=e/t,c=i?new sV().orthographic({fovy:r,aspect:l,focalDistance:s,near:a,far:o}):new sV().perspective({fovy:r,aspect:l,near:a,far:o});if(n){let{left:i=0,right:r=0,top:s=0,bottom:a=0}=n,o=rd((i+e-r)/2,0,e)-e/2,l=rd((s+t-a)/2,0,t)-t/2;c[8]-=2*o/e,c[9]+=2*l/t}return c}({width:this.width,height:this.height,orthographic:s,fovyRadians:n||a*a3,focalDistance:u,padding:c,near:o,far:l});let h=aJ();tE.multiply(h,h,this.projectionMatrix),tE.multiply(h,h,this.viewMatrix),this.viewProjectionMatrix=h,this.viewMatrixInverse=tE.invert([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=[(t=this.viewMatrixInverse)[12],t[13],t[14]];let d=aJ(),f=aJ();tE.scale(d,d,[this.width/2,-this.height/2,1]),tE.translate(d,d,[1,-1,0]),tE.multiply(f,d,this.viewProjectionMatrix),this.pixelProjectionMatrix=f,this.pixelUnprojectionMatrix=tE.invert(aJ(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||is.warn("Pixel project matrix not invertible")()}}a8.displayName="Viewport";let a7=a8;class a9{constructor(e,t){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=e=>{nC("layerManager.activateViewport",this,e),e&&(this.context.viewport=e)};const{deck:i,stats:r,viewport:s,timeline:n}=t||{};this.layers=[],this.resourceManager=new aX({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e?.gl,deck:i,shaderAssembler:function(e){let t=eC.getDefaultShaderAssembler();for(let e of ng)t.addDefaultModule(e);for(let i of(t._hookFunctions.length=0,"glsl"===e?nm:ny))t.addShaderHook(i);return t}(e?.info?.shadingLanguage||"glsl"),defaultShaderModules:[eF],renderPass:void 0,stats:r||new nA.Stats({id:"deck.gl"}),viewport:s||new a7({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:n||new ee,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){for(let e of(this.resourceManager.finalize(),this.layers))this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;for(let i of(e.clearRedrawFlags&&(this._needsRedraw=!1),this.layers)){let r=i.getNeedsRedraw(e);t=t||r}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(e=>0===t.id.indexOf(e))):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){nC("layerManager.setLayers",this,t,e),this._lastRenderedLayers=e;let i=nM(e,Boolean);for(let e of i)e.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){let e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){let{defaultShaderModules:t}=this.context;t.find(t=>t.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){let{defaultShaderModules:t}=this.context,i=t.findIndex(t=>t.name===e.name);i>=0&&(t.splice(i,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,i){i.raiseError(t,`${e} of ${i}`)}_updateLayers(e,t){let i={};for(let t of e)i[t.id]?is.warn(`Multiple old layers with same id ${t.id}`)():i[t.id]=t;if(this._defaultShaderModulesChanged){for(let t of e)t.setNeedsUpdate(),t.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}let r=[];this._updateSublayersRecursively(t,i,r),this._finalizeOldLayers(i);let s=!1;for(let e of r)if(e.hasUniformTransition()){s=`Uniform transition in ${e}`;break}this._needsUpdate=s,this.layers=r}_updateSublayersRecursively(e,t,i){for(let r of e){r.context=this.context;let e=t[r.id];null===e&&is.warn(`Multiple new layers with same id ${r.id}`)(),t[r.id]=null;let s=null;try{this._debug&&e!==r&&r.validateProps(),e?(this._transferLayerState(e,r),this._updateLayer(r)):this._initializeLayer(r),i.push(r),s=r.isComposite?r.getSubLayers():null}catch(e){this._handleError("matching",e,r)}s&&this._updateSublayersRecursively(s,t,i)}}_finalizeOldLayers(e){for(let t in e){let i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle="Initialized"}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle="Matched. State transferred from previous layer",t!==e&&(e.lifecycle="Discarded. Awaiting garbage collection")}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle="No longer matched. Awaiting garbage collection";try{e._finalize(),e.lifecycle="Finalized! Awaiting garbage collection"}catch(t){this._handleError("finalization",t,e)}}}function oe(e,t,i){if(e===t)return!0;if(!i||!e||!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!oe(e[r],t[r],i-1))return!1;return!0}if(Array.isArray(t))return!1;if("object"==typeof e&&"object"==typeof t){let r=Object.keys(e),s=Object.keys(t);if(r.length!==s.length)return!1;for(let s of r)if(!t.hasOwnProperty(s)||!oe(e[s],t[s],i-1))return!1;return!0}return!1}class ot{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(let e in this.controllers){let t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(let e in this.controllers){let t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){let e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){let t="string"==typeof e?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){let i=this.getViewports(),r={x:e[0],y:e[1]};for(let s=i.length-1;s>=0;--s){let n=i[s];if(n.containsPixel(r)){let i=e.slice();return i[0]-=n.x,i[1]-=n.y,n.unproject(i,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=nM(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(oe(e,this.viewState,3)||this.setNeedsUpdate("viewState changed"),this.viewState=e):is.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){return new t.type({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:t=>this.getView(e.id)?.makeViewport({viewState:t,width:this.width,height:this.height})})}_updateController(e,t,i,r){let s=e.controller;if(s&&i){let n={...t,...s,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return r&&r.constructor===s.type||(r=this._createController(e,n)),r&&r.setProps(n),r}return null}_rebuildViewports(){let{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let r=e.length;r--;){let s=e[r],n=this.getViewState(s),a=s.makeViewport({viewState:n,width:this.width,height:this.height}),o=t[s.id],l=!!s.controller;l&&!o&&(i=!0),(i||!l)&&o&&(o.finalize(),o=null),this.controllers[s.id]=this._updateController(s,n,a,o),a&&this._viewports.unshift(a)}for(let e in t){let i=t[e];i&&!this.controllers[e]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length||e.some((i,r)=>!e[r].equals(t[r]))}}let oi=/([0-9]+\.?[0-9]*)(%|px)/;function or(e){switch(typeof e){case"number":return{position:e,relative:!1};case"string":let t=oi.exec(e);if(t&&t.length>=3){let e="%"===t[2],i=parseFloat(t[1]);return{position:e?i/100:i,relative:e}}default:throw Error(`Could not parse position string ${e}`)}}function os(e,t){return e.relative?Math.round(e.position*t):e.position}class on{constructor(e){const{id:t,x:i=0,y:r=0,width:s="100%",height:n="100%",padding:a=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=or(i),this._y=or(r),this._width=or(s),this._height=or(n),this._padding=a&&{left:or(a.left||0),right:or(a.right||0),top:or(a.top||0),bottom:or(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e||this.constructor===e.constructor&&oe(this.props,e.props,2)}clone(e){return new this.constructor({...this.props,...e})}makeViewport({width:e,height:t,viewState:i}){i=this.filterViewState(i);let r=this.getDimensions({width:e,height:t});return r.height&&r.width?new(this.getViewportType(i))({...i,...this.props,...r}):null}getViewStateId(){let{viewState:e}=this.props;return"string"==typeof e?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&"object"==typeof this.props.viewState){if(!this.props.viewState.id)return this.props.viewState;let t={...e};for(let e in this.props.viewState)"id"!==e&&(t[e]=this.props.viewState[e]);return t}return e}getDimensions({width:e,height:t}){let i={x:os(this._x,e),y:os(this._y,t),width:os(this._width,e),height:os(this._height,t)};return this._padding&&(i.padding={left:os(this._padding.left,e),top:os(this._padding.top,t),right:os(this._padding.right,e),bottom:os(this._padding.bottom,t)}),i}get controller(){let e=this.props.controller;return e?!0===e?{type:this.ControllerType}:"function"==typeof e?{type:e}:{type:this.ControllerType,...e}:null}}var sY=sY;class oa extends a7{constructor(e={}){let t;const{latitude:i=0,longitude:r=0,zoom:s=0,pitch:n=0,bearing:a=0,nearZMultiplier:o=.1,farZMultiplier:l=1.01,nearZ:c,farZ:u,orthographic:h=!1,projectionMatrix:d,repeat:f=!1,worldOffset:p=0,position:g,padding:m,legacyMeterSizes:y=!1}=e;let{width:v,height:x,altitude:_=1.5}=e;const b=Math.pow(2,s);v=v||1,x=x||1;let w=null;if(d)t=s8(_=d[5]/2);else{let r;if(e.fovy?_=s7(t=e.fovy):t=s8(_),m){const{top:e=0,bottom:t=0}=m;r=[0,rd((e+x-t)/2,0,x)-x/2]}w=function(e){let{width:t,height:i,altitude:r,pitch:s=0,offset:n,center:a,scale:o,nearZMultiplier:l=1,farZMultiplier:c=1}=e,{fovy:u=s8(1.5)}=e;void 0!==r&&(u=s8(r));let h=u*s0,d=s*s0,f=s7(u),p=f;a&&(p+=a[2]*o/Math.cos(d)/i);let g=h*(.5+(n?n[1]:0)/i),m=Math.sin(g)*p/Math.sin(sH(Math.PI/2-d-g,.01,Math.PI-.01));return{fov:h,aspect:t/i,focalDistance:f,near:l,far:Math.min((Math.sin(d)*m+p)*c,10*p)}}({width:v,height:x,scale:b,center:g&&[0,0,g[2]*s4(i)],offset:r,pitch:n,fovy:t,nearZMultiplier:o,farZMultiplier:l}),Number.isFinite(c)&&(w.near=c),Number.isFinite(u)&&(w.far=u)}let k=function(e){let{height:t,pitch:i,bearing:r,altitude:s,scale:n,center:a}=e,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];tE.translate(o,o,[0,0,-s]),tE.rotateX(o,o,-i*s0),tE.rotateZ(o,o,r*s0);let l=n/t;return tE.scale(o,o,[l,l,l]),a&&tE.translate(o,o,sX.negate([],a)),o}({height:x,pitch:n,bearing:a,scale:b,altitude:_});p&&(k=new sV().translate([512*p,0,0]).multiplyLeft(k)),super({...e,width:v,height:x,viewMatrix:k,longitude:r,latitude:i,zoom:s,...w,fovy:t,focalDistance:_}),this.latitude=i,this.longitude=r,this.zoom=s,this.pitch=n,this.bearing=a,this.altitude=_,this.fovy=t,this.orthographic=h,this._subViewports=f?[]:null,this._pseudoMeters=y,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let e=t;e<=i;e++){let t=e?new oa({...this,worldOffset:e}):this;this._subViewports.push(t)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,i]=this.projectFlat(e);return[t,i,(e[2]||0)*s4(e[1])]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,i]=this.unprojectFlat(e),r=(e[2]||0)/s4(i);return[t,i,r]}addMetersToLngLat(e,t){return s5(e,t)}panByPosition(e,t){let i=ne(t,this.pixelUnprojectionMatrix),r=this.projectFlat(e),s=sY.add([],r,sY.negate([],i)),n=sY.add([],this.center,s),[a,o]=this.unprojectFlat(n);return{longitude:a,latitude:o}}getBounds(e={}){let t=function(e,t=0){let i,r,{width:s,height:n,unproject:a}=e,o={targetZ:t},l=a([0,n],o),c=a([s,n],o);return(e.fovy?.5*e.fovy*nt:Math.atan(.5/e.altitude))>(90-e.pitch)*nt-.01?(i=ni(e,0,t),r=ni(e,s,t)):(i=a([0,0],o),r=a([s,0],o)),[l,c,r,i]}(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:i,height:r}=this,{longitude:s,latitude:n,zoom:a}=function(e){let{width:t,height:i,bounds:r,minExtent:s=0,maxZoom:n=24,offset:a=[0,0]}=e,[[o,l],[c,u]]=r,h=function(e=0){return"number"==typeof e?{top:e,bottom:e,left:e,right:e}:(sK(Number.isFinite(e.top)&&Number.isFinite(e.bottom)&&Number.isFinite(e.left)&&Number.isFinite(e.right)),e)}(e.padding),d=s2([o,sH(u,-85.051129,85.051129)]),f=s2([c,sH(l,-85.051129,85.051129)]),p=[Math.max(Math.abs(f[0]-d[0]),s),Math.max(Math.abs(f[1]-d[1]),s)],g=[t-h.left-h.right-2*Math.abs(a[0]),i-h.top-h.bottom-2*Math.abs(a[1])];sK(g[0]>0&&g[1]>0);let m=g[0]/p[0],y=g[1]/p[1],v=(h.right-h.left)/2/m,x=(h.top-h.bottom)/2/y,_=s3([(f[0]+d[0])/2+v,(f[1]+d[1])/2+x]),b=Math.min(n,sZ(Math.abs(Math.min(m,y))));return sK(Number.isFinite(b)),{longitude:_[0],latitude:_[1],zoom:b}}({width:i,height:r,bounds:e,...t});return new oa({width:i,height:r,longitude:s,latitude:n,zoom:a})}}oa.displayName="WebMercatorViewport";class oo{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings=e,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(null===this._handle){let{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}let ol=()=>{},oc=e=>e;class ou{constructor(e){this._onTransitionUpdate=e=>{let{time:t,settings:{interpolator:i,startProps:r,endProps:s,duration:n,easing:a}}=e,o=a(t/n),l=i.interpolateProps(r,s,o);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new oo(e.timeline),this.onViewStateChange=e.onViewStateChange||ol,this.onStateChange=e.onStateChange||ol}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1,i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let r=i;if(this.transition.inProgress){let{interruption:e,endProps:t}=this.transition.settings;r={...i,...2===e?t:this.propsInTransition||i}}this._triggerTransition(r,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){let{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||"auto"===t)&&!!i}_isUpdateDueToCurrentTransition(e){return!!this.transition.inProgress&&!!this.propsInTransition&&this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition)}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?3===this.transition.settings.interruption||this._isUpdateDueToCurrentTransition(t):!this._isTransitionEnabled(t)||t.transitionInterpolator.arePropsEqual(e,t)}_triggerTransition(e,t){let i=this.getControllerState(e),r=this.getControllerState(t).shortestPathFrom(i),s=t.transitionInterpolator,n=s.getDuration?s.getDuration(e,t):t.transitionDuration;if(0===n)return;let a=s.initializeProps(e,r);this.propsInTransition={};let o={duration:n,easing:t.transitionEasing||oc,interpolator:s,interruption:t.transitionInterruption||1,startProps:a.start,endProps:a.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(o),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}}function oh(e,t){if(!e)throw Error(t||"deck.gl: assertion failed.")}class od{constructor(e){const{compare:t,extract:i,required:r}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=r}arePropsEqual(e,t){for(let i of this._propsToCompare)if(!(i in e)||!(i in t)||!rp(e[i],t[i]))return!1;return!0}initializeProps(e,t){let i={},r={};for(let s of this._propsToExtract)(s in e||s in t)&&(i[s]=e[s],r[s]=t[s]);return this._checkRequiredProps(i),this._checkRequiredProps(r),{start:i,end:r}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{let i=e[t];oh(Number.isFinite(i)||Array.isArray(i),`${t} is required for transition`)})}}let of=["longitude","latitude","zoom","bearing","pitch"],op=["longitude","latitude","zoom"];class og extends od{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:of,required:op},super(i.transitionProps),this.opts=i}initializeProps(e,t){let i=super.initializeProps(e,t),{makeViewport:r,around:s}=this.opts;if(r&&s){let n=r(e),a=r(t),o=n.unproject(s);i.start.around=s,Object.assign(i.end,{around:a.project(o),aroundPosition:o,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){let r={};for(let s of this._propsToExtract)r[s]=rf(e[s]||0,t[s]||0,i);if(t.aroundPosition&&this.opts.makeViewport){let s=this.opts.makeViewport({...t,...r});Object.assign(r,s.panByPosition(t.aroundPosition,rf(e.around,t.around,i)))}return r}}let om={transitionDuration:0},oy=e=>1-(1-e)*(1-e),ov=["wheel"],ox=["panstart","panmove","panend"],o_=["pinchstart","pinchmove","pinchend"],ob=["multipanstart","multipanmove","multipanend"],ow=["dblclick"],ok=["keydown"],oP={};class oS{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new ou({...e,getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(let e in this._events)this._events[e]&&this.eventManager?.off(e,this.handleEvent);this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;let t=this._eventStartBlocked;switch(e.type){case"panstart":return!t&&this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return!t&&this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return!t&&this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){let{x:t,y:i}=this.props,{offsetCenter:r}=e;return[r.x-t,r.y-i]}isPointInBounds(e,t){let{width:i,height:r}=this.props;if(t&&t.handled)return!1;let s=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=r;return s&&t&&t.stopPropagation(),s}isFunctionKeyPressed(e){let{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){let t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);let{inertia:t}=e;this.inertia=Number.isFinite(t)?t:300*(!0===t);let{scrollZoom:i=!0,dragPan:r=!0,dragRotate:s=!0,doubleClickZoom:n=!0,touchZoom:a=!0,touchRotate:o=!1,keyboard:l=!0}=e,c=!!this.onViewStateChange;this.toggleEvents(ov,c&&i),this.toggleEvents(ox,c),this.toggleEvents(o_,c&&(a||o)),this.toggleEvents(ob,c&&o),this.toggleEvents(ow,c&&n),this.toggleEvents(ok,c&&l),this.scrollZoom=i,this.dragPan=r,this.dragRotate=s,this.doubleClickZoom=n,this.touchZoom=a,this.touchRotate=o,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(e=>{this._events[e]!==t&&(this._events[e]=t,t?this.eventManager.on(e,this.handleEvent):this.eventManager.off(e,this.handleEvent))})}updateViewport(e,t=null,i={}){let r={...e.getViewportProps(),...t},s=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),s){let e=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:e,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||"pan"===this.dragMode)&&(i=!i);let r=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(r,om,{isDragging:!0}),!0}_onPan(e){return!!this.isDragging()&&(this._panMove?this._onPanMove(e):this._onPanRotate(e))}_onPanEnd(e){return!!this.isDragging()&&(this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e))}_onPanMove(e){if(!this.dragPan)return!1;let t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,om,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){let{inertia:t}=this;if(this.dragPan&&t&&e.velocity){let i=this.getCenter(e),r=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],s=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:oy},{isDragging:!1,isPanning:!0})}else{let e=this.controllerState.panEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;let t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,om,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){let{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){let i=this.getCenter(e),r=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],s=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:oy},{isDragging:!1,isRotating:!0})}else{let e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();let{speed:i=.01,smooth:r=!1}=!0===this.scrollZoom?{}:this.scrollZoom,{delta:s}=e,n=2/(1+Math.exp(-Math.abs(s*i)));s<0&&0!==n&&(n=1/n);let a=r?{...this._getTransitionProps({around:t}),transitionDuration:250}:om,o=this.controllerState.zoom({pos:t,scale:n});return this.updateViewport(o,a,{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,om,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;let t=this.getCenter(e);t[0]-=e.deltaX;let i=this.controllerState.rotate({pos:t});return this.updateViewport(i,om,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){let i=this.getCenter(e),r=[i[0],i[1]+=e.velocityY*t/2],s=this.controllerState.rotate({pos:r});this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:oy},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{let e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return oP._startPinchRotation=e.rotation,oP._lastPinchEvent=e,this.updateViewport(i,om,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){let{scale:i}=e,r=this.getCenter(e);t=t.zoom({pos:r,scale:i})}if(this.touchRotate){let{rotation:i}=e;t=t.rotate({deltaAngleX:oP._startPinchRotation-i})}return this.updateViewport(t,om,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),oP._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this,{_lastPinchEvent:i}=oP;if(this.touchZoom&&t&&i&&e.scale!==i.scale){let r=this.getCenter(e),s=this.controllerState.rotateEnd(),n=Math.log2(e.scale),a=(n-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),o=Math.pow(2,n+a*t/2);s=s.zoom({pos:r,scale:o}).zoomEnd(),this.updateViewport(s,{...this._getTransitionProps({around:r}),transitionDuration:t,transitionEasing:oy},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{let e=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return oP._startPinchRotation=null,oP._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e),r=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(r,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){let t;if(!this.keyboard)return!1;let i=this.isFunctionKeyPressed(e),{zoomSpeed:r,moveSpeed:s,rotateSpeedX:n,rotateSpeedY:a}=!0===this.keyboard?{}:this.keyboard,{controllerState:o}=this,l={};switch(e.srcEvent.code){case"Minus":t=i?o.zoomOut(r).zoomOut(r):o.zoomOut(r),l.isZooming=!0;break;case"Equal":t=i?o.zoomIn(r).zoomIn(r):o.zoomIn(r),l.isZooming=!0;break;case"ArrowLeft":i?(t=o.rotateLeft(n),l.isRotating=!0):(t=o.moveLeft(s),l.isPanning=!0);break;case"ArrowRight":i?(t=o.rotateRight(n),l.isRotating=!0):(t=o.moveRight(s),l.isPanning=!0);break;case"ArrowUp":i?(t=o.rotateUp(a),l.isRotating=!0):(t=o.moveUp(s),l.isPanning=!0);break;case"ArrowDown":i?(t=o.rotateDown(a),l.isRotating=!0):(t=o.moveDown(s),l.isPanning=!0);break;default:return!1}return this.updateViewport(t,this._getTransitionProps(),l),!0}_getTransitionProps(e){let{transition:t}=this;return t&&t.transitionInterpolator?e?{...t,transitionInterpolator:new og({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t:om}}class oT{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}class oC extends oT{constructor(e){const{width:t,height:i,latitude:r,longitude:s,zoom:n,bearing:a=0,pitch:o=0,altitude:l=1.5,position:c=[0,0,0],maxZoom:u=20,minZoom:h=0,maxPitch:d=60,minPitch:f=0,startPanLngLat:p,startZoomLngLat:g,startRotatePos:m,startBearing:y,startPitch:v,startZoom:x,normalize:_=!0}=e;oh(Number.isFinite(s)),oh(Number.isFinite(r)),oh(Number.isFinite(n)),super({width:t,height:i,latitude:r,longitude:s,zoom:n,bearing:a,pitch:o,altitude:l,maxZoom:u,minZoom:h,maxPitch:d,minPitch:f,normalize:_,position:c},{startPanLngLat:p,startZoomLngLat:g,startRotatePos:m,startBearing:y,startPitch:v,startZoom:x}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){let i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;let r=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(r)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let r,{startRotatePos:s,startBearing:n,startPitch:a}=this.getState();return s&&void 0!==n&&void 0!==a?(r=e?this._getNewRotation(e,s,a,n):{bearing:n+t,pitch:a+i},this._getUpdatedState(r)):this}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:r,startZoomLngLat:s}=this.getState();if(s||(r=this.getViewportProps().zoom,s=this._unproject(t)||this._unproject(e)),!s)return this;let{maxZoom:n,minZoom:a}=this.getViewportProps(),o=r+Math.log2(i);o=rd(o,a,n);let l=this.makeViewport({...this.getViewportProps(),zoom:o});return this._getUpdatedState({zoom:o,...l.panByPosition(s,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:r,longitude:s}=i;return Math.abs(r-t.bearing)>180&&(i.bearing=r<0?r+360:r-360),Math.abs(s-t.longitude)>180&&(i.longitude=s<0?s+360:s-360),i}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:r}=e;e.zoom=rd(r,i,t);let{maxPitch:s,minPitch:n,pitch:a}=e;e.pitch=rd(a,n,s);let{normalize:o=!0}=e;return o&&Object.assign(e,function(e){let{width:t,height:i,pitch:r=0}=e,{longitude:s,latitude:n,zoom:a,bearing:o=0}=e;(s<-180||s>180)&&(s=sq(s+180,360)-180),(o<-180||o>180)&&(o=sq(o+180,360)-180);let l=sZ(i/512);if(a<=l)a=l,n=0;else{let e=i/2/Math.pow(2,a),t=s3([0,e])[1];if(n<t)n=t;else{let t=s3([0,512-e])[1];n>t&&(n=t)}}return{width:t,height:i,longitude:s,latitude:n,zoom:a,pitch:r,bearing:o}}(e)),e}_zoomFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,r){let s=e[0]-t[0],n=e[1]-t[1],a=e[1],o=t[1],{width:l,height:c}=this.getViewportProps(),u=0;n>0?Math.abs(c-o)>5&&(u=n/(o-c)*1.2):n<0&&o>5&&(u=1-a/o),u=rd(u,-1,1);let{minPitch:h,maxPitch:d}=this.getViewportProps(),f=i;return u>0?f=i+u*(d-i):u<0&&(f=i-u*(h-i)),{pitch:f,bearing:r+s/l*180}}}class oM extends oS{constructor(){super(...arguments),this.ControllerState=oC,this.transition={transitionDuration:300,transitionInterpolator:new og({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];let t=this.props;super.setProps(e),t&&t.height===e.height||this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class oA extends on{constructor(e={}){super(e)}getViewportType(){return oa}get ControllerType(){return oM}}oA.displayName="MapView";let oI=[255,255,255],oE=0;class oL{constructor(e={}){this.type="ambient";const{color:t=oI}=e,{intensity:i=1}=e;this.id=e.id||`ambient-${oE++}`,this.color=t,this.intensity=i}}let oO=[255,255,255],oR=[0,0,-1],oN=0;class oj{constructor(e={}){this.type="directional";const{color:t=oO}=e,{intensity:i=1}=e,{direction:r=oR}=e,{_shadow:s=!1}=e;this.id=e.id||`directional-${oN++}`,this.color=t,this.intensity=i,this.type="directional",this.direction=new st(r).normalize().toArray(),this.shadow=s}getProjectedLight(e){return this}}class oD{constructor(e,t={id:"pass"}){const{id:i}=t;this.id=i,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class oz extends oD{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){let[t,i]=this.device.canvasContext.getDrawingBufferSize(),r=e.clearCanvas??!0,s=e.clearColor??(!!r&&[0,0,0,0]),n=e.colorMask??15,a={viewport:[0,0,t,i]};e.colorMask&&(a.colorMask=n),e.scissorRect&&(a.scissorRect=e.scissorRect);let o=this.device.beginRenderPass({framebuffer:e.target,parameters:a,clearColor:s,clearDepth:!!r&&1,clearStencil:!!r&&0});try{return this._drawLayers(o,e)}finally{o.end(),this.device.submit()}}_drawLayers(e,t){let{target:i,shaderModuleProps:r,viewports:s,views:n,onViewportActive:a,clearStack:o=!0}=t;t.pass=t.pass||"unknown",o&&(this._lastRenderIndex=-1);let l=[];for(let o of s){let s=n&&n[o.id];a?.(o);let c=this._getDrawLayerParams(o,t);for(let n of o.subViewports||[o]){let a=this._drawLayersInViewport(e,{target:i,shaderModuleProps:r,viewport:n,view:s,pass:t.pass,layers:t.layers},c);l.push(a)}}return l}_getDrawLayerParams(e,{layers:t,pass:i,isPicking:r=!1,layerFilter:s,cullRect:n,effects:a,shaderModuleProps:o},l=!1){let c=[],u=function e(t=0,i={}){let r={},s=(n,a)=>{let o,l=n.props._offset,c=n.id,u=n.parent&&n.parent.id;if(!u||u in i||s(n.parent,!1),u in r){let t=r[u]=r[u]||e(i[u],i);o=t(n,a),r[c]=t}else Number.isFinite(l)?(o=l+(i[u]||0),r[c]=null):o=t;return a&&o>=t&&(t=o+1),i[c]=o,o};return s}(this._lastRenderIndex+1),h={layer:t[0],viewport:e,isPicking:r,renderPass:i,cullRect:n},d={};for(let r=0;r<t.length;r++){let n=t[r],f=this._shouldDrawLayer(n,h,s,d),p={shouldDrawLayer:f};f&&!l&&(p.shouldDrawLayer=!0,p.layerRenderIndex=u(n,f),p.shaderModuleProps=this._getShaderModuleProps(n,a,i,o),p.layerParameters={...n.context.deck?.props.parameters,...this.getLayerParameters(n,r,e)}),c[r]=p}return c}_drawLayersInViewport(e,{layers:t,shaderModuleProps:i,pass:r,target:s,viewport:n,view:a},o){let l=function(e,{shaderModuleProps:t,target:i,viewport:r}){let s=t?.project?.devicePixelRatio??e.canvasContext.cssToDeviceRatio(),[,n]=e.canvasContext.getDrawingBufferSize(),a=i?i.height:n;return[r.x*s,a-(r.y+r.height)*s,r.width*s,r.height*s]}(this.device,{shaderModuleProps:i,target:s,viewport:n});if(a){let{clear:e,clearColor:t,clearDepth:i,clearStencil:r}=a.props;if(e){let e=[0,0,0,0],n=1,a=0;Array.isArray(t)?e=[...t.slice(0,3),t[3]||255].map(e=>e/255):!1===t&&(e=!1),void 0!==i&&(n=i),void 0!==r&&(a=r),this.device.beginRenderPass({framebuffer:s,parameters:{viewport:l,scissorRect:l},clearColor:e,clearDepth:n,clearStencil:a}).end()}}let c={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:l});for(let i=0;i<t.length;i++){let s=t[i],a=o[i],{shouldDrawLayer:l}=a;if(l&&s.props.pickable&&c.pickableCount++,s.isComposite&&c.compositeCount++,s.isDrawable&&a.shouldDrawLayer){let{layerRenderIndex:t,shaderModuleProps:i,layerParameters:o}=a;c.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,t),i.project&&(i.project.viewport=n),s.context.renderPass=e;try{s._drawLayer({renderPass:e,shaderModuleProps:i,uniforms:{layerIndex:t},parameters:o})}catch(e){s.raiseError(e,`drawing ${s} to ${r}`)}}}return c}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,i){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,r){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let s=e.parent;for(;s;){if(!s.props.visible||!s.filterSubLayer(t))return!1;t.layer=s,s=s.parent}if(i){let e=t.layer.id;if(e in r||(r[e]=i(t)),!r[e])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,i,r){let s=this.device.canvasContext.cssToDeviceRatio(),n=e.internalState?.propsInTransition||e.props,a={layer:n,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:s,modelMatrix:n.modelMatrix,coordinateSystem:n.coordinateSystem,coordinateOrigin:n.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(let i of t)oF(a,i.getShaderModuleProps?.(e,a));return oF(a,this.getShaderModuleProps(e,t,a),r)}}function oF(e,...t){for(let i of t)if(i)for(let t in i)e[t]?Object.assign(e[t],i[t]):e[t]=i[t];return e}class oB extends oz{constructor(e,t){super(e,t);const i=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}}),r=e.createTexture({format:"depth16unorm",width:1,height:1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[i],depthStencilAttachment:r})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){let t=this.fbo,i=this.device.canvasContext.cssToDeviceRatio(),r=e.viewports[0],s=r.width*i,n=r.height*i;(s!==t.width||n!==t.height)&&t.resize({width:s,height:n}),super.render({...e,clearColor:[1,1,1,1],target:t,pass:"shadow"})}getLayerParameters(e,t,i){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return!1!==e.props.shadowEnabled}getShaderModuleProps(e,t,i){return{shadow:{project:i.project,drawToShadowMap:!0}}}}let oU={color:[255,255,255],intensity:1},o$=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],oV=[0,0,0,200/255];class oW{constructor(e={}){this.id="lighting-effect",this.shadowColor=oV,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;let{device:t,deck:i}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),i._addDefaultShaderModule(nd),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){for(let t in this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[],e){let i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i)}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(e=>e.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:i,onViewportActive:r,views:s}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let n=0;n<this.shadowPasses.length;n++)this.shadowPasses[n].render({layers:e,layerFilter:t,viewports:i,onViewportActive:r,views:s,shaderModuleProps:{shadow:{shadowLightId:n,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){let i=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(e=>e.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},r={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(t=>t.getProjectedLight({layer:e})),pointLights:this.pointLights.map(t=>t.getProjectedLight({layer:e}))},s=e.props.material;return{shadow:i,lighting:r,phongMaterial:s,gouraudMaterial:s}}cleanup(e){for(let e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(nd))}_calculateMatrices(){let e=[];for(let t of this.directionalLights){let i=new sV().lookAt({eye:new st(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){let i=new oB(e);this.shadowPasses[t]=i}}_applyDefaultLights(){let{ambientLight:e,pointLights:t,directionalLights:i}=this;e||0!==t.length||0!==i.length||(this.ambientLight=new oL(oU),this.directionalLights.push(new oj(o$[0]),new oj(o$[1])))}}let oG=new oW;class oq{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){let t=this._defaultEffects;if(!t.find(t=>t.id===e.id)){let i=t.findIndex(t=>(t.order??1/0)-(e.order??1/0)>0);i<0?t.push(e):t.splice(i,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&!oe(e.effects,this.effects,1)&&this._setEffects(e.effects)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){let t={};for(let e of this.effects)t[e.id]=e;let i=[];for(let r of e){let e=t[r.id],s=r;e&&e!==r?e.setProps?(e.setProps(r.props),s=e):e.cleanup(this._context):e||r.setup(this._context),i.push(s),delete t[r.id]}for(let e in t)t[e].cleanup(this._context);this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),e.some(e=>e instanceof oW)||this._resolvedEffects.push(oG),this._needsRedraw="effects changed"}finalize(){for(let e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class oH extends oz{shouldDrawLayer(e){let{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}let oZ={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant",blendAlphaDstFactor:"zero"};class oY extends oz{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:r,onViewportActive:s,pickingFBO:n,deviceRect:{x:a,y:o,width:l,height:c},cullRect:u,effects:h,pass:d="picking",pickZ:f,shaderModuleProps:p}){this.pickZ=f;let g=this._resetColorEncoder(f),m=super.render({target:n,layers:e,layerFilter:t,views:i,viewports:r,onViewportActive:s,cullRect:u,effects:h?.filter(e=>e.useInPicking),pass:d,isPicking:!0,shaderModuleProps:p,clearColor:[0,0,0,0],colorMask:15,scissorRect:[a,o,l,c]});return this._colorEncoderState=null,{decodePickingColor:g&&oX.bind(null,g),stats:m}}shouldDrawLayer(e){let{pickable:t,operation:i}=e.props;return t&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getShaderModuleProps(e,t,i){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,i){let r={...e.props.parameters},{pickable:s,operation:n}=e.props;return!this._colorEncoderState||n.includes("terrain")?r.blend=!1:s&&n.includes("draw")&&(Object.assign(r,oZ),r.blend=!0,r.blendColor=function(e,t,i){let r,{byLayer:s,byAlpha:n}=e,a=s.get(t);return a?(a.viewports.push(i),r=a.a):(r=s.size+1)<=255?(a={a:r,layer:t,viewports:[i]},s.set(t,a),n[r]=a):(is.warn("Too many pickable layers, only picking the first 255")(),r=0),[0,0,0,r/255]}(this._colorEncoderState,e,i)),r}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function oX(e,t){let i=e.byAlpha[t[3]];return i&&{pickedLayer:i.layer,pickedViewports:i.viewports,pickedObjectIndex:i.layer.decodePickingColor(t)}}class oK{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new oH(e),this.pickLayersPass=new oY(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;let t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};i.effects&&this._preRender(i.effects,i);let r=this.lastPostProcessEffect?this.renderBuffers[0]:i.target;this.lastPostProcessEffect&&(i.clearColor=[0,0,0,0],i.clearCanvas=!0);let s=t.render({...i,target:r});i.effects&&(this.lastPostProcessEffect&&(i.clearCanvas=void 0===e.clearCanvas||e.clearCanvas),this._postRender(i.effects,i)),this.renderCount++,nC("deckRenderer.renderLayers",this,s,e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){let{renderBuffers:e}=this;for(let t of e)t.delete();e.length=0}_preRender(e,t){for(let i of(this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{},e))t.preRenderStats[i.id]=i.preRender(t),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){let{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize(),[i,r]=t;for(let s of(0===e.length&&[0,1].map(t=>{let s=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"},width:i,height:r});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${t}`,colorAttachments:[s]}))}),e))s.resize(t)}_postRender(e,t){let{renderBuffers:i}=this,r={...t,inputBuffer:i[0],swapBuffer:i[1]};for(let s of e)if(s.postRender){r.target=s.id===this.lastPostProcessEffect?t.target:void 0;let e=s.postRender(r);r.inputBuffer=e,r.swapBuffer=e===i[0]?i[1]:i[0]}}}let oJ={pickedColor:null,pickedObjectIndex:-1};function oQ({pickedColors:e,decodePickingColor:t,deviceX:i,deviceY:r,deviceRadius:s,deviceRect:n}){let{x:a,y:o,width:l,height:c}=n,u=s*s,h=-1,d=0;for(let t=0;t<c;t++){let s=t+o-r,n=s*s;if(n>u)d+=4*l;else for(let t=0;t<l;t++){if(e[d+3]-1>=0){let e=t+a-i,r=e*e+n;r<=u&&(u=r,h=d)}d+=4}}if(h>=0){let i=e.slice(h,h+4),r=t(i);if(r){let e=Math.floor(h/4/l),t=h/4-e*l;return{...r,pickedColor:i,pickedX:a+t,pickedY:o+e}}is.error("Picked non-existent layer. Is picking buffer corrupt?")()}return oJ}function o0({pickedColors:e,decodePickingColor:t}){let i=new Map;if(e){for(let r=0;r<e.length;r+=4)if(e[r+3]-1>=0){let s=e.slice(r,r+4),n=s.join(",");if(!i.has(n)){let e=t(s);e?i.set(n,{...e,color:s}):is.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(i.values())}function o1({pickInfo:e,viewports:t,pixelRatio:i,x:r,y:s,z:n}){let a,o=t[0];if(t.length>1&&(o=function(e,t){for(let i=e.length-1;i>=0;i--){let r=e[i];if(r.containsPixel(t))return r}return e[0]}(e?.pickedViewports||t,{x:r,y:s})),o){let e=[r-o.x,s-o.y];void 0!==n&&(e[2]=n),a=o.unproject(e)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:r,y:s,pixel:[r,s],coordinate:a,devicePixel:e&&"pickedX"in e?[e.pickedX,e.pickedY]:void 0,pixelRatio:i}}function o2(e){let{pickInfo:t,lastPickedInfo:i,mode:r,layers:s}=e,{pickedColor:n,pickedLayer:a,pickedObjectIndex:o}=t,l=a?[a]:[];if("hover"===r){let e=i.index,t=i.layerId,r=a?a.props.id:null;if(r!==t||o!==e){if(r!==t){let e=s.find(e=>e.props.id===t);e&&l.unshift(e)}i.layerId=r,i.index=o,i.info=null}}let c=o1(e),u=new Map;return u.set(null,c),l.forEach(e=>{let t={...c};e===a&&(t.color=n,t.index=o,t.picked=!0);let s=(t=o3({layer:e,info:t,mode:r})).layer;e===a&&"hover"===r&&(i.info=t),u.set(s.id,t),"hover"===r&&s.updateAutoHighlight(t)}),u}function o3({layer:e,info:t,mode:i}){for(;e&&t;){let r=t.layer||null;t.sourceLayer=r,t.layer=e,t=e.getPickingInfo({info:t,mode:i,sourceLayer:r}),e=e.parent}return t}class o4{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new oY(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObjectAsync(e){return this._pickClosestObjectAsync(e)}pickObjectsAsync(e){return this._pickVisibleObjectsAsync(e)}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:r},s=this.lastPickedInfo.info){let n=s&&s.layer&&s.layer.id,a=s&&s.viewport&&s.viewport.id,o=n?i.find(e=>e.id===n):null,l=a&&r.find(e=>e.id===a)||r[0],c=l&&l.unproject([e-l.x,t-l.y]);return{...s,x:e,y:t,viewport:l,coordinate:c,layer:o}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){let e=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=e}let{canvas:e}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:e.width,height:e.height}),this.depthFBO?.resize({width:e.width,height:e.height})}_getPickable(e){if(!1===this._pickable)return null;let t=e.filter(e=>this.pickLayersPass.shouldDrawLayer(e)&&!e.isComposite);return t.length?t:null}async _pickClosestObjectAsync({layers:e,views:t,viewports:i,x:r,y:s,radius:n=0,depth:a=1,mode:o="query",unproject3D:l,onViewportActive:c,effects:u}){let h,d=this.device.canvasContext.cssToDeviceRatio(),f=this._getPickable(e);if(!f||0===i.length)return{result:[],emptyInfo:o1({viewports:i,x:r,y:s,pixelRatio:d})};this._resizeBuffer();let p=this.device.canvasContext.cssToDevicePixels([r,s],!0),g=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],m=Math.round(n*d),{width:y,height:v}=this.pickingFBO,x=this._getPickingRect({deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceWidth:y,deviceHeight:v}),_={x:r-n,y:s-n,width:2*n+1,height:2*n+1},b=[],w=new Set;for(let e=0;e<a;e++){let n,p;if((n=x?oQ({...this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:c,deviceRect:x,cullRect:_,effects:u,pass:`picking:${o}`}),deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceRect:x}):{pickedColor:null,pickedObjectIndex:-1}).pickedLayer&&l&&this.depthFBO){let{pickedColors:e}=this._drawAndSample({layers:[n.pickedLayer],views:t,viewports:i,onViewportActive:c,deviceRect:{x:n.pickedX,y:n.pickedY,width:1,height:1},cullRect:_,effects:u,pass:`picking:${o}:z`},!0);e[3]&&(p=e[0])}for(let t of(n.pickedLayer&&e+1<a&&(w.add(n.pickedLayer),n.pickedLayer.disablePickingIndex(n.pickedObjectIndex)),(h=o2({pickInfo:n,lastPickedInfo:this.lastPickedInfo,mode:o,layers:f,viewports:i,x:r,y:s,z:p,pixelRatio:d})).values()))t.layer&&b.push(t);if(!n.pickedColor)break}for(let e of w)e.restorePickingColors();return{result:b,emptyInfo:h.get(null)}}_pickClosestObject({layers:e,views:t,viewports:i,x:r,y:s,radius:n=0,depth:a=1,mode:o="query",unproject3D:l,onViewportActive:c,effects:u}){let h,d=this.device.canvasContext.cssToDeviceRatio(),f=this._getPickable(e);if(!f||0===i.length)return{result:[],emptyInfo:o1({viewports:i,x:r,y:s,pixelRatio:d})};this._resizeBuffer();let p=this.device.canvasContext.cssToDevicePixels([r,s],!0),g=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],m=Math.round(n*d),{width:y,height:v}=this.pickingFBO,x=this._getPickingRect({deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceWidth:y,deviceHeight:v}),_={x:r-n,y:s-n,width:2*n+1,height:2*n+1},b=[],w=new Set;for(let e=0;e<a;e++){let n,p;if((n=x?oQ({...this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:c,deviceRect:x,cullRect:_,effects:u,pass:`picking:${o}`}),deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceRect:x}):{pickedColor:null,pickedObjectIndex:-1}).pickedLayer&&l&&this.depthFBO){let{pickedColors:e}=this._drawAndSample({layers:[n.pickedLayer],views:t,viewports:i,onViewportActive:c,deviceRect:{x:n.pickedX,y:n.pickedY,width:1,height:1},cullRect:_,effects:u,pass:`picking:${o}:z`},!0);e[3]&&(p=e[0])}for(let t of(n.pickedLayer&&e+1<a&&(w.add(n.pickedLayer),n.pickedLayer.disablePickingIndex(n.pickedObjectIndex)),(h=o2({pickInfo:n,lastPickedInfo:this.lastPickedInfo,mode:o,layers:f,viewports:i,x:r,y:s,z:p,pixelRatio:d})).values()))t.layer&&b.push(t);if(!n.pickedColor)break}for(let e of w)e.restorePickingColors();return{result:b,emptyInfo:h.get(null)}}async _pickVisibleObjectsAsync({layers:e,views:t,viewports:i,x:r,y:s,width:n=1,height:a=1,mode:o="query",maxObjects:l=null,onViewportActive:c,effects:u}){let h=this._getPickable(e);if(!h||0===i.length)return[];this._resizeBuffer();let d=this.device.canvasContext.cssToDeviceRatio(),f=this.device.canvasContext.cssToDevicePixels([r,s],!0),p=f.x,g=f.y+f.height,m=this.device.canvasContext.cssToDevicePixels([r+n,s+a],!0),y=m.x+m.width,v=m.y,x=this._drawAndSample({layers:h,views:t,viewports:i,onViewportActive:c,deviceRect:{x:p,y:v,width:y-p,height:g-v},cullRect:{x:r,y:s,width:n,height:a},effects:u,pass:`picking:${o}`}),_=o0(x),b=new Map,w=[],k=Number.isFinite(l);for(let e=0;e<_.length&&(!k||!(w.length>=l));e++){let t=_[e],i={color:t.pickedColor,layer:null,index:t.pickedObjectIndex,picked:!0,x:r,y:s,pixelRatio:d},n=(i=o3({layer:t.pickedLayer,info:i,mode:o})).layer.id;b.has(n)||b.set(n,new Set);let a=b.get(n),l=i.object??i.index;a.has(l)||(a.add(l),w.push(i))}return w}_pickVisibleObjects({layers:e,views:t,viewports:i,x:r,y:s,width:n=1,height:a=1,mode:o="query",maxObjects:l=null,onViewportActive:c,effects:u}){let h=this._getPickable(e);if(!h||0===i.length)return[];this._resizeBuffer();let d=this.device.canvasContext.cssToDeviceRatio(),f=this.device.canvasContext.cssToDevicePixels([r,s],!0),p=f.x,g=f.y+f.height,m=this.device.canvasContext.cssToDevicePixels([r+n,s+a],!0),y=m.x+m.width,v=m.y,x=this._drawAndSample({layers:h,views:t,viewports:i,onViewportActive:c,deviceRect:{x:p,y:v,width:y-p,height:g-v},cullRect:{x:r,y:s,width:n,height:a},effects:u,pass:`picking:${o}`}),_=o0(x),b=new Map,w=[],k=Number.isFinite(l);for(let e=0;e<_.length&&(!k||!(w.length>=l));e++){let t=_[e],i={color:t.pickedColor,layer:null,index:t.pickedObjectIndex,picked:!0,x:r,y:s,pixelRatio:d},n=(i=o3({layer:t.pickedLayer,info:i,mode:o})).layer.id;b.has(n)||b.set(n,new Set);let a=b.get(n),l=i.object??i.index;a.has(l)||(a.add(l),w.push(i))}return w}async _drawAndSampleAsync({layers:e,views:t,viewports:i,onViewportActive:r,deviceRect:s,cullRect:n,effects:a,pass:o},l=!1){let c=l?this.depthFBO:this.pickingFBO,u={layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:r,pickingFBO:c,deviceRect:s,cullRect:n,effects:a,pass:o,pickZ:l,preRenderStats:{},isPicking:!0};for(let e of a)e.useInPicking&&(u.preRenderStats[e.id]=e.preRender(u));let{decodePickingColor:h}=this.pickLayersPass.render(u),{x:d,y:f,width:p,height:g}=s,m=new(l?Float32Array:Uint8Array)(p*g*4);return this.device.readPixelsToArrayWebGL(c,{sourceX:d,sourceY:f,sourceWidth:p,sourceHeight:g,target:m}),{pickedColors:m,decodePickingColor:h}}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:r,deviceRect:s,cullRect:n,effects:a,pass:o},l=!1){let c=l?this.depthFBO:this.pickingFBO,u={layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:r,pickingFBO:c,deviceRect:s,cullRect:n,effects:a,pass:o,pickZ:l,preRenderStats:{},isPicking:!0};for(let e of a)e.useInPicking&&(u.preRenderStats[e.id]=e.preRender(u));let{decodePickingColor:h}=this.pickLayersPass.render(u),{x:d,y:f,width:p,height:g}=s,m=new(l?Float32Array:Uint8Array)(p*g*4);return this.device.readPixelsToArrayWebGL(c,{sourceX:d,sourceY:f,sourceWidth:p,sourceHeight:g,target:m}),{pickedColors:m,decodePickingColor:h}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:r,deviceHeight:s}){let n=Math.max(0,e-i),a=Math.max(0,t-i),o=Math.min(r,e+i+1)-n,l=Math.min(s,t+i+1)-a;return o<=0||l<=0?null:{x:n,y:a,width:o,height:l}}}let o6={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},o5="__root";class o8{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,t?.classList.add("deck-widget-container"),this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){if(e.widgets&&!oe(e.widgets,this.widgets,1)){let t=e.widgets.filter(Boolean);this._setWidgets(t)}}finalize(){for(let e of this.getWidgets())this._removeWidget(e);for(let e in this.defaultWidgets.length=0,this.resolvedWidgets.length=0,this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._addWidget(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}onRedraw({viewports:e,layers:t}){let i=e.reduce((e,t)=>(e[t.id]=t,e),{});for(let r of this.getWidgets()){let{viewId:s}=r;if(s){let e=i[s];e&&(r.onViewportChange&&r.onViewportChange(e),r.onRedraw?.({viewports:[e],layers:t}))}else{if(r.onViewportChange)for(let t of e)r.onViewportChange(t);r.onRedraw?.({viewports:e,layers:t})}}this.lastViewports=i,this._updateContainers()}onHover(e,t){for(let i of this.getWidgets()){let{viewId:r}=i;r&&r!==e.viewport?.id||i.onHover?.(e,t)}}onEvent(e,t){let i=iQ[t.type];if(i)for(let r of this.getWidgets()){let{viewId:s}=r;s&&s!==e.viewport?.id||r[i]?.(e,t)}}_setWidgets(e){let t={};for(let e of this.resolvedWidgets)t[e.id]=e;for(let e of(this.resolvedWidgets.length=0,this.defaultWidgets))t[e.id]=null,this.resolvedWidgets.push(e);for(let i of e){let e=t[i.id];e?e.viewId!==i.viewId||e.placement!==i.placement?(this._removeWidget(e),this._addWidget(i)):i!==e&&(e.setProps(i.props),i=e):this._addWidget(i),t[i.id]=null,this.resolvedWidgets.push(i)}for(let e in t){let i=t[e];i&&this._removeWidget(i)}this.widgets=e}_addWidget(e){let{viewId:t=null,placement:i="top-left"}=e;e.widgetManager=this,e.deck=this.deck,e.rootElement=e._onAdd({deck:this.deck,viewId:t}),e.rootElement&&this._getContainer(t,i).append(e.rootElement),e.updateHTML()}_removeWidget(e){e.onRemove?.(),e.rootElement&&e.rootElement.remove(),e.rootElement=void 0,e.deck=void 0,e.widgetManager=void 0}_getContainer(e,t){let i=e||o5,r=this.containers[i];r||((r=document.createElement("div")).style.pointerEvents="none",r.style.position="absolute",r.style.overflow="hidden",this.parentElement?.append(r),this.containers[i]=r);let s=r.querySelector(`.${t}`);return s||((s=globalThis.document.createElement("div")).className=t,s.style.position="absolute",s.style.zIndex="2",Object.assign(s.style,o6[t]),r.append(s)),s}_updateContainers(){let e=this.deck.width,t=this.deck.height;for(let i in this.containers){let r=this.lastViewports[i]||null,s=i===o5||r,n=this.containers[i];s?(n.style.display="block",n.style.left=`${r?r.x:0}px`,n.style.top=`${r?r.y:0}px`,n.style.width=`${r?r.width:e}px`,n.style.height=`${r?r.height:t}px`):n.style.display="none"}}}function o7(e,t){t&&Object.entries(t).map(([t,i])=>{t.startsWith("--")?e.style.setProperty(t,i):e.style[t]=i})}class o9{constructor(e){this.viewId=null,this.props={...this.constructor.defaultProps,...e},this.id=this.props.id}setProps(e){let t=this.props,i=this.rootElement;if(i&&t.className!==e.className&&(t.className&&i.classList.remove(t.className),e.className&&i.classList.add(e.className)),i&&!oe(t.style,e.style,1)){var r;(r=t.style)&&Object.keys(r).map(e=>{e.startsWith("--")?i.style.removeProperty(e):i.style[e]=""}),o7(i,e.style)}Object.assign(this.props,e),this.updateHTML()}updateHTML(){this.rootElement&&this.onRenderHTML(this.rootElement)}onCreateRootElement(){let e=["deck-widget",this.className,this.props.className],t=document.createElement("div");return e.filter(e=>"string"==typeof e&&e.length>0).forEach(e=>t.classList.add(e)),o7(t,this.props.style),t}_onAdd(e){return this.onAdd(e)??this.onCreateRootElement()}onAdd(e){}onRemove(){}onViewportChange(e){}onRedraw(e){}onHover(e,t){}onClick(e,t){}onDrag(e,t){}onDragStart(e,t){}onDragEnd(e,t){}}o9.defaultProps={id:"widget",style:{},className:""};let le={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class lt extends o9{constructor(e={}){super(e),this.id="default-tooltip",this.placement="fill",this.className="deck-tooltip",this.isVisible=!1,this.setProps(e)}onCreateRootElement(){let e=document.createElement("div");return e.className=this.className,Object.assign(e.style,le),e}onRenderHTML(e){}onViewportChange(e){this.isVisible&&e.id===this.lastViewport?.id&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){let{deck:t}=this,i=t&&t.props.getTooltip;if(!i)return;let r=i(e);this.lastViewport=e.viewport,this.setTooltip(r,e.x,e.y)}setTooltip(e,t,i){let r=this.rootElement;if(r){if("string"==typeof e)r.innerText=e;else if(e)e.text&&(r.innerText=e.text),e.html&&(r.innerHTML=e.html),e.className&&(r.className=e.className);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform=`translate(${t}px, ${i}px)`,e&&"object"==typeof e&&"style"in e&&Object.assign(r.style,e.style)}}}lt.defaultProps={...o9.defaultProps};let li=globalThis.loaders?.parseImageNode,lr="undefined"!=typeof Image,ls="undefined"!=typeof ImageBitmap,ln=!!n6||!!li,la=/^data:image\/svg\+xml/,lo=/\.svg((\?|#).*)?$/;function ll(e){return e&&(la.test(e)||lo.test(e))}function lc(e,t){if(ll(t))throw Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}async function lu(e,t,i){let r=function(e,t){if(ll(t)){let t=new TextDecoder().decode(e);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(t=unescape(encodeURIComponent(t)))}catch(e){throw Error(e.message)}return`data:image/svg+xml;base64,${btoa(t)}`}return lc(e,t)}(e,i),s=self.URL||self.webkitURL,n="string"!=typeof r&&s.createObjectURL(r);try{return await lh(n||r,t)}finally{n&&s.revokeObjectURL(n)}}async function lh(e,t){let i=new Image;return(i.src=e,t.image&&t.image.decode&&i.decode)?(await i.decode(),i):await new Promise((e,t)=>{try{i.onload=()=>e(i),i.onerror=e=>{let i=e instanceof Error?e.message:"error";t(Error(i))}}catch(e){t(e)}})}let ld={},lf=!0;async function lp(e,t,i){let r;r=ll(i)?await lu(e,t,i):lc(e,i);let s=t&&t.imagebitmap;return await lg(r,s)}async function lg(e,t=null){if((function(e){for(let t in e||ld)return!1;return!0}(t)||!lf)&&(t=null),t)try{return await createImageBitmap(e,t)}catch(e){console.warn(e),lf=!1}return await createImageBitmap(e)}function lm(e){var t,i;let r,s,n,a,o=ly(e);return((r=ly(o)).byteLength>=24&&0x89504e47===r.getUint32(0,!1)?{mimeType:"image/png",width:r.getUint32(16,!1),height:r.getUint32(20,!1)}:null)||function(e){let t=ly(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,!1)&&255===t.getUint8(2)))return null;let{tableMarkers:i,sofMarkers:r}=function(){let e=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)e.add(t);return{tableMarkers:e,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}(),s=2;for(;s+9<t.byteLength;){let e=t.getUint16(s,!1);if(r.has(e))return{mimeType:"image/jpeg",height:t.getUint16(s+5,!1),width:t.getUint16(s+7,!1)};if(!i.has(e))break;s+=2,s+=t.getUint16(s,!1)}return null}(o)||((s=ly(o)).byteLength>=10&&0x47494638===s.getUint32(0,!1)?{mimeType:"image/gif",width:s.getUint16(6,!0),height:s.getUint16(8,!0)}:null)||((n=ly(o)).byteLength>=14&&16973===n.getUint16(0,!1)&&n.getUint32(2,!0)===n.byteLength?{mimeType:"image/bmp",width:n.getUint32(18,!0),height:n.getUint32(22,!0)}:null)||((a=!function(e,t,i=0){let r=[...t].map(e=>e.charCodeAt(0));for(let t=0;t<r.length;++t)if(r[t]!==e[t+i])return!1;return!0}(i=new Uint8Array((t=o)instanceof DataView?t.buffer:t),"ftyp",4)||(96&i[8])==0?null:function(e){switch(String.fromCharCode(...e.slice(8,12)).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}(i))?{mimeType:a.mimeType,width:0,height:0}:null)}function ly(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw Error("toDataView")}async function lv(e,t){let{mimeType:i}=lm(e)||{},r=globalThis.loaders?.parseImageNode;return nN(r),await r(e,i)}let lx={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:"4.3.3",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:async function e(e,t,i){let r,s=((t=t||{}).image||{}).type||"auto",{url:n}=i||{};switch(function(e){switch(e){case"auto":case"data":if(ls)return"imagebitmap";if(lr)return"image";if(ln)return"data";throw Error("Install '@loaders.gl/polyfills' to parse images under Node.js");default:return!function(e){switch(e){case"auto":return ls;case"imagebitmap":case"image":case"data":return;default:throw Error(`@loaders.gl/images: image ${e} not supported in this environment`)}}(e),e}}(s)){case"imagebitmap":r=await lp(e,t,n);break;case"image":r=await lu(e,t,n);break;case"data":r=await lv(e,t);break;default:nN(!1)}return"data"===s&&(r=function(e){switch(function(e){var t;let i=(t=e,"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?"imagebitmap":"undefined"!=typeof Image&&t instanceof Image?"image":t&&"object"==typeof t&&t.data&&t.width&&t.height?"data":null);if(!i)throw Error("Not an image");return i}(e)){case"data":return e;case"image":case"imagebitmap":let t=document.createElement("canvas"),i=t.getContext("2d");if(!i)throw Error("getImageData");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height);default:throw Error("getImageData")}}(r)),r},tests:[e=>!!lm(new DataView(e))],options:{image:{type:"auto",decode:!0}}},l_={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:function(e){let t=e[0],i=e[e.length-1];return"{"===t&&"}"===i||"["===t&&"]"===i},parseTextSync:JSON.parse},lb=function(){let e="9.2.2",t=globalThis.deck&&globalThis.deck.VERSION;if(t&&t!==e)throw Error(`deck.gl - multiple versions detected: ${t} vs ${e}`);if(!t){is.log(1,`deck.gl ${e}`)(),globalThis.deck={...globalThis.deck,VERSION:e,version:e,log:is,_registerLoggers:nT};var i=[l_,[lx,{imagebitmap:{premultiplyAlpha:"none"}}]];let t=aj();for(let e of i=Array.isArray(i)?i:[i]){let i=nD(e);t.find(e=>i===e)||t.unshift(i)}}return e}();var lw=e.i(9900),lk=e.i(4819);let lP="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class lS{static defaultProps={...lw.Device.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};stats=lk.lumaStats;log=eM.log;VERSION="9.2.3";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw eM.log.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),eM.log.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),Error("luma.gl - multiple versions detected: see console log");eM.log.error("This version of luma.gl has already been initialized")()}eM.log.log(1,`${this.VERSION} - set luma.log.level=1 (or higher) to trace rendering`)(),globalThis.luma=this}async createDevice(e={}){let t={...lS.defaultProps,...e},i=this.selectAdapter(t.type,t.adapters);if(!i)throw Error(lP);return t.waitForPageLoad&&await i.pageLoaded,await i.create(t)}async attachDevice(e,t){let i=this._getTypeFromHandle(e,t.adapters),r=i&&this.selectAdapter(i,t.adapters);if(!r)throw Error(lP);return await r?.attach?.(e,t)}registerAdapters(e){for(let t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){return Array.from(this._getAdapterMap(e)).map(([,e])=>e).filter(e=>e.isSupported?.()).map(e=>e.type)}getBestAvailableAdapterType(e=[]){let t=this._getAdapterMap(e);for(let e of["webgpu","webgl","null"])if(t.get(e)?.isSupported?.())return e;return null}selectAdapter(e,t=[]){let i=e;"best-available"===e&&(i=this.getBestAvailableAdapterType(t));let r=this._getAdapterMap(t);return i&&r.get(i)||null}enforceWebGL2(e=!0,t=[]){let i=this._getAdapterMap(t).get("webgl");i||eM.log.warn("enforceWebGL2: webgl adapter not found")(),i?.enforceWebGL2?.(e)}setDefaultDeviceProps(e){Object.assign(lS.defaultProps,e)}_getAdapterMap(e=[]){let t=new Map(this.preregisteredAdapters);for(let i of e)t.set(i.type,i);return t}_getTypeFromHandle(e,t=[]){return e instanceof WebGL2RenderingContext?"webgl":"undefined"!=typeof GPUDevice&&e instanceof GPUDevice||e?.queue?"webgpu":null===e?"null":(e instanceof WebGLRenderingContext?eM.log.warn("WebGL1 is not supported",e)():eM.log.warn("Unknown handle type",e)(),null)}}let lT=new lS;var lC=e.i(40021);class lM{get pageLoaded(){return lI||(lI=lA&&"complete"===document.readyState||"undefined"==typeof window?Promise.resolve():new Promise(e=>window.addEventListener("load",()=>e()))),lI}}let lA=(0,lC.isBrowser)()&&"undefined"!=typeof document,lI=null,lE={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}};var lL=e.i(31934),lO=e.i(7784);let lR=new class extends lM{type="webgl";constructor(){super(),lw.Device.defaultProps={...lw.Device.defaultProps,...lL.DEFAULT_SPECTOR_PROPS}}enforceWebGL2(e){!function(e=!0){let t=HTMLCanvasElement.prototype;if(!e&&t.originalGetContext){t.getContext=t.originalGetContext,t.originalGetContext=void 0;return}t.originalGetContext=t.getContext,t.getContext=function(e,t){if("webgl"===e||"experimental-webgl"===e){let e=this.originalGetContext("webgl2",t);return e instanceof HTMLElement&&function(e){e.getExtension("EXT_color_buffer_float");let t={...lE,WEBGL_disjoint_timer_query:e.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:{drawBuffersWEBGL:t=>e.drawBuffers(t),COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067},OES_vertex_array_object:{VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES:()=>e.createVertexArray(),deleteVertexArrayOES:t=>e.deleteVertexArray(t),isVertexArrayOES:t=>e.isVertexArray(t),bindVertexArrayOES:t=>e.bindVertexArray(t)},ANGLE_instanced_arrays:{VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE:(...t)=>e.drawArraysInstanced(...t),drawElementsInstancedANGLE:(...t)=>e.drawElementsInstanced(...t),vertexAttribDivisorANGLE:(...t)=>e.vertexAttribDivisor(...t)}},i=e.getExtension;e.getExtension=function(r){let s=i.call(e,r);return s||(r in t?t[r]:null)};let r=e.getSupportedExtensions;e.getSupportedExtensions=function(){let i=r.apply(e)||[];return i?.concat(Object.keys(t))}}(e),e}return this.originalGetContext(e,t)}}(e)}isSupported(){return"undefined"!=typeof WebGL2RenderingContext}isDeviceHandle(e){return!!("undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext)||("undefined"!=typeof WebGLRenderingContext&&e instanceof WebGLRenderingContext&&eM.log.warn("WebGL1 is not supported",e)(),!1)}async attach(t,i={}){var r;let{WebGLDevice:s}=await e.A(76084);if(t instanceof s)return t;if(t?.device instanceof s)return t.device;if(r=t,!("undefined"!=typeof WebGL2RenderingContext&&r instanceof WebGL2RenderingContext||r&&Number.isFinite(r._version)))throw Error("Invalid WebGL2RenderingContext");let n=!0===i.createCanvasContext?{}:i.createCanvasContext;return new s({...i,_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1,...n}})}async create(t={}){let{WebGLDevice:i}=await e.A(76084);eM.log.groupCollapsed(1,"WebGLDevice created")();try{let e=[];for(let i of((t.debugWebGL||t.debug)&&e.push((0,lO.loadWebGLDeveloperTools)()),t.debugSpectorJS&&e.push((0,lL.loadSpectorJS)(t)),await Promise.allSettled(e)))"rejected"===i.status&&eM.log.error(`Failed to initialize debug libraries ${i.reason}`)();let r=new i(t),s=`\
${r._reused?"Reusing":"Created"} device with WebGL2 ${r.props.debug?"debug ":""}context: \
${r.info.vendor}, ${r.info.renderer} for canvas: ${r.canvasContext.id}`;return eM.log.probe(1,s)(),eM.log.table(1,r.info)(),r}finally{eM.log.groupEnd(1)()}}},lN=0;class lj{static defaultAnimationLoopProps={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:e=>console.error(e),stats:lT.stats.get(`animation-loop-${lN++}`),autoResizeViewport:!1};device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(e){if(this.props={...lj.defaultAnimationLoopProps,...e},!(e=this.props).device)throw Error("No device provided");this.stats=e.stats||new nA.Stats({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}reportError(e){this.props.onError(e),this._error=e}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;if(this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),!this._running)return null;return!1!==e&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this}catch(t){let e=t instanceof Error?t:Error("Unknown error");throw this.props.onError(e),e}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error||(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers()),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){if(this._running){var e;this._animationFrameId=(e=this._animationFrame.bind(this),"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(e):setTimeout(e,1e3/60))}}_cancelAnimationFrame(){if(null!==this._animationFrameId){var e;e=this._animationFrameId,"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(e):clearTimeout(e),this._animationFrameId=null}}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){this.display?this.display._renderFrame(e):(this.props.onRender(this._getAnimationProps()),this.device?.submit())}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeViewport()}_initializeAnimationProps(){let e=this.device?.getDefaultCanvasContext();if(!this.device||!e)throw Error("loop");let t=e?.canvas,i=e.props.useDevicePixels;this.animationProps={animationLoop:this,device:this.device,canvasContext:e,canvas:t,useDevicePixels:i,timeline:this.timeline,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;let{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw Error("No device provided");this.canvas=this.device.getDefaultCanvasContext().canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){let e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";let t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);let i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};let[e,t]=this.device?.getDefaultCanvasContext().getDevicePixelSize()||[1,1],i=1,r=this.device?.getDefaultCanvasContext().canvas;return r&&r.clientHeight?i=r.clientWidth/r.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}function lD(){}let lz={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:lD,onWebGLInitialized:lD,onResize:lD,onViewStateChange:lD,onInteractionStateChange:lD,onBeforeRender:lD,onAfterRender:lD,onLoad:lD,onError:e=>is.error(e.message,e.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:({isDragging:e})=>e?"grabbing":"grab",getTooltip:null,debug:!1,drawPickingColors:!1};class lF{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new nA.Stats({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=e=>{let{_pickRequest:t}=this;if("pointerleave"===e.type)t.x=-1,t.y=-1,t.radius=0;else{if(e.leftButton||e.rightButton)return;let i=e.offsetCenter;if(!i)return;t.x=i.x,t.y=i.y,t.radius=this.props.pickingRadius}this.layerManager&&(this.layerManager.context.mousePosition={x:t.x,y:t.y}),t.event=e},this._onEvent=e=>{let t=iQ[e.type],i=e.offsetCenter;if(!t||!i||!this.layerManager)return;let r=this.layerManager.getLayers(),s=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:r,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:n}=s,a=n&&(n[t]||n.props[t]),o=this.props[t],l=!1;a&&(l=a.call(n,s,e)),l||(o?.(s,e),this.widgetManager.onEvent(s,e))},this._onPointerDown=e=>{if(this.device?.type==="webgpu")return;let t=e.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:t.x,y:t.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo},this.props={...lz,...e},(e=this.props).viewState&&e.initialViewState&&is.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&is.error("WebGL1 context not supported.")(),t=lR.attach(e.gl,this.props.deviceProps)),t||(t=this._createDevice(e)),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&aK.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,this.props.canvas||this.props.device||this.props.gl||!this.canvas||(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&is.removed("onLayerHover","onHover")(),"onLayerClick"in e&&is.removed("onLayerClick","onClick")(),e.initialViewState&&!oe(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);let t=Object.create(this.props);if(Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),e.device&&e.device.id!==this.device?.id&&(this.animationLoop?.stop(),this.canvas!==e.device.canvasContext?.canvas&&(this.canvas?.remove(),this.eventManager?.destroy(),this.canvas=null),is.log(`recreating animation loop for new device! id=${e.device.id}`)(),this.animationLoop=this._createAnimationLoop(e.device,e),this.animationLoop.start()),this.animationLoop?.setProps(t),void 0!==e.useDevicePixels&&this.device?.canvasContext?.canvas instanceof HTMLCanvasElement){this.device.canvasContext.props.useDevicePixels=e.useDevicePixels;let t=this.device.canvasContext.canvas,i={target:t,contentBoxSize:[{inlineSize:t.clientWidth,blockSize:t.clientHeight}],devicePixelContentBoxSize:[{inlineSize:t.clientWidth,blockSize:t.clientHeight}],borderBoxSize:[{inlineSize:t.clientWidth,blockSize:t.clientHeight}]};this.device.canvasContext._handleResize([i])}this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);let i=this.viewManager.needsRedraw(e),r=this.layerManager.needsRedraw(e),s=this.effectManager.needsRedraw(e),n=this.deckRenderer.needsRedraw(e);return t||i||r||s||n}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});(t=e||t)&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return null!==this.viewManager}getViews(){return oh(this.viewManager),this.viewManager.views}getViewports(e){return oh(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){let t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(let i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(let t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){this.layerManager?.removeDefaultShaderModule(e)}_pick(e,t,i){oh(this.deckPicker);let{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(t).timeStart();let s=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return r.get(t).timeEnd(),s}_createCanvas(e){let t=e.canvas;return"string"==typeof t&&oh(t=document.getElementById(t)),t||((t=document.createElement("canvas")).id=e.id||"deckgl-overlay",e.width&&"number"==typeof e.width&&(t.width=e.width),e.height&&"number"==typeof e.height&&(t.height=e.height),(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;let{width:t,height:i}=e;if(t||0===t){let e=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=e}if(i||0===i){let t=Number.isFinite(i)?`${i}px`:i;this.canvas.style.position=e.style?.position||"absolute",this.canvas.style.height=t}}_updateCanvasSize(){let{canvas:e}=this;if(!e)return;let t=e.clientWidth??e.width,i=e.clientHeight??e.height;(t!==this.width||i!==this.height)&&(this.width=t,this.height=i,this.viewManager?.setProps({width:t,height:i}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:i}))}_createAnimationLoop(e,t){let{gl:i,onError:r}=t;return new lj({device:e,autoResizeDrawingBuffer:!i,autoResizeViewport:!1,onInitialize:e=>this._setDevice(e.device),onRender:this._onRenderFrame.bind(this),onError:r})}_createDevice(e){let t=this.props.deviceProps?.createCanvasContext,i={adapters:[],...e.deviceProps};i.adapters.includes(lR)||i.adapters.push(lR);let r={alphaMode:this.props.deviceProps?.type==="webgpu"?"premultiplied":void 0};return lT.createDevice({_reuseDevices:!0,type:"webgl",...i,createCanvasContext:{...r,..."object"==typeof t?t:void 0,canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!0}})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new oA({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){let{onError:e}=this.props;this.animationLoop&&e&&e(Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;let{_pickRequest:e}=this;if(e.event){let{result:t,emptyInfo:i}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=t.length>0;let r=i,s=!1;for(let i of t)r=i,s=i.layer?.onHover(i,e.event)||s;s||(this.props.onHover?.(r,e.event),this.widgetManager.onHover(r,e.event)),e.event=null}}_updateCursor(){let e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas,!this.canvas.isConnected&&this.props.parent&&this.props.parent.insertBefore(this.canvas,this.props.parent.firstChild)),"webgl"===this.device.type&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),"webgl"===this.device.type&&this.props.onWebGLInitialized(this.device.gl);let t=new ee;for(let e in t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new iY(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(i0).map(e=>{let[t,i,r,s]=i0[e],n=this.props.eventRecognizerOptions?.[e];return{recognizer:new t({...i,...n,event:e}),recognizeWith:r,requestFailure:s}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}}),iQ)this.eventManager.on(e,this._onEvent);this.viewManager=new ot({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let i=this.viewManager.getViewports()[0];this.layerManager=new a9(this.device,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new oq({deck:this,device:this.device}),this.deckRenderer=new oK(this.device),this.deckPicker=new o4(this.device),this.widgetManager=new o8({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new lt),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){let{device:i,gl:r}=this.layerManager.context;this.props.onBeforeRender({device:i,gl:r});let s={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};this.deckRenderer?.renderLayers(s),"screen"===s.pass&&this.widgetManager.onRedraw({viewports:s.viewports,layers:s.layers}),this.props.onAfterRender({device:i,gl:r})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60==0&&(this._getMetrics(),this.stats.reset(),is.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){let t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},!this.props.viewState&&this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){let{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();let t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();let i=lT.stats.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}}lF.defaultProps=lz,lF.VERSION=lb;let lB="undefined"!=typeof window?D.useLayoutEffect:D.useEffect;function lU(e,t){for(;e;){if(e===t)return!0;e=Object.getPrototypeOf(e)}return!1}var l$=e.i(6145),lV=e.i(95002),lW=e.i(44135);let lG=lW.getDataType;function lq(e,t,i){let r="webgpu"===i&&"uint8"===t.type?"unorm8":t.type;return{attribute:e,format:t.size>1?`${r}x${t.size}`:t.type,byteOffset:t.offset||0}}function lH(e){return e.stride||e.size*e.bytesPerElement}function lZ(e,t){t.offset&&is.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let i=lH(e),r=(void 0!==t.vertexOffset?t.vertexOffset:e.vertexOffset||0)*i+(t.elementOffset||0)*e.bytesPerElement+(e.offset||0);return{...t,offset:r,stride:i}}class lY{constructor(e,t,i){let r;this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const s=t.logicalType||t.type,n="float64"===s;let{defaultValue:a}=t;a=Number.isFinite(a)?[a]:a||Array(this.size).fill(0),r=n?"float32":!s&&t.isIndexed?"uint32":s||"float32";let o=function(e){switch(e){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return(0,lW.getTypedArrayConstructor)(e)}}(s||r);this.doublePrecision=n,n&&!1===t.fp64&&(o=Float32Array),this.value=null,this.settings={...t,defaultType:o,defaultValue:a,logicalType:s,type:r,normalized:r.includes("norm"),size:this.size,bytesPerElement:o.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*lH(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),aK.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){let i={};if(this.state.constant){let r=this.value;if(t){let s=lZ(this.getAccessor(),t),n=s.offset/r.BYTES_PER_ELEMENT,a=s.size||this.size;i[e]=r.subarray(n,n+a)}else i[e]=r}else i[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?i[`${e}64Low`]=i[e]:i[`${e}64Low`]=new Float32Array(this.size)),i}_getBufferLayout(e=this.id,t=null){let i=this.getAccessor(),r=[],s={name:this.id,byteStride:lH(i),attributes:r};if(this.doublePrecision){let s,n={high:s=lZ(i,t||{}),low:{...s,offset:s.offset+4*i.size}};r.push(lq(e,{...i,...n.high},this.device.type),lq(`${e}64Low`,{...i,...n.low},this.device.type))}else if(t){let s=lZ(i,t);r.push(lq(e,{...i,...s},this.device.type))}else r.push(lq(e,i,this.device.type));return s}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:i,size:r}=this,s=i*r;if(t&&s&&t.length>=s){let i=Array(r).fill(1/0),n=Array(r).fill(-1/0);for(let e=0;e<s;)for(let s=0;s<r;s++){let r=t[e++];r<i[s]&&(i[s]=r),r>n[s]&&(n[s]=r)}e=[i,n]}}return this.state.bounds=e,e}setData(e){let t,{state:i}=this;t=ArrayBuffer.isView(e)?{value:e}:e instanceof l$.Buffer?{buffer:e}:e;let r={...this.settings,...t};if(ArrayBuffer.isView(t.value)){if(!t.type)if(this.doublePrecision&&t.value instanceof Float64Array)r.type="float32";else{let e=lG(t.value);r.type=r.normalized?e.replace("int","norm"):e}r.bytesPerElement=t.value.BYTES_PER_ELEMENT,r.stride=lH(r)}if(i.bounds=null,t.constant){let e=t.value;if(e=this._normalizeValue(e,[],0),this.settings.normalized&&(e=this.normalizeConstant(e)),!(!i.constant||!this._areValuesEqual(e,this.value)))return!1;i.externalBuffer=null,i.constant=!0,this.value=ArrayBuffer.isView(e)?e:new Float32Array(e)}else if(t.buffer)i.externalBuffer=t.buffer,i.constant=!1,this.value=t.value||null;else if(t.value){this._checkExternalBuffer(t);let e=t.value;i.externalBuffer=null,i.constant=!1,this.value=e;let{buffer:s}=this,n=lH(r),a=(r.vertexOffset||0)*n;if(this.doublePrecision&&e instanceof Float64Array&&(e=a1(e,r)),this.settings.isIndexed){let t=this.settings.defaultType;e.constructor!==t&&(e=new t(e))}let o=e.byteLength+a+2*n;(!s||s.byteLength<o)&&(s=this._createBuffer(o)),s.write(e,a)}return this.setAccessor(r),!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:i=0,endOffset:r}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?a1(t,{size:this.size,startIndex:i,endIndex:r}):t.subarray(i,r),i*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){let{state:i}=this,r=i.allocatedValue,s=aK.allocate(r,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=s;let{byteOffset:n}=this,{buffer:a}=this;return(!a||a.byteLength<s.byteLength+n)&&(a=this._createBuffer(s.byteLength+n),t&&r&&a.write(r instanceof Float64Array?a1(r,this):r,n)),i.allocatedValue=s,i.constant=!1,i.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw Error(`Attribute ${this.id} value is not TypedArray`);let i=this.settings.defaultType,r=!1;if(this.doublePrecision&&(r=t.BYTES_PER_ELEMENT<4),r)throw Error(`Attribute ${this.id} does not support ${t.constructor.name}`);t instanceof i||!this.settings.normalized||"normalized"in e||is.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(e=>(e+128)/255*2-1);case"snorm16":return new Float32Array(e).map(e=>(e+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(e=>e/255);case"unorm16":return new Float32Array(e).map(e=>e/65535);default:return e}}_normalizeValue(e,t,i){let{defaultValue:r,size:s}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e){let e=s;for(;--e>=0;)t[i+e]=r[e];return t}switch(s){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:r[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:r[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:r[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:r[0];break;default:let n=s;for(;--n>=0;)t[i+n]=Number.isFinite(e[n])?e[n]:r[n]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:i}=this;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0}_createBuffer(e){this._buffer&&this._buffer.destroy();let{isIndexed:t,type:i}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:(t?l$.Buffer.INDEX:l$.Buffer.VERTEX)|l$.Buffer.COPY_DST,indexType:t?i:void 0,byteLength:e}),this._buffer}}let lX=[],lK=[];function lJ(e,t=0,i=1/0){let r=lX,s={index:-1,data:e,target:[]};return e?"function"==typeof e[Symbol.iterator]?r=e:e.length>0&&(lK.length=e.length,r=lK):r=lX,(t>0||Number.isFinite(i))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(t,i),s.index=t-1),{iterable:r,objectInfo:s}}function lQ(e){return e&&e[Symbol.asyncIterator]}function l0(e,t){let{size:i,stride:r,offset:s,startIndices:n,nested:a}=t,o=e.BYTES_PER_ELEMENT,l=r?r/o:i,c=s?s/o:0,u=Math.floor((e.length-c)/l);return(t,{index:r,target:s})=>{let o;if(!n){let t=r*l+c;for(let r=0;r<i;r++)s[r]=e[t+r];return s}let h=n[r],d=n[r+1]||u;if(a){o=Array(d-h);for(let t=h;t<d;t++){let r=t*l+c;s=Array(i);for(let t=0;t<i;t++)s[t]=e[r+t];o[t-h]=s}}else if(l===i)o=e.subarray(h*i+c,d*i+c);else{o=new e.constructor((d-h)*i);let t=0;for(let r=h;r<d;r++){let s=r*l+c;for(let r=0;r<i;r++)o[t++]=e[s+r]}}return o}}let l1=[],l2=[[0,1/0]],l3={interpolation:{duration:0,easing:e=>e},spring:{stiffness:.05,damping:.5}};function l4(e,t){if(!e)return null;Number.isFinite(e)&&(e={type:"interpolation",duration:e});let i=e.type||"interpolation";return{...l3[i],...t,...e,type:i}}class l6 extends lY{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:l2}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t,i;(t=this.state).layoutChanged||(i=this.getAccessor(),t.layoutChanged=e.type!==i.type||e.size!==i.size||lH(e)!==lH(i)||(e.offset||0)!==(i.offset||0)),super.setAccessor(e)}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat("function"!=typeof e&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,i=this.settings.transition;return l4(Array.isArray(t)?e[t.find(t=>e[t])]:e[t],i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:e=0,endRow:i=1/0}=t;this.state.updateRanges=function(e,t){if(e===l2||(t[0]<0&&(t[0]=0),t[0]>=t[1]))return e;let i=[],r=e.length,s=0;for(let n=0;n<r;n++){let r=e[n];r[1]<t[0]?(i.push(r),s=n+1):r[0]>t[1]?i.push(r):t=[Math.min(r[0],t[0]),Math.max(r[1],t[1])]}return i.splice(s,0,t),i}(this.state.updateRanges,[e,i])}else this.state.updateRanges=l2}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=l1}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:i}=this;return!i.noAlloc&&!!i.update&&(super.allocate(e,t.updateRanges!==l2),!0)}updateBuffer({numInstances:e,data:t,props:i,context:r}){if(!this.needsUpdate())return!1;let{state:{updateRanges:s},settings:{update:n,noAlloc:a}}=this,o=!0;if(n){for(let[a,o]of s)n.call(r,this,{data:t,startRow:a,endRow:o,props:i,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[t,i]of s){let r=Number.isFinite(t)?this.getVertexOffset(t):0,s=Number.isFinite(i)?this.getVertexOffset(i):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:r,endOffset:s})}this._checkAttributeArray()}else o=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),o}setConstantValue(e,t){let i="webgpu"===this.device.type;if(i||void 0===t||"function"==typeof t){if(i&&"function"!=typeof t){let e=this._normalizeValue(t,[],0);this._areValuesEqual(e,this.value)||this.setNeedsUpdate("WebGPU constant updated")}return!1}let r=this.settings.transform&&e?this.settings.transform.call(e,t):t;return this.setData({constant:!0,value:r})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e),!0)):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:i,settings:r}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),r.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let s=e;oh(ArrayBuffer.isView(s.value),`invalid ${r.accessor}`);let n=!!s.size&&s.size!==this.size;return i.binaryAccessor=l0(s.value,{size:s.size||this.size,stride:s.stride,offset:s.offset,startIndices:t,nested:n}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){let e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(let i in e)Object.assign(t,super.getValue(i,e[i]));return t}getBufferLayout(e){this.state.layoutChanged=!1;let t=this.settings.shaderAttributes,i=super._getBufferLayout(),{stepMode:r}=this.settings;if("dynamic"===r?i.stepMode=e?e.isInstanced?"instance":"vertex":"instance":i.stepMode=r??"vertex",!t)return i;for(let e in t){let r=super._getBufferLayout(e,t[e]);i.attributes.push(...r.attributes)}return i}_autoUpdater(e,{data:t,startRow:i,endRow:r,props:s,numInstances:n}){if(e.constant&&"webgpu"!==this.context.device.type)return;let{settings:a,state:o,value:l,size:c,startIndices:u}=e,{accessor:h,transform:d}=a,f=o.binaryAccessor||("function"==typeof h?h:s[h]);"function"!=typeof f&&"string"==typeof h&&(f=()=>s[h]),oh("function"==typeof f,`accessor "${h}" is not a function`);let p=e.getVertexOffset(i),{iterable:g,objectInfo:m}=lJ(t,i,r);for(let t of g){m.index++;let i=f(t,m);if(d&&(i=d.call(this,i)),u){let t=(m.index<u.length-1?u[m.index+1]:n)-u[m.index];if(i&&Array.isArray(i[0])){let t=p;for(let r of i)e._normalizeValue(r,l,t),t+=c}else i&&i.length>c?l.set(i,p):(e._normalizeValue(i,m.target,0),function({target:e,source:t,start:i=0,count:r=1}){let s=t.length,n=r*s,a=0;for(let r=i;a<s;a++)e[r++]=t[a];for(;a<n;)a<n-a?(e.copyWithin(i+a,i,i+a),a*=2):(e.copyWithin(i+a,i,i+n-a),a=n)}({target:l,source:m.target,start:p,count:t}));p+=t*c}else e._normalizeValue(i,l,p),p+=c}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||"function"==typeof e.update))throw Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw Error(`Illegal attribute generated for ${this.id}`)}}}let l5=`\
out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,l8=`#version 300 es
${l5}`;var l7=e.i(25458),l9=e.i(96204),ce=e.i(88396),ct=e.i(49494);function ci(e){return Array.isArray(e)?0===e.length||"number"==typeof e[0]:ArrayBuffer.isView(e)&&!(e instanceof DataView)}class cr{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(e){if(this.name=e?.name||"unnamed",e?.name&&e?.shaderLayout){const t=e?.shaderLayout.bindings?.find(t=>"uniform"===t.type&&t.name===e?.name);if(!t)throw Error(e?.name);for(const e of t.uniforms||[])this.bindingLayout[e.name]=e}}setUniforms(e){for(let[t,i]of Object.entries(e))this._setUniform(t,i),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${i}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){!function(e,t,i=16){if(e!==t||!ci(e))return!1;if(ci(t)&&e.length===t.length){for(let i=0;i<e.length;++i)if(t[i]!==e[i])return!1}return!0}(this.uniforms[e],t)&&(this.uniforms[e]=ci(t)?t.slice():t,this.modifiedUniforms[e]=!0,this.modified=!0)}}var cs=e.i(72288),cn=e.i(53746);class ca{layout={};byteLength;constructor(e,t={}){let i=0;for(const[r,s]of Object.entries(e)){const{type:e,components:n}=(0,cs.getVariableShaderTypeInfo)(s),a=n*(t?.[r]??1),o=i=(0,lW.alignTo)(i,a);i+=a,this.layout[r]={type:e,size:a,offset:o}}const r=4*(i+=(4-i%4)%4);this.byteLength=Math.max(r,1024)}getData(e){let t=(0,cn.getScratchArrayBuffer)(this.byteLength),i={i32:new Int32Array(t),u32:new Uint32Array(t),f32:new Float32Array(t),f16:new Uint16Array(t)};for(let[t,r]of Object.entries(e)){let e=this.layout[t];if(!e){eM.log.warn(`Supplied uniform value ${t} not present in uniform block layout`)();continue}let{type:s,size:n,offset:a}=e,o=i[s];if(1===n){if("number"!=typeof r&&"boolean"!=typeof r){eM.log.warn(`Supplied value for single component uniform ${t} is not a number: ${r}`)();continue}o[a]=Number(r)}else{if(!ci(r)){eM.log.warn(`Supplied value for multi component / array uniform ${t} is not a numeric array: ${r}`)();continue}o.set(r,a)}}return new Uint8Array(t,0,this.byteLength)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}class co{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(e){for(const[t,i]of Object.entries(e)){const e=new ca(i.uniformTypes??{},i.uniformSizes??{});this.uniformBufferLayouts.set(t,e);const r=new cr({name:t});r.setUniforms(i.defaultUniforms||{}),this.uniformBlocks.set(t,r)}}destroy(){for(let e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(let[t,i]of Object.entries(e))this.uniformBlocks.get(t)?.setUniforms(i);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e)?.byteLength||0}getUniformBufferData(e){let t=this.uniformBlocks.get(e)?.getAllUniforms()||{};return this.uniformBufferLayouts.get(e)?.getData(t)}createUniformBuffer(e,t,i){i&&this.setUniforms(i);let r=this.getUniformBufferByteLength(t),s=e.createBuffer({usage:l$.Buffer.UNIFORM|l$.Buffer.COPY_DST,byteLength:r}),n=this.getUniformBufferData(t);return s.write(n),s}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){let i=this.getUniformBufferByteLength(t),r=e.createBuffer({usage:l$.Buffer.UNIFORM|l$.Buffer.COPY_DST,byteLength:i});this.uniformBuffers.set(t,r)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(let t of this.uniformBlocks.keys()){let i=this.updateUniformBuffer(t);e||=i}return e&&eM.log.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){let t=this.uniformBlocks.get(e),i=this.uniformBuffers.get(e),r=!1;if(i&&t?.needsRedraw){r||=t.needsRedraw;let s=this.getUniformBufferData(e);i=this.uniformBuffers.get(e),i?.write(s);let n=this.uniformBlocks.get(e)?.getAllUniforms();eM.log.log(4,`Writing to uniform buffer ${String(e)}`,s,n)()}return r}}var cl=e.i(65880);class cc{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class cu{constructor(e,t,i){this.name=e,this.type=t,this.attributes=i,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class ch extends cc{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class cd extends cc{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class cf extends cc{constructor(e,t,i){super(e,i),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class cp extends cc{constructor(e,t,i,r){super(e,i),this.format=t,this.access=r}get isTemplate(){return!0}getTypeName(){let e=this.name;if(null!==this.format){if("vec2"===e||"vec3"===e||"vec4"===e||"mat2x2"===e||"mat2x3"===e||"mat2x4"===e||"mat3x2"===e||"mat3x3"===e||"mat3x4"===e||"mat4x2"===e||"mat4x3"===e||"mat4x4"===e){if("f32"===this.format.name)return e+"f";if("i32"===this.format.name)return e+"i";if("u32"===this.format.name)return e+"u";if("bool"===this.format.name)return e+"b";if("f16"===this.format.name)return e+"h"}e+=`<${this.format.name}>`}return e}}(_=E||(E={}))[_.Uniform=0]="Uniform",_[_.Storage=1]="Storage",_[_.Texture=2]="Texture",_[_.Sampler=3]="Sampler",_[_.StorageTexture=4]="StorageTexture";class cg{constructor(e,t,i,r,s,n,a){this.name=e,this.type=t,this.group=i,this.binding=r,this.attributes=s,this.resourceType=n,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class cm{constructor(e,t){this.name=e,this.type=t}}class cy{constructor(e,t,i,r){this.name=e,this.type=t,this.locationType=i,this.location=r,this.interpolation=null}}class cv{constructor(e,t,i,r){this.name=e,this.type=t,this.locationType=i,this.location=r}}class cx{constructor(e,t,i,r){this.name=e,this.type=t,this.attributes=i,this.id=r}}class c_{constructor(e,t,i){this.name=e,this.type=t,this.attributes=i}}class cb{constructor(e,t=null,i){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=i}}class cw{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}let ck=new Float32Array(1),cP=new Int32Array(ck.buffer),cS=new Uint16Array(1),cT=new Uint32Array(1),cC=new Float32Array(cT.buffer,0,1);function cM(e){return cT[0]=112+(e>>6&31)<<23|(63&e)<<17,cC[0]}function cA(e,t,i,r){let s=[0,0,0,0];for(let n=0;n<r;++n)switch(i){case"8unorm":s[n]=e[t]/255,t++;break;case"8snorm":s[n]=e[t]/255*2-1,t++;break;case"8uint":s[n]=e[t],t++;break;case"8sint":s[n]=e[t]-127,t++;break;case"16uint":s[n]=e[t]|e[t+1]<<8,t+=2;break;case"16sint":s[n]=(e[t]|e[t+1]<<8)-32768,t+=2;break;case"16float":s[n]=function(e){var t=(32768&e)>>15,i=(31744&e)>>10,r=1023&e;return 0==i?(t?-1:1)*6103515625e-14*(r/1024):31==i?r?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+r/1024)}(e[t]|e[t+1]<<8),t+=2;break;case"32uint":case"32sint":s[n]=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,t+=4;break;case"32float":s[n]=new Float32Array(e.buffer,t,1)[0],t+=4}return s}function cI(e,t,i,r,s){for(let n=0;n<r;++n)switch(i){case"8unorm":e[t]=255*s[n],t++;break;case"8snorm":e[t]=.5*(s[n]+1)*255,t++;break;case"8uint":e[t]=s[n],t++;break;case"8sint":e[t]=s[n]+127,t++;break;case"16uint":new Uint16Array(e.buffer,t,1)[0]=s[n],t+=2;break;case"16sint":new Int16Array(e.buffer,t,1)[0]=s[n],t+=2;break;case"16float":{let i=function(e){ck[0]=e;let t=cP[0],i=t>>31&1,r=t>>23&255,s=8388607&t;if(255===r)return cS[0]=i<<15|31744|512*(0!==s),cS[0];if(0===r){if(0===s)return cS[0]=i<<15,cS[0];s|=8388608;let e=113;for(;!(8388608&s);)s<<=1,e--;return s&=8388607,(r=127-e)>0?(s=(s>>126-r)+(s>>127-r&1),cS[0]=i<<15|r<<10|s>>13):cS[0]=i<<15,cS[0]}return(r=r-127+15)>=31?cS[0]=i<<15|31744:r<=0?r<-10?cS[0]=i<<15:(s=(8388608|s)>>1-r,cS[0]=i<<15|s>>13):(s>>=13,cS[0]=i<<15|r<<10|s),cS[0]}(s[n]);new Uint16Array(e.buffer,t,1)[0]=i,t+=2;break}case"32uint":new Uint32Array(e.buffer,t,1)[0]=s[n],t+=4;break;case"32sint":new Int32Array(e.buffer,t,1)[0]=s[n],t+=4;break;case"32float":new Float32Array(e.buffer,t,1)[0]=s[n],t+=4}return s}let cE={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class cL{constructor(){this.id=cL._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){for(let i of(t(cO.instance),e))i instanceof Array?this.searchBlock(i,t):i.search(t);t(cR.instance)}}constEvaluate(e,t){throw Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}cL._id=0;class cO extends cL{}cO.instance=new cO;class cR extends cL{}cR.instance=new cR;let cN=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class cj extends cL{constructor(){super()}}class cD extends cj{constructor(e,t,i,r,s,n){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=i,this.body=r,this.startLine=s,this.endLine=n}get astNodeType(){return"function"}search(e){if(this.attributes)for(let t of this.attributes)e(t);for(let t of(e(this),this.args))e(t);this.searchBlock(this.body,e)}}class cz extends cj{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class cF extends cj{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class cB extends cj{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class cU extends cj{constructor(e,t,i,r){super(),this.init=e,this.condition=t,this.increment=i,this.body=r}get astNodeType(){return"for"}search(e){var t,i,r;null==(t=this.init)||t.search(e),null==(i=this.condition)||i.search(e),null==(r=this.increment)||r.search(e),this.searchBlock(this.body,e)}}class c$ extends cj{constructor(e,t,i,r,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=s}get astNodeType(){return"var"}search(e){var t;e(this),null==(t=this.value)||t.search(e)}}class cV extends cj{constructor(e,t,i){super(),this.attributes=null,this.name=e,this.type=t,this.value=i}get astNodeType(){return"override"}search(e){var t;null==(t=this.value)||t.search(e)}}class cW extends cj{constructor(e,t,i,r,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=s}get astNodeType(){return"let"}search(e){var t;e(this),null==(t=this.value)||t.search(e)}}class cG extends cj{constructor(e,t,i,r,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=s}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),null==(t=this.value)||t.search(e)}}(b=L||(L={})).increment="++",b.decrement="--",(w=L||(L={})).parse=function(e){if("parse"==e)throw Error("Invalid value for IncrementOperator");return w[e]};class cq extends cj{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(k=O||(O={})).assign="=",k.addAssign="+=",k.subtractAssin="-=",k.multiplyAssign="*=",k.divideAssign="/=",k.moduloAssign="%=",k.andAssign="&=",k.orAssign="|=",k.xorAssign="^=",k.shiftLeftAssign="<<=",k.shiftRightAssign=">>=",(O||(O={})).parse=function(e){if("parse"==e)throw Error("Invalid value for AssignOperator");return e};class cH extends cj{constructor(e,t,i){super(),this.operator=e,this.variable=t,this.value=i}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class cZ extends cj{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return cN.has(this.name)}search(e){for(let t of this.args)t.search(e);e(this)}}class cY extends cj{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}search(e){var t;this.searchBlock(this.body,e),null==(t=this.continuing)||t.search(e)}}class cX extends cj{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){for(let t of(e(this),this.cases))t.search(e)}}class cK extends cj{constructor(e,t,i,r){super(),this.condition=e,this.body=t,this.elseif=i,this.else=r}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class cJ extends cj{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;null==(t=this.value)||t.search(e)}}class cQ extends cj{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class c0 extends cj{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class c1 extends cj{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class c2 extends cj{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class c3 extends cj{constructor(){super()}get astNodeType(){return"discard"}}class c4 extends cj{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class c6 extends cj{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class c5 extends cj{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if("f32"===t.name)return t;for(let i=1;i<e.length;++i){let r=c5._priority.get(t.name);c5._priority.get(e[i].name)<r&&(t=e[i])}return"x32"===t.name?c5.i32:t}getTypeName(){return this.name}}c5.x32=new c5("x32"),c5.f32=new c5("f32"),c5.i32=new c5("i32"),c5.u32=new c5("u32"),c5.f16=new c5("f16"),c5.bool=new c5("bool"),c5.void=new c5("void"),c5._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class c8 extends c5{constructor(e){super(e)}}class c7 extends c5{constructor(e,t,i,r){super(e),this.members=t,this.startLine=i,this.endLine=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return -1}search(e){for(let t of this.members)e(t)}}class c9 extends c5{constructor(e,t,i){super(e),this.format=t,this.access=i}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(null!==this.format){if("vec2"===e||"vec3"===e||"vec4"===e||"mat2x2"===e||"mat2x3"===e||"mat2x4"===e||"mat3x2"===e||"mat3x3"===e||"mat3x4"===e||"mat4x2"===e||"mat4x3"===e||"mat4x4"===e){if("f32"===this.format.name)return e+"f";if("i32"===this.format.name)return e+"i";if("u32"===this.format.name)return e+"u";if("bool"===this.format.name)return e+"b";if("f16"===this.format.name)return e+"h"}e+=`<${this.format.name}>`}return e}}c9.vec2f=new c9("vec2",c5.f32,null),c9.vec3f=new c9("vec3",c5.f32,null),c9.vec4f=new c9("vec4",c5.f32,null),c9.vec2i=new c9("vec2",c5.i32,null),c9.vec3i=new c9("vec3",c5.i32,null),c9.vec4i=new c9("vec4",c5.i32,null),c9.vec2u=new c9("vec2",c5.u32,null),c9.vec3u=new c9("vec3",c5.u32,null),c9.vec4u=new c9("vec4",c5.u32,null),c9.vec2h=new c9("vec2",c5.f16,null),c9.vec3h=new c9("vec3",c5.f16,null),c9.vec4h=new c9("vec4",c5.f16,null),c9.vec2b=new c9("vec2",c5.bool,null),c9.vec3b=new c9("vec3",c5.bool,null),c9.vec4b=new c9("vec4",c5.bool,null),c9.mat2x2f=new c9("mat2x2",c5.f32,null),c9.mat2x3f=new c9("mat2x3",c5.f32,null),c9.mat2x4f=new c9("mat2x4",c5.f32,null),c9.mat3x2f=new c9("mat3x2",c5.f32,null),c9.mat3x3f=new c9("mat3x3",c5.f32,null),c9.mat3x4f=new c9("mat3x4",c5.f32,null),c9.mat4x2f=new c9("mat4x2",c5.f32,null),c9.mat4x3f=new c9("mat4x3",c5.f32,null),c9.mat4x4f=new c9("mat4x4",c5.f32,null),c9.mat2x2h=new c9("mat2x2",c5.f16,null),c9.mat2x3h=new c9("mat2x3",c5.f16,null),c9.mat2x4h=new c9("mat2x4",c5.f16,null),c9.mat3x2h=new c9("mat3x2",c5.f16,null),c9.mat3x3h=new c9("mat3x3",c5.f16,null),c9.mat3x4h=new c9("mat3x4",c5.f16,null),c9.mat4x2h=new c9("mat4x2",c5.f16,null),c9.mat4x3h=new c9("mat4x3",c5.f16,null),c9.mat4x4h=new c9("mat4x4",c5.f16,null),c9.mat2x2i=new c9("mat2x2",c5.i32,null),c9.mat2x3i=new c9("mat2x3",c5.i32,null),c9.mat2x4i=new c9("mat2x4",c5.i32,null),c9.mat3x2i=new c9("mat3x2",c5.i32,null),c9.mat3x3i=new c9("mat3x3",c5.i32,null),c9.mat3x4i=new c9("mat3x4",c5.i32,null),c9.mat4x2i=new c9("mat4x2",c5.i32,null),c9.mat4x3i=new c9("mat4x3",c5.i32,null),c9.mat4x4i=new c9("mat4x4",c5.i32,null),c9.mat2x2u=new c9("mat2x2",c5.u32,null),c9.mat2x3u=new c9("mat2x3",c5.u32,null),c9.mat2x4u=new c9("mat2x4",c5.u32,null),c9.mat3x2u=new c9("mat3x2",c5.u32,null),c9.mat3x3u=new c9("mat3x3",c5.u32,null),c9.mat3x4u=new c9("mat3x4",c5.u32,null),c9.mat4x2u=new c9("mat4x2",c5.u32,null),c9.mat4x3u=new c9("mat4x3",c5.u32,null),c9.mat4x4u=new c9("mat4x4",c5.u32,null);class ue extends c5{constructor(e,t,i,r){super(e),this.storage=t,this.type=i,this.access=r}get astNodeType(){return"pointer"}}class ut extends c5{constructor(e,t,i,r){super(e),this.attributes=t,this.format=i,this.count=r}get astNodeType(){return"array"}get isArray(){return!0}}class ui extends c5{constructor(e,t,i){super(e),this.format=t,this.access=i}get astNodeType(){return"sampler"}}class ur extends cL{constructor(){super(),this.postfix=null}}class us extends ur{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class un extends ur{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(let t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class ua extends ur{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return cN.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(let t of this.args)t.search(e);e(this)}}class uo extends ur{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class ul extends ur{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){let t=e.evalExpression(this.initializer,e.context);return null!==t&&this.postfix?t.getSubData(e,this.postfix,e.context):t}return null}search(e){this.initializer.search(e)}}class uc extends ur{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return void 0!==t&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof uT}get isVector(){return this.value instanceof uC||this.value instanceof uM}get scalarValue(){return this.value instanceof uT?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof uC||this.value instanceof uM?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class uu extends ur{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class uh extends ur{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class ud extends ur{constructor(){super()}}class uf extends ud{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class up extends ud{constructor(e,t,i){super(),this.operator=e,this.left=t,this.right=i}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:"f32"===e.name||"f32"===t.name?c5.f32:"u32"===e.name||"u32"===t.name?c5.u32:c5.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class ug extends cL{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class um extends ur{constructor(){super()}get astNodeType(){return"default"}}class uy extends ug{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class uv extends ug{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class ux extends cL{constructor(e,t,i){super(),this.name=e,this.type=t,this.attributes=i}get astNodeType(){return"argument"}}class u_ extends cL{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class ub extends cL{constructor(e,t,i){super(),this.name=e,this.type=t,this.attributes=i}get astNodeType(){return"member"}}class uw extends cL{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class uk{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=uk._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,i,r){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,i){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}uk._id=0;class uP extends uk{constructor(){super(new cc("void",null),null)}toString(){return"void"}}uP.void=new uP;class uS extends uk{constructor(e){super(new cf("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,i,r){this.reference.setDataValue(e,t,i,r)}getSubData(e,t,i){return t?this.reference.getSubData(e,t,i):this}toString(){return`&${this.reference.toString()}`}}class uT extends uk{constructor(e,t,i=null){super(t,i),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:"x32"===this.typeInfo.name?e-Math.floor(e)!=0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):"i32"===this.typeInfo.name||"bool"===this.typeInfo.name?this.data=new Int32Array([e]):"u32"===this.typeInfo.name?this.data=new Uint32Array([e]):"f32"===this.typeInfo.name||"f16"===this.typeInfo.name?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new uT(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new uT(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new uT(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,i,r){if(i)return void console.error("SetDataValue: Scalar data does not support postfix",i);if(!(t instanceof uT))return void console.error("SetDataValue: Invalid value",t);let s=t.data[0];"i32"===this.typeInfo.name||"u32"===this.typeInfo.name?s=Math.floor(s):"bool"===this.typeInfo.name&&(s=+!!s),this.data[0]=s}getSubData(e,t,i){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}class uC extends uk{constructor(e,t,i=null){if(super(t,i),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const t=this.typeInfo.name;"vec2f"===t||"vec3f"===t||"vec4f"===t?this.data=new Float32Array(e):"vec2i"===t||"vec3i"===t||"vec4i"===t?this.data=new Int32Array(e):"vec2u"===t||"vec3u"===t||"vec4u"===t?this.data=new Uint32Array(e):"vec2h"===t||"vec3h"===t||"vec4h"===t?this.data=new Float32Array(e):"vec2b"===t||"vec3b"===t||"vec4b"===t?this.data=new Int32Array(e):"vec2"===t||"vec3"===t||"vec4"===t?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${t}`)}}clone(){if(this.data instanceof Float32Array)return new uC(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new uC(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new uC(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,i,r){i instanceof us?console.error("TODO: Set vector postfix"):t instanceof uC?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,i){if(null===t)return this;let r=e.getTypeInfo("f32");if(this.typeInfo instanceof cp)r=this.typeInfo.format||r;else{let t=this.typeInfo.name;"vec2f"===t||"vec3f"===t||"vec4f"===t?r=e.getTypeInfo("f32"):"vec2i"===t||"vec3i"===t||"vec4i"===t?r=e.getTypeInfo("i32"):"vec2b"===t||"vec3b"===t||"vec4b"===t?r=e.getTypeInfo("bool"):"vec2u"===t||"vec3u"===t||"vec4u"===t?r=e.getTypeInfo("u32"):"vec2h"===t||"vec3h"===t||"vec4h"===t?r=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${t}`)}let s=this;for(;null!==t&&null!==s;){if(t instanceof uh){let n=t.index,a=-1;if(n instanceof uc){if(!(n.value instanceof uT))return console.error(`GetSubData: Invalid array index ${n.value}`),null;a=n.value.value}else{let t=e.evalExpression(n,i);if(!(t instanceof uT))return console.error("GetSubData: Unknown index type",n),null;a=t.value}if(a<0||a>=s.data.length)return console.error("GetSubData: Index out of range",a),null;if(s.data instanceof Float32Array)return new uT(new Float32Array(s.data.buffer,s.data.byteOffset+4*a,1),r);if(s.data instanceof Int32Array)return new uT(new Int32Array(s.data.buffer,s.data.byteOffset+4*a,1),r);if(s.data instanceof Uint32Array)return new uT(new Uint32Array(s.data.buffer,s.data.byteOffset+4*a,1),r);throw"GetSubData: Invalid data type"}if(!(t instanceof us))return console.error("GetSubData: Unknown postfix",t),null;{let i=t.value.toLowerCase();if(1===i.length){let e=0;if("x"===i||"r"===i)e=0;else if("y"===i||"g"===i)e=1;else if("z"===i||"b"===i)e=2;else{if("w"!==i&&"a"!==i)return console.error(`GetSubData: Unknown member ${i}`),null;e=3}if(this.data instanceof Float32Array)return new uT(new Float32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this);if(this.data instanceof Int32Array)return new uT(new Int32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this);if(this.data instanceof Uint32Array)return new uT(new Uint32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this)}let n=[];for(let e of i)"x"===e||"r"===e?n.push(this.data[0]):"y"===e||"g"===e?n.push(this.data[1]):"z"===e||"b"===e?n.push(this.data[2]):"w"===e||"a"===e?n.push(this.data[3]):console.error(`GetDataValue: Unknown member ${e}`);s=function(e,t,i){let r=t.length;return 2===r?"f32"===i?new uC(new Float32Array(t),e.getTypeInfo("vec2f")):"i32"===i||"bool"===i?new uC(new Int32Array(t),e.getTypeInfo("vec2i")):"u32"===i?new uC(new Uint32Array(t),e.getTypeInfo("vec2u")):"f16"===i?new uC(new Float32Array(t),e.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${i}`),null):3===r?"f32"===i?new uC(new Float32Array(t),e.getTypeInfo("vec3f")):"i32"===i||"bool"===i?new uC(new Int32Array(t),e.getTypeInfo("vec3i")):"u32"===i?new uC(new Uint32Array(t),e.getTypeInfo("vec3u")):"f16"===i?new uC(new Float32Array(t),e.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${i}`),null):4===r?"f32"===i?new uC(new Float32Array(t),e.getTypeInfo("vec4f")):"i32"===i||"bool"===i?new uC(new Int32Array(t),e.getTypeInfo("vec4i")):"u32"===i?new uC(new Uint32Array(t),e.getTypeInfo("vec4u")):"f16"===i?new uC(new Float32Array(t),e.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${i}`),null):(console.error(`getSubData: Invalid vector size ${t.length}`),null)}(e,n,r.name)}t=t.postfix}return s}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class uM extends uk{constructor(e,t,i=null){super(t,i),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new uM(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,i,r){i instanceof us?console.error("TODO: Set matrix postfix"):t instanceof uM?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,i){if(null===t)return this;let r=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof cp)this.typeInfo.format;else if(r.endsWith("f"))e.getTypeInfo("f32");else if(r.endsWith("i"))e.getTypeInfo("i32");else if(r.endsWith("u"))e.getTypeInfo("u32");else{if(!r.endsWith("h"))return console.error(`GetDataValue: Unknown type ${r}`),null;e.getTypeInfo("f16")}if(t instanceof uh){let s,n=t.index,a=-1;if(n instanceof uc){if(!(n.value instanceof uT))return console.error(`GetDataValue: Invalid array index ${n.value}`),null;a=n.value.value}else{let t=e.evalExpression(n,i);if(!(t instanceof uT))return console.error("GetDataValue: Unknown index type",n),null;a=t.value}if(a<0||a>=this.data.length)return console.error("GetDataValue: Index out of range",a),null;let o=r.endsWith("h")?"h":"f";if("mat2x2"===r||"mat2x2f"===r||"mat2x2h"===r||"mat3x2"===r||"mat3x2f"===r||"mat3x2h"===r||"mat4x2"===r||"mat4x2f"===r||"mat4x2h"===r)s=new uC(new Float32Array(this.data.buffer,this.data.byteOffset+2*a*4,2),e.getTypeInfo(`vec2${o}`));else if("mat2x3"===r||"mat2x3f"===r||"mat2x3h"===r||"mat3x3"===r||"mat3x3f"===r||"mat3x3h"===r||"mat4x3"===r||"mat4x3f"===r||"mat4x3h"===r)s=new uC(new Float32Array(this.data.buffer,this.data.byteOffset+3*a*4,3),e.getTypeInfo(`vec3${o}`));else{if("mat2x4"!==r&&"mat2x4f"!==r&&"mat2x4h"!==r&&"mat3x4"!==r&&"mat3x4f"!==r&&"mat3x4h"!==r&&"mat4x4"!==r&&"mat4x4f"!==r&&"mat4x4h"!==r)return console.error(`GetDataValue: Unknown type ${r}`),null;s=new uC(new Float32Array(this.data.buffer,this.data.byteOffset+4*a*4,4),e.getTypeInfo(`vec4${o}`))}return t.postfix?s.getSubData(e,t.postfix,i):s}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class uA extends uk{constructor(e,t,i=0,r=null){super(t,r),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=i}clone(){return new uA(new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size)).buffer,this.typeInfo,0,null)}setDataValue(e,t,i,r){if(null===t)return void console.log("setDataValue: NULL data.");let s=this.offset,n=this.typeInfo;for(;i;){if(i instanceof uh)if(n instanceof cd){let t=i.index;if(t instanceof uc){if(!(t.value instanceof uT))return void console.error(`SetDataValue: Invalid index type ${t.value}`);s+=t.value.value*n.stride}else{let i=e.evalExpression(t,r);if(!(i instanceof uT))return void console.error("SetDataValue: Unknown index type",t);s+=i.value*n.stride}n=n.format}else console.error(`SetDataValue: Type ${n.getTypeName()} is not an array`);else{if(!(i instanceof us))return void console.error("SetDataValue: Unknown postfix type",i);{let e=i.value;if(n instanceof ch){let t=!1;for(let i of n.members)if(i.name===e){s+=i.offset,n=i.type,t=!0;break}if(!t)return void console.error(`SetDataValue: Member ${e} not found`)}else if(n instanceof cc){let i=n.getTypeName(),r=0;if("x"===e||"r"===e)r=0;else if("y"===e||"g"===e)r=1;else if("z"===e||"b"===e)r=2;else{if("w"!==e&&"a"!==e)return void console.error(`SetDataValue: Unknown member ${e}`);r=3}if(!(t instanceof uT))return void console.error("SetDataValue: Invalid value",t);let a=t.value;return"vec2f"===i?void(new Float32Array(this.buffer,s,2)[r]=a):"vec3f"===i?void(new Float32Array(this.buffer,s,3)[r]=a):"vec4f"===i?void(new Float32Array(this.buffer,s,4)[r]=a):"vec2i"===i?void(new Int32Array(this.buffer,s,2)[r]=a):"vec3i"===i?void(new Int32Array(this.buffer,s,3)[r]=a):"vec4i"===i?void(new Int32Array(this.buffer,s,4)[r]=a):"vec2u"===i?void(new Uint32Array(this.buffer,s,2)[r]=a):"vec3u"===i?void(new Uint32Array(this.buffer,s,3)[r]=a):"vec4u"===i?void(new Uint32Array(this.buffer,s,4)[r]=a):void console.error(`SetDataValue: Type ${i} is not a struct`)}}}i=i.postfix}this.setData(e,t,n,s,r)}setData(e,t,i,r,s){let n=i.getTypeName();if("f32"!==n&&"f16"!==n)if("i32"!==n&&"atomic<i32>"!==n&&"x32"!==n)if("u32"!==n&&"atomic<u32>"!==n)if("bool"!==n){if("vec2f"===n||"vec2h"===n){let e=new Float32Array(this.buffer,r,2);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3f"===n||"vec3h"===n){let e=new Float32Array(this.buffer,r,3);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4f"===n||"vec4h"===n){let e=new Float32Array(this.buffer,r,4);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("vec2i"===n){let e=new Int32Array(this.buffer,r,2);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3i"===n){let e=new Int32Array(this.buffer,r,3);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4i"===n){let e=new Int32Array(this.buffer,r,4);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("vec2u"===n){let e=new Uint32Array(this.buffer,r,2);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3u"===n){let e=new Uint32Array(this.buffer,r,3);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4u"===n){let e=new Uint32Array(this.buffer,r,4);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("vec2b"===n){let e=new Uint32Array(this.buffer,r,2);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3b"===n){let e=new Uint32Array(this.buffer,r,3);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4b"===n){let e=new Uint32Array(this.buffer,r,4);return void(t instanceof uC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("mat2x2f"===n||"mat2x2h"===n){let e=new Float32Array(this.buffer,r,4);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("mat2x3f"===n||"mat2x3h"===n){let e=new Float32Array(this.buffer,r,6);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5]))}if("mat2x4f"===n||"mat2x4h"===n){let e=new Float32Array(this.buffer,r,8);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7]))}if("mat3x2f"===n||"mat3x2h"===n){let e=new Float32Array(this.buffer,r,6);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5]))}if("mat3x3f"===n||"mat3x3h"===n){let e=new Float32Array(this.buffer,r,9);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8]))}if("mat3x4f"===n||"mat3x4h"===n){let e=new Float32Array(this.buffer,r,12);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11]))}if("mat4x2f"===n||"mat4x2h"===n){let e=new Float32Array(this.buffer,r,8);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7]))}if("mat4x3f"===n||"mat4x3h"===n){let e=new Float32Array(this.buffer,r,12);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11]))}if("mat4x4f"===n||"mat4x4h"===n){let e=new Float32Array(this.buffer,r,16);return void(t instanceof uM?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11],e[12]=t.data[12],e[13]=t.data[13],e[14]=t.data[14],e[15]=t.data[15]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}if(t instanceof uA){if(i===t.typeInfo)return void new Uint8Array(this.buffer,r,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",n,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${n}`)}else t instanceof uT&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof uT&&(new Uint32Array(this.buffer,r,1)[0]=t.value);else t instanceof uT&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof uT&&(new Float32Array(this.buffer,r,1)[0]=t.value)}getSubData(e,t,i){var r,s,n;if(null===t)return this;let a=this.offset,o=this.typeInfo;for(;t;){if(t instanceof uh){let r=t.index,s=r instanceof ur?e.evalExpression(r,i):r,n=0;if(s instanceof uT?n=s.value:"number"==typeof s?n=s:console.error("GetDataValue: Invalid index type",r),o instanceof cd)a+=n*o.stride,o=o.format;else{let t=o.getTypeName();"mat4x4"===t||"mat4x4f"===t||"mat4x4h"===t?(a+=16*n,o=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${o.getTypeName()} is not an array`)}}else{if(!(t instanceof us))return console.error("GetDataValue: Unknown postfix type",t),null;{let i=t.value;if(o instanceof ch){let e=!1;for(let t of o.members)if(t.name===i){a+=t.offset,o=t.type,e=!0;break}if(!e)return console.error(`GetDataValue: Member ${i} not found`),null}else if(o instanceof cc){let t=o.getTypeName();if("vec2f"===t||"vec3f"===t||"vec4f"===t||"vec2i"===t||"vec3i"===t||"vec4i"===t||"vec2u"===t||"vec3u"===t||"vec4u"===t||"vec2b"===t||"vec3b"===t||"vec4b"===t||"vec2h"===t||"vec3h"===t||"vec4h"===t||"vec2"===t||"vec3"===t||"vec4"===t){if(i.length>0&&i.length<5){let r="f",s=[];for(let n=0;n<i.length;++n){let o=i[n].toLowerCase(),l=0;if("x"===o||"r"===o)l=0;else if("y"===o||"g"===o)l=1;else if("z"===o||"b"===o)l=2;else{if("w"!==o&&"a"!==o)return console.error(`Unknown member ${i}`),null;l=3}if(1===i.length){if(t.endsWith("f"))return this.buffer.byteLength<a+4*l+4?(console.log("Insufficient buffer data"),null):new uT(new Float32Array(this.buffer,a+4*l,1),e.getTypeInfo("f32"),this);if(t.endsWith("h"))return new uT(new Float32Array(this.buffer,a+4*l,1),e.getTypeInfo("f16"),this);if(t.endsWith("i"))return new uT(new Int32Array(this.buffer,a+4*l,1),e.getTypeInfo("i32"),this);if(t.endsWith("b"))return new uT(new Int32Array(this.buffer,a+4*l,1),e.getTypeInfo("bool"),this);if(t.endsWith("u"))return new uT(new Uint32Array(this.buffer,a+4*l,1),e.getTypeInfo("i32"),this)}if("vec2f"===t)s.push(new Float32Array(this.buffer,a,2)[l]);else if("vec3f"===t){if(a+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;let e=new Float32Array(this.buffer,a,3);s.push(e[l])}else if("vec4f"===t)s.push(new Float32Array(this.buffer,a,4)[l]);else if("vec2i"===t)r="i",s.push(new Int32Array(this.buffer,a,2)[l]);else if("vec3i"===t)r="i",s.push(new Int32Array(this.buffer,a,3)[l]);else if("vec4i"===t)r="i",s.push(new Int32Array(this.buffer,a,4)[l]);else if("vec2u"===t){r="u";let e=new Uint32Array(this.buffer,a,2);s.push(e[l])}else"vec3u"===t?(r="u",s.push(new Uint32Array(this.buffer,a,3)[l])):"vec4u"===t&&(r="u",s.push(new Uint32Array(this.buffer,a,4)[l]))}return 2===s.length?o=e.getTypeInfo(`vec2${r}`):3===s.length?o=e.getTypeInfo(`vec3${r}`):4===s.length?o=e.getTypeInfo(`vec4${r}`):console.error(`GetDataValue: Invalid vector length ${s.length}`),new uC(s,o,null)}return console.error(`GetDataValue: Unknown member ${i}`),null}return console.error(`GetDataValue: Type ${t} is not a struct`),null}}}t=t.postfix}let l=o.getTypeName();return"f32"===l?new uT(new Float32Array(this.buffer,a,1),o,this):"i32"===l?new uT(new Int32Array(this.buffer,a,1),o,this):"u32"===l?new uT(new Uint32Array(this.buffer,a,1),o,this):"vec2f"===l?new uC(new Float32Array(this.buffer,a,2),o,this):"vec3f"===l?new uC(new Float32Array(this.buffer,a,3),o,this):"vec4f"===l?new uC(new Float32Array(this.buffer,a,4),o,this):"vec2i"===l?new uC(new Int32Array(this.buffer,a,2),o,this):"vec3i"===l?new uC(new Int32Array(this.buffer,a,3),o,this):"vec4i"===l?new uC(new Int32Array(this.buffer,a,4),o,this):"vec2u"===l?new uC(new Uint32Array(this.buffer,a,2),o,this):"vec3u"===l?new uC(new Uint32Array(this.buffer,a,3),o,this):"vec4u"===l?new uC(new Uint32Array(this.buffer,a,4),o,this):o instanceof cp&&"atomic"===o.name?"u32"===(null==(r=o.format)?void 0:r.name)?new uT(new Uint32Array(this.buffer,a,1)[0],o.format,this):"i32"===(null==(s=o.format)?void 0:s.name)?new uT(new Int32Array(this.buffer,a,1)[0],o.format,this):(console.error(`GetDataValue: Invalid atomic format ${null==(n=o.format)?void 0:n.name}`),null):new uA(this.buffer,o,a,this)}toString(){let e="";if(this.typeInfo instanceof cd)if("f32"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if("i32"===this.typeInfo.format.name){let t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if("u32"===this.typeInfo.format.name){let t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if("vec2f"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let i=1;i<t.length/2;++i)e+=`, [${t[2*i]}, ${t[2*i+1]}]`}else if("vec3f"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let i=4;i<t.length;i+=4)e+=`, [${t[i]}, ${t[i+1]}, ${t[i+2]}]`}else if("vec4f"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let i=4;i<t.length;i+=4)e+=`, [${t[i]}, ${t[i+1]}, ${t[i+2]}, ${t[i+3]}]`}else e="[...]";else this.typeInfo instanceof ch?e+="{...}":e="[...]";return e}}class uI extends uk{constructor(e,t,i,r){super(t,null),this.data=e,this.descriptor=i,this.view=r}clone(){return new uI(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;let i=this.descriptor.size;return i instanceof Array&&i.length>0?null!=(e=i[0])?e:0:i instanceof Object&&null!=(t=i.width)?t:0}get height(){var e,t;let i=this.descriptor.size;return i instanceof Array&&i.length>1?null!=(e=i[1])?e:0:i instanceof Object&&null!=(t=i.height)?t:0}get depthOrArrayLayers(){var e,t;let i=this.descriptor.size;return i instanceof Array&&i.length>2?null!=(e=i[2])?e:0:i instanceof Object&&null!=(t=i.depthOrArrayLayers)?t:0}get format(){var e;return this.descriptor&&null!=(e=this.descriptor.format)?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&null!=(e=this.descriptor.sampleCount)?e:1}get mipLevelCount(){var e;return this.descriptor&&null!=(e=this.descriptor.mipLevelCount)?e:1}get dimension(){var e;return this.descriptor&&null!=(e=this.descriptor.dimension)?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];let t=[this.width,this.height,this.depthOrArrayLayers];for(let i=0;i<t.length;++i)t[i]=Math.max(1,t[i]>>e);return t}get texelByteSize(){let e=cE[this.format];return e?e.isDepthStencil?4:e.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){let e=cE[this.format];return!!e&&e.isDepthStencil}getGpuSize(){let e=this.format,t=cE[e],i=this.width;if(!e||i<=0||!t)return -1;let r=this.height,s=this.depthOrArrayLayers,n=this.dimension;return i/t.blockWidth*("1d"===n?1:r/t.blockHeight)*t.bytesPerBlock*s}getPixel(e,t,i=0,r=0){let s=this.texelByteSize,n=this.bytesPerRow,a=this.height;return function(e,t,i,r,s,n,a,o,l){let c=r*(a>>=s)*(n>>=s)+i*a+t*o;switch(l){case"r8unorm":return[cA(e,c,"8unorm",1)[0]];case"r8snorm":return[cA(e,c,"8snorm",1)[0]];case"r8uint":return[cA(e,c,"8uint",1)[0]];case"r8sint":return[cA(e,c,"8sint",1)[0]];case"rg8unorm":{let t=cA(e,c,"8unorm",2);return[t[0],t[1]]}case"rg8snorm":{let t=cA(e,c,"8snorm",2);return[t[0],t[1]]}case"rg8uint":{let t=cA(e,c,"8uint",2);return[t[0],t[1]]}case"rg8sint":{let t=cA(e,c,"8sint",2);return[t[0],t[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{let t=cA(e,c,"8unorm",4);return[t[0],t[1],t[2],t[3]]}case"rgba8snorm":{let t=cA(e,c,"8snorm",4);return[t[0],t[1],t[2],t[3]]}case"rgba8uint":{let t=cA(e,c,"8uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba8sint":{let t=cA(e,c,"8sint",4);return[t[0],t[1],t[2],t[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{let t=cA(e,c,"8unorm",4);return[t[2],t[1],t[0],t[3]]}case"r16uint":return[cA(e,c,"16uint",1)[0]];case"r16sint":return[cA(e,c,"16sint",1)[0]];case"r16float":return[cA(e,c,"16float",1)[0]];case"rg16uint":{let t=cA(e,c,"16uint",2);return[t[0],t[1]]}case"rg16sint":{let t=cA(e,c,"16sint",2);return[t[0],t[1]]}case"rg16float":{let t=cA(e,c,"16float",2);return[t[0],t[1]]}case"rgba16uint":{let t=cA(e,c,"16uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba16sint":{let t=cA(e,c,"16sint",4);return[t[0],t[1],t[2],t[3]]}case"rgba16float":{let t=cA(e,c,"16float",4);return[t[0],t[1],t[2],t[3]]}case"r32uint":return[cA(e,c,"32uint",1)[0]];case"r32sint":return[cA(e,c,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[cA(e,c,"32float",1)[0]];case"rg32uint":{let t=cA(e,c,"32uint",2);return[t[0],t[1]]}case"rg32sint":{let t=cA(e,c,"32sint",2);return[t[0],t[1]]}case"rg32float":{let t=cA(e,c,"32float",2);return[t[0],t[1]]}case"rgba32uint":{let t=cA(e,c,"32uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba32sint":{let t=cA(e,c,"32sint",4);return[t[0],t[1],t[2],t[3]]}case"rgba32float":{let t=cA(e,c,"32float",4);return[t[0],t[1],t[2],t[3]]}case"rg11b10ufloat":{var u;let t=new Uint32Array(e.buffer,c,1)[0];return[cM(2047&t),cM((4192256&t)>>11),(u=(0xffc00000&t)>>22,cT[0]=112+(u>>5&31)<<23|(31&u)<<18,cC[0]),1]}}return null}(new Uint8Array(this.data[r]),e,t,i,r,a,n,s,this.format)}setPixel(e,t,i,r,s){let n=this.texelByteSize,a=this.bytesPerRow,o=this.height;!function(e,t,i,r,s,n,a,o,l,c){let u=r*(a>>=s)*(n>>=s)+i*a+t*o;switch(l){case"r8unorm":return cI(e,u,"8unorm",1,c);case"r8snorm":return cI(e,u,"8snorm",1,c);case"r8uint":return cI(e,u,"8uint",1,c);case"r8sint":return cI(e,u,"8sint",1,c);case"rg8unorm":return cI(e,u,"8unorm",2,c);case"rg8snorm":return cI(e,u,"8snorm",2,c);case"rg8uint":return cI(e,u,"8uint",2,c);case"rg8sint":return cI(e,u,"8sint",2,c);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return cI(e,u,"8unorm",4,c);case"rgba8snorm":return cI(e,u,"8snorm",4,c);case"rgba8uint":return cI(e,u,"8uint",4,c);case"rgba8sint":return cI(e,u,"8sint",4,c);case"r16uint":return cI(e,u,"16uint",1,c);case"r16sint":return cI(e,u,"16sint",1,c);case"r16float":return cI(e,u,"16float",1,c);case"rg16uint":return cI(e,u,"16uint",2,c);case"rg16sint":return cI(e,u,"16sint",2,c);case"rg16float":return cI(e,u,"16float",2,c);case"rgba16uint":return cI(e,u,"16uint",4,c);case"rgba16sint":return cI(e,u,"16sint",4,c);case"rgba16float":return cI(e,u,"16float",4,c);case"r32uint":return cI(e,u,"32uint",1,c);case"r32sint":return cI(e,u,"32sint",1,c);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return cI(e,u,"32float",1,c);case"rg32uint":return cI(e,u,"32uint",2,c);case"rg32sint":return cI(e,u,"32sint",2,c);case"rg32float":return cI(e,u,"32float",2,c);case"rgba32uint":return cI(e,u,"32uint",4,c);case"rgba32sint":return cI(e,u,"32sint",4,c);case"rgba32float":return cI(e,u,"32float",4,c);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}}(new Uint8Array(this.data[r]),e,t,i,r,o,a,n,this.format,s)}}(P=R||(R={}))[P.token=0]="token",P[P.keyword=1]="keyword",P[P.reserved=2]="reserved";class uE{constructor(e,t,i){this.name=e,this.type=t,this.rule=i}toString(){return this.name}}class uL{}uL.none=new uE("",R.reserved,""),uL.eof=new uE("EOF",R.token,""),uL.reserved={asm:new uE("asm",R.reserved,"asm"),bf16:new uE("bf16",R.reserved,"bf16"),do:new uE("do",R.reserved,"do"),enum:new uE("enum",R.reserved,"enum"),f16:new uE("f16",R.reserved,"f16"),f64:new uE("f64",R.reserved,"f64"),handle:new uE("handle",R.reserved,"handle"),i8:new uE("i8",R.reserved,"i8"),i16:new uE("i16",R.reserved,"i16"),i64:new uE("i64",R.reserved,"i64"),mat:new uE("mat",R.reserved,"mat"),premerge:new uE("premerge",R.reserved,"premerge"),regardless:new uE("regardless",R.reserved,"regardless"),typedef:new uE("typedef",R.reserved,"typedef"),u8:new uE("u8",R.reserved,"u8"),u16:new uE("u16",R.reserved,"u16"),u64:new uE("u64",R.reserved,"u64"),unless:new uE("unless",R.reserved,"unless"),using:new uE("using",R.reserved,"using"),vec:new uE("vec",R.reserved,"vec"),void:new uE("void",R.reserved,"void")},uL.keywords={array:new uE("array",R.keyword,"array"),atomic:new uE("atomic",R.keyword,"atomic"),bool:new uE("bool",R.keyword,"bool"),f32:new uE("f32",R.keyword,"f32"),i32:new uE("i32",R.keyword,"i32"),mat2x2:new uE("mat2x2",R.keyword,"mat2x2"),mat2x3:new uE("mat2x3",R.keyword,"mat2x3"),mat2x4:new uE("mat2x4",R.keyword,"mat2x4"),mat3x2:new uE("mat3x2",R.keyword,"mat3x2"),mat3x3:new uE("mat3x3",R.keyword,"mat3x3"),mat3x4:new uE("mat3x4",R.keyword,"mat3x4"),mat4x2:new uE("mat4x2",R.keyword,"mat4x2"),mat4x3:new uE("mat4x3",R.keyword,"mat4x3"),mat4x4:new uE("mat4x4",R.keyword,"mat4x4"),ptr:new uE("ptr",R.keyword,"ptr"),sampler:new uE("sampler",R.keyword,"sampler"),sampler_comparison:new uE("sampler_comparison",R.keyword,"sampler_comparison"),struct:new uE("struct",R.keyword,"struct"),texture_1d:new uE("texture_1d",R.keyword,"texture_1d"),texture_2d:new uE("texture_2d",R.keyword,"texture_2d"),texture_2d_array:new uE("texture_2d_array",R.keyword,"texture_2d_array"),texture_3d:new uE("texture_3d",R.keyword,"texture_3d"),texture_cube:new uE("texture_cube",R.keyword,"texture_cube"),texture_cube_array:new uE("texture_cube_array",R.keyword,"texture_cube_array"),texture_multisampled_2d:new uE("texture_multisampled_2d",R.keyword,"texture_multisampled_2d"),texture_storage_1d:new uE("texture_storage_1d",R.keyword,"texture_storage_1d"),texture_storage_2d:new uE("texture_storage_2d",R.keyword,"texture_storage_2d"),texture_storage_2d_array:new uE("texture_storage_2d_array",R.keyword,"texture_storage_2d_array"),texture_storage_3d:new uE("texture_storage_3d",R.keyword,"texture_storage_3d"),texture_depth_2d:new uE("texture_depth_2d",R.keyword,"texture_depth_2d"),texture_depth_2d_array:new uE("texture_depth_2d_array",R.keyword,"texture_depth_2d_array"),texture_depth_cube:new uE("texture_depth_cube",R.keyword,"texture_depth_cube"),texture_depth_cube_array:new uE("texture_depth_cube_array",R.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new uE("texture_depth_multisampled_2d",R.keyword,"texture_depth_multisampled_2d"),texture_external:new uE("texture_external",R.keyword,"texture_external"),u32:new uE("u32",R.keyword,"u32"),vec2:new uE("vec2",R.keyword,"vec2"),vec3:new uE("vec3",R.keyword,"vec3"),vec4:new uE("vec4",R.keyword,"vec4"),bitcast:new uE("bitcast",R.keyword,"bitcast"),block:new uE("block",R.keyword,"block"),break:new uE("break",R.keyword,"break"),case:new uE("case",R.keyword,"case"),continue:new uE("continue",R.keyword,"continue"),continuing:new uE("continuing",R.keyword,"continuing"),default:new uE("default",R.keyword,"default"),diagnostic:new uE("diagnostic",R.keyword,"diagnostic"),discard:new uE("discard",R.keyword,"discard"),else:new uE("else",R.keyword,"else"),enable:new uE("enable",R.keyword,"enable"),fallthrough:new uE("fallthrough",R.keyword,"fallthrough"),false:new uE("false",R.keyword,"false"),fn:new uE("fn",R.keyword,"fn"),for:new uE("for",R.keyword,"for"),function:new uE("function",R.keyword,"function"),if:new uE("if",R.keyword,"if"),let:new uE("let",R.keyword,"let"),const:new uE("const",R.keyword,"const"),loop:new uE("loop",R.keyword,"loop"),while:new uE("while",R.keyword,"while"),private:new uE("private",R.keyword,"private"),read:new uE("read",R.keyword,"read"),read_write:new uE("read_write",R.keyword,"read_write"),return:new uE("return",R.keyword,"return"),requires:new uE("requires",R.keyword,"requires"),storage:new uE("storage",R.keyword,"storage"),switch:new uE("switch",R.keyword,"switch"),true:new uE("true",R.keyword,"true"),alias:new uE("alias",R.keyword,"alias"),type:new uE("type",R.keyword,"type"),uniform:new uE("uniform",R.keyword,"uniform"),var:new uE("var",R.keyword,"var"),override:new uE("override",R.keyword,"override"),workgroup:new uE("workgroup",R.keyword,"workgroup"),write:new uE("write",R.keyword,"write"),r8unorm:new uE("r8unorm",R.keyword,"r8unorm"),r8snorm:new uE("r8snorm",R.keyword,"r8snorm"),r8uint:new uE("r8uint",R.keyword,"r8uint"),r8sint:new uE("r8sint",R.keyword,"r8sint"),r16uint:new uE("r16uint",R.keyword,"r16uint"),r16sint:new uE("r16sint",R.keyword,"r16sint"),r16float:new uE("r16float",R.keyword,"r16float"),rg8unorm:new uE("rg8unorm",R.keyword,"rg8unorm"),rg8snorm:new uE("rg8snorm",R.keyword,"rg8snorm"),rg8uint:new uE("rg8uint",R.keyword,"rg8uint"),rg8sint:new uE("rg8sint",R.keyword,"rg8sint"),r32uint:new uE("r32uint",R.keyword,"r32uint"),r32sint:new uE("r32sint",R.keyword,"r32sint"),r32float:new uE("r32float",R.keyword,"r32float"),rg16uint:new uE("rg16uint",R.keyword,"rg16uint"),rg16sint:new uE("rg16sint",R.keyword,"rg16sint"),rg16float:new uE("rg16float",R.keyword,"rg16float"),rgba8unorm:new uE("rgba8unorm",R.keyword,"rgba8unorm"),rgba8unorm_srgb:new uE("rgba8unorm_srgb",R.keyword,"rgba8unorm_srgb"),rgba8snorm:new uE("rgba8snorm",R.keyword,"rgba8snorm"),rgba8uint:new uE("rgba8uint",R.keyword,"rgba8uint"),rgba8sint:new uE("rgba8sint",R.keyword,"rgba8sint"),bgra8unorm:new uE("bgra8unorm",R.keyword,"bgra8unorm"),bgra8unorm_srgb:new uE("bgra8unorm_srgb",R.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new uE("rgb10a2unorm",R.keyword,"rgb10a2unorm"),rg11b10float:new uE("rg11b10float",R.keyword,"rg11b10float"),rg32uint:new uE("rg32uint",R.keyword,"rg32uint"),rg32sint:new uE("rg32sint",R.keyword,"rg32sint"),rg32float:new uE("rg32float",R.keyword,"rg32float"),rgba16uint:new uE("rgba16uint",R.keyword,"rgba16uint"),rgba16sint:new uE("rgba16sint",R.keyword,"rgba16sint"),rgba16float:new uE("rgba16float",R.keyword,"rgba16float"),rgba32uint:new uE("rgba32uint",R.keyword,"rgba32uint"),rgba32sint:new uE("rgba32sint",R.keyword,"rgba32sint"),rgba32float:new uE("rgba32float",R.keyword,"rgba32float"),static_assert:new uE("static_assert",R.keyword,"static_assert")},uL.tokens={decimal_float_literal:new uE("decimal_float_literal",R.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new uE("hex_float_literal",R.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new uE("int_literal",R.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new uE("uint_literal",R.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new uE("name",R.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new uE("ident",R.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new uE("and",R.token,"&"),and_and:new uE("and_and",R.token,"&&"),arrow:new uE("arrow ",R.token,"->"),attr:new uE("attr",R.token,"@"),forward_slash:new uE("forward_slash",R.token,"/"),bang:new uE("bang",R.token,"!"),bracket_left:new uE("bracket_left",R.token,"["),bracket_right:new uE("bracket_right",R.token,"]"),brace_left:new uE("brace_left",R.token,"{"),brace_right:new uE("brace_right",R.token,"}"),colon:new uE("colon",R.token,":"),comma:new uE("comma",R.token,","),equal:new uE("equal",R.token,"="),equal_equal:new uE("equal_equal",R.token,"=="),not_equal:new uE("not_equal",R.token,"!="),greater_than:new uE("greater_than",R.token,">"),greater_than_equal:new uE("greater_than_equal",R.token,">="),shift_right:new uE("shift_right",R.token,">>"),less_than:new uE("less_than",R.token,"<"),less_than_equal:new uE("less_than_equal",R.token,"<="),shift_left:new uE("shift_left",R.token,"<<"),modulo:new uE("modulo",R.token,"%"),minus:new uE("minus",R.token,"-"),minus_minus:new uE("minus_minus",R.token,"--"),period:new uE("period",R.token,"."),plus:new uE("plus",R.token,"+"),plus_plus:new uE("plus_plus",R.token,"++"),or:new uE("or",R.token,"|"),or_or:new uE("or_or",R.token,"||"),paren_left:new uE("paren_left",R.token,"("),paren_right:new uE("paren_right",R.token,")"),semicolon:new uE("semicolon",R.token,";"),star:new uE("star",R.token,"*"),tilde:new uE("tilde",R.token,"~"),underscore:new uE("underscore",R.token,"_"),xor:new uE("xor",R.token,"^"),plus_equal:new uE("plus_equal",R.token,"+="),minus_equal:new uE("minus_equal",R.token,"-="),times_equal:new uE("times_equal",R.token,"*="),division_equal:new uE("division_equal",R.token,"/="),modulo_equal:new uE("modulo_equal",R.token,"%="),and_equal:new uE("and_equal",R.token,"&="),or_equal:new uE("or_equal",R.token,"|="),xor_equal:new uE("xor_equal",R.token,"^="),shift_right_equal:new uE("shift_right_equal",R.token,">>="),shift_left_equal:new uE("shift_left_equal",R.token,"<<=")},uL.simpleTokens={"@":uL.tokens.attr,"{":uL.tokens.brace_left,"}":uL.tokens.brace_right,":":uL.tokens.colon,",":uL.tokens.comma,"(":uL.tokens.paren_left,")":uL.tokens.paren_right,";":uL.tokens.semicolon},uL.literalTokens={"&":uL.tokens.and,"&&":uL.tokens.and_and,"->":uL.tokens.arrow,"/":uL.tokens.forward_slash,"!":uL.tokens.bang,"[":uL.tokens.bracket_left,"]":uL.tokens.bracket_right,"=":uL.tokens.equal,"==":uL.tokens.equal_equal,"!=":uL.tokens.not_equal,">":uL.tokens.greater_than,">=":uL.tokens.greater_than_equal,">>":uL.tokens.shift_right,"<":uL.tokens.less_than,"<=":uL.tokens.less_than_equal,"<<":uL.tokens.shift_left,"%":uL.tokens.modulo,"-":uL.tokens.minus,"--":uL.tokens.minus_minus,".":uL.tokens.period,"+":uL.tokens.plus,"++":uL.tokens.plus_plus,"|":uL.tokens.or,"||":uL.tokens.or_or,"*":uL.tokens.star,"~":uL.tokens.tilde,_:uL.tokens.underscore,"^":uL.tokens.xor,"+=":uL.tokens.plus_equal,"-=":uL.tokens.minus_equal,"*=":uL.tokens.times_equal,"/=":uL.tokens.division_equal,"%=":uL.tokens.modulo_equal,"&=":uL.tokens.and_equal,"|=":uL.tokens.or_equal,"^=":uL.tokens.xor_equal,">>=":uL.tokens.shift_right_equal,"<<=":uL.tokens.shift_left_equal},uL.regexTokens={decimal_float_literal:uL.tokens.decimal_float_literal,hex_float_literal:uL.tokens.hex_float_literal,int_literal:uL.tokens.int_literal,uint_literal:uL.tokens.uint_literal,ident:uL.tokens.ident},uL.storage_class=[uL.keywords.function,uL.keywords.private,uL.keywords.workgroup,uL.keywords.uniform,uL.keywords.storage],uL.access_mode=[uL.keywords.read,uL.keywords.write,uL.keywords.read_write],uL.sampler_type=[uL.keywords.sampler,uL.keywords.sampler_comparison],uL.sampled_texture_type=[uL.keywords.texture_1d,uL.keywords.texture_2d,uL.keywords.texture_2d_array,uL.keywords.texture_3d,uL.keywords.texture_cube,uL.keywords.texture_cube_array],uL.multisampled_texture_type=[uL.keywords.texture_multisampled_2d],uL.storage_texture_type=[uL.keywords.texture_storage_1d,uL.keywords.texture_storage_2d,uL.keywords.texture_storage_2d_array,uL.keywords.texture_storage_3d],uL.depth_texture_type=[uL.keywords.texture_depth_2d,uL.keywords.texture_depth_2d_array,uL.keywords.texture_depth_cube,uL.keywords.texture_depth_cube_array,uL.keywords.texture_depth_multisampled_2d],uL.texture_external_type=[uL.keywords.texture_external],uL.any_texture_type=[...uL.sampled_texture_type,...uL.multisampled_texture_type,...uL.storage_texture_type,...uL.depth_texture_type,...uL.texture_external_type],uL.texel_format=[uL.keywords.r8unorm,uL.keywords.r8snorm,uL.keywords.r8uint,uL.keywords.r8sint,uL.keywords.r16uint,uL.keywords.r16sint,uL.keywords.r16float,uL.keywords.rg8unorm,uL.keywords.rg8snorm,uL.keywords.rg8uint,uL.keywords.rg8sint,uL.keywords.r32uint,uL.keywords.r32sint,uL.keywords.r32float,uL.keywords.rg16uint,uL.keywords.rg16sint,uL.keywords.rg16float,uL.keywords.rgba8unorm,uL.keywords.rgba8unorm_srgb,uL.keywords.rgba8snorm,uL.keywords.rgba8uint,uL.keywords.rgba8sint,uL.keywords.bgra8unorm,uL.keywords.bgra8unorm_srgb,uL.keywords.rgb10a2unorm,uL.keywords.rg11b10float,uL.keywords.rg32uint,uL.keywords.rg32sint,uL.keywords.rg32float,uL.keywords.rgba16uint,uL.keywords.rgba16sint,uL.keywords.rgba16float,uL.keywords.rgba32uint,uL.keywords.rgba32sint,uL.keywords.rgba32float],uL.const_literal=[uL.tokens.int_literal,uL.tokens.uint_literal,uL.tokens.decimal_float_literal,uL.tokens.hex_float_literal,uL.keywords.true,uL.keywords.false],uL.literal_or_ident=[uL.tokens.ident,uL.tokens.int_literal,uL.tokens.uint_literal,uL.tokens.decimal_float_literal,uL.tokens.hex_float_literal,uL.tokens.name],uL.element_count_expression=[uL.tokens.int_literal,uL.tokens.uint_literal,uL.tokens.ident],uL.template_types=[uL.keywords.vec2,uL.keywords.vec3,uL.keywords.vec4,uL.keywords.mat2x2,uL.keywords.mat2x3,uL.keywords.mat2x4,uL.keywords.mat3x2,uL.keywords.mat3x3,uL.keywords.mat3x4,uL.keywords.mat4x2,uL.keywords.mat4x3,uL.keywords.mat4x4,uL.keywords.atomic,uL.keywords.bitcast,...uL.any_texture_type],uL.attribute_name=[uL.tokens.ident,uL.keywords.block,uL.keywords.diagnostic],uL.assignment_operators=[uL.tokens.equal,uL.tokens.plus_equal,uL.tokens.minus_equal,uL.tokens.times_equal,uL.tokens.division_equal,uL.tokens.modulo_equal,uL.tokens.and_equal,uL.tokens.or_equal,uL.tokens.xor_equal,uL.tokens.shift_right_equal,uL.tokens.shift_left_equal],uL.increment_operators=[uL.tokens.plus_plus,uL.tokens.minus_minus];class uO{constructor(e,t,i,r,s){this.type=e,this.lexeme=t,this.line=i,this.start=r,this.end=s}toString(){return this.lexeme}isTemplateType(){return -1!=uL.template_types.indexOf(this.type)}isArrayType(){return this.type==uL.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class uR{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new uO(uL.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if("\n"==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if("/"==e){if("/"==this._peekAhead()){for(;"\n"!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if("*"==this._peekAhead()){this._advance();let t=1;for(;t>0&&!this._isAtEnd();)if("\n"==(e=this._advance()))this._line++;else if("*"==e){if("/"==this._peekAhead()&&(this._advance(),0==--t))break}else"/"==e&&"*"==this._peekAhead()&&(this._advance(),t++);return!0}}let t=uL.simpleTokens[e];if(t)return this._addToken(t),!0;let i=uL.none,r=this._isAlpha(e),s="_"===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(r){let t=uL.keywords[e];if(t)return this._addToken(t),!0}if(r||s)return this._addToken(uL.tokens.ident),!0;for(;;){let t=this._findType(e),r=this._peekAhead();if("-"==e&&this._tokens.length>0){if("="==r)return this._current++,e+=r,this._addToken(uL.tokens.minus_equal),!0;if("-"==r)return this._current++,e+=r,this._addToken(uL.tokens.minus_minus),!0;let i=this._tokens.length-1;if((-1!=uL.literal_or_ident.indexOf(this._tokens[i].type)||this._tokens[i].type==uL.tokens.paren_right)&&">"!=r)return this._addToken(t),!0}if(">"==e&&(">"==r||"="==r)){let e=!1,i=this._tokens.length-1;for(let t=0;t<5&&i>=0&&-1===uL.assignment_operators.indexOf(this._tokens[i].type);++t,--i)if(this._tokens[i].type===uL.tokens.less_than){i>0&&this._tokens[i-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===uL.none){let r=e,s=0;for(let e=0;e<2;++e)if(r+=this._peekAhead(e),(t=this._findType(r))!==uL.none){s=e;break}if(t===uL.none)return i!==uL.none&&(this._current--,this._addToken(i),!0);e=r,this._current+=s+1}if(i=t,this._isAtEnd())break;e+=this._advance()}return i!==uL.none&&(this._addToken(i),!0)}_findType(e){for(let t in uL.regexTokens){let i=uL.regexTokens[t];if(this._match(e,i.rule))return i}return uL.literalTokens[e]||uL.none}_match(e,t){let i=t.exec(e);return i&&0==i.index&&i[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&"_"!==e&&"."!==e&&"("!==e&&")"!==e&&"["!==e&&"]"!==e&&"{"!==e&&"}"!==e&&","!==e&&";"!==e&&":"!==e&&"="!==e&&"!"!==e&&"<"!==e&&">"!==e&&"+"!==e&&"-"!==e&&"*"!==e&&"/"!==e&&"%"!==e&&"&"!==e&&"|"!==e&&"^"!==e&&"~"!==e&&"@"!==e&&"#"!==e&&"?"!==e&&"'"!==e&&"`"!==e&&'"'!==e&&"\\"!==e&&"\n"!==e&&"\r"!==e&&"	"!==e&&"\0"!==e}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||"_"===e}_isWhitespace(e){return" "==e||"	"==e||"\r"==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){let t=this._source.substring(this._start,this._current);this._tokens.push(new uO(e,t,this._line,this._start,this._current))}}function uN(e){return Array.isArray(e)||(null==e?void 0:e.buffer)instanceof ArrayBuffer}let uj=new Float32Array(1),uD=new Uint32Array(uj.buffer),uz=new Uint32Array(uj.buffer),uF=new Int32Array(1),uB=new Float32Array(uF.buffer),uU=new Uint32Array(uF.buffer),u$=new Uint32Array(1),uV=new Float32Array(u$.buffer),uW=new Int32Array(u$.buffer);function uG(e,t,i){if(t===i)return e;if("f32"===t){if("i32"===i||"x32"===i)return uj[0]=e,uD[0];if("u32"===i)return uj[0]=e,uz[0]}else if("i32"===t||"x32"===t){if("f32"===i)return uF[0]=e,uB[0];if("u32"===i)return uF[0]=e,uU[0]}else if("u32"===t){if("f32"===i)return u$[0]=e,uV[0];if("i32"===i||"x32"===i)return u$[0]=e,uW[0]}return console.error(`Unsupported cast from ${t} to ${i}`),e}class uq{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class uH{constructor(e,t){this.align=e,this.size=t}}class uZ{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new cw,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return"texture_storage_1d"==e.name||"texture_storage_2d"==e.name||"texture_storage_2d_array"==e.name||"texture_storage_3d"==e.name}updateAST(e){for(let t of e)t instanceof cD&&this._functions.set(t.name,new uq(t));for(let t of e)if(t instanceof c7){let e=this.getTypeInfo(t,null);e instanceof ch&&this.structs.push(e)}for(let t of e)if(t instanceof c2)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof cV){let e=this._getAttributeNum(t.attributes,"id",0),i=null!=t.type?this.getTypeInfo(t.type,t.attributes):null;this.overrides.push(new cx(t.name,i,t.attributes,e));continue}if(this._isUniformVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),s=new cg(t.name,r,e,i,t.attributes,E.Uniform,t.access);s.access||(s.access="read"),this.uniforms.push(s);continue}if(this._isStorageVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),s=this._isStorageTexture(r),n=new cg(t.name,r,e,i,t.attributes,s?E.StorageTexture:E.Storage,t.access);n.access||(n.access="read"),this.storage.push(n);continue}if(this._isTextureVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),s=this._isStorageTexture(r),n=new cg(t.name,r,e,i,t.attributes,s?E.StorageTexture:E.Texture,t.access);n.access||(n.access="read"),s?this.storage.push(n):this.textures.push(n);continue}if(this._isSamplerVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),s=new cg(t.name,r,e,i,t.attributes,E.Sampler,t.access);this.samplers.push(s);continue}}for(let t of e)if(t instanceof cD){let e=this._getAttribute(t,"vertex"),i=this._getAttribute(t,"fragment"),r=this._getAttribute(t,"compute"),s=e||i||r,n=new cb(t.name,null==s?void 0:s.name,t.attributes);n.attributes=t.attributes,n.startLine=t.startLine,n.endLine=t.endLine,this.functions.push(n),this._functions.get(t.name).info=n,s&&(this._functions.get(t.name).inUse=!0,n.inUse=!0,n.resources=this._findResources(t,!!s),n.inputs=this._getInputs(t.args),n.outputs=this._getOutputs(t.returnType),this.entry[s.name].push(n)),n.arguments=t.args.map(e=>new c_(e.name,this.getTypeInfo(e.type,e.attributes),e.attributes)),n.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(let e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(let e of this._functions.values())e.node.search(t=>{var i,r,s;if(t instanceof uw){if(t.value)if(uN(t.value))for(let r of t.value)for(let t of this.overrides)r===t.name&&(null==(i=e.info)||i.overrides.push(t));else for(let i of this.overrides)t.value===i.name&&(null==(r=e.info)||r.overrides.push(i))}else if(t instanceof uo)for(let i of this.overrides)t.name===i.name&&(null==(s=e.info)||s.overrides.push(i))});for(let e of this.uniforms)this._markStructsInUse(e.type);for(let e of this.storage)this._markStructsInUse(e.type)}getFunctionInfo(e){for(let t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(let t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(let t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(let t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{let t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var i;for(let r of e.calls){let e=null==(i=this._functions.get(r.name))?void 0:i.info;e&&t.add(e)}}findResource(e,t,i){if(i){for(let r of this.entry.compute)if(r.name===i){for(let i of r.resources)if(i.group==e&&i.binding==t)return i}for(let r of this.entry.vertex)if(r.name===i){for(let i of r.resources)if(i.group==e&&i.binding==t)return i}for(let r of this.entry.fragment)if(r.name===i){for(let i of r.resources)if(i.group==e&&i.binding==t)return i}}for(let i of this.uniforms)if(i.group==e&&i.binding==t)return i;for(let i of this.storage)if(i.group==e&&i.binding==t)return i;for(let i of this.textures)if(i.group==e&&i.binding==t)return i;for(let i of this.samplers)if(i.group==e&&i.binding==t)return i;return null}_findResource(e){for(let t of this.uniforms)if(t.name==e)return t;for(let t of this.storage)if(t.name==e)return t;for(let t of this.textures)if(t.name==e)return t;for(let t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){let t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){let i=[],r=this,s=[];return e.search(n=>{if(n instanceof cO)s.push({});else if(n instanceof cR)s.pop();else if(n instanceof c$)t&&null!==n.type&&this._markStructsFromAST(n.type),s.length>0&&(s[s.length-1][n.name]=n);else if(n instanceof un)t&&null!==n.type&&this._markStructsFromAST(n.type);else if(n instanceof cW)t&&null!==n.type&&this._markStructsFromAST(n.type),s.length>0&&(s[s.length-1][n.name]=n);else if(n instanceof uo){if(s.length>0&&s[s.length-1][n.name])return;let e=r._findResource(n.name);e&&i.push(e)}else if(n instanceof ua){let s=r._functions.get(n.name);s&&(t&&(s.inUse=!0),e.calls.add(s.node),null===s.resources&&(s.resources=r._findResources(s.node,t)),i.push(...s.resources))}else if(n instanceof cZ){let s=r._functions.get(n.name);s&&(t&&(s.inUse=!0),e.calls.add(s.node),null===s.resources&&(s.resources=r._findResources(s.node,t)),i.push(...s.resources))}}),[...new Map(i.map(e=>[e.name,e])).values()]}getBindGroups(){let e=[];function t(t,i){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),i>=e[t].length&&(e[t].length=i+1)}for(let i of this.uniforms)t(i.group,i.binding),e[i.group][i.binding]=i;for(let i of this.storage)t(i.group,i.binding),e[i.group][i.binding]=i;for(let i of this.textures)t(i.group,i.binding),e[i.group][i.binding]=i;for(let i of this.samplers)t(i.group,i.binding),e[i.group][i.binding]=i;return e}_getOutputs(e,t){if(void 0===t&&(t=[]),e instanceof c7)this._getStructOutputs(e,t);else{let i=this._getOutputInfo(e);null!==i&&t.push(i)}return t}_getStructOutputs(e,t){for(let i of e.members)if(i.type instanceof c7)this._getStructOutputs(i.type,t);else{let e=this._getAttribute(i,"location")||this._getAttribute(i,"builtin");if(null!==e){let r=this.getTypeInfo(i.type,i.type.attributes),s=this._parseInt(e.value),n=new cv(i.name,r,e.name,s);t.push(n)}}}_getOutputInfo(e){let t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){let i=this.getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new cv("",i,t.name,r)}return null}_getInputs(e,t){for(let i of(void 0===t&&(t=[]),e))if(i.type instanceof c7)this._getStructInputs(i.type,t);else{let e=this._getInputInfo(i);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(let i of e.members)if(i.type instanceof c7)this._getStructInputs(i.type,t);else{let e=this._getInputInfo(i);null!==e&&t.push(e)}}_getInputInfo(e){let t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){let i=this._getAttribute(e,"interpolation"),r=this.getTypeInfo(e.type,e.attributes),s=this._parseInt(t.value),n=new cy(e.name,r,t.name,s);return null!==i&&(n.interpolation=this._parseString(i.value)),n}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);let t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(let t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new cm(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(let t of this.structs)if(t.name==e)return t;for(let t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof ue){let i=e.type?this.getTypeInfo(e.type,e.attributes):null,r=new cf(e.name,i,t);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof ut){let i=e.format?this.getTypeInfo(e.format,e.attributes):null,r=new cd(e.name,t);return r.format=i,r.count=e.count,this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof c7){let i=new ch(e.name,t);for(let t of(i.startLine=e.startLine,i.endLine=e.endLine,e.members)){let e=this.getTypeInfo(t.type,t.attributes);i.members.push(new cu(t.name,e,t.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof ui){let i=e.format instanceof c5,r=e.format?i?this.getTypeInfo(e.format,null):new cc(e.format,null):null,s=new cp(e.name,r,t,e.access);return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof c9){let i=e.format?this.getTypeInfo(e.format,null):null,r=new cp(e.name,i,t,e.access);return this._types.set(e,r),this._updateTypeInfo(r),r}let i=new cc(e.name,t);return this._types.set(e,i),this._updateTypeInfo(i),i}_updateTypeInfo(e){var t,i,r;let s=this._getTypeSize(e);if(e.size=null!=(t=null==s?void 0:s.size)?t:0,e instanceof cd&&e.format){let t=this._getTypeSize(e.format);e.stride=Math.max(null!=(i=null==t?void 0:t.size)?i:0,null!=(r=null==t?void 0:t.align)?r:0),this._updateTypeInfo(e.format)}e instanceof cf&&this._updateTypeInfo(e.format),e instanceof ch&&this._updateStructInfo(e)}_updateStructInfo(e){let t=0,i=0,r=0,s=0;for(let n=0,a=e.members.length;n<a;++n){let a=e.members[n],o=this._getTypeSize(a);if(!o)continue;null!=this._getAlias(a.type.name)||a.type;let l=o.align,c=o.size;t=this._roundUp(l,t+i),i=c,r=t,s=Math.max(s,l),a.offset=t,a.size=c,this._updateTypeInfo(a.type)}e.size=this._roundUp(s,r+i),e.align=s}_getTypeSize(e){var t,i;if(null==e)return null;let r=this._getAttributeNum(e.attributes,"size",0),s=this._getAttributeNum(e.attributes,"align",0);if(e instanceof cu&&(e=e.type),e instanceof cc){let t=this._getAlias(e.name);null!==t&&(e=t)}{let i=uZ._typeInfo[e.name];if(void 0!==i){let n="f16"===(null==(t=e.format)?void 0:t.name)?2:1;return new uH(Math.max(s,i.align/n),Math.max(r,i.size/n))}}{let t=uZ._typeInfo[e.name.substring(0,e.name.length-1)];if(t){let i="h"===e.name[e.name.length-1]?2:1;return new uH(Math.max(s,t.align/i),Math.max(r,t.size/i))}}if(e instanceof cd){let t=e,n=8,a=8,o=this._getTypeSize(t.format);return null!==o&&(a=o.size,n=o.align),a=t.count*this._getAttributeNum(null!=(i=null==e?void 0:e.attributes)?i:null,"stride",this._roundUp(n,a)),r&&(a=r),new uH(Math.max(s,n),Math.max(r,a))}if(e instanceof ch){let t=0,i=0,n=0,a=0,o=0;for(let i of e.members){let e=this._getTypeSize(i.type);null!==e&&(t=Math.max(e.align,t),n=this._roundUp(e.align,n+a),a=e.size,o=n)}return i=this._roundUp(t,o+a),new uH(Math.max(s,t),Math.max(r,i))}return null}_isUniformVar(e){return e instanceof c$&&"uniform"==e.storage}_isStorageVar(e){return e instanceof c$&&"storage"==e.storage}_isTextureVar(e){return e instanceof c$&&null!==e.type&&-1!=uZ._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof c$&&null!==e.type&&-1!=uZ._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){if(!e||!e.attributes)return null;for(let i of e.attributes)if(i.name==t)return i;return null}_getAttributeNum(e,t,i){if(null===e)return i;for(let r of e)if(r.name==t){let e=null!==r&&null!==r.value?r.value:i;return e instanceof Array&&(e=e[0]),"number"==typeof e?e:"string"==typeof e?parseInt(e):i}return i}_roundUp(e,t){return Math.ceil(t/e)*e}}uZ._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},uZ._textureTypes=uL.any_texture_type.map(e=>e.name),uZ._samplerTypes=uL.sampler_type.map(e=>e.name);let uY=0;class uX{constructor(e,t,i){this.id=uY++,this.name=e,this.value=t,this.node=i}clone(){return new uX(this.name,this.value,this.node)}}class uK{constructor(e){this.id=uY++,this.name=e.name,this.node=e}clone(){return new uK(this.node)}}class uJ{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=uY++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?null!=(t=this.variables.get(e))?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?null!=(t=this.functions.get(e))?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,i){this.variables.set(e,new uX(e,t,null!=i?i:null))}setVariable(e,t,i){let r=this.getVariable(e);null!==r?r.value=t:this.createVariable(e,t,i)}getVariableValue(e){var t;let i=this.getVariable(e);return null!=(t=null==i?void 0:i.value)?t:null}clone(){return new uJ(this)}}class uQ{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class u0{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){let i=this.exec.evalExpression(e.args[0],t),r=!0;if(i instanceof uC)return i.data.forEach(e=>{e||(r=!1)}),new uT(+!!r,this.getTypeInfo("bool"));throw Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof uC)return new uT(+!!i.data.some(e=>e),this.getTypeInfo("bool"));throw Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){let i=this.exec.evalExpression(e.args[2],t);if(!(i instanceof uT))throw Error(`Select() expects a bool condition. Line ${e.line}`);return i.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.evalExpression(i,t);if(r instanceof uA&&0===r.typeInfo.size){let e=r.typeInfo;return new uT(r.buffer.byteLength/e.stride,this.getTypeInfo("u32"))}return new uT(r.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.abs(e)),i.typeInfo):new uT(Math.abs(i.value),i.typeInfo)}Acos(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.acos(e)),i.typeInfo):new uT(Math.acos(i.value),i.typeInfo)}Acosh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.acosh(e)),i.typeInfo):new uT(Math.acosh(i.value),i.typeInfo)}Asin(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.asin(e)),i.typeInfo):new uT(Math.asin(i.value),i.typeInfo)}Asinh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.asinh(e)),i.typeInfo):new uT(Math.asinh(i.value),i.typeInfo)}Atan(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.atan(e)),i.typeInfo):new uT(Math.atan(i.value),i.typeInfo)}Atanh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.atanh(e)),i.typeInfo):new uT(Math.atanh(i.value),i.typeInfo)}Atan2(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof uC&&r instanceof uC?new uC(i.data.map((e,t)=>Math.atan2(e,r.data[t])),i.typeInfo):new uT(Math.atan2(i.value,r.value),i.typeInfo)}Ceil(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.ceil(e)),i.typeInfo):new uT(Math.ceil(i.value),i.typeInfo)}_clamp(e,t,i){return Math.min(Math.max(e,t),i)}Clamp(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);return i instanceof uC&&r instanceof uC&&s instanceof uC?new uC(i.data.map((e,t)=>this._clamp(e,r.data[t],s.data[t])),i.typeInfo):new uT(this._clamp(i.value,r.value,s.value),i.typeInfo)}Cos(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.cos(e)),i.typeInfo):new uT(Math.cos(i.value),i.typeInfo)}Cosh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.cosh(e)),i.typeInfo):new uT(Math.cos(i.value),i.typeInfo)}CountLeadingZeros(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.clz32(e)),i.typeInfo):new uT(Math.clz32(i.value),i.typeInfo)}_countOneBits(e){let t=0;for(;0!==e;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>this._countOneBits(e)),i.typeInfo):new uT(this._countOneBits(i.value),i.typeInfo)}_countTrailingZeros(e){if(0===e)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>this._countTrailingZeros(e)),i.typeInfo):new uT(this._countTrailingZeros(i.value),i.typeInfo)}Cross(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof uC&&r instanceof uC){if(3!==i.data.length||3!==r.data.length)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;let t=i.data,s=r.data;return new uC([t[1]*s[2]-s[1]*t[2],t[2]*s[0]-s[2]*t[0],t[0]*s[1]-s[0]*t[1]],i.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){let i=this.exec.evalExpression(e.args[0],t),r=180/Math.PI;return i instanceof uC?new uC(i.data.map(e=>e*r),i.typeInfo):new uT(i.value*r,this.getTypeInfo("f32"))}Determinant(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof uM){let e=i.data,t=i.typeInfo.getTypeName(),r=t.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if("mat2x2"===t||"mat2x2f"===t||"mat2x2h"===t)return new uT(e[0]*e[3]-e[1]*e[2],r);if("mat2x3"===t||"mat2x3f"===t||"mat2x3h"===t)return new uT(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);if("mat2x4"===t||"mat2x4f"===t||"mat2x4h"===t)console.error(`TODO: Determinant for ${t}`);else if("mat3x2"===t||"mat3x2f"===t||"mat3x2h"===t)console.error(`TODO: Determinant for ${t}`);else{if("mat3x3"===t||"mat3x3f"===t||"mat3x3h"===t)return new uT(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);"mat3x4"===t||"mat3x4f"===t||"mat3x4h"===t||"mat4x2"===t||"mat4x2f"===t||"mat4x2h"===t||"mat4x3"===t||"mat4x3f"===t||"mat4x3h"===t?console.error(`TODO: Determinant for ${t}`):"mat4x4"!==t&&"mat4x4f"!==t&&"mat4x4h"!==t||console.error(`TODO: Determinant for ${t}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof uC&&r instanceof uC){let e=0;for(let t=0;t<i.data.length;++t)e+=(i.data[t]-r.data[t])*(i.data[t]-r.data[t]);return new uT(Math.sqrt(e),this.getTypeInfo("f32"))}return new uT(Math.abs(i.value-r.value),i.typeInfo)}_dot(e,t){let i=0;for(let r=0;r<e.length;++r)i+=t[r]*e[r];return i}Dot(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof uC&&r instanceof uC?new uT(this._dot(i.data,r.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.exp(e)),i.typeInfo):new uT(Math.exp(i.value),i.typeInfo)}Exp2(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.pow(2,e)),i.typeInfo):new uT(Math.pow(2,i.value),i.typeInfo)}ExtractBits(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if("u32"!==r.typeInfo.name&&"x32"!==r.typeInfo.name)return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if("u32"!==s.typeInfo.name&&"x32"!==s.typeInfo.name)return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;let n=r.value,a=s.value;return i instanceof uC?new uC(i.data.map(e=>e>>n&(1<<a)-1),i.typeInfo):"i32"!==i.typeInfo.name&&"x32"!==i.typeInfo.name?(console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null):new uT(i.value>>n&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);return i instanceof uC&&r instanceof uC&&s instanceof uC?new uC(0>this._dot(r.data,s.data)?Array.from(i.data):i.data.map(e=>-e),i.typeInfo):(console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null)}_firstLeadingBit(e){return 0===e?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>this._firstLeadingBit(e)),i.typeInfo):new uT(this._firstLeadingBit(i.value),i.typeInfo)}_firstTrailingBit(e){return 0===e?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>this._firstTrailingBit(e)),i.typeInfo):new uT(this._firstTrailingBit(i.value),i.typeInfo)}Floor(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.floor(e)),i.typeInfo):new uT(Math.floor(i.value),i.typeInfo)}Fma(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);return i instanceof uC&&r instanceof uC&&s instanceof uC?i.data.length!==r.data.length||i.data.length!==s.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new uC(i.data.map((e,t)=>e*r.data[t]+s.data[t]),i.typeInfo):new uT(i.value*r.value+s.value,i.typeInfo)}Fract(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>e-Math.floor(e)),i.typeInfo):new uT(i.value-Math.floor(i.value),i.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t),n=this.exec.evalExpression(e.args[3],t);if("u32"!==s.typeInfo.name&&"x32"!==s.typeInfo.name)return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;let a=s.value,o=(1<<n.value)-1<<a,l=~o;return i instanceof uC&&r instanceof uC?new uC(i.data.map((e,t)=>e&l|r.data[t]<<a&o),i.typeInfo):new uT(i.value&l|r.value<<a&o,i.typeInfo)}InverseSqrt(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>1/Math.sqrt(e)),i.typeInfo):new uT(1/Math.sqrt(i.value),i.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof uC){let e=0;return i.data.forEach(t=>{e+=t*t}),new uT(Math.sqrt(e),this.getTypeInfo("f32"))}return new uT(Math.abs(i.value),i.typeInfo)}Log(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.log(e)),i.typeInfo):new uT(Math.log(i.value),i.typeInfo)}Log2(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.log2(e)),i.typeInfo):new uT(Math.log2(i.value),i.typeInfo)}Max(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof uC&&r instanceof uC?new uC(i.data.map((e,t)=>Math.max(e,r.data[t])),i.typeInfo):new uT(Math.max(i.value,r.value),i.typeInfo)}Min(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof uC&&r instanceof uC?new uC(i.data.map((e,t)=>Math.min(e,r.data[t])),i.typeInfo):new uT(Math.min(i.value,r.value),i.typeInfo)}Mix(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);return i instanceof uC&&r instanceof uC&&s instanceof uC?new uC(i.data.map((e,t)=>i.data[t]*(1-s.data[t])+r.data[t]*s.data[t]),i.typeInfo):new uT(i.value*(1-s.value)+r.value*s.value,i.typeInfo)}Modf(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof uC&&r instanceof uC?new uC(i.data.map((e,t)=>e%r.data[t]),i.typeInfo):new uT(i.value%r.value,i.typeInfo)}Normalize(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof uC){let r=this.Length(e,t).value;return new uC(i.data.map(e=>e/r),i.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof uC&&r instanceof uC?new uC(i.data.map((e,t)=>Math.pow(e,r.data[t])),i.typeInfo):new uT(Math.pow(i.value,r.value),i.typeInfo)}QuantizeToF16(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>e),i.typeInfo):new uT(i.value,i.typeInfo)}Radians(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>e*Math.PI/180),i.typeInfo):new uT(i.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof uC&&r instanceof uC){let e=this._dot(i.data,r.data);return new uC(i.data.map((t,i)=>t-2*e*r.data[i]),i.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(i instanceof uC&&r instanceof uC&&s instanceof uT){let e=this._dot(r.data,i.data);return new uC(i.data.map((t,i)=>{let n=1-s.value*s.value*(1-e*e);if(n<0)return 0;let a=Math.sqrt(n);return s.value*t-(s.value*e+a)*r.data[i]}),i.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.round(e)),i.typeInfo):new uT(Math.round(i.value),i.typeInfo)}Saturate(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.min(Math.max(e,0),1)),i.typeInfo):new uT(Math.min(Math.max(i.value,0),1),i.typeInfo)}Sign(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.sign(e)),i.typeInfo):new uT(Math.sign(i.value),i.typeInfo)}Sin(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.sin(e)),i.typeInfo):new uT(Math.sin(i.value),i.typeInfo)}Sinh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.sinh(e)),i.typeInfo):new uT(Math.sinh(i.value),i.typeInfo)}_smoothstep(e,t,i){let r=Math.min(Math.max((i-e)/(t-e),0),1);return r*r*(3-2*r)}SmoothStep(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);return s instanceof uC&&i instanceof uC&&r instanceof uC?new uC(s.data.map((e,t)=>this._smoothstep(i.data[t],r.data[t],e)),s.typeInfo):new uT(this._smoothstep(i.value,r.value,s.value),s.typeInfo)}Sqrt(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.sqrt(e)),i.typeInfo):new uT(Math.sqrt(i.value),i.typeInfo)}Step(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return r instanceof uC&&i instanceof uC?new uC(r.data.map((e,t)=>e<i.data[t]?0:1),r.typeInfo):new uT(r.value<i.value?0:1,i.typeInfo)}Tan(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.tan(e)),i.typeInfo):new uT(Math.tan(i.value),i.typeInfo)}Tanh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.tanh(e)),i.typeInfo):new uT(Math.tanh(i.value),i.typeInfo)}_getTransposeType(e){let t=e.getTypeName();return"mat2x2f"===t||"mat2x2h"===t?e:"mat2x3f"===t?this.getTypeInfo("mat3x2f"):"mat2x3h"===t?this.getTypeInfo("mat3x2h"):"mat2x4f"===t?this.getTypeInfo("mat4x2f"):"mat2x4h"===t?this.getTypeInfo("mat4x2h"):"mat3x2f"===t?this.getTypeInfo("mat2x3f"):"mat3x2h"===t?this.getTypeInfo("mat2x3h"):"mat3x3f"===t||"mat3x3h"===t?e:"mat3x4f"===t?this.getTypeInfo("mat4x3f"):"mat3x4h"===t?this.getTypeInfo("mat4x3h"):"mat4x2f"===t?this.getTypeInfo("mat2x4f"):"mat4x2h"===t?this.getTypeInfo("mat2x4h"):"mat4x3f"===t?this.getTypeInfo("mat3x4f"):"mat4x3h"===t?this.getTypeInfo("mat3x4h"):("mat4x4f"===t||"mat4x4h"===t||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){let i=this.exec.evalExpression(e.args[0],t);if(!(i instanceof uM))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;let r=this._getTransposeType(i.typeInfo);if("mat2x2"===i.typeInfo.name||"mat2x2f"===i.typeInfo.name||"mat2x2h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[2],e[1],e[3]],r)}if("mat2x3"===i.typeInfo.name||"mat2x3f"===i.typeInfo.name||"mat2x3h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[3],e[6],e[1],e[4],e[7]],r)}if("mat2x4"===i.typeInfo.name||"mat2x4f"===i.typeInfo.name||"mat2x4h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13]],r)}if("mat3x2"===i.typeInfo.name||"mat3x2f"===i.typeInfo.name||"mat3x2h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[3],e[1],e[4],e[2],e[5]],r)}if("mat3x3"===i.typeInfo.name||"mat3x3f"===i.typeInfo.name||"mat3x3h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]],r)}if("mat3x4"===i.typeInfo.name||"mat3x4f"===i.typeInfo.name||"mat3x4h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14]],r)}if("mat4x2"===i.typeInfo.name||"mat4x2f"===i.typeInfo.name||"mat4x2h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[4],e[1],e[5],e[2],e[6]],r)}if("mat4x3"===i.typeInfo.name||"mat4x3f"===i.typeInfo.name||"mat4x3h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]],r)}if("mat4x4"===i.typeInfo.name||"mat4x4f"===i.typeInfo.name||"mat4x4h"===i.typeInfo.name){let e=i.data;return new uM([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]],r)}return console.error(`Invalid matrix type ${i.typeInfo.name}`),null}Trunc(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof uC?new uC(i.data.map(e=>Math.trunc(e)),i.typeInfo):new uT(Math.trunc(i.value),i.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){let i=e.args[0],r=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(i instanceof uo){let s=i.name,n=t.getVariableValue(s);if(n instanceof uI){if(r<0||r>=n.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;let t=n.getMipLevelSize(r),i=n.dimension;return"1d"===i?new uT(t[0],this.getTypeInfo("u32")):"3d"===i?new uC(t,this.getTypeInfo("vec3u")):"2d"===i?new uC(t.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${i} not found. Line ${e.line}`),null)}return console.error(`Texture ${s} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){let i=e.args[0],r=this.exec.evalExpression(e.args[1],t),s=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(r instanceof uC)||2!==r.data.length)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(i instanceof uo){let n=i.name,a=t.getVariableValue(n);if(a instanceof uI){let t=Math.floor(r.data[0]),i=Math.floor(r.data[1]);if(t<0||t>=a.width||i<0||i>=a.height)return console.error(`Texture ${n} out of bounds. Line ${e.line}`),null;let o=a.getPixel(t,i,0,s);return null===o?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new uC(o,this.getTypeInfo("vec4f"))}return console.error(`Texture ${n} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){let i=e.args[0];if(i instanceof uo){let r=i.name,s=t.getVariableValue(r);return s instanceof uI?new uT(s.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){let i=e.args[0];if(i instanceof uo){let r=i.name,s=t.getVariableValue(r);return s instanceof uI?new uT(s.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){let i=e.args[0];if(i instanceof uo){let r=i.name,s=t.getVariableValue(r);return s instanceof uI?new uT(s.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){let i=e.args[0],r=this.exec.evalExpression(e.args[1],t),s=4===e.args.length?this.exec.evalExpression(e.args[2],t).value:0,n=4===e.args.length?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(4!==n.length)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(r instanceof uC)||2!==r.data.length)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(i instanceof uo){let a=i.name,o=t.getVariableValue(a);if(o instanceof uI){let t=o.getMipLevelSize(0),i=Math.floor(r.data[0]),l=Math.floor(r.data[1]);return i<0||i>=t[0]||l<0||l>=t[1]?console.error(`Texture ${a} out of bounds. Line ${e.line}`):o.setPixel(i,l,0,s,Array.from(n)),null}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t);return t.getVariable(r).value.getSubData(this.exec,i.postfix,t)}AtomicStore(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t);return o instanceof uT&&a instanceof uT&&(o.value=a.value),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),null}AtomicAdd(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value+=a.value),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicSub(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value-=a.value),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicMax(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value=Math.max(o.value,a.value)),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicMin(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value=Math.min(o.value,a.value)),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicAnd(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value=o.value&a.value),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicOr(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value=o.value|a.value),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicXor(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value=o.value^a.value),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicExchange(e,t){let i=e.args[0];i instanceof uf&&(i=i.right);let r=this.exec.getVariableName(i,t),s=t.getVariable(r),n=e.args[1],a=this.exec.evalExpression(n,t),o=s.value.getSubData(this.exec,i.postfix,t),l=new uT(o.value,o.typeInfo);return o instanceof uT&&a instanceof uT&&(o.value=a.value),s.value instanceof uA&&s.value.setDataValue(this.exec,o,i.postfix,t),l}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}let u1={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},u2={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class u3 extends uQ{constructor(e,t){var i;super(),this.ast=null!=e?e:[],this.reflection=new uZ,this.reflection.updateAST(this.ast),this.context=null!=(i=null==t?void 0:t.clone())?i:new uJ,this.builtins=new u0(this),this.typeInfo={bool:this.getTypeInfo(c5.bool),i32:this.getTypeInfo(c5.i32),u32:this.getTypeInfo(c5.u32),f32:this.getTypeInfo(c5.f32),f16:this.getTypeInfo(c5.f16),vec2f:this.getTypeInfo(c9.vec2f),vec2u:this.getTypeInfo(c9.vec2u),vec2i:this.getTypeInfo(c9.vec2i),vec2h:this.getTypeInfo(c9.vec2h),vec3f:this.getTypeInfo(c9.vec3f),vec3u:this.getTypeInfo(c9.vec3u),vec3i:this.getTypeInfo(c9.vec3i),vec3h:this.getTypeInfo(c9.vec3h),vec4f:this.getTypeInfo(c9.vec4f),vec4u:this.getTypeInfo(c9.vec4u),vec4i:this.getTypeInfo(c9.vec4i),vec4h:this.getTypeInfo(c9.vec4h),mat2x2f:this.getTypeInfo(c9.mat2x2f),mat2x3f:this.getTypeInfo(c9.mat2x3f),mat2x4f:this.getTypeInfo(c9.mat2x4f),mat3x2f:this.getTypeInfo(c9.mat3x2f),mat3x3f:this.getTypeInfo(c9.mat3x3f),mat3x4f:this.getTypeInfo(c9.mat3x4f),mat4x2f:this.getTypeInfo(c9.mat4x2f),mat4x3f:this.getTypeInfo(c9.mat4x3f),mat4x4f:this.getTypeInfo(c9.mat4x4f)}}getVariableValue(e){var t,i;let r=null!=(i=null==(t=this.context.getVariable(e))?void 0:t.value)?i:null;if(null===r)return null;if(r instanceof uT)return r.value;if(r instanceof uC||r instanceof uM)return Array.from(r.data);if(r instanceof uA&&r.typeInfo instanceof cd){if("u32"===r.typeInfo.format.name)return Array.from(new Uint32Array(r.buffer,r.offset,r.typeInfo.count));if("i32"===r.typeInfo.format.name)return Array.from(new Int32Array(r.buffer,r.offset,r.typeInfo.count));if("f32"===r.typeInfo.format.name)return Array.from(new Float32Array(r.buffer,r.offset,r.typeInfo.count))}return console.error(`Unsupported return variable type ${r.typeInfo.name}`),null}execute(e){(e=null!=e?e:{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,i,r){let s=this.context.clone();(r=null!=r?r:{}).constants&&this._setOverrides(r.constants,s),this._execStatements(this.ast,s);let n=s.getFunction(e);if(!n)return void console.error(`Function ${e} not found`);if("number"==typeof t)t=[t,1,1];else{if(0===t.length)return void console.error("Invalid dispatch count");1===t.length?t=[t[0],1,1]:2===t.length?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}let a=t[0],o=t[1],l=t[2],c=this.getTypeInfo("vec3u");s.setVariable("@num_workgroups",new uC(t,c));let u=this.reflection.getFunctionInfo(e);for(let t in null===u&&console.error(`Function ${e} not found in reflection data`),i)for(let e in i[t]){let r=i[t][e];s.variables.forEach(i=>{var s;let n=i.node;if(null==n?void 0:n.attributes){let a=null,o=null;for(let e of n.attributes)"binding"===e.name?a=e.value:"group"===e.name&&(o=e.value);if(e==a&&t==o){let a=!1;for(let r of u.resources)if(r.name===i.name&&r.group===parseInt(t)&&r.binding===parseInt(e)){a=!0;break}a&&(void 0!==r.texture&&void 0!==r.descriptor?i.value=new uI(r.texture,this.getTypeInfo(n.type),r.descriptor,null!=(s=r.texture.view)?s:null):void 0!==r.uniform?i.value=new uA(r.uniform,this.getTypeInfo(n.type)):i.value=new uA(r,this.getTypeInfo(n.type)))}}})}for(let e=0;e<l;++e)for(let t=0;t<o;++t)for(let i=0;i<a;++i)s.setVariable("@workgroup_id",new uC([i,t,e],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(n,[i,t,e],s)}execStatement(e,t){if(e instanceof cJ)return this.evalExpression(e.value,t);if(e instanceof c4){if(e.condition){let i=this.evalExpression(e.condition,t);if(!(i instanceof uT))throw Error("Invalid break-if condition");if(!i.value)return null}return u3._breakObj}if(e instanceof c6)return u3._continueObj;if(e instanceof cW)this._let(e,t);else if(e instanceof c$)this._var(e,t);else if(e instanceof cG)this._const(e,t);else if(e instanceof cD)this._function(e,t);else{if(e instanceof cK)return this._if(e,t);if(e instanceof cX)return this._switch(e,t);if(e instanceof cU)return this._for(e,t);if(e instanceof cF)return this._while(e,t);if(e instanceof cY)return this._loop(e,t);if(e instanceof cB){let i=t.clone();return i.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,i)}if(e instanceof cH)this._assign(e,t);else if(e instanceof cq)this._increment(e,t);else{if(e instanceof c7)return null;if(e instanceof cV){let i=e.name;null===t.getVariable(i)&&t.setVariable(i,new uT(0,this.getTypeInfo("u32")))}else if(e instanceof cZ)this._call(e,t);else{if(e instanceof c1||e instanceof c2)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof up?this._evalBinaryOp(e,t):e instanceof uc?this._evalLiteral(e,t):e instanceof uo?this._evalVariable(e,t):e instanceof ua?this._evalCall(e,t):e instanceof un?this._evalCreate(e,t):e instanceof ul?this._evalConst(e,t):e instanceof uu?this._evalBitcast(e,t):e instanceof uf?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof c5){let t=this.reflection.getTypeInfo(e);if(null!==t)return t}let i=null!=(t=this.typeInfo[e])?t:null;return null!==i||(i=this.reflection.getTypeInfoByName(e)),i}_setOverrides(e,t){for(let i in e){let r=e[i],s=this.reflection.getOverrideInfo(i);null!==s?(null===s.type&&(s.type=this.getTypeInfo("u32")),"u32"===s.type.name||"i32"===s.type.name||"f32"===s.type.name||"f16"===s.type.name?t.setVariable(i,new uT(r,s.type)):"bool"===s.type.name?t.setVariable(i,new uT(+!!r,s.type)):"vec2"===s.type.name||"vec3"===s.type.name||"vec4"===s.type.name||"vec2f"===s.type.name||"vec3f"===s.type.name||"vec4f"===s.type.name||"vec2i"===s.type.name||"vec3i"===s.type.name||"vec4i"===s.type.name||"vec2u"===s.type.name||"vec3u"===s.type.name||"vec4u"===s.type.name||"vec2h"===s.type.name||"vec3h"===s.type.name||"vec4h"===s.type.name?t.setVariable(i,new uC(r,s.type)):console.error(`Invalid constant type for ${i}`)):console.error(`Override ${i} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,i){let r=[1,1,1];for(let t of e.node.attributes)if("workgroup_size"===t.name){if(t.value.length>0){let e=i.getVariableValue(t.value[0]);r[0]=e instanceof uT?e.value:parseInt(t.value[0])}if(t.value.length>1){let e=i.getVariableValue(t.value[1]);r[1]=e instanceof uT?e.value:parseInt(t.value[1])}if(t.value.length>2){let e=i.getVariableValue(t.value[2]);r[2]=e instanceof uT?e.value:parseInt(t.value[2])}}let s=this.getTypeInfo("vec3u"),n=this.getTypeInfo("u32");i.setVariable("@workgroup_size",new uC(r,s));let a=r[0],o=r[1],l=r[2];for(let c=0,u=0;c<l;++c)for(let l=0;l<o;++l)for(let o=0;o<a;++o,++u){let a=[o,l,c],h=[o+t[0]*r[0],l+t[1]*r[1],c+t[2]*r[2]];i.setVariable("@local_invocation_id",new uC(a,s)),i.setVariable("@global_invocation_id",new uC(h,s)),i.setVariable("@local_invocation_index",new uT(u,n)),this._dispatchExec(e,i)}}_dispatchExec(e,t){for(let i of e.node.args)for(let e of i.attributes)if("builtin"===e.name){let r=`@${e.value}`,s=t.getVariable(r);void 0!==s&&t.variables.set(i.name,s)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof uf;)e=e.right;return e instanceof uo?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(let i of e){if(i instanceof Array){let e=t.clone(),r=this._execStatements(i,e);if(r)return r;continue}let e=this.execStatement(i,t);if(e)return e}return null}_call(e,t){let i=t.clone();i.currentFunctionName=e.name;let r=t.getFunction(e.name);if(r){for(let t=0;t<r.node.args.length;++t){let s=r.node.args[t],n=this.evalExpression(e.args[t],i);i.setVariable(s.name,n,s)}this._execStatements(r.node.body,i)}else e.isBuiltin?this._callBuiltinFunction(e,i):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){let i=this.getVariableName(e.variable,t),r=t.getVariable(i);r?"++"===e.operator?r.value instanceof uT?r.value.value++:console.error(`Variable ${i} is not a scalar. Line ${e.line}`):"--"===e.operator?r.value instanceof uT?r.value.value--:console.error(`Variable ${i} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${i} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof uo){let i=this.getVariableName(e,t),r=t.getVariable(i);return null===r?(console.error(`Variable ${i} not found. Line ${e.line}`),null):r.value.getSubData(this,e.postfix,t)}if(e instanceof uf){if("*"===e.operator){let i=this._getVariableData(e.right,t);return i instanceof uS?i.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if("&"===e.operator)return new uS(this._getVariableData(e.right,t))}return null}_assign(e,t){let i=null,r="<var>",s=null;if(e.variable instanceof uf){let i=this._getVariableData(e.variable,t),r=this.evalExpression(e.value,t),s=e.operator;if("="===s){if(i instanceof uT||i instanceof uC||i instanceof uM){if(r instanceof uT||r instanceof uC||r instanceof uM&&i.data.length===r.data.length)return void i.data.set(r.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(i instanceof uA&&r instanceof uA&&i.buffer.byteLength-i.offset>=r.buffer.byteLength-r.offset)return void(i.buffer.byteLength%4==0?new Uint32Array(i.buffer,i.offset,i.typeInfo.size/4).set(new Uint32Array(r.buffer,r.offset,r.typeInfo.size/4)):new Uint8Array(i.buffer,i.offset,i.typeInfo.size).set(new Uint8Array(r.buffer,r.offset,r.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if("+="===s)return i instanceof uT||i instanceof uC||i instanceof uM?r instanceof uT||r instanceof uC||r instanceof uM?void i.data.set(r.data.map((e,t)=>i.data[t]+e)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if("-="===s)return(i instanceof uT||i instanceof uC||i instanceof uM)&&(r instanceof uT||r instanceof uC||r instanceof uM)?void i.data.set(r.data.map((e,t)=>i.data[t]-e)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof uf){if("*"===e.variable.operator){r=this.getVariableName(e.variable.right,t);let s=t.getVariable(r);if(!(s&&s.value instanceof uS))return void console.error(`Variable ${r} is not a pointer. Line ${e.line}`);i=s.value.reference;let n=e.variable.postfix;if(!n){let t=e.variable.right;for(;t instanceof uf;){if(t.postfix){n=t.postfix;break}t=t.right}}n&&(i=i.getSubData(this,n,t))}}else{s=e.variable.postfix,r=this.getVariableName(e.variable,t);let n=t.getVariable(r);if(null===n)return void console.error(`Variable ${r} not found. Line ${e.line}`);i=n.value}if(i instanceof uS&&(i=i.reference),null===i)return void console.error(`Variable ${r} not found. Line ${e.line}`);let n=this.evalExpression(e.value,t),a=e.operator;if("="!==a){let r=i.getSubData(this,s,t);if(r instanceof uC&&n instanceof uT){let t=r.data,i=n.value;if("+="===a)for(let e=0;e<t.length;++e)t[e]+=i;else if("-="===a)for(let e=0;e<t.length;++e)t[e]-=i;else if("*="===a)for(let e=0;e<t.length;++e)t[e]*=i;else if("/="===a)for(let e=0;e<t.length;++e)t[e]/=i;else if("%="===a)for(let e=0;e<t.length;++e)t[e]%=i;else if("&="===a)for(let e=0;e<t.length;++e)t[e]&=i;else if("|="===a)for(let e=0;e<t.length;++e)t[e]|=i;else if("^="===a)for(let e=0;e<t.length;++e)t[e]^=i;else if("<<="===a)for(let e=0;e<t.length;++e)t[e]<<=i;else if(">>="===a)for(let e=0;e<t.length;++e)t[e]>>=i;else console.error(`Invalid operator ${a}. Line ${e.line}`)}else if(r instanceof uC&&n instanceof uC){let t=r.data,i=n.data;if(t.length!==i.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if("+="===a)for(let e=0;e<t.length;++e)t[e]+=i[e];else if("-="===a)for(let e=0;e<t.length;++e)t[e]-=i[e];else if("*="===a)for(let e=0;e<t.length;++e)t[e]*=i[e];else if("/="===a)for(let e=0;e<t.length;++e)t[e]/=i[e];else if("%="===a)for(let e=0;e<t.length;++e)t[e]%=i[e];else if("&="===a)for(let e=0;e<t.length;++e)t[e]&=i[e];else if("|="===a)for(let e=0;e<t.length;++e)t[e]|=i[e];else if("^="===a)for(let e=0;e<t.length;++e)t[e]^=i[e];else if("<<="===a)for(let e=0;e<t.length;++e)t[e]<<=i[e];else if(">>="===a)for(let e=0;e<t.length;++e)t[e]>>=i[e];else console.error(`Invalid operator ${a}. Line ${e.line}`)}else{if(!(r instanceof uT&&n instanceof uT))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);"+="===a?r.value+=n.value:"-="===a?r.value-=n.value:"*="===a?r.value*=n.value:"/="===a?r.value/=n.value:"%="===a?r.value%=n.value:"&="===a?r.value&=n.value:"|="===a?r.value|=n.value:"^="===a?r.value^=n.value:"<<="===a?r.value<<=n.value:">>="===a?r.value>>=n.value:console.error(`Invalid operator ${a}. Line ${e.line}`)}return void(i instanceof uA&&i.setDataValue(this,r,s,t))}if(i instanceof uA)i.setDataValue(this,n,s,t);else if(s){if(!(i instanceof uC||i instanceof uM))return void console.error(`Variable ${r} is not a vector or matrix. Line ${e.line}`);if(s instanceof uh){let a=this.evalExpression(s.index,t).value;if(i instanceof uC){if(!(n instanceof uT))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[a]=n.value}else{if(!(i instanceof uM))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let a=this.evalExpression(s.index,t).value;if(a<0||!(n instanceof uC))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let t=i.typeInfo.getTypeName();if("mat2x2"===t||"mat2x2f"===t||"mat2x2h"===t){if(!(a<2&&2===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*a]=n.data[0],i.data[2*a+1]=n.data[1]}else if("mat2x3"===t||"mat2x3f"===t||"mat2x3h"===t){if(!(a<2&&3===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*a]=n.data[0],i.data[3*a+1]=n.data[1],i.data[3*a+2]=n.data[2]}else if("mat2x4"===t||"mat2x4f"===t||"mat2x4h"===t){if(!(a<2&&4===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*a]=n.data[0],i.data[4*a+1]=n.data[1],i.data[4*a+2]=n.data[2],i.data[4*a+3]=n.data[3]}else if("mat3x2"===t||"mat3x2f"===t||"mat3x2h"===t){if(!(a<3&&2===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*a]=n.data[0],i.data[2*a+1]=n.data[1]}else if("mat3x3"===t||"mat3x3f"===t||"mat3x3h"===t){if(!(a<3&&3===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*a]=n.data[0],i.data[3*a+1]=n.data[1],i.data[3*a+2]=n.data[2]}else if("mat3x4"===t||"mat3x4f"===t||"mat3x4h"===t){if(!(a<3&&4===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*a]=n.data[0],i.data[4*a+1]=n.data[1],i.data[4*a+2]=n.data[2],i.data[4*a+3]=n.data[3]}else if("mat4x2"===t||"mat4x2f"===t||"mat4x2h"===t){if(!(a<4&&2===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*a]=n.data[0],i.data[2*a+1]=n.data[1]}else if("mat4x3"===t||"mat4x3f"===t||"mat4x3h"===t){if(!(a<4&&3===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*a]=n.data[0],i.data[3*a+1]=n.data[1],i.data[3*a+2]=n.data[2]}else{if("mat4x4"!==t&&"mat4x4f"!==t&&"mat4x4h"!==t||!(a<4&&4===n.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*a]=n.data[0],i.data[4*a+1]=n.data[1],i.data[4*a+2]=n.data[2],i.data[4*a+3]=n.data[3]}}}}}else if(s instanceof us){let t=s.value;if(!(i instanceof uC))return void console.error(`Invalid assignment to ${t}. Variable ${r} is not a vector. Line ${e.line}`);if(n instanceof uT){if(t.length>1)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);if("x"===t)i.data[0]=n.value;else if("y"===t){if(i.data.length<2)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);i.data[1]=n.value}else if("z"===t){if(i.data.length<3)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);i.data[2]=n.value}else if("w"===t){if(i.data.length<4)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);i.data[3]=n.value}}else{if(!(n instanceof uC))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(t.length!==n.data.length)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);for(let s=0;s<t.length;++s){let a=t[s];if("x"===a||"r"===a)i.data[0]=n.data[s];else if("y"===a||"g"===a){if(n.data.length<2)return void console.error(`Invalid assignment to ${a} for variable ${r}. Line ${e.line}`);i.data[1]=n.data[s]}else if("z"===a||"b"===a){if(n.data.length<3)return void console.error(`Invalid assignment to ${a} for variable ${r}. Line ${e.line}`);i.data[2]=n.data[s]}else{if("w"!==a&&"a"!==a||n.data.length<4)return void console.error(`Invalid assignment to ${a} for variable ${r}. Line ${e.line}`);i.data[3]=n.data[s]}}}}}else i instanceof uT&&n instanceof uT?i.value=n.value:i instanceof uC&&n instanceof uC||i instanceof uM&&n instanceof uM?i.data.set(n.data):console.error(`Invalid assignment to ${r}. Line ${e.line}`)}_function(e,t){let i=new uK(e);t.functions.set(e.name,i)}_const(e,t){let i=null;null!==e.value&&(i=this.evalExpression(e.value,t)),t.createVariable(e.name,i,e)}_let(e,t){let i=null;if(null!==e.value){if(null===(i=this.evalExpression(e.value,t)))return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof uf||(i=i.clone())}else{let r=e.type.name;if("f32"===r||"i32"===r||"u32"===r||"bool"===r||"f16"===r||"vec2"===r||"vec3"===r||"vec4"===r||"vec2f"===r||"vec3f"===r||"vec4f"===r||"vec2i"===r||"vec3i"===r||"vec4i"===r||"vec2u"===r||"vec3u"===r||"vec4u"===r||"vec2h"===r||"vec3h"===r||"vec4h"===r||"vec2b"===r||"vec3b"===r||"vec4b"===r||"mat2x2"===r||"mat2x3"===r||"mat2x4"===r||"mat3x2"===r||"mat3x3"===r||"mat3x4"===r||"mat4x2"===r||"mat4x3"===r||"mat4x4"===r||"mat2x2f"===r||"mat2x3f"===r||"mat2x4f"===r||"mat3x2f"===r||"mat3x3f"===r||"mat3x4f"===r||"mat4x2f"===r||"mat4x3f"===r||"mat4x4f"===r||"mat2x2h"===r||"mat2x3h"===r||"mat2x4h"===r||"mat3x2h"===r||"mat3x3h"===r||"mat3x4h"===r||"mat4x2h"===r||"mat4x3h"===r||"mat4x4h"===r||"array"===r){let r=new un(e.type,[]);i=this._evalCreate(r,t)}}t.createVariable(e.name,i,e)}_var(e,t){let i=null;if(null!==e.value){if(null===(i=this.evalExpression(e.value,t)))return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof uf||(i=i.clone())}else{if(null===e.type)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);let r=e.type.name;if("f32"===r||"i32"===r||"u32"===r||"bool"===r||"f16"===r||"vec2"===r||"vec3"===r||"vec4"===r||"vec2f"===r||"vec3f"===r||"vec4f"===r||"vec2i"===r||"vec3i"===r||"vec4i"===r||"vec2u"===r||"vec3u"===r||"vec4u"===r||"vec2h"===r||"vec3h"===r||"vec4h"===r||"vec2b"===r||"vec3b"===r||"vec4b"===r||"mat2x2"===r||"mat2x3"===r||"mat2x4"===r||"mat3x2"===r||"mat3x3"===r||"mat3x4"===r||"mat4x2"===r||"mat4x3"===r||"mat4x4"===r||"mat2x2f"===r||"mat2x3f"===r||"mat2x4f"===r||"mat3x2f"===r||"mat3x3f"===r||"mat3x4f"===r||"mat4x2f"===r||"mat4x3f"===r||"mat4x4f"===r||"mat2x2h"===r||"mat2x3h"===r||"mat2x4h"===r||"mat3x2h"===r||"mat3x3h"===r||"mat3x4h"===r||"mat4x2h"===r||"mat4x3h"===r||"mat4x4h"===r||e.type instanceof ut||e.type instanceof c7||e.type instanceof c9){let r=new un(e.type,[]);i=this._evalCreate(r,t)}}t.createVariable(e.name,i,e)}_switch(e,t){t=t.clone();let i=this.evalExpression(e.condition,t);if(!(i instanceof uT))return console.error(`Invalid if condition. Line ${e.line}`),null;let r=null;for(let s of e.cases)if(s instanceof uy)for(let n of s.selectors){if(n instanceof um){r=s;continue}let a=this.evalExpression(n,t);if(!(a instanceof uT))return console.error(`Invalid case selector. Line ${e.line}`),null;if(a.value===i.value)return this._execStatements(s.body,t)}else s instanceof uv&&(r=s);return r?this._execStatements(r.body,t):null}_if(e,t){t=t.clone();let i=this.evalExpression(e.condition,t);if(!(i instanceof uT))return console.error(`Invalid if condition. Line ${e.line}`),null;if(i.value)return this._execStatements(e.body,t);for(let i of e.elseif){let r=this.evalExpression(i.condition,t);if(!(r instanceof uT))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(i.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof uT?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){let i=this._execStatements(e.body,t);if(i===u3._breakObj)break;if(null!==i&&i!==u3._continueObj)return i;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){let i=this._execStatements(e.body,t);if(i===u3._breakObj)break;if(i===u3._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===u3._breakObj)break}else if(null!==i)return i}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){let i=this._execStatements(e.body,t);if(i===u3._breakObj)break;if(i!==u3._continueObj&&null!==i)return i}return null}_evalBitcast(e,t){let i=this.evalExpression(e.value,t),r=e.type;if(i instanceof uT)return new uT(uG(i.value,i.typeInfo.name,r.name),this.getTypeInfo(r));if(i instanceof uC){let t=i.typeInfo.getTypeName(),s="";if(t.endsWith("f"))s="f32";else if(t.endsWith("i"))s="i32";else if(t.endsWith("u"))s="u32";else if(t.endsWith("b"))s="bool";else{if(!t.endsWith("h"))return console.error(`Unknown vector type ${t}. Line ${e.line}`),null;s="f16"}let n=r.getTypeName(),a="";if(n.endsWith("f"))a="f32";else if(n.endsWith("i"))a="i32";else if(n.endsWith("u"))a="u32";else if(n.endsWith("b"))a="bool";else{if(!n.endsWith("h"))return console.error(`Unknown vector type ${a}. Line ${e.line}`),null;a="f16"}return new uC(function(e,t,i){if(t===i)return e;let r=Array(e.length);for(let s=0;s<e.length;s++)r[s]=uG(e[s],t,i);return r}(Array.from(i.data),s,a),this.getTypeInfo(r))}return console.error(`TODO: bitcast for ${i.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var i;if(e instanceof un){if(null===e.type)return uP.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}let r=e instanceof un?e.type.name:e.name,s=e instanceof un?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(null===s)return console.error(`Unknown type ${r}. Line ${e.line}`),null;if(0===s.size)return null;let n=new uA(new ArrayBuffer(s.size),s,0);if(s instanceof ch){if(e.args)for(let i=0;i<e.args.length;++i){let r=s.members[i],a=e.args[i],o=this.evalExpression(a,t);n.setData(this,o,r.type,r.offset,t)}}else if(s instanceof cd){let r=0;if(e.args)for(let a=0;a<e.args.length;++a){let o=e.args[a],l=this.evalExpression(o,t);null===s.format&&("x32"===(null==(i=l.typeInfo)?void 0:i.name)?s.format=this.getTypeInfo("i32"):s.format=l.typeInfo),n.setData(this,l,s.format,r,t),r+=s.stride}}else console.error(`Unknown type "${r}". Line ${e.line}`);return e instanceof un?n.getSubData(this,e.postfix,t):n}_evalLiteral(e,t){let i=this.getTypeInfo(e.type),r=i.name;return"x32"===r||"u32"===r||"f32"===r||"f16"===r||"i32"===r||"bool"===r?new uT(e.scalarValue,i):"vec2"===r||"vec3"===r||"vec4"===r||"vec2f"===r||"vec3f"===r||"vec4f"===r||"vec2h"===r||"vec3h"===r||"vec4h"===r||"vec2i"===r||"vec3i"===r||"vec4i"===r||"vec2u"===r||"vec3u"===r||"vec4u"===r?this._callConstructorVec(e,t):"mat2x2"===r||"mat2x3"===r||"mat2x4"===r||"mat3x2"===r||"mat3x3"===r||"mat3x4"===r||"mat4x2"===r||"mat4x3"===r||"mat4x4"===r||"mat2x2f"===r||"mat2x3f"===r||"mat2x4f"===r||"mat3x2f"===r||"mat3x3f"===r||"mat3x4f"===r||"mat4x2f"===r||"mat4x3f"===r||"mat4x4f"===r||"mat2x2h"===r||"mat2x3h"===r||"mat2x4h"===r||"mat3x2h"===r||"mat3x3h"===r||"mat3x4h"===r||"mat4x2h"===r||"mat4x3h"===r||"mat4x4h"===r?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){let i=t.getVariableValue(e.name);return null===i?i:i.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if("f32"===t.name)return t;for(let i=1;i<e.length;++i){let r=u3._priority.get(t.name);u3._priority.get(e[i].name)<r&&(t=e[i])}return"x32"===t.name?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){let i=this.evalExpression(e.right,t);if("&"===e.operator)return new uS(i);if("*"===e.operator)return i instanceof uS?i.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);let r=i instanceof uT?i.value:i instanceof uC?Array.from(i.data):null;switch(e.operator){case"+":if(uN(r))return new uC(r.map((e,t)=>+e),i.typeInfo);return new uT(+r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]));case"-":if(uN(r))return new uC(r.map((e,t)=>-e),i.typeInfo);return new uT(-r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]));case"!":if(uN(r))return new uC(r.map((e,t)=>+!e),i.typeInfo);return new uT(+!r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]));case"~":if(uN(r))return new uC(r.map((e,t)=>~e),i.typeInfo);return new uT(~r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]))}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){let i=this.evalExpression(e.left,t),r=this.evalExpression(e.right,t),s=i instanceof uT?i.value:i instanceof uC||i instanceof uM?Array.from(i.data):null,n=r instanceof uT?r.value:r instanceof uC||r instanceof uM?Array.from(r.data):null;switch(e.operator){case"+":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e+n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e+n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s+e),r.typeInfo);return new uT(s+n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"-":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e-n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e-n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s-e),r.typeInfo);return new uT(s-n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"*":if(uN(s)&&uN(n)){if(i instanceof uM&&r instanceof uM){let t=function(e,t,i,r){if(void 0===u2[t.name]||void 0===u2[r.name])return null;let s=u2[t.name][0],n=u2[t.name][1],a=u2[r.name][0];if(s!==u2[r.name][1])return null;let o=Array(a*n);for(let t=0;t<n;t++)for(let r=0;r<a;r++){let l=0;for(let a=0;a<s;a++)l+=e[a*n+t]*i[r*s+a];o[t*a+r]=l}return o}(s,i.typeInfo,n,r.typeInfo);if(null===t)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;let a=u2[r.typeInfo.name][0],o=u2[i.typeInfo.name][1];return new uM(t,this.getTypeInfo(`mat${a}x${o}f`))}if(i instanceof uM&&r instanceof uC){let t=function(e,t,i,r){if(void 0===u2[t.name]||void 0===u1[r.name])return null;let s=u2[t.name][0],n=u2[t.name][1];if(s!==i.length)return null;let a=Array(n);for(let t=0;t<n;t++){let r=0;for(let a=0;a<s;a++)r+=e[a*n+t]*i[a];a[t]=r}return a}(s,i.typeInfo,n,r.typeInfo);return null===t?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new uC(t,r.typeInfo)}if(i instanceof uC&&r instanceof uM){let t=function(e,t,i,r){if(void 0===u1[t.name]||void 0===u2[r.name])return null;let s=u2[r.name][0],n=u2[r.name][1];if(n!==e.length)return null;let a=[];for(let t=0;t<s;t++){let r=0;for(let a=0;a<n;a++)r+=e[a]*i[a*s+t];a[t]=r}return a}(s,i.typeInfo,n,r.typeInfo);return null===t?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new uC(t,i.typeInfo)}if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e*n[t]),i.typeInfo)}if(uN(s)){let e=s.map((e,t)=>e*n);return i instanceof uM?new uM(e,i.typeInfo):new uC(e,i.typeInfo)}if(uN(n)){let e=n.map((e,t)=>s*e);return r instanceof uM?new uM(e,r.typeInfo):new uC(e,r.typeInfo)}return new uT(s*n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"%":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e%n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e%n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s%e),r.typeInfo);return new uT(s%n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"/":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e/n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e/n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s/e),r.typeInfo);return new uT(s/n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"&":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e&n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e&n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s&e),r.typeInfo);return new uT(s&n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"|":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e|n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e|n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s|e),r.typeInfo);return new uT(s|n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"^":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e^n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e^n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s^e),r.typeInfo);return new uT(s^n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"<<":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e<<n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e<<n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s<<e),r.typeInfo);return new uT(s<<n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case">>":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e>>n[t]),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e>>n),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s>>e),r.typeInfo);return new uT(s>>n,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case">":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>+(e>n[t])),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>+(e>n)),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>+(s>e)),r.typeInfo);return new uT(+(s>n),this.getTypeInfo("bool"));case"<":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>+(e<n[t])),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>+(e<n)),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>+(s<e)),r.typeInfo);return new uT(+(s<n),this.getTypeInfo("bool"));case"==":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>+(e===n[t])),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>+(e==n)),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>+(s==e)),r.typeInfo);return new uT(+(s===n),this.getTypeInfo("bool"));case"!=":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>+(e!==n[t])),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>+(e!==n)),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>+(s!==e)),r.typeInfo);return new uT(+(s!==n),this.getTypeInfo("bool"));case">=":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>+(e>=n[t])),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>+(e>=n)),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>+(s>=e)),r.typeInfo);return new uT(+(s>=n),this.getTypeInfo("bool"));case"<=":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>+(e<=n[t])),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>+(e<=n)),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>+(s<=e)),r.typeInfo);return new uT(+(s<=n),this.getTypeInfo("bool"));case"&&":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e&&n[t]?1:0),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e&&n?1:0),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s&&e?1:0),r.typeInfo);return new uT(s&&n?1:0,this.getTypeInfo("bool"));case"||":if(uN(s)&&uN(n)){if(s.length!==n.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new uC(s.map((e,t)=>e||n[t]?1:0),i.typeInfo)}if(uN(s))return new uC(s.map((e,t)=>e||n?1:0),i.typeInfo);if(uN(n))return new uC(n.map((e,t)=>s||e?1:0),r.typeInfo);return new uT(s||n?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(null!==e.cachedReturnValue)return e.cachedReturnValue;let i=t.clone();i.currentFunctionName=e.name;let r=t.getFunction(e.name);if(!r)return e.isBuiltin?this._callBuiltinFunction(e,i):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let t=0;t<r.node.args.length;++t){let s=r.node.args[t],n=this.evalExpression(e.args[t],i);i.createVariable(s.name,n,s)}return this._execStatements(r.node.body,i)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothstep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}let i=t.getFunction(e.name);if(i){let r=t.clone();for(let t=0;t<i.node.args.length;++t){let s=i.node.args[t],n=this.evalExpression(e.args[t],r);r.setVariable(s.name,n,s)}return this._execStatements(i.node.body,r)}return null}_callConstructorValue(e,t){if(!e.args||0===e.args.length)return new uT(0,this.getTypeInfo(e.type));let i=this.evalExpression(e.args[0],t);return i.typeInfo=this.getTypeInfo(e.type),i.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){let i=this.getTypeInfo(e.type),r=e.type.getTypeName(),s=u1[r];if(void 0===s)return console.error(`Invalid vec constructor ${r}. Line ${e.line}`),null;let n=[];if(e instanceof uc)if(e.isVector)for(let t of e.vectorValue)n.push(t);else n.push(e.scalarValue);else if(e.args)for(let i of e.args){let e=this.evalExpression(i,t);if(e instanceof uC){let t=e.data;for(let e=0;e<t.length;++e){let i=t[e];n.push(i)}}else if(e instanceof uT){let t=e.value;n.push(t)}}if(e.type instanceof c9&&null===e.type.format&&(e.type.format=c9.f32),0===n.length)return new uC(Array(s).fill(0),i).getSubData(this,e.postfix,t);if(1===n.length)for(;n.length<s;)n.push(n[0]);return n.length<s?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new uC(n.length>s?n.slice(0,s):n,i).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){let i=this.getTypeInfo(e.type),r=e.type.getTypeName(),s=u2[r];if(void 0===s)return console.error(`Invalid matrix constructor ${r}. Line ${e.line}`),null;let n=[];if(e instanceof uc)if(e.isVector)for(let t of e.vectorValue)n.push(t);else n.push(e.scalarValue);else if(e.args)for(let i of e.args){let e=this.evalExpression(i,t);e instanceof uC?n.push(...e.data):e instanceof uT?n.push(e.value):e instanceof uM&&n.push(...e.data)}return(i instanceof cp&&null===i.format&&(i.format=this.getTypeInfo("f32")),0===n.length)?new uM(Array(s[2]).fill(0),i).getSubData(this,e.postfix,t):n.length!==s[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new uM(n,i).getSubData(this,e.postfix,t)}}u3._breakObj=new uk(new cc("BREAK",null),null),u3._continueObj=new uk(new cc("CONTINUE",null),null),u3._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class u4{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class u6{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new u4,this._exec=new u3,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;let t=[];for(;!this._isAtEnd();){let e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(let e of this._deferArrayCountEval){let t=e.arrayType,i=e.countNode;if(i instanceof uo){let e=i.name,r=this._context.constants.get(e);if(r)try{t.count=r.constEvaluate(this._exec)}catch(e){}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(let e of t)e.search(e=>{e instanceof ub||e instanceof ue?e.type=this._forwardType(e.type):e instanceof ut?e.format=this._forwardType(e.format):e instanceof c$||e instanceof cW||e instanceof cG?e.type=this._forwardType(e.type):e instanceof cD?e.returnType=this._forwardType(e.returnType):e instanceof ux&&(e.type=this._forwardType(e.type))});return t}_forwardType(e){if(e instanceof c8){let t=this._getType(e.name);if(t)return t}else e instanceof ue?e.type=this._forwardType(e.type):e instanceof ut&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if("string"==typeof e){let t=new uR(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=null!=t?t:this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==uL.eof}_match(e){if(e instanceof uE)return!!this._check(e)&&(this._advance(),!0);for(let t=0,i=e.length;t<i;++t){let i=e[t];if(this._check(i))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;let t=this._peek();if(e instanceof Array){let i=t.type,r=!1;for(let t of e){if(i===t)return!0;t===uL.tokens.name&&(r=!0)}if(r){let e=uL.tokens.name.rule.exec(t.lexeme);if(e&&0==e.index&&e[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===uL.tokens.name){let e=uL.tokens.name.rule.exec(t.lexeme);return e&&0==e.index&&e[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=null!=(t=null==(e=this._peek())?void 0:e.line)?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(uL.tokens.semicolon)&&!this._isAtEnd(););if(this._match(uL.keywords.alias)){let e=this._type_alias();return this._consume(uL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(uL.keywords.diagnostic)){let e=this._diagnostic();return this._consume(uL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(uL.keywords.requires)){let e=this._requires_directive();return this._consume(uL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(uL.keywords.enable)){let e=this._enable_directive();return this._consume(uL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}let e=this._attribute();if(this._check(uL.keywords.var)){let t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(uL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(uL.keywords.override)){let t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(uL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(uL.keywords.let)){let t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(uL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(uL.keywords.const)){let t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(uL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(uL.keywords.struct)){let t=this._struct_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(uL.keywords.fn)){let t=this._function_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(uL.keywords.fn))return null;let e=this._currentLine,t=this._consume(uL.tokens.ident,"Expected function name.").toString();this._consume(uL.tokens.paren_left,"Expected '(' for function arguments.");let i=[];if(!this._check(uL.tokens.paren_right))do{if(this._check(uL.tokens.paren_right))break;let e=this._attribute(),t=this._consume(uL.tokens.name,"Expected argument name.").toString();this._consume(uL.tokens.colon,"Expected ':' for argument type.");let r=this._attribute(),s=this._type_decl();null!=s&&(s.attributes=r,i.push(this._updateNode(new ux(t,s,e))))}while(this._match(uL.tokens.comma))this._consume(uL.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(uL.tokens.arrow)){let e=this._attribute();null!=(r=this._type_decl())&&(r.attributes=e)}let s=this._compound_statement(),n=this._currentLine;return this._updateNode(new cD(t,i,r,s,e,n),e)}_compound_statement(){let e=[];for(this._consume(uL.tokens.brace_left,"Expected '{' for block.");!this._check(uL.tokens.brace_right);){let t=this._statement();null!==t&&e.push(t)}return this._consume(uL.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(uL.tokens.semicolon)&&!this._isAtEnd(););if(this._check(uL.tokens.attr)&&this._attribute(),this._check(uL.keywords.if))return this._if_statement();if(this._check(uL.keywords.switch))return this._switch_statement();if(this._check(uL.keywords.loop))return this._loop_statement();if(this._check(uL.keywords.for))return this._for_statement();if(this._check(uL.keywords.while))return this._while_statement();if(this._check(uL.keywords.continuing))return this._continuing_statement();if(this._check(uL.keywords.static_assert))return this._static_assert_statement();if(this._check(uL.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(uL.keywords.return))e=this._return_statement();else if(this._check([uL.keywords.var,uL.keywords.let,uL.keywords.const]))e=this._variable_statement();else if(this._match(uL.keywords.discard))e=this._updateNode(new c3);else if(this._match(uL.keywords.break)){let t=this._updateNode(new c4);this._currentLoop.length>0&&(t.loopId=this._currentLoop[this._currentLoop.length-1].id),e=t,this._check(uL.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(uL.keywords.continue)){let t=this._updateNode(new c6);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);t.loopId=this._currentLoop[this._currentLoop.length-1].id,e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return null!=e&&this._consume(uL.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(uL.keywords.static_assert))return null;let e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new cz(t),e)}_while_statement(){if(!this._match(uL.keywords.while))return null;let e=this._updateNode(new cF(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(uL.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){let e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(uL.keywords.continuing))return null;let t=this._currentLine,i=this._compound_statement();return this._updateNode(new cB(i,e),t)}_for_statement(){if(!this._match(uL.keywords.for))return null;this._consume(uL.tokens.paren_left,"Expected '('.");let e=this._updateNode(new cU(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(uL.tokens.semicolon)?null:this._for_init(),this._consume(uL.tokens.semicolon,"Expected ';'."),e.condition=this._check(uL.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(uL.tokens.semicolon,"Expected ';'."),e.increment=this._check(uL.tokens.paren_right)?null:this._for_increment(),this._consume(uL.tokens.paren_right,"Expected ')'."),this._check(uL.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(uL.keywords.var)){let e=this._variable_decl();if(null===e)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(uL.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new c$(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(uL.keywords.let)){let e=this._currentLine,t=this._consume(uL.tokens.name,"Expected name for let.").toString(),i=null;if(this._match(uL.tokens.colon)){let e=this._attribute();null!=(i=this._type_decl())&&(i.attributes=e)}this._consume(uL.tokens.equal,"Expected '=' for let.");let r=this._short_circuit_or_expression();return this._updateNode(new cW(t,i,null,null,r),e)}if(this._match(uL.keywords.const)){let e=this._currentLine,t=this._consume(uL.tokens.name,"Expected name for const.").toString(),i=null;if(this._match(uL.tokens.colon)){let e=this._attribute();null!=(i=this._type_decl())&&(i.attributes=e)}this._consume(uL.tokens.equal,"Expected '=' for const.");let r=this._short_circuit_or_expression();return null===i&&r instanceof uc&&(i=r.type),this._updateNode(new cG(t,i,null,null,r),e)}return null}_increment_decrement_statement(){let e=this._current,t=this._unary_expression();if(null==t)return null;if(!this._check(uL.increment_operators))return this._current=e,null;let i=this._consume(uL.increment_operators,"Expected increment operator");return this._updateNode(new cq(i.type===uL.tokens.plus_plus?L.increment:L.decrement,t))}_assignment_statement(){let e=null,t=this._currentLine;if(this._check(uL.tokens.brace_right))return null;let i=this._match(uL.tokens.underscore);if(i||(e=this._unary_expression()),!i&&null==e)return null;let r=this._consume(uL.assignment_operators,"Expected assignment operator."),s=this._short_circuit_or_expression();return this._updateNode(new cH(O.parse(r.lexeme),e,s),t)}_func_call_statement(){if(!this._check(uL.tokens.ident))return null;let e=this._currentLine,t=this._current,i=this._consume(uL.tokens.ident,"Expected function name."),r=this._argument_expression_list();return null===r?(this._current=t,null):this._updateNode(new cZ(i.lexeme,r),e)}_loop_statement(){if(!this._match(uL.keywords.loop))return null;this._check(uL.tokens.attr)&&this._attribute(),this._consume(uL.tokens.brace_left,"Expected '{' for loop.");let e=this._updateNode(new cY([],null));this._currentLoop.push(e);let t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let i of t)e.body.push(i);else e.body.push(t);if(t instanceof cB){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(uL.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(uL.keywords.switch))return null;let e=this._updateNode(new cX(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(uL.tokens.attr)&&this._attribute(),this._consume(uL.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),null==e.cases||0==e.cases.length)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(uL.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){let e=[],t=!1;for(;this._check([uL.keywords.default,uL.keywords.case]);){if(this._match(uL.keywords.case)){let i=this._case_selectors();for(let e of i)if(e instanceof um){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(uL.tokens.colon),this._check(uL.tokens.attr)&&this._attribute(),this._consume(uL.tokens.brace_left,"Exected '{' for switch case.");let r=this._case_body();this._consume(uL.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new uy(i,r)))}if(this._match(uL.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(uL.tokens.colon),this._check(uL.tokens.attr)&&this._attribute(),this._consume(uL.tokens.brace_left,"Exected '{' for switch default.");let i=this._case_body();this._consume(uL.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new uv(i)))}}return e}_case_selectors(){let e=[];for(this._match(uL.keywords.default)?e.push(this._updateNode(new um)):e.push(this._shift_expression());this._match(uL.tokens.comma);)this._match(uL.keywords.default)?e.push(this._updateNode(new um)):e.push(this._shift_expression());return e}_case_body(){if(this._match(uL.keywords.fallthrough))return this._consume(uL.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);let t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(uL.keywords.if))return null;let e=this._currentLine,t=this._optional_paren_expression();this._check(uL.tokens.attr)&&this._attribute();let i=this._compound_statement(),r=[];this._match_elseif()&&(this._check(uL.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let s=null;return this._match(uL.keywords.else)&&(this._check(uL.tokens.attr)&&this._attribute(),s=this._compound_statement()),this._updateNode(new cK(t,i,r,s),e)}_match_elseif(){return this._tokens[this._current].type===uL.keywords.else&&this._tokens[this._current+1].type===uL.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){let t=this._optional_paren_expression(),i=this._compound_statement();return e.push(this._updateNode(new u_(t,i))),this._match_elseif()&&(this._check(uL.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(uL.keywords.return))return null;let e=this._short_circuit_or_expression();return this._updateNode(new cJ(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(uL.tokens.or_or);)e=this._updateNode(new up(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(uL.tokens.and_and);)e=this._updateNode(new up(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(uL.tokens.or);)e=this._updateNode(new up(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(uL.tokens.xor);)e=this._updateNode(new up(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(uL.tokens.and);)e=this._updateNode(new up(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){let e=this._relational_expression();return this._match([uL.tokens.equal_equal,uL.tokens.not_equal])?this._updateNode(new up(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([uL.tokens.less_than,uL.tokens.greater_than,uL.tokens.less_than_equal,uL.tokens.greater_than_equal]);)e=this._updateNode(new up(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([uL.tokens.shift_left,uL.tokens.shift_right]);)e=this._updateNode(new up(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([uL.tokens.plus,uL.tokens.minus]);)e=this._updateNode(new up(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([uL.tokens.star,uL.tokens.forward_slash,uL.tokens.modulo]);)e=this._updateNode(new up(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([uL.tokens.minus,uL.tokens.bang,uL.tokens.tilde,uL.tokens.star,uL.tokens.and])?this._updateNode(new uf(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){let e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(uL.tokens.bracket_left)){let e=this._short_circuit_or_expression();this._consume(uL.tokens.bracket_right,"Expected ']'.");let t=this._updateNode(new uh(e)),i=this._postfix_expression();return i&&(t.postfix=i),t}if(this._match(uL.tokens.period)){let e=this._consume(uL.tokens.name,"Expected member name."),t=this._postfix_expression(),i=this._updateNode(new us(e.lexeme));return t&&(i.postfix=t),i}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){let t=this._getStruct(e);if(null!==t)return t;switch(e){case"void":return c5.void;case"bool":return c5.bool;case"i32":return c5.i32;case"u32":return c5.u32;case"f32":return c5.f32;case"f16":return c5.f16;case"vec2f":return c9.vec2f;case"vec3f":return c9.vec3f;case"vec4f":return c9.vec4f;case"vec2i":return c9.vec2i;case"vec3i":return c9.vec3i;case"vec4i":return c9.vec4i;case"vec2u":return c9.vec2u;case"vec3u":return c9.vec3u;case"vec4u":return c9.vec4u;case"vec2h":return c9.vec2h;case"vec3h":return c9.vec3h;case"vec4h":return c9.vec4h;case"mat2x2f":return c9.mat2x2f;case"mat2x3f":return c9.mat2x3f;case"mat2x4f":return c9.mat2x4f;case"mat3x2f":return c9.mat3x2f;case"mat3x3f":return c9.mat3x3f;case"mat3x4f":return c9.mat3x4f;case"mat4x2f":return c9.mat4x2f;case"mat4x3f":return c9.mat4x3f;case"mat4x4f":return c9.mat4x4f;case"mat2x2h":return c9.mat2x2h;case"mat2x3h":return c9.mat2x3h;case"mat2x4h":return c9.mat2x4h;case"mat3x2h":return c9.mat3x2h;case"mat3x3h":return c9.mat3x3h;case"mat3x4h":return c9.mat3x4h;case"mat4x2h":return c9.mat4x2h;case"mat4x3h":return c9.mat4x3h;case"mat4x4h":return c9.mat4x4h;case"mat2x2i":return c9.mat2x2i;case"mat2x3i":return c9.mat2x3i;case"mat2x4i":return c9.mat2x4i;case"mat3x2i":return c9.mat3x2i;case"mat3x3i":return c9.mat3x3i;case"mat3x4i":return c9.mat3x4i;case"mat4x2i":return c9.mat4x2i;case"mat4x3i":return c9.mat4x3i;case"mat4x4i":return c9.mat4x4i;case"mat2x2u":return c9.mat2x2u;case"mat2x3u":return c9.mat2x3u;case"mat2x4u":return c9.mat2x4u;case"mat3x2u":return c9.mat3x2u;case"mat3x3u":return c9.mat3x3u;case"mat3x4u":return c9.mat3x4u;case"mat4x2u":return c9.mat4x2u;case"mat4x3u":return c9.mat4x3u;case"mat4x4u":return c9.mat4x4u}return null}_validateTypeRange(e,t){if("i32"===t.name){if(e<-0x80000000||e>0x7fffffff)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if("u32"===t.name&&(e<0||e>0xffffffff))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(uL.tokens.ident)){let e=this._previous().toString();if(this._check(uL.tokens.paren_left)){let t=this._argument_expression_list(),i=this._getType(e);return null!==i?this._updateNode(new un(i,t)):this._updateNode(new ua(e,t))}if(this._context.constants.has(e)){let t=this._context.constants.get(e);return this._updateNode(new ul(e,t.value))}return this._updateNode(new uo(e))}if(this._match(uL.tokens.int_literal)){let e=this._previous().toString(),t=e.endsWith("i")||e.endsWith("i")?c5.i32:e.endsWith("u")||e.endsWith("U")?c5.u32:c5.x32,i=parseInt(e);return this._validateTypeRange(i,t),this._updateNode(new uc(new uT(i,this._exec.getTypeInfo(t)),t))}if(this._match(uL.tokens.uint_literal)){let e=parseInt(this._previous().toString());return this._validateTypeRange(e,c5.u32),this._updateNode(new uc(new uT(e,this._exec.getTypeInfo(c5.u32)),c5.u32))}if(this._match([uL.tokens.decimal_float_literal,uL.tokens.hex_float_literal])){let e=this._previous().toString(),t=e.endsWith("h");t&&(e=e.substring(0,e.length-1));let i=parseFloat(e);this._validateTypeRange(i,t?c5.f16:c5.f32);let r=t?c5.f16:c5.f32;return this._updateNode(new uc(new uT(i,this._exec.getTypeInfo(r)),r))}if(this._match([uL.keywords.true,uL.keywords.false])){let e=this._previous().toString()===uL.keywords.true.rule;return this._updateNode(new uc(new uT(+!!e,this._exec.getTypeInfo(c5.bool)),c5.bool))}if(this._check(uL.tokens.paren_left))return this._paren_expression();if(this._match(uL.keywords.bitcast)){this._consume(uL.tokens.less_than,"Expected '<'.");let e=this._type_decl();this._consume(uL.tokens.greater_than,"Expected '>'.");let t=this._paren_expression();return this._updateNode(new uu(e,t))}let e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new un(e,t))}_argument_expression_list(){if(!this._match(uL.tokens.paren_left))return null;let e=[];do{if(this._check(uL.tokens.paren_right))break;let t=this._short_circuit_or_expression();e.push(t)}while(this._match(uL.tokens.comma))return this._consume(uL.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(uL.tokens.paren_left);let e=this._short_circuit_or_expression();return this._match(uL.tokens.paren_right),e}_paren_expression(){this._consume(uL.tokens.paren_left,"Expected '('.");let e=this._short_circuit_or_expression();return this._consume(uL.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(uL.keywords.struct))return null;let e=this._currentLine,t=this._consume(uL.tokens.ident,"Expected name for struct.").toString();this._consume(uL.tokens.brace_left,"Expected '{' for struct body.");let i=[];for(;!this._check(uL.tokens.brace_right);){let e=this._attribute(),t=this._consume(uL.tokens.name,"Expected variable name.").toString();this._consume(uL.tokens.colon,"Expected ':' for struct member type.");let r=this._attribute(),s=this._type_decl();null!=s&&(s.attributes=r),this._check(uL.tokens.brace_right)?this._match(uL.tokens.comma):this._consume(uL.tokens.comma,"Expected ',' for struct member."),i.push(this._updateNode(new ub(t,s,e)))}this._consume(uL.tokens.brace_right,"Expected '}' after struct body.");let r=this._currentLine,s=this._updateNode(new c7(t,i,e,r),e);return this._context.structs.set(t,s),s}_global_variable_decl(){let e=this._variable_decl();if(!e)return null;if(this._match(uL.tokens.equal)&&(e.value=this._const_expression()),null!==e.type&&e.value instanceof uc){if("x32"!==e.value.type.name&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else null===e.type&&e.value instanceof uc&&(e.type="x32"===e.value.type.name?c5.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){let e=this._override_decl();return e&&this._match(uL.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(uL.keywords.const))return null;let t=this._consume(uL.tokens.name,"Expected variable name"),i=this._currentLine,r=null;if(this._match(uL.tokens.colon)){let e=this._attribute();null!=(r=this._type_decl())&&(r.attributes=e)}let s=null;this._consume(uL.tokens.equal,"const declarations require an assignment");let n=this._short_circuit_or_expression();try{let e=[c5.f32],i=n.constEvaluate(this._exec,e);i instanceof uT&&this._validateTypeRange(i.value,e[0]),e[0]instanceof c9&&null===e[0].format&&i.typeInfo instanceof cp&&null!==i.typeInfo.format&&("f16"===i.typeInfo.format.name?e[0].format=c5.f16:"f32"===i.typeInfo.format.name?e[0].format=c5.f32:"i32"===i.typeInfo.format.name?e[0].format=c5.i32:"u32"===i.typeInfo.format.name?e[0].format=c5.u32:"bool"===i.typeInfo.format.name?e[0].format=c5.bool:console.error(`TODO: impelement template format type ${i.typeInfo.format.name}`)),s=this._updateNode(new uc(i,e[0])),this._exec.context.setVariable(t.toString(),i)}catch(e){s=n}if(null!==r&&s instanceof uc){if("x32"!==s.type.name&&r.getTypeName()!==s.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${r.name}. Line:${this._currentLine}`);s.type=r,s.isScalar&&this._validateTypeRange(s.scalarValue,s.type)}else null===r&&s instanceof uc&&(r=null!=(e=null==s?void 0:s.type)?e:c5.f32)===c5.x32&&(r=c5.i32);let a=this._updateNode(new cG(t.toString(),r,"","",s),i);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(uL.keywords.let))return null;let e=this._currentLine,t=this._consume(uL.tokens.name,"Expected variable name"),i=null;if(this._match(uL.tokens.colon)){let e=this._attribute();null!=(i=this._type_decl())&&(i.attributes=e)}let r=null;if(this._match(uL.tokens.equal)&&(r=this._const_expression()),null!==i&&r instanceof uc){if("x32"!==r.type.name&&i.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${i.name}. Line:${this._currentLine}`);r.type=i}else null===i&&r instanceof uc&&(i="x32"===r.type.name?c5.i32:r.type);return r instanceof uc&&r.isScalar&&this._validateTypeRange(r.scalarValue,i),this._updateNode(new cW(t.toString(),i,"","",r),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(uL.keywords.var))return null;let e=this._currentLine,t="",i="";this._match(uL.tokens.less_than)&&(t=this._consume(uL.storage_class,"Expected storage_class.").toString(),this._match(uL.tokens.comma)&&(i=this._consume(uL.access_mode,"Expected access_mode.").toString()),this._consume(uL.tokens.greater_than,"Expected '>'."));let r=this._consume(uL.tokens.name,"Expected variable name"),s=null;if(this._match(uL.tokens.colon)){let e=this._attribute();null!=(s=this._type_decl())&&(s.attributes=e)}return this._updateNode(new c$(r.toString(),s,t,i,null),e)}_override_decl(){if(!this._match(uL.keywords.override))return null;let e=this._consume(uL.tokens.name,"Expected variable name"),t=null;if(this._match(uL.tokens.colon)){let e=this._attribute();null!=(t=this._type_decl())&&(t.attributes=e)}return this._updateNode(new cV(e.toString(),t,null))}_diagnostic(){this._consume(uL.tokens.paren_left,"Expected '('");let e=this._consume(uL.tokens.ident,"Expected severity control name.");this._consume(uL.tokens.comma,"Expected ','");let t=this._consume(uL.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(uL.tokens.period)&&(t+=`.${this._consume(uL.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(uL.tokens.paren_right,"Expected ')'"),this._updateNode(new c1(e.toString(),t))}_enable_directive(){let e=this._consume(uL.tokens.ident,"identity expected.");return this._updateNode(new cQ(e.toString()))}_requires_directive(){let e=[this._consume(uL.tokens.ident,"identity expected.").toString()];for(;this._match(uL.tokens.comma);){let t=this._consume(uL.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new c0(e))}_type_alias(){let e=this._consume(uL.tokens.ident,"identity expected.");this._consume(uL.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(null===t)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);let i=this._updateNode(new c2(e.toString(),t));return this._context.aliases.set(i.name,i),i}_type_decl(){if(this._check([uL.tokens.ident,...uL.texel_format,uL.keywords.bool,uL.keywords.f32,uL.keywords.i32,uL.keywords.u32])){let e=this._advance().toString();if(this._context.structs.has(e))return this._context.structs.get(e);if(this._context.aliases.has(e))return this._context.aliases.get(e).type;if(!this._getType(e)){let t=this._updateNode(new c8(e));return this._forwardTypeCount++,t}return this._updateNode(new c5(e))}let e=this._texture_sampler_types();if(e)return e;if(this._check(uL.template_types)){let e=this._advance().toString(),t=null,i=null;return this._match(uL.tokens.less_than)&&(t=this._type_decl(),i=null,this._match(uL.tokens.comma)&&(i=this._consume(uL.access_mode,"Expected access_mode for pointer").toString()),this._consume(uL.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new c9(e,t,i))}if(this._match(uL.keywords.ptr)){let e=this._previous().toString();this._consume(uL.tokens.less_than,"Expected '<' for pointer.");let t=this._consume(uL.storage_class,"Expected storage_class for pointer");this._consume(uL.tokens.comma,"Expected ',' for pointer.");let i=this._type_decl(),r=null;return this._match(uL.tokens.comma)&&(r=this._consume(uL.access_mode,"Expected access_mode for pointer").toString()),this._consume(uL.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new ue(e,t.toString(),i,r))}let t=this._attribute();if(this._match(uL.keywords.array)){let e=null,i=-1,r=this._previous(),s=null;if(this._match(uL.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t="";if(this._match(uL.tokens.comma)){s=this._shift_expression();try{t=s.constEvaluate(this._exec).toString(),s=null}catch(e){t="1"}}this._consume(uL.tokens.greater_than,"Expected '>' for array."),i=t?parseInt(t):0}let n=this._updateNode(new ut(r.toString(),t,e,i));return s&&this._deferArrayCountEval.push({arrayType:n,countNode:s}),n}return null}_texture_sampler_types(){if(this._match(uL.sampler_type)||this._match(uL.depth_texture_type))return this._updateNode(new ui(this._previous().toString(),null,null));if(this._match(uL.sampled_texture_type)||this._match(uL.multisampled_texture_type)){let e=this._previous();this._consume(uL.tokens.less_than,"Expected '<' for sampler type.");let t=this._type_decl();return this._consume(uL.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new ui(e.toString(),t,null))}if(this._match(uL.storage_texture_type)){let e=this._previous();this._consume(uL.tokens.less_than,"Expected '<' for sampler type.");let t=this._consume(uL.texel_format,"Invalid texel format.").toString();this._consume(uL.tokens.comma,"Expected ',' after texel format.");let i=this._consume(uL.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(uL.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new ui(e.toString(),t,i))}return null}_attribute(){let e=[];for(;this._match(uL.tokens.attr);){let t=this._consume(uL.attribute_name,"Expected attribute name"),i=this._updateNode(new uw(t.toString(),null));if(this._match(uL.tokens.paren_left)){if(i.value=this._consume(uL.literal_or_ident,"Expected attribute value").toString(),this._check(uL.tokens.comma)){this._advance();do{let e=this._consume(uL.literal_or_ident,"Expected attribute value").toString();i.value instanceof Array||(i.value=[i.value]),i.value.push(e)}while(this._match(uL.tokens.comma))}this._consume(uL.tokens.paren_right,"Expected ')'")}e.push(i)}return 0==e.length?null:e}}class u5 extends uZ{constructor(e){super(),e&&this.update(e)}update(e){let t=(new u6).parse(e);this.updateAST(t)}}function u8(e){return e?.format?`${e.name}<${e.format.name}>`:e.name}var u7=e.i(36932);let u9={};function he(e="id"){u9[e]=u9[e]||1;let t=u9[e]++;return`${e}-${t}`}class ht{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(e){if(this.id=e.id||he("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&l$.Buffer.INDEX))throw Error("Index buffer must have INDEX usage")}destroy(){for(let e of(this.indices?.destroy(),Object.values(this.attributes)))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}var hi=e.i(81905);class hr extends hi.Resource{get[Symbol.toStringTag](){return"ComputePipeline"}hash="";shaderLayout;constructor(e,t){super(e,t,hr.defaultProps),this.shaderLayout=t.shaderLayout}static defaultProps={...hi.Resource.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0}}class hs{static defaultProps={...ct.RenderPipeline.defaultProps};static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new hs(e),e._lumaData.defaultPipelineFactory}device;cachingEnabled;destroyPolicy;debug;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};get[Symbol.toStringTag](){return"PipelineFactory"}toString(){return`PipelineFactory(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cachePipelines,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=e.props.debugFactories}createRenderPipeline(e){if(!this.cachingEnabled)return this.device.createRenderPipeline(e);let t={...ct.RenderPipeline.defaultProps,...e},i=this._renderPipelineCache,r=this._hashRenderPipeline(t),s=i[r]?.pipeline;return s?(i[r].useCount++,this.debug&&eM.log.warn(`${this}: ${i[r].pipeline} reused, count=${i[r].useCount}, (id=${e.id})`)()):((s=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:he("unnamed-cached")})).hash=r,i[r]={pipeline:s,useCount:1},this.debug&&eM.log.warn(`${this}: ${s} created, count=${i[r].useCount}`)()),s}createComputePipeline(e){if(!this.cachingEnabled)return this.device.createComputePipeline(e);let t={...hr.defaultProps,...e},i=this._computePipelineCache,r=this._hashComputePipeline(t),s=i[r]?.pipeline;return s?(i[r].useCount++,this.debug&&eM.log.warn(`${this}: ${i[r].pipeline} reused, count=${i[r].useCount}, (id=${e.id})`)()):((s=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0})).hash=r,i[r]={pipeline:s,useCount:1},this.debug&&eM.log.warn(`${this}: ${s} created, count=${i[r].useCount}`)()),s}release(e){if(!this.cachingEnabled)return void e.destroy();let t=this._getCache(e),i=e.hash;t[i].useCount--,0===t[i].useCount?(this._destroyPipeline(e),this.debug&&eM.log.warn(`${this}: ${e} released and destroyed`)()):t[i].useCount<0?(eM.log.error(`${this}: ${e} released, useCount < 0, resetting`)(),t[i].useCount=0):this.debug&&eM.log.warn(`${this}: ${e} released, count=${t[i].useCount}`)()}_destroyPipeline(e){let t=this._getCache(e);switch(this.destroyPolicy){case"never":return!1;case"unused":return delete t[e.hash],e.destroy(),!0}}_getCache(e){let t;if(e instanceof hr&&(t=this._computePipelineCache),e instanceof ct.RenderPipeline&&(t=this._renderPipelineCache),!t)throw Error(`${this}`);if(!t[e.hash])throw Error(`${this}: ${e} matched incorrect entry`);return t}_hashComputePipeline(e){let{type:t}=this.device,i=this._getHash(e.shader.source);return`${t}/C/${i}`}_hashRenderPipeline(e){let t=e.vs?this._getHash(e.vs.source):0,i=e.fs?this._getHash(e.fs.source):0,r=this._getHash(JSON.stringify(e.bufferLayout)),{type:s}=this.device;if("webgl"===s)return`${s}/R/${t}/${i}V-BL${r}`;{let n=this._getHash(JSON.stringify(e.parameters));return`${s}/R/${t}/${i}V-T${e.topology}P${n}BL${r}`}}_getHash(e){return void 0===this._hashes[e]&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}var hn=e.i(45453);class ha{static defaultProps={...hn.Shader.defaultProps};static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new ha(e),e._lumaData.defaultShaderFactory}device;cachingEnabled;destroyPolicy;debug;_cache={};get[Symbol.toStringTag](){return"ShaderFactory"}toString(){return`${this[Symbol.toStringTag]}(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cacheShaders,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=!0}createShader(e){if(!this.cachingEnabled)return this.device.createShader(e);let t=this._hashShader(e),i=this._cache[t];if(i)i.useCount++,this.debug&&eM.log.warn(`${this}: Reusing shader ${i.shader.id} count=${i.useCount}`)();else{let r=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=i={shader:r,useCount:1},this.debug&&eM.log.warn(`${this}: Created new shader ${r.id}`)()}return i.shader}release(e){if(!this.cachingEnabled)return void e.destroy();let t=this._hashShader(e),i=this._cache[t];if(i)if(i.useCount--,0===i.useCount)"unused"===this.destroyPolicy&&(delete this._cache[t],i.shader.destroy(),this.debug&&eM.log.warn(`${this}: Releasing shader ${e.id}, destroyed`)());else if(i.useCount<0)throw Error(`ShaderFactory: Shader ${e.id} released too many times`);else this.debug&&eM.log.warn(`${this}: Releasing shader ${e.id} count=${i.useCount}`)()}_hashShader(e){return`${e.stage}:${e.source}`}}let ho=null,hl=null;class hc{bufferLayouts;constructor(e){this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){return e.attributes?e.attributes?.map(e=>e.attribute):[e.name]}mergeBufferLayouts(e,t){let i=[...e];for(let e of t){let t=i.findIndex(t=>t.name===e.name);t<0?i.push(e):i[t]=e}return i}getBufferIndex(e){let t=this.bufferLayouts.findIndex(t=>t.name===e);return -1===t&&eM.log.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}class hu{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(e,t){for(const i of(Object.assign(this.options,t),ed(Object.values(e).filter(e=>e.dependencies))))e[i.name]=i;for(const[t,i]of(eM.log.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={},Object.entries(e)))this._addModule(i),i.name&&t!==i.name&&!this.options.disableWarnings&&eM.log.warn(`Module name: ${t} vs ${i.name}`)()}destroy(){}setProps(e){for(let t of Object.keys(e)){let i=e[t]||{},r=this.modules[t];if(!r){this.options.disableWarnings||eM.log.warn(`Module ${t} not found`)();continue}let s=this.moduleUniforms[t],n=this.moduleBindings[t],{uniforms:a,bindings:o}=function(e){let t={bindings:{},uniforms:{}};return Object.keys(e).forEach(i=>{let r=e[i];(!ArrayBuffer.isView(r)||r instanceof DataView)&&(Array.isArray(r)?0!==r.length&&"number"!=typeof r[0]:1)&&"number"!=typeof r&&"boolean"!=typeof r?t.bindings[i]=r:t.uniforms[i]=r}),t}(r.getUniforms?.(i,s)||i);this.moduleUniforms[t]={...s,...a},this.moduleBindings[t]={...n,...o}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){let e={};for(let t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){let e={};for(let[t,i]of Object.entries(this.moduleUniforms))for(let[r,s]of Object.entries(i))e[`${t}.${r}`]={type:this.modules[t].uniformTypes?.[r],value:String(s)};return e}_addModule(e){let t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}async function hh(e,t){let i=new Image;return i.crossOrigin=t?.crossOrigin||"anonymous",i.src=e.startsWith("http")?e:""+e,await i.decode(),t?await createImageBitmap(i,t):await createImageBitmap(i)}let hd=["+X","-X","+Y","-Y","+Z","-Z"],hf=["+X","-X","+Y","-Y","+Z","-Z"];class hp{device;id;props;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(e,t){this.device=e;const i=he("async-texture");this.props={...hp.defaultProps,id:i,...t},this.id=this.props.id,t={...t},"string"==typeof t?.data&&"2d"===t.dimension&&(t.data=hh(t.data)),t.mipmaps&&(t.mipLevels="auto"),this.ready=new Promise((e,t)=>{this.resolveReady=()=>{this.isReady=!0,e()},this.rejectReady=t}),this.initAsync(t)}async initAsync(e){let t=e.data,i=await hg(t).then(void 0,this.rejectReady);if(this.destroyed)return;let r=this.props.width&&this.props.height?{width:this.props.width,height:this.props.height}:this.getTextureDataSize(i);if(!r)throw Error("Texture size could not be determined");let s={...r,...e,data:void 0,mipLevels:1},n=this.device.getMipLevelCount(s.width,s.height);if(s.mipLevels="auto"===this.props.mipLevels?n:Math.min(n,this.props.mipLevels),this.texture=this.device.createTexture(s),this.sampler=this.texture.sampler,this.view=this.texture.view,e.data)switch(this.props.dimension){case"1d":this._setTexture1DData(this.texture,i);break;case"2d":this._setTexture2DData(i);break;case"3d":this._setTexture3DData(this.texture,i);break;case"2d-array":this._setTextureArrayData(this.texture,i);break;case"cube":this._setTextureCubeData(this.texture,i);break;case"cube-array":this._setTextureCubeArrayData(this.texture,i)}this.props.mipmaps&&this.generateMipmaps(),eM.log.info(1,`${this} loaded`),this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}generateMipmaps(){this.texture.generateMipmapsWebGL()}setSampler(e={}){this.texture.setSampler(e instanceof ce.Sampler?e:this.device.createSampler(e))}resize(e){if(!this.isReady)throw Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){let t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}isTextureLevelData(e){return ArrayBuffer.isView(e?.data)}getTextureDataSize(e){if(!e||ArrayBuffer.isView(e))return null;if(Array.isArray(e))return this.getTextureDataSize(e[0]);if(this.device.isExternalImage(e))return this.device.getExternalImageSize(e);if(e&&"object"==typeof e&&e.constructor===Object){let t=Object.values(e)[0];return{width:t.width,height:t.height}}throw Error("texture size deduction failed")}getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw Error(e)}}setTextureData(e){}_setTexture1DData(e,t){throw Error("setTexture1DData not supported in WebGL.")}_setTexture2DData(e,t=0){if(!this.texture)throw Error("Texture not initialized");let i=this._normalizeTextureData(e);i.length>1&&!1!==this.props.mipmaps&&eM.log.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let e=0;e<i.length;e++){let r=i[e];this.device.isExternalImage(r)?this.texture.copyExternalImage({image:r,depth:t,mipLevel:e,flipY:!0}):this.texture.copyImageData({data:r.data,mipLevel:e})}}_setTexture3DData(e,t){if(this.texture?.props.dimension!=="3d")throw Error(this.id);for(let e=0;e<t.length;e++)this._setTexture2DData(t[e],e)}_setTextureCubeData(e,t){if(this.texture?.props.dimension!=="cube")throw Error(this.id);for(let[e,i]of Object.entries(t)){let t=hf.indexOf(e);this._setTexture2DData(i,t)}}_setTextureArrayData(e,t){if(this.texture?.props.dimension!=="2d-array")throw Error(this.id);for(let e=0;e<t.length;e++)this._setTexture2DData(t[e],e)}_setTextureCubeArrayData(e,t){throw Error("setTextureCubeArrayData not supported in WebGL2.")}_setTextureCubeFaceData(e,t,i,r=0){Array.isArray(t)&&t.length>1&&!1!==this.props.mipmaps&&eM.log.warn(`${this.id} has mipmap and multiple LODs.`)();let s=hd.indexOf(i);this._setTexture2DData(t,s)}_normalizeTextureData(e){let t=this.texture;return ArrayBuffer.isView(e)?[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?e:[e]}static defaultProps={...l7.Texture.defaultProps,data:null,mipmaps:!1}}async function hg(e){if(Array.isArray(e=await e))return await Promise.all(e.map(hg));if(e&&"object"==typeof e&&e.constructor===Object){let t=e,i=await Promise.all(Object.values(t)),r=Object.keys(t),s={};for(let e=0;e<r.length;e++)s[r[e]]=i[e];return s}return e}class hm{static defaultProps={...ct.RenderPipeline.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:eC.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(e,t){this.props={...hm.defaultProps,...t},t=this.props,this.id=t.id||he("model"),this.device=e,Object.assign(this.userData,t.userData);const i=Object.fromEntries(this.props.modules?.map(e=>[e.name,e])||[]),r=t.shaderInputs||new hu(i,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(r);const s=function(e){return{type:e.type,shaderLanguage:e.info.shadingLanguage,shaderLanguageVersion:e.info.shadingLanguageVersion,gpu:e.info.gpu,features:e.features}}(e),n=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if("webgpu"===this.device.type&&this.props.source){const{source:e,getUniforms:t}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:s,...this.props,modules:n});this.source=e,this._getModuleUniforms=t,this.props.shaderLayout||=function(e){let t,i={attributes:[],bindings:[]};try{t=function(e){try{return new u5(e)}catch(t){if(t instanceof Error)throw t;let e="WGSL parse error";throw"object"==typeof t&&t?.message&&(e+=`: ${t.message} `),"object"==typeof t&&t?.token&&(e+=t.token.line||""),Error(e,{cause:t})}}(e)}catch(e){return eM.log.error(e.message)(),i}for(let e of t.uniforms){let t=[];for(let i of e.type?.members||[])t.push({name:i.name,type:u8(i.type)});i.bindings.push({type:"uniform",name:e.name,group:e.group,location:e.binding,members:t})}for(let e of t.textures)i.bindings.push({type:"texture",name:e.name,group:e.group,location:e.binding});for(let e of t.samplers)i.bindings.push({type:"sampler",name:e.name,group:e.group,location:e.binding});let r=t.entry.vertex[0],s=r?.inputs.length||0;for(let e=0;e<s;e++){let t=r.inputs[e];if("location"===t.locationType){let e=u8(t.type);i.attributes.push({name:t.name,location:Number(t.location),type:e})}}return i}(this.source)}else{const{vs:e,fs:t,getUniforms:i}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:s,...this.props,modules:n});this.vs=e,this.fs=t,this._getModuleUniforms=i}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||hs.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||ha.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");let e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){let t,i=this._areBindingsLoading();if(i)return eM.log.info(2,`>>> DRAWING ABORTED ${this.id}: ${i} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();let i=this._getBindings();this.pipeline.setBindings(i,{disableWarnings:this.props.disableWarnings});let{indexBuffer:r}=this.vertexArray,s=r?r.byteLength/("uint32"===r.indexType?4:2):void 0;t=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:s,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),t?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",t}setGeometry(e){this._gpuGeometry?.destroy();let t=e&&function(e,t){if(t instanceof ht)return t;let i=function(e,t){if(!t.indices)return;let i=t.indices.value;return e.createBuffer({usage:l$.Buffer.INDEX,data:i})}(e,t),{attributes:r,bufferLayout:s}=function(e,t){let i=[],r={};for(let[s,n]of Object.entries(t.attributes)){let t=s;switch(s){case"POSITION":t="positions";break;case"NORMAL":t="normals";break;case"TEXCOORD_0":t="texCoords";break;case"COLOR_0":t="colors"}if(n){r[t]=e.createBuffer({data:n.value,id:`${s}-buffer`});let{value:a,size:o,normalized:l}=n;i.push({name:t,format:(0,u7.getVertexFormatFromAttribute)(a,o,l)})}}return{attributes:r,bufferLayout:i,vertexCount:t._calculateVertexCount(t.attributes,t.indices)}}(e,t);return new ht({topology:t.topology||"triangle-list",bufferLayout:s,vertexCount:t.vertexCount,indices:i,attributes:r})}(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");let e=new hc(this.bufferLayout);this.bufferLayout=e.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){let t=new hc(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){!function e(t,i,r){if(t===i)return!0;if(!r||!t||!i)return!1;if(Array.isArray(t)){if(!Array.isArray(i)||t.length!==i.length)return!1;for(let s=0;s<t.length;s++)if(!e(t[s],i[s],r-1))return!1;return!0}if(Array.isArray(i))return!1;if("object"==typeof t&&"object"==typeof i){let s=Object.keys(t),n=Object.keys(i);if(s.length!==n.length)return!1;for(let n of s)if(!i.hasOwnProperty(n)||!e(t[n],i[n],r-1))return!1;return!0}return!1}(e,this.parameters,2)&&(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,void 0===this.isInstanced&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){for(let[i,r]of(this.shaderInputs=e,this._uniformStore=new co(this.shaderInputs.modules),Object.entries(this.shaderInputs.modules))){var t;if((t=r).uniformTypes&&!function(e){for(let t in e)return!1;return!0}(t.uniformTypes)){let e=this._uniformStore.getManagedUniformBuffer(this.device,i);this.bindings[`${i}Uniforms`]=e}}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){var i,r;let s,n,a=t?.disableWarnings??this.props.disableWarnings;e.indices&&eM.log.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=(i=this.pipeline.shaderLayout,r=this.bufferLayout,s=Object.fromEntries(i.attributes.map(e=>[e.name,e.location])),(n=r.slice()).sort((e,t)=>{let i=e.attributes?e.attributes.map(e=>e.attribute):[e.name],r=t.attributes?t.attributes.map(e=>e.attribute):[t.name];return Math.min(...i.map(e=>s[e]))-Math.min(...r.map(e=>s[e]))}),n);let o=new hc(this.bufferLayout);for(let[t,i]of Object.entries(e)){let e=o.getBufferLayout(t);if(!e){a||eM.log.warn(`Model(${this.id}): Missing layout for buffer "${t}".`)();continue}let r=o.getAttributeNamesForBuffer(e),s=!1;for(let e of r){let t=this._attributeInfos[e];if(t){let e="webgpu"===this.device.type?o.getBufferIndex(t.bufferName):t.location;this.vertexArray.setBuffer(e,i),s=!0}}s||a||eM.log.warn(`Model(${this.id}): Ignoring buffer "${i.id}" for unknown attribute "${t}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(let[i,r]of Object.entries(e)){let e=this._attributeInfos[i];e?this.vertexArray.setConstantWebGL(e.location,r):(t?.disableWarnings??this.props.disableWarnings)||eM.log.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${i}"`)()}this.setNeedsRedraw("constants")}_areBindingsLoading(){for(let e of Object.values(this.bindings))if(e instanceof hp&&!e.isReady)return e.id;return!1}_getBindings(){let e={};for(let[t,i]of Object.entries(this.bindings))i instanceof hp?i.isReady&&(e[t]=i.texture):e[t]=i;return e}_getBindingsUpdateTimestamp(){let e=0;for(let t of Object.values(this.bindings))t instanceof l9.TextureView?e=Math.max(e,t.texture.updateTimestamp):t instanceof l$.Buffer||t instanceof l7.Texture?e=Math.max(e,t.updateTimestamp):t instanceof hp?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof ce.Sampler||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){let t={...e.attributes};for(let[e]of Object.entries(t))this.pipeline.shaderLayout.attributes.find(t=>t.name===e)||"positions"===e||delete t[e];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(eM.log.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;let i=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders}),r=null;this.source?r=i:this.fs&&(r=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:i,fs:r}),this._attributeInfos=(0,cl.getAttributeInfosFromLayouts)(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){let e=eM.log.level>3?0:1e4;eM.log.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,eM.log.group(2,`>>> DRAWING MODEL ${this.id}`,{collapsed:eM.log.level<=2})())}_logDrawCallEnd(){if(this._logOpen){let e=function(e,t){let i={},r="Values";if(0===e.attributes.length&&!e.varyings?.length)return{"No attributes or varyings":{[r]:"N/A"}};for(let t of e.attributes)if(t){let e=`${t.location} ${t.name}: ${t.type}`;i[`in ${e}`]={[r]:t.stepMode||"vertex"}}for(let t of e.varyings||[]){let e=`${t.location} ${t.name}`;i[`out ${e}`]={[r]:JSON.stringify(t)}}return i}(this.pipeline.shaderLayout,this.id);eM.log.table(2,e)();let t=this.shaderInputs.getDebugTable();eM.log.table(2,t)();let i=this._getAttributeDebugTable();eM.log.table(2,this._attributeInfos)(),eM.log.table(2,i)(),eM.log.groupEnd(2)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(e){let t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;let i=e.props.framebuffer;i&&function(e,{id:t,minimap:i,opaque:r,top:s="0",left:n="0",rgbaScale:a=1}){ho||((ho=document.createElement("canvas")).id=t,ho.title=t,ho.style.zIndex="100",ho.style.position="absolute",ho.style.top=s,ho.style.left=n,ho.style.border="blue 5px solid",ho.style.transform="scaleY(-1)",document.body.appendChild(ho),hl=ho.getContext("2d")),(ho.width!==e.width||ho.height!==e.height)&&(ho.width=e.width/2,ho.height=e.height/2,ho.style.width="400px",ho.style.height="400px");let o=e.device.readPixelsToArrayWebGL(e),l=hl?.createImageData(e.width,e.height);if(l){for(let e=0;e<o.length;e+=4)l.data[0+e+0]=o[e+0]*a,l.data[0+e+1]=o[e+1]*a,l.data[0+e+2]=o[e+2]*a,l.data[0+e+3]=r?255:o[e+3]*a;hl?.putImageData(l,0,0)}}(i,{id:i.id,minimap:!0})}_getAttributeDebugTable(){let e={};for(let[t,i]of Object.entries(this._attributeInfos)){let r=this.vertexArray.attributes[i.location];e[i.location]={name:t,type:i.shaderType,values:r?this._getBufferOrConstantValues(r,i.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){let{indexBuffer:t}=this.vertexArray,i="uint32"===t.indexType?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:i.toString()}}return e}_getBufferOrConstantValues(e,t){let i=(0,lW.getTypedArrayConstructor)(t);return(e instanceof l$.Buffer?new i(e.debugData):e).toString()}}class hy{device;model;transformFeedback;static defaultProps={...hm.defaultProps,outputs:void 0,feedbackBuffers:void 0};static isSupported(e){return e?.info?.type==="webgl"}constructor(e,t=hy.defaultProps){if(!hy.isSupported(e))throw Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new hm(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||function(e){let{input:t,inputChannels:i,output:r}={};if(!t)return l8;if(!i)throw Error("inputChannels");let s=function(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw Error(`invalid channels: ${e}`)}}(i),n=function(e,t){switch(t){case 1:return`vec4(${e}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${e}, 0.0, 1.0)`;case 3:return`vec4(${e}, 1.0)`;case 4:return e;default:throw Error(`invalid channels: ${t}`)}}(t,i);return`\
#version 300 es
in ${s} ${t};
out vec4 ${r};
void main() {
  ${r} = ${n};
}`}(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e?.inputBuffers&&this.model.setAttributes(e.inputBuffers),e?.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);let t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){let t=this.getBuffer(e);if(!t)throw Error("BufferTransform#getBuffer");if(t instanceof l$.Buffer)return t.readAsync();let{buffer:i,byteOffset:r=0,byteLength:s=i.byteLength}=t;return i.readAsync(r,s)}}function hv(e,t=[],i=0){let r=Math.fround(e),s=e-r;return t[i]=r,t[i+1]=s,t}let hx={name:"fp64arithmetic",vs:`\

uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,defaultUniforms:{ONE:1},uniformTypes:{ONE:"f32"},fp64ify:hv,fp64LowPart:function(e){return e-Math.fround(e)},fp64ifyMatrix4:function(e){let t=new Float32Array(32);for(let i=0;i<4;++i)for(let r=0;r<4;++r){let s=4*i+r;hv(e[4*r+i],t,2*s)}return t}};function h_(e){let{source:t,target:i,start:r=0,size:s,getData:n}=e,a=e.end||i.length,o=t.length,l=a-r;if(o>l)return void i.set(t.subarray(0,l),r);if(i.set(t,r),!n)return;let c=o;for(;c<l;){let e=n(c,t);for(let t=0;t<s;t++)i[r+c]=e[t]||0,c++}}function hb(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw Error(`No defined attribute type for size "${e}"`)}}function hw(e){switch(e){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw Error("invalid type size")}}function hk(e){e.push(e.shift())}function hP({device:e,source:t,target:i}){return(!i||i.byteLength<t.byteLength)&&(i?.destroy(),i=e.createBuffer({byteLength:t.byteLength,usage:t.usage})),i}function hS({device:e,buffer:t,attribute:i,fromLength:r,toLength:s,fromStartIndices:n,getData:a=e=>e}){let o=i.doublePrecision&&i.value instanceof Float64Array?2:1,l=i.size*o,c=i.byteOffset,u=i.settings.bytesPerElement<4?c/i.settings.bytesPerElement*4:c,h=i.startIndices,d=n&&h,f=i.isConstant;if(!d&&t&&r>=s)return t;let p=i.value instanceof Float64Array?Float32Array:i.value.constructor,g=f?i.value:new p(i.getBuffer().readSyncWebGL(c,s*p.BYTES_PER_ELEMENT).buffer);if(i.settings.normalized&&!f){let e=a;a=(t,r)=>i.normalizeConstant(e(t,r))}let m=f?(e,t)=>a(g,t):(e,t)=>a(g.subarray(e+c,e+c+l),t),y=new Float32Array(t?t.readSyncWebGL(u,4*r).buffer:0),v=new Float32Array(s);return!function({source:e,target:t,size:i,getData:r,sourceStartIndices:s,targetStartIndices:n}){if(!s||!n)return h_({source:e,target:t,size:i,getData:r});let a=0,o=0,l=r&&((e,t)=>r(e+o,t)),c=Math.min(s.length,n.length);for(let r=1;r<c;r++){let c=s[r]*i,u=n[r]*i;h_({source:e.subarray(a,c),target:t,start:o,end:u,size:i,getData:l}),a=c,o=u}o<t.length&&h_({source:[],target:t,start:o,size:i,getData:l})}({source:y,target:v,sourceStartIndices:n,targetStartIndices:h,size:l,getData:m}),(!t||t.byteLength<v.byteLength+u)&&(t?.destroy(),t=e.createBuffer({byteLength:v.byteLength+u,usage:35050})),t.write(v,u),t}class hT{constructor({device:e,attribute:t,timeline:i}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new oo(i),this.attribute=t,this.attributeInTransition=function(e){let{device:t,settings:i,value:r}=e,s=new l6(t,i);return s.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:i.normalized}),s}(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,i=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=function(e,t){let{doublePrecision:i,settings:r,value:s,size:n}=e,a=i&&s instanceof Float64Array?2:1,o=0,{shaderAttributes:l}=e.settings;if(l)for(let e of Object.values(l))o=Math.max(o,e.vertexOffset??0);return(r.noAlloc?s.length:(t+o)*n)*a}(this.attribute,t),this.transition.start({...e,duration:i})}update(){let e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){for(let e of(this.cancel(),this.buffers))e.destroy();this.buffers.length=0}}let hC={name:"interpolation",vs:`\
uniform interpolationUniforms {
  float time;
} interpolation;
`,uniformTypes:{time:"f32"}},hM=`\
#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,hA=`\
#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function hI(e){return e.doublePrecision&&e.value instanceof Float64Array}let hE={name:"spring",vs:`\
uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,uniformTypes:{damping:"f32",stiffness:"f32"}},hL=`\
#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,hO=`\
#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`,hR={interpolation:class extends hT{constructor({device:e,attribute:t,timeline:i}){super({device:e,attribute:t,timeline:i}),this.type="interpolation",this.transform=function(e,t){let i=t.size,r=hb(i),s=hw(i),n=t.getBufferLayout();return hI(t)?new hy(e,{vs:hA,bufferLayout:[{name:"aFrom",byteStride:8*i,attributes:[{attribute:"aFrom",format:s,byteOffset:0},{attribute:"aFrom64Low",format:s,byteOffset:4*i}]},{name:"aTo",byteStride:8*i,attributes:[{attribute:"aTo",format:s,byteOffset:0},{attribute:"aTo64Low",format:s,byteOffset:4*i}]}],modules:[hx,hC],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:i},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new hy(e,{vs:hM,bufferLayout:[{name:"aFrom",format:s},{name:"aTo",format:n.attributes[0].format}],modules:[hC],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}(e,t)}start(e,t){let i=this.currentLength,r=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0)return void this.transition.cancel();let{buffers:s,attribute:n}=this;hk(s),s[0]=hS({device:this.device,buffer:s[0],attribute:n,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter}),s[1]=hP({device:this.device,source:s[0],target:s[1]}),this.setBuffer(s[1]);let{transform:a}=this,o=a.model,l=Math.floor(this.currentLength/n.size);hI(n)&&(l/=2),o.setVertexCount(l),n.isConstant?(o.setAttributes({aFrom:s[0]}),o.setConstantAttributes({aTo:n.value})):o.setAttributes({aFrom:s[0],aTo:n.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:s[1]})}onUpdate(){let{duration:e,easing:t}=this.settings,{time:i}=this.transition,r=i/e;t&&(r=t(r));let{model:s}=this.transform,n={time:r};s.shaderInputs.setProps({interpolation:n}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}},spring:class extends hT{constructor({device:e,attribute:t,timeline:i}){var r,s;super({device:e,attribute:t,timeline:i}),this.type="spring",this.texture=e.createTexture({data:new Uint8Array(4),format:"rgba8unorm",width:1,height:1}),this.framebuffer=(r=e,s=this.texture,r.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[s]})),this.transform=function(e,t){let i=hb(t.size),r=hw(t.size);return new hy(e,{vs:hL,fs:hO,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:t.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[hE],defines:{ATTRIBUTE_TYPE:i},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}(e,t)}start(e,t){let i=this.currentLength,r=this.currentStartIndices;super.start(e,t);let{buffers:s,attribute:n}=this;for(let t=0;t<2;t++)s[t]=hS({device:this.device,buffer:s[t],attribute:n,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter});s[2]=hP({device:this.device,source:s[0],target:s[2]}),this.setBuffer(s[1]);let{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/n.size)),n.isConstant?a.setConstantAttributes({aTo:n.value}):a.setAttributes({aTo:n.getBuffer()})}onUpdate(){let{buffers:e,transform:t,framebuffer:i,transition:r}=this,s=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});let n={stiffness:s.stiffness,damping:s.damping};t.model.shaderInputs.setProps({spring:n}),t.run({framebuffer:i,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),hk(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(i)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}};class hN{constructor(e,{id:t,timeline:i}){if(!e)throw Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){for(let r in this.numInstances=i||1,e){let i=e[r],s=i.getTransitionSetting(t);s&&this._updateAttribute(r,i,s)}for(let i in this.transitions){let r=e[i];r&&r.getTransitionSetting(t)||this._removeTransition(i)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(0===this.numInstances)return!1;for(let e in this.transitions)this.transitions[e].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,i){let r=this.transitions[e],s=!r||r.type!==i.type;if(s){r&&this._removeTransition(e);let n=hR[i.type];n?this.transitions[e]=new n({attribute:t,timeline:this.timeline,device:this.device}):(is.error(`unsupported transition type '${i.type}'`)(),s=!1)}(s||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}}let hj="attributeManager.invalidate";class hD{constructor(e,{id:t="attribute-manager",stats:i,timeline:r}={}){this.mergeBoundsMemoized=i1(a2),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new hN(e,{id:`${t}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(let t of e)void 0!==this.attributes[t]&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let i=this._invalidateTrigger(e,t);nC(hj,this,e,i)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);nC(hj,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:r,props:s={},buffers:n={},context:a={}}){let o=!1;for(let r in nC("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart(),this.attributes){let l=this.attributes[r],c=l.settings.accessor;l.startIndices=i,l.numInstances=t,s[r]&&is.removed(`props.${r}`,`data.attributes.${r}`)(),l.setExternalBuffer(n[r])||l.setBinaryValue("string"==typeof c?n[c]:void 0,e.startIndices)||"string"==typeof c&&!n[c]&&l.setConstantValue(a,s[c])||l.needsUpdate()&&(o=!0,this._updateAttribute({attribute:l,numInstances:t,data:e,props:s,context:a})),this.needsRedraw=this.needsRedraw||l.needsRedraw()}o&&nC("attributeManager.updateEnd",this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:r})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){let t=e.map(e=>this.attributes[e]?.getBounds());return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:i}=this,r={...i.getAttributes()};for(let s in t){let n=t[s];n.needsRedraw(e)&&!i.hasAttribute(s)&&(r[s]=n)}return r}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(let i in e){let r=e[i],s={...r,id:i,size:r.isIndexed&&1||r.size||1,...t};this.attributes[i]=new l6(this.device,s)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(i=>{e[i]||(e[i]=[]),e[i].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:i,updateTriggers:r}=this,s=r[e];return s&&s.forEach(e=>{let r=i[e];r&&r.setNeedsUpdate(r.id,t)}),s}_updateAttribute(e){let{attribute:t,numInstances:i}=e;(nC("attribute.updateStart",t),t.constant)?t.setConstantValue(e.context,t.value):(t.allocate(i)&&nC("attribute.allocate",t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,nC("attribute.updateEnd",t,i)))}}function hz(e,t,i,r,s){let n=t-e;return(i-t)*s+-n*r+n+t}function hF(e,t){if(Array.isArray(e)){let i=0;for(let r=0;r<e.length;r++){let s=e[r]-t[r];i+=s*s}return Math.sqrt(i)}return Math.abs(e-t)}let hB={interpolation:class extends oo{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:i,duration:r,easing:s}}=this,n=s(e/r);this._value=rf(t,i,n)}},spring:class extends oo{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:i,stiffness:r}=this.settings,{_prevValue:s=e,_currValue:n=e}=this,a=function(e,t,i,r,s){if(Array.isArray(i)){let n=[];for(let a=0;a<i.length;a++)n[a]=hz(e[a],t[a],i[a],r,s);return n}return hz(e,t,i,r,s)}(s,n,t,i,r),o=hF(a,t),l=hF(a,n);o<1e-5&&l<1e-5&&(a=t,this.end()),this._prevValue=n,this._currValue=a}}};class hU{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,r){let{transitions:s}=this;if(s.has(e)){let i=s.get(e),{value:r=i.settings.fromValue}=i;t=r,this.remove(e)}if(!(r=l4(r)))return;let n=hB[r.type];if(!n)return void is.error(`unsupported transition type '${r.type}'`)();let a=new n(this.timeline);a.start({...r,fromValue:t,toValue:i}),s.set(e,a)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}}function h$({newProps:e,oldProps:t,ignoreProps:i={},propTypes:r={},triggerName:s="props"}){if(t===e)return!1;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return`${s} changed shallowly`;for(let n of Object.keys(e))if(!(n in i)){if(!(n in t))return`${s}.${n} added`;let i=hV(e[n],t[n],r[n]);if(i)return`${s}.${n} ${i}`}for(let n of Object.keys(t))if(!(n in i)){if(!(n in e))return`${s}.${n} dropped`;if(!Object.hasOwnProperty.call(e,n)){let i=hV(e[n],t[n],r[n]);if(i)return`${s}.${n} ${i}`}}return!1}function hV(e,t,i){let r=i&&i.equal;return r&&!r(e,t,i)||!r&&(r=e&&t&&e.equals)&&!r.call(e,t)?"changed deeply":r||t===e?null:"changed shallowly"}function hW(e,t,i){let r=e.updateTriggers[i];r=null==r?{}:r;let s=t.updateTriggers[i];return h$({oldProps:s=null==s?{}:s,newProps:r,triggerName:i})}function hG(e,t){if(!t)return e;let i={...e,...t};if("defines"in t&&(i.defines={...e.defines,...t.defines}),"modules"in t&&(i.modules=(e.modules||[]).concat(t.modules),t.modules.some(e=>"project64"===e.name))){let e=i.modules.findIndex(e=>"project32"===e.name);e>=0&&i.modules.splice(e,1)}if("inject"in t)if(e.inject){let r={...e.inject};for(let e in t.inject)r[e]=(r[e]||"")+t.inject[e];i.inject=r}else i.inject=t.inject;return i}var sX=sX,ii=ii;let hq=[0,0,0];function hH(e,t,i=!1){let r=t.projectPosition(e);if(i&&t instanceof oa){let[i,s,n=0]=e,a=t.getDistanceScales([i,s]);r[2]=n*a.unitsPerMeter[2]}return r}function hZ(e,{viewport:t,modelMatrix:i,coordinateSystem:r,coordinateOrigin:s,offsetMode:n}){let[a,o,l=0]=e;switch(i&&([a,o,l]=ii.transformMat4([],[a,o,l,1],i)),r){case iX.LNGLAT:return hH([a,o,l],t,n);case iX.LNGLAT_OFFSETS:return hH([a+s[0],o+s[1],l+(s[2]||0)],t,n);case iX.METER_OFFSETS:return hH(s5(s,[a,o,l]),t,n);case iX.CARTESIAN:default:return t.isGeospatial?[a+s[0],o+s[1],l+s[2]]:t.projectPosition([a,o,l])}}let hY={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},hX={},hK={boolean:{validate:(e,t)=>!0,equal:(e,t,i)=>!!e==!!t},number:{validate:(e,t)=>Number.isFinite(e)&&(!("max"in t)||e<=t.max)&&(!("min"in t)||e>=t.min)},color:{validate:(e,t)=>t.optional&&!e||hQ(e)&&(3===e.length||4===e.length),equal:(e,t,i)=>oe(e,t,1)},accessor:{validate(e,t){let i=h0(e);return"function"===i||i===h0(t.value)},equal:(e,t,i)=>"function"==typeof t||oe(e,t,1)},array:{validate:(e,t)=>t.optional&&!e||hQ(e),equal(e,t,i){let{compare:r}=i,s=Number.isInteger(r)?r:+!!r;return r?oe(e,t,s):e===t}},object:{equal(e,t,i){if(i.ignore)return!0;let{compare:r}=i,s=Number.isInteger(r)?r:+!!r;return r?oe(e,t,s):e===t}},function:{validate:(e,t)=>t.optional&&!e||"function"==typeof e,equal:(e,t,i)=>!i.compare&&!1!==i.ignore||e===t},data:{transform:(e,t,i)=>{if(!e)return e;let{dataTransform:r}=i.props;return r?r(e):"string"==typeof e.shape&&e.shape.endsWith("-table")&&Array.isArray(e.data)?e.data:e}},image:{transform:(e,t,i)=>{let r=i.context;return r&&r.device?function(e,t,i,r){if(i instanceof l7.Texture)return i;i.constructor&&"Object"!==i.constructor.name&&(i={data:i});let s=null;i.compressed&&(s={minFilter:"linear",mipmapFilter:i.data.length>1?"nearest":"linear"});let{width:n,height:a}=i.data,o=t.createTexture({...i,sampler:{...hY,...s,...r},mipLevels:t.getMipLevelCount(n,a)});return o.generateMipmapsWebGL(),hX[o.id]=e,o}(i.id,r.device,e,{...t.parameters,...i.props.textureParameters}):null},release:(e,t,i)=>{var r;r=i.id,e&&e instanceof l7.Texture&&hX[e.id]===r&&(e.delete(),delete hX[e.id])}}};function hJ(e,t){return"type"in t?{name:e,...hK[t.type],...t}:"value"in t?{name:e,type:h0(t.value),...t}:{name:e,type:"object",value:t}}function hQ(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function h0(e){return hQ(e)?"array":null===e?"null":typeof e}function h1(e,t){return Object.prototype.hasOwnProperty.call(e,t)}let h2=0;class h3{constructor(...e){this.props=function(e,t){let i;for(let e=t.length-1;e>=0;e--){let r=t[e];"extensions"in r&&(i=r.extensions)}let r=Object.create(function e(t,i){var r,s;if(!(t instanceof h4.constructor))return{};let n="_mergedDefaultProps";if(i)for(let e of i){let t=e.constructor;t&&(n+=`:${t.extensionName||t.name}`)}let a=h1(r=t,s=n)&&r[s];return a||(t[n]=function(t,i){var r;let s;if(!t.prototype)return null;let n=e(Object.getPrototypeOf(t)),a=function(e){let t={},i={},r={};for(let[s,n]of Object.entries(e)){let e=n?.deprecatedFor;if(e)r[s]=Array.isArray(e)?e:[e];else{let e=function(e,t){switch(h0(t)){case"object":return hJ(e,t);case"array":return hJ(e,{type:"array",value:t,compare:!1});case"boolean":return hJ(e,{type:"boolean",value:t});case"number":return hJ(e,{type:"number",value:t});case"function":return hJ(e,{type:"function",value:t,compare:!0});default:return{name:e,type:"unknown",value:t}}}(s,n);t[s]=e,i[s]=e.value}}return{propTypes:t,defaultProps:i,deprecatedProps:r}}(function(e,t){return h1(e,t)&&e[t]}(t,"defaultProps")||{}),o=Object.assign(Object.create(null),n,a.defaultProps),l=Object.assign(Object.create(null),n?.[nx],a.propTypes),c=Object.assign(Object.create(null),n?.[n_],a.deprecatedProps);for(let t of i){let i=e(t.constructor);i&&(Object.assign(o,i),Object.assign(l,i[nx]),Object.assign(c,i[n_]))}return Object.defineProperties(o,{id:{writable:!0,value:((s=(r=t).componentName)||is.warn(`${r.name}.componentName not specified`)(),s||r.name)}}),function(e,t){let i={},r={};for(let e in t){let s=t[e],{name:n,value:a}=s;s.async&&(i[n]=a,r[n]=function(e){return{enumerable:!0,set(t){"string"==typeof t||t instanceof Promise||lQ(t)?this[nw][e]=t:this[nk][e]=t},get(){if(this[nk]){if(e in this[nk])return this[nk][e]||this[nb][e];if(e in this[nw]){let t=this[nv]&&this[nv].internalState;if(t&&t.hasAsyncProp(e))return t.getAsyncProp(e)||this[nb][e]}}return this[nb][e]}}}(n))}e[nb]=i,e[nw]={},Object.defineProperties(e,r)}(o,l),function(e,t){for(let i in t)Object.defineProperty(e,i,{enumerable:!1,set(e){let r=`${this.id}: ${i}`;for(let r of t[i])h1(this,r)||(this[r]=e);is.deprecated(r,t[i].join("/"))()}})}(o,c),o[nx]=l,o[n_]=c,0!==i.length||h1(t,"_propTypes")||(t._propTypes=l),o}(t,i||[]))}(e.constructor,i));r[nv]=e,r[nw]={},r[nk]={};for(let e=0;e<t.length;++e){let i=t[e];for(let e in i)r[e]=i[e]}return Object.freeze(r),r}(this,e),this.id=this.props.id,this.count=h2++}clone(e){let{props:t}=this,i={};for(let e in t[nb])e in t[nk]?i[e]=t[nk][e]:e in t[nw]&&(i[e]=t[nw][e]);return new this.constructor({...t,...i,...e})}}h3.componentName="Component",h3.defaultProps={};let h4=h3,h6=Object.freeze({});class h5{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||h6}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[nv]||this.component;let t=e[nk]||{},i=e[nw]||e,r=e[nb]||{};for(let e in t){let i=t[e];this._createAsyncPropData(e,r[e]),this._updateAsyncProp(e,i),t[e]=this.getAsyncProp(e)}for(let e in i){let t=i[e];this._createAsyncPropData(e,r[e]),this._updateAsyncProp(e,t)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if("string"==typeof t&&(t=this._fetch(e,t)),t instanceof Promise)return void this._watchPromise(e,t);if(lQ(t))return void this._resolveAsyncIterable(e,t);this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps)for(let e in this.oldAsyncProps=Object.create(this.oldProps),this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}_didAsyncInputValueChange(e,t){let i=this.asyncProps[e];return t!==i.resolvedValue&&t!==i.lastValue&&(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){let r=this.asyncProps[e];r&&i>=r.resolvedLoadCount&&void 0!==t&&(this._freezeAsyncOldProps(),r.resolvedValue=t,r.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let i=this.asyncProps[e];if(i){i.pendingLoadCount++;let r=i.pendingLoadCount;t.then(t=>{this.component&&(t=this._postProcessValue(i,t),this._setAsyncPropValue(e,t,r),this._onResolve(e,t))}).catch(t=>{this._onError(e,t)})}}async _resolveAsyncIterable(e,t){if("data"!==e)return void this._setPropValue(e,t);let i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;let r=i.pendingLoadCount,s=[],n=0;for await(let i of t){if(!this.component)return;let{dataTransform:t}=this.component.props;Object.defineProperty(s=t?t(i,s):s.concat(i),"__diff",{enumerable:!1,value:[{startRow:n,endRow:s.length}]}),n=s.length,this._setAsyncPropValue(e,s,r)}this._onResolve(e,s)}_postProcessValue(e,t){let i=e.type;return i&&this.component&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let i=this.component&&this.component.props[nx];this.asyncProps[e]={type:i&&i[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class h8 extends h5{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){let i=this.layer,r=i?.props.fetch;return r?r(t,{propName:e,layer:i}):super._fetch(e,t)}_onResolve(e,t){let i=this.layer;if(i){let r=i.props.onDataLoad;"data"===e&&r&&r(t,{propName:e,layer:i})}}_onError(e,t){let i=this.layer;i&&i.raiseError(t,`loading ${e} of ${this.layer}`)}}let h7=Object.freeze([]),h9=i1(({oldViewport:e,viewport:t})=>e.equals(t)),de=new Uint8ClampedArray(0),dt={data:{type:"data",value:h7,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:e=>e&&e.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(e,{propName:t,layer:i,loaders:r,loadOptions:s,signal:n})=>{let{resourceManager:a}=i.context;s=s||i.getLoadOptions(),r=r||i.props.loaders,n&&(s={...s,fetch:{...s?.fetch,signal:n}});let o=a.contains(e);return(o||s||(a.add({resourceId:e,data:aZ(e,r),persistent:!1}),o=!0),o)?a.subscribe({resourceId:e,onChange:e=>i.internalState?.reloadAsyncProp(t,e),consumerId:i.id,requestId:t}):aZ(e,r,s)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:iX.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:e})=>[0,-(100*e)]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class di extends h4{constructor(){super(...arguments),this.internalState=null,this.lifecycle="Awaiting state",this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return`${e}({id: '${this.props.id}'})`}project(e){oh(this.internalState);let t=this.internalState.viewport||this.context.viewport,[i,r,s]=s9(hZ(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),t.pixelProjectionMatrix);return 2===e.length?[i,r]:[i,r,s]}unproject(e){return oh(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){return oh(this.internalState),function(e,t){let{viewport:i,coordinateSystem:r,coordinateOrigin:s,modelMatrix:n,fromCoordinateSystem:a,fromCoordinateOrigin:o}=function(e){let{viewport:t,modelMatrix:i,coordinateOrigin:r}=e,{coordinateSystem:s,fromCoordinateSystem:n,fromCoordinateOrigin:a}=e;return s===iX.DEFAULT&&(s=t.isGeospatial?iX.LNGLAT:iX.CARTESIAN),void 0===n&&(n=s),void 0===a&&(a=r),{viewport:t,coordinateSystem:s,coordinateOrigin:r,modelMatrix:i,fromCoordinateSystem:n,fromCoordinateOrigin:a}}(t),{autoOffset:l=!0}=t,{geospatialOrigin:c=hq,shaderCoordinateOrigin:u=hq,offsetMode:h=!1}=l?i7(i,r,s):{},d=hZ(e,{viewport:i,modelMatrix:n,coordinateSystem:a,coordinateOrigin:o,offsetMode:h});if(h){let e=i.projectPosition(c||u);sX.sub(d,d,e)}return d}(e,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){let e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(let t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===iX.DEFAULT||e===iX.LNGLAT||e===iX.CARTESIAN}onHover(e,t){return!!this.props.onHover&&(this.props.onHover(e,t)||!1)}onClick(e,t){return!!this.props.onClick&&(this.props.onClick(e,t)||!1)}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){oh(e instanceof Uint8Array);let[t,i,r]=e;return t+256*i+65536*r-1}getNumInstances(){if(Number.isFinite(this.props.numInstances))return this.props.numInstances;if(this.state&&void 0!==this.state.numInstances)return this.state.numInstances;var e,t,i=this.props.data;if(null===(e=i)||"object"!=typeof e)throw Error("count(): argument not an object");if("function"==typeof i.count)return i.count();if(Number.isFinite(i.size))return i.size;if(Number.isFinite(i.length))return i.length;if(null!==(t=i)&&"object"==typeof t&&t.constructor===Object)return Object.keys(i).length;throw Error("count(): argument not a container")}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){for(let t of(e=hG(e,{disableWarnings:!0,modules:this.context.defaultShaderModules}),this.props.extensions))e=hG(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(let e of i)t.invalidateAll(e);else t.invalidateAll();if(t){let{props:i}=e,r=this.internalState.hasPickingBuffer,s=Number.isInteger(i.highlightedObjectIndex)||i.pickable||i.extensions.some(e=>e.getNeedsPickingBuffer.call(this,e));if(r!==s){this.internalState.hasPickingBuffer=s;let{pickingColors:e,instancePickingColors:i}=t.attributes,r=e||i;r&&(s&&r.constant&&(r.constant=!1,t.invalidate(r.id)),r.value||s||(r.constant=!0,r.value=[0,0,0]))}}}finalizeState(e){for(let e of this.getModels())e.destroy();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:i}){let{index:r}=e;return r>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[r]),e}raiseError(e,t){t&&(e=Error(`${t}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,t&&h9({oldViewport:t,viewport:e})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();t&&("all"===e?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(let i in e)e[i].layoutChanged()&&(t=!0);for(let i of this.getModels())this._setModelAttributes(i,e,t)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,i=this.getNumInstances(),r=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:r,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let s=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(s)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),i=Object.create(this.props);for(let e in t)Object.defineProperty(i,e,{value:t[e]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let i=Math.floor(de.length/4);if(this.internalState.usesPickingColorCache=!0,i<t){t>0xffffff&&is.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")();let e=Math.floor((de=aK.allocate(de,t,{size:4,copy:!0,maxCount:Math.max(t,0xffffff)})).length/4),r=[0,0,0];for(let t=i;t<e;t++)this.encodePickingColor(t,r),de[4*t+0]=r[0],de[4*t+1]=r[1],de[4*t+2]=r[2],de[4*t+3]=0}e.value=de.subarray(0,4*t)}_setModelAttributes(e,t,i=!1){if(!Object.keys(t).length)return;if(i){let i=this.getAttributeManager();e.setBufferLayout(i.getBufferLayouts(e)),t=i.getAttributes()}let r=e.userData?.excludeAttributes||{},s={},n={};for(let i in t){if(r[i])continue;let a=t[i].getValue();for(let r in a){let o=a[r];o instanceof l$.Buffer?t[i].settings.isIndexed?e.setIndexBuffer(o):s[r]=o:o&&(n[r]=o)}}e.setAttributes(s),e.setConstantAttributes(n)}disablePickingIndex(e){let t=this.props.data;if(!("attributes"in t))return void this._disablePickingIndex(e);let{pickingColors:i,instancePickingColors:r}=this.getAttributeManager().attributes,s=i||r,n=s&&t.attributes&&t.attributes[s.id];if(n&&n.value){let i=n.value,r=this.encodePickingColor(e);for(let e=0;e<t.length;e++){let t=s.getVertexOffset(e);i[t]===r[0]&&i[t+1]===r[1]&&i[t+2]===r[2]&&this._disablePickingIndex(e)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,r=t||i;if(!r)return;let s=r.getVertexOffset(e),n=r.getVertexOffset(e+1);r.buffer.write(new Uint8Array(n-s),s)}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;i&&(this.internalState.usesPickingColorCache&&i.value.buffer!==de.buffer&&(i.value=de.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){oh(!this.internalState),oh(Number.isFinite(this.props.coordinateSystem)),nC("layer.initialize",this);let e=this._getAttributeManager();for(let t of(e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new h8({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(is.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new hU(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context),this.props.extensions))t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){nC("layer.matched",this,this===e);let{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(nC("layer.update",this,e),!e)return;let t=this.props,i=this.context,r=this.internalState,s=i.viewport,n=this._updateUniformTransition();r.propsInTransition=n,i.viewport=r.viewport||s,this.props=n;try{let e=this._getUpdateParams(),t=this.getModels();if(i.device)this.updateState(e);else try{this.updateState(e)}catch(e){}for(let t of this.props.extensions)t.updateState.call(this,e,t);this.setNeedsRedraw(),this._updateAttributes();let r=this.getModels()[0]!==t[0];this._postUpdate(e,r)}finally{i.viewport=s,this.props=t,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){for(let e of(nC("layer.finalize",this),this.finalizeState(this.context),this.props.extensions))e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:i={},parameters:r={}}){this._updateAttributeTransition();let s=this.props,n=this.context;this.props=this.internalState.propsInTransition||s;try{t&&this.setShaderModuleProps(t);let{getPolygonOffset:s}=this.props,a=s&&s(i)||[0,0];for(let e of(n.device instanceof lV.WebGLDevice&&n.device.setParametersWebGL({polygonOffset:a}),this.getModels()))"webgpu"===e.device.type?e.setParameters({...e.parameters,...r}):e.setParameters(r);if(n.device instanceof lV.WebGLDevice)n.device.withParametersWebGL(r,()=>{let s={renderPass:e,shaderModuleProps:t,uniforms:i,parameters:r,context:n};for(let e of this.props.extensions)e.draw.call(this,s,e);this.draw(s)});else{let s={renderPass:e,shaderModuleProps:t,uniforms:i,parameters:r,context:n};for(let e of this.props.extensions)e.draw.call(this,s,e);this.draw(s)}}finally{this.props=s}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let i in e)if(e[i]){let r=!1;if("dataChanged"===i){let s=e[i],n=t[i];s&&Array.isArray(n)&&(t.dataChanged=Array.isArray(s)?n.concat(s):s,r=!0)}t[i]||(t[i]=e[i],r=!0),r&&nC("layer.changeFlag",this,i,e)}let i=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let i,r,s,n=(i=h$({newProps:e,oldProps:t,propTypes:e[nx],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=function(e,t){if(null===t)return"oldProps is null, initial diff";let i=!1,{dataComparator:r,_dataDiff:s}=e;return r?r(e.data,t.data)||(i="Data comparator detected a change"):e.data!==t.data&&(i="A new data container was supplied"),i&&s&&(i=s(e.data,t.data)||i),i}(e,t),s=!1,r||(s=function(e,t){if(null===t||"all"in e.updateTriggers&&hW(e,t,"all"))return{all:!0};let i={},r=!1;for(let s in e.updateTriggers)"all"!==s&&hW(e,t,s)&&(i[s]=!0,r=!0);return!!r&&i}(e,t)),{dataChanged:r,propsChanged:i,updateTriggersChanged:s,extensionsChanged:function(e,t){if(null===t)return!0;let i=t.extensions,{extensions:r}=e;if(r===i)return!1;if(!i||!r||r.length!==i.length)return!0;for(let e=0;e<r.length;e++)if(!r[e].equals(i[e]))return!0;return!1}(e,t),transitionsChanged:function(e,t){if(!e.transitions)return!1;let i={},r=e[nx],s=!1;for(let n in e.transitions){let a=r[n],o=a&&a.type;("number"===o||"color"===o||"array"===o)&&hV(e[n],t[n],a)&&(i[n]=!0,s=!0)}return!!s&&i}(e,t)});if(n.updateTriggersChanged)for(let e in n.updateTriggersChanged)n.updateTriggersChanged[e]&&this.invalidateAttribute(e);if(n.transitionsChanged)for(let i in n.transitionsChanged)this.internalState.uniformTransitions.add(i,t[i],e[i],e.transitions?.[i]);return this.setChangeFlags(n)}validateProps(){!function(e){let t=e[nx];for(let i in t){let r=t[i],{validate:s}=r;if(s&&!s(e[i],r))throw Error(`Invalid prop ${i}: ${e[i]}`)}}(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&"function"==typeof i&&(t.highlightColor=i(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new hD(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:i,oldProps:r}=e,s=this.state.model;s?.isInstanced&&s.setInstanceCount(this.getNumInstances());let{autoHighlight:n,highlightedObjectIndex:a,highlightColor:o}=i;if(t||r.autoHighlight!==n||r.highlightedObjectIndex!==a||r.highlightColor!==o){let e={};Array.isArray(o)&&(e.highlightColor=o),(t||r.autoHighlight!==n||a!==r.highlightedObjectIndex)&&(e.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:e})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=this.internalState.needsRedraw&&this.id;let i=this.getAttributeManager(),r=!!i&&i.getNeedsRedraw(e);if(t=t||r)for(let e of this.props.extensions)e.onNeedsRedraw.call(this,e);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}di.defaultProps=dt,di.layerName="Layer";let dr=di,ds={position:"absolute",zIndex:-1};function dn(e){return e&&"object"==typeof e&&"type"in e||!1}let da=(0,D.createContext)(),dl={mixBlendMode:null};function dc(e){e.redrawReason&&(e.deck._drawLayers(e.redrawReason),e.redrawReason=null)}let du=D.forwardRef(function(e,t){let[i,r]=(0,D.useState)(0),s=(0,D.useRef)({control:null,version:i,forceUpdate:()=>r(e=>e+1)}).current,n=(0,D.useRef)(null),a=(0,D.useRef)(null),o=(0,D.useMemo)(()=>(function({children:e,layers:t=[],views:i=null}){let r=[],s=[],n={};return D.Children.forEach(function e(t){if("function"==typeof t)return(0,D.createElement)(on,{},t);if(Array.isArray(t))return t.map(e);if(dn(t)){if(t.type===D.Fragment)return e(t.props.children);lU(t.type,on)}return t}(e),e=>{if(dn(e)){let t=e.type;if(lU(t,dr)){let i=function(e,t){let i={},r=e.defaultProps||{};for(let e in t)r[e]!==t[e]&&(i[e]=t[e]);return new e(i)}(t,e.props);s.push(i)}else r.push(e);if(lU(t,on)&&t!==on&&e.props.id){let i=new t(e.props);n[i.id]=i}}else e&&r.push(e)}),Object.keys(n).length>0&&(Array.isArray(i)?i.forEach(e=>{n[e.id]=e}):i&&(n[i.id]=i),i=Object.values(n)),{layers:t=s.length>0?[...s,...t]:t,children:r,views:i}})(e),[e.layers,e.views,e.children]),l=!0,c=t=>l&&e.viewState?(s.viewStateUpdateRequested=t,null):(s.viewStateUpdateRequested=null,e.onViewStateChange?.(t)),u=t=>{l?s.interactionStateUpdateRequested=t:(s.interactionStateUpdateRequested=null,e.onInteractionStateChange?.(t))},h=(0,D.useMemo)(()=>{let t={widgets:[],...e,style:null,width:"100%",height:"100%",parent:n.current,canvas:a.current,layers:o.layers,views:o.views,onViewStateChange:c,onInteractionStateChange:u};return delete t._customRender,s.deck&&s.deck.setProps(t),t},[e]);(0,D.useEffect)(()=>{var t;let i;return i=new(e.Deck||lF)({...t={...h,parent:n.current,canvas:a.current},_customRender:t.deviceProps?.adapters?.[0]?.type==="webgpu"?void 0:e=>{s.redrawReason=e;let t=i.getViewports();s.lastRenderedViewports!==t?s.forceUpdate():dc(s)}}),s.deck=i,()=>s.deck?.finalize()},[]),lB(()=>{dc(s);let{viewStateUpdateRequested:e,interactionStateUpdateRequested:t}=s;e&&c(e),t&&u(t),s.deck?.isInitialized&&s.deck.redraw("Initial render")}),(0,D.useImperativeHandle)(t,()=>({get deck(){return s.deck},pickObject:e=>s.deck.pickObject(e),pickMultipleObjects:e=>s.deck.pickMultipleObjects(e),pickObjects:e=>s.deck.pickObjects(e)}),[]);let d=s.deck&&s.deck.isInitialized?s.deck.getViewports():void 0,{ContextProvider:f,width:p="100%",height:g="100%",id:m,style:y}=e,{containerStyle:v,canvasStyle:x}=(0,D.useMemo)(()=>(function({width:e,height:t,style:i}){let r={position:"absolute",zIndex:0,left:0,top:0,width:e,height:t},s={left:0,top:0};if(i)for(let e in i)e in dl?s[e]=i[e]:r[e]=i[e];return{containerStyle:r,canvasStyle:s}})({width:p,height:g,style:y}),[p,g,y]);if(!s.viewStateUpdateRequested&&s.lastRenderedViewports===d||s.version!==i){s.lastRenderedViewports=d,s.version=i;let e=function({children:e,deck:t,ContextProvider:i=da.Provider}){let{viewManager:r}=t||{};if(!r||!r.views.length)return[];let s={},n=r.views[0].id;for(let t of e){let e=n,i=t;dn(t)&&lU(t.type,on)&&(e=t.props.id||n,i=t.props.children);let a=r.getViewport(e),o=r.getViewState(e);if(a){o.padding=a.padding;let{x:t,y:r,width:n,height:l}=a;i=function e(t,i){if("function"==typeof t)return t(i);if(Array.isArray(t))return t.map(t=>e(t,i));if(dn(t)){var r;if(r=t,r.props?.mapStyle)return i.style=ds,(0,D.cloneElement)(t,i);if(function(e){let t=e.type;return t&&t.deckGLViewProps}(t))return(0,D.cloneElement)(t,i)}return t}(i,{x:t,y:r,width:n,height:l,viewport:a,viewState:o}),s[e]||(s[e]={viewport:a,children:[]}),s[e].children.push(i)}}return Object.keys(s).map(e=>{let{viewport:r,children:n}=s[e],{x:a,y:o,width:l,height:c}=r,u=`view-${e}`,h=(0,D.createElement)("div",{key:u,id:u,style:{position:"absolute",left:a,top:o,width:l,height:c}},...n),d={deck:t,viewport:r,container:t.canvas.offsetParent,eventManager:t.eventManager,onViewStateChange:i=>{i.viewId=e,t._onViewStateChange(i)},widgets:[]},f=`view-${e}-context`;return(0,D.createElement)(i,{key:f,value:d},h)})}({children:o.children,deck:s.deck,ContextProvider:f}),t=(0,D.createElement)("canvas",{key:"canvas",id:m||"deckgl-overlay",ref:a,style:x});s.control=(0,D.createElement)("div",{id:`${m||"deckgl"}-wrapper`,ref:n,style:v},[t,e])}return l=!1,s.control});class dh{id;topology;vertexCount;indices;attributes;userData={};constructor(e){const{attributes:t={},indices:i=null,vertexCount:r=null}=e;for(const[r,s]of(this.id=e.id||he("geometry"),this.topology=e.topology,i&&(this.indices=ArrayBuffer.isView(i)?{value:i,size:1}:i),this.attributes={},Object.entries(t))){const e=ArrayBuffer.isView(s)?{value:s}:s;if(!ArrayBuffer.isView(e.value))throw Error(`${this._print(r)}: must be typed array or object with value as typed array`);if("POSITION"!==r&&"positions"!==r||e.size||(e.size=3),"indices"===r){if(this.indices)throw Error("Multiple indices detected");this.indices=e}else this.attributes[r]=e}this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=r||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(let t of Object.values(e)){let{value:e,size:r,constant:s}=t;!s&&e&&void 0!==r&&r>=1&&(i=Math.min(i,e.length/r))}return i}}let dd=`\
uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  float filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,df={name:"scatterplot",vs:dd,fs:dd,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},dp=`\
#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
);
outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
if (scatterplot.billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,dg=`\
#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = scatterplot.antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (scatterplot.stroked > 0.5) {
float isLine = scatterplot.antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (scatterplot.filled > 0.5) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (scatterplot.filled < 0.5) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,dm=`\
// Main shaders

struct ScatterplotUniforms {
  radiusScale: f32,
  radiusMinPixels: f32,
  radiusMaxPixels: f32,
  lineWidthScale: f32,
  lineWidthMinPixels: f32,
  lineWidthMaxPixels: f32,
  stroked: f32,
  filled: i32,
  antialiasing: i32,
  billboard: i32,
  radiusUnits: i32,
  lineWidthUnits: i32,
};

struct ConstantAttributeUniforms {
 instancePositions: vec3<f32>,
 instancePositions64Low: vec3<f32>,
 instanceRadius: f32,
 instanceLineWidths: f32,
 instanceFillColors: vec4<f32>,
 instanceLineColors: vec4<f32>,
 instancePickingColors: vec3<f32>,

 instancePositionsConstant: i32,
 instancePositions64LowConstant: i32,
 instanceRadiusConstant: i32,
 instanceLineWidthsConstant: i32,
 instanceFillColorsConstant: i32,
 instanceLineColorsConstant: i32,
 instancePickingColorsConstant: i32
};

@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;

struct ConstantAttributes {
  instancePositions: vec3<f32>,
  instancePositions64Low: vec3<f32>,
  instanceRadius: f32,
  instanceLineWidths: f32,
  instanceFillColors: vec4<f32>,
  instanceLineColors: vec4<f32>,
  instancePickingColors: vec3<f32>
};

const constants = ConstantAttributes(
  vec3<f32>(0.0),
  vec3<f32>(0.0),
  0.0,
  0.0,
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec3<f32>(0.0)
);

struct Attributes {
  @builtin(instance_index) instanceIndex : u32,
  @builtin(vertex_index) vertexIndex : u32,
  @location(0) positions: vec3<f32>,
  @location(1) instancePositions: vec3<f32>,
  @location(2) instancePositions64Low: vec3<f32>,
  @location(3) instanceRadius: f32,
  @location(4) instanceLineWidths: f32,
  @location(5) instanceFillColors: vec4<f32>,
  @location(6) instanceLineColors: vec4<f32>,
  @location(7) instancePickingColors: vec3<f32>
};

struct Varyings {
  @builtin(position) position: vec4<f32>,
  @location(0) vFillColor: vec4<f32>,
  @location(1) vLineColor: vec4<f32>,
  @location(2) unitPosition: vec2<f32>,
  @location(3) innerUnitRadius: f32,
  @location(4) outerRadiusPixels: f32,
};

@vertex
fn vertexMain(attributes: Attributes) -> Varyings {
  var varyings: Varyings;

  // Draw an inline geometry constant array clip space triangle to verify that rendering works.
  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));
  // if (attributes.instanceIndex == 0) {
  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);
  //   return varyings;
  // }

  // var geometry: Geometry;
  // geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  varyings.outerRadiusPixels = clamp(
    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );

  // Multiply out line width and clamp to limits
  let lineWidthPixels = clamp(
    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accommodate edge smoothing
  let edgePadding = select(
    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,
    1.0,
    scatterplot.antialiasing != 0
  );

  // position on the containing square in [-1, 1] space
  varyings.unitPosition = edgePadding * attributes.positions.xy;
  geometry.uv = varyings.unitPosition;
  geometry.pickingColor = attributes.instancePickingColors;

  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;

  if (scatterplot.billboard != 0) {
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;
    // DECKGL_FILTER_SIZE(offset, geometry);
    let clipPixels = project_pixel_size_to_clipspace(offset.xy);
    varyings.position.x = clipPixels.x;
    varyings.position.y = clipPixels.y;
  } else {
    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);
    // DECKGL_FILTER_SIZE(offset, geometry);
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);
  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);

  return varyings;
}

@fragment
fn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {
  // var geometry: Geometry;
  // geometry.uv = unitPosition;

  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;
  let inCircle = select(
    smoothedge(distToCenter, varyings.outerRadiusPixels),
    step(distToCenter, varyings.outerRadiusPixels),
    scatterplot.antialiasing != 0
  );

  if (inCircle == 0.0) {
    discard;
  }

  var fragColor: vec4<f32>;

  if (scatterplot.stroked != 0) {
    let isLine = select(
      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      scatterplot.antialiasing != 0
    );

    if (scatterplot.filled != 0) {
      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == 0) {
    discard;
  } else {
    fragColor = varyings.vFillColor;
  }

  fragColor.a *= inCircle;
  // DECKGL_FILTER_COLOR(fragColor, geometry);

  // Apply premultiplied alpha as required by transparent canvas
  fragColor = deckgl_premultiplied_alpha(fragColor);

  return fragColor;
  // return vec4<f32>(0, 0, 1, 1);
}
`,dy=[0,0,0,255],dv={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:e=>e.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:dy},getLineColor:{type:"accessor",value:dy},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class dx extends dr{getShaders(){return super.getShaders({vs:dp,fs:dg,source:dm,modules:[rc,eB,np,df]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e),e.changeFlags.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){let{radiusUnits:t,radiusScale:i,radiusMinPixels:r,radiusMaxPixels:s,stroked:n,filled:a,billboard:o,antialiasing:l,lineWidthUnits:c,lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d}=this.props,f={stroked:n,filled:a,billboard:o,antialiasing:l,radiusUnits:iJ[t],radiusScale:i,radiusMinPixels:r,radiusMaxPixels:s,lineWidthUnits:iJ[c],lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d},p=this.state.model;p.shaderInputs.setProps({scatterplot:f}),"webgpu"===this.context.device.type&&(p.instanceCount=this.props.data.length),p.draw(this.context.renderPass)}_getModel(){let e="webgpu"===this.context.device.type?{depthWriteEnabled:!0,depthCompare:"less-equal"}:void 0;return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new dh({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0])}}}),isInstanced:!0,parameters:e})}}dx.defaultProps=dv,dx.layerName="ScatterplotLayer";let d_=Math.PI/180,db=23.4397*d_;function dw(e,t,i){var r,s,n,a,o,l,c;let u,h,d,f,{azimuth:p,altitude:g}=(u=d_*t,d=function(e){var t;let i,r=(t=d_*(357.5291+.98560028*e),i=d_*(1.9148*Math.sin(t)+.02*Math.sin(2*t)+3e-4*Math.sin(3*t)),t+i+102.9372*d_+Math.PI);return{declination:Math.asin(0*Math.cos(db)+Math.sin(db)*Math.sin(r)),rightAscension:Math.atan2(Math.sin(r)*Math.cos(db)-Math.tan(0)*Math.sin(db),Math.cos(r))}}(h=function(e){return("number"==typeof e?e:e.getTime())/864e5-.5+2440588-2451545}(e)),{azimuth:Math.atan2(Math.sin(n=f=(r=h,s=-(d_*i),d_*(280.147+360.9856235*r)-s-d.rightAscension)),Math.cos(n)*Math.sin(a=u)-Math.tan(d.declination)*Math.cos(a)),altitude:(o=f,Math.asin(Math.sin(l=u)*Math.sin(c=d.declination)+Math.cos(l)*Math.cos(c)*Math.cos(o)))});return[Math.sin(p)*Math.cos(g),Math.cos(p)*Math.cos(g),-Math.sin(g)]}let dk=new Uint32Array([0,2,1,0,3,2]),dP=new Float32Array([0,1,0,0,1,0,1,1]),dS=`\
uniform bitmapUniforms {
  vec4 bounds;
  float coordinateConversion;
  float desaturate;
  vec3 tintColor;
  vec4 transparentColor;
} bitmap;
`,dT={name:"bitmap",vs:dS,fs:dS,uniformTypes:{bounds:"vec4<f32>",coordinateConversion:"f32",desaturate:"f32",tintColor:"vec3<f32>",transparentColor:"vec4<f32>"}},dC=`\
#version 300 es
#define SHADER_NAME bitmap-layer-vertex-shader

in vec2 texCoords;
in vec3 positions;
in vec3 positions64Low;

out vec2 vTexCoord;
out vec2 vTexPos;

const vec3 pickingColor = vec3(1.0, 0.0, 0.0);

void main(void) {
  geometry.worldPosition = positions;
  geometry.uv = texCoords;
  geometry.pickingColor = pickingColor;

  gl_Position = project_position_to_clipspace(positions, positions64Low, vec3(0.0), geometry.position);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTexCoord = texCoords;

  if (bitmap.coordinateConversion < -0.5) {
    vTexPos = geometry.position.xy + project.commonOrigin.xy;
  } else if (bitmap.coordinateConversion > 0.5) {
    vTexPos = geometry.worldPosition.xy;
  }

  vec4 color = vec4(0.0);
  DECKGL_FILTER_COLOR(color, geometry);
}
`,dM=`
vec3 packUVsIntoRGB(vec2 uv) {
  // Extract the top 8 bits. We want values to be truncated down so we can add a fraction
  vec2 uv8bit = floor(uv * 256.);

  // Calculate the normalized remainders of u and v parts that do not fit into 8 bits
  // Scale and clamp to 0-1 range
  vec2 uvFraction = fract(uv * 256.);
  vec2 uvFraction4bit = floor(uvFraction * 16.);

  // Remainder can be encoded in blue channel, encode as 4 bits for pixel coordinates
  float fractions = uvFraction4bit.x + uvFraction4bit.y * 16.;

  return vec3(uv8bit, fractions) / 255.;
}
`,dA=`\
#version 300 es
#define SHADER_NAME bitmap-layer-fragment-shader

#ifdef GL_ES
precision highp float;
#endif

uniform sampler2D bitmapTexture;

in vec2 vTexCoord;
in vec2 vTexPos;

out vec4 fragColor;

/* projection utils */
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / PI / 2.0;

// from degrees to Web Mercator
vec2 lnglat_to_mercator(vec2 lnglat) {
  float x = lnglat.x;
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// from Web Mercator to degrees
vec2 mercator_to_lnglat(vec2 xy) {
  xy /= WORLD_SCALE;
  return degrees(vec2(
    xy.x - PI,
    atan(exp(xy.y - PI)) * 2.0 - PI * 0.5
  ));
}
/* End projection utils */

// apply desaturation
vec3 color_desaturate(vec3 color) {
  float luminance = (color.r + color.g + color.b) * 0.333333333;
  return mix(color, vec3(luminance), bitmap.desaturate);
}

// apply tint
vec3 color_tint(vec3 color) {
  return color * bitmap.tintColor;
}

// blend with background color
vec4 apply_opacity(vec3 color, float alpha) {
  if (bitmap.transparentColor.a == 0.0) {
    return vec4(color, alpha);
  }
  float blendedAlpha = alpha + bitmap.transparentColor.a * (1.0 - alpha);
  float highLightRatio = alpha / blendedAlpha;
  vec3 blendedRGB = mix(bitmap.transparentColor.rgb, color, highLightRatio);
  return vec4(blendedRGB, blendedAlpha);
}

vec2 getUV(vec2 pos) {
  return vec2(
    (pos.x - bitmap.bounds[0]) / (bitmap.bounds[2] - bitmap.bounds[0]),
    (pos.y - bitmap.bounds[3]) / (bitmap.bounds[1] - bitmap.bounds[3])
  );
}

${dM}

void main(void) {
  vec2 uv = vTexCoord;
  if (bitmap.coordinateConversion < -0.5) {
    vec2 lnglat = mercator_to_lnglat(vTexPos);
    uv = getUV(lnglat);
  } else if (bitmap.coordinateConversion > 0.5) {
    vec2 commonPos = lnglat_to_mercator(vTexPos);
    uv = getUV(commonPos);
  }
  vec4 bitmapColor = texture(bitmapTexture, uv);

  fragColor = apply_opacity(color_tint(color_desaturate(bitmapColor.rgb)), bitmapColor.a * layer.opacity);

  geometry.uv = uv;
  DECKGL_FILTER_COLOR(fragColor, geometry);

  if (bool(picking.isActive) && !bool(picking.isAttribute)) {
    // Since instance information is not used, we can use picking color for pixel index
    fragColor.rgb = packUVsIntoRGB(uv);
  }
}
`,dI={image:{type:"image",value:null,async:!0},bounds:{type:"array",value:[1,0,0,1],compare:!0},_imageCoordinateSystem:iX.DEFAULT,desaturate:{type:"number",min:0,max:1,value:0},transparentColor:{type:"color",value:[0,0,0,0]},tintColor:{type:"color",value:[255,255,255]},textureParameters:{type:"object",ignore:!0,value:null}};class dE extends dr{getShaders(){return super.getShaders({vs:dC,fs:dA,modules:[rc,np,dT]})}initializeState(){let e=this.getAttributeManager();e.remove(["instancePickingColors"]),e.add({indices:{size:1,isIndexed:!0,update:e=>e.value=this.state.mesh.indices,noAlloc:!0},positions:{size:3,type:"float64",fp64:this.use64bitPositions(),update:e=>e.value=this.state.mesh.positions,noAlloc:!0},texCoords:{size:2,update:e=>e.value=this.state.mesh.texCoords,noAlloc:!0}})}updateState({props:e,oldProps:t,changeFlags:i}){let r=this.getAttributeManager();if(i.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),r.invalidateAll()),e.bounds!==t.bounds){let e=this.state.mesh,t=this._createMesh();for(let i in this.state.model.setVertexCount(t.vertexCount),t)e&&e[i]!==t[i]&&r.invalidate(i);this.setState({mesh:t,...this._getCoordinateUniforms()})}else e._imageCoordinateSystem!==t._imageCoordinateSystem&&this.setState(this._getCoordinateUniforms())}getPickingInfo(e){let{image:t}=this.props,i=e.info;if(!i.color||!t)return i.bitmap=null,i;let{width:r,height:s}=t;i.index=0;let n=function(e){let[t,i,r]=e;return[(t+(15&r)/16)/256,(i+(240&r)/256)/256]}(i.color);return i.bitmap={size:{width:r,height:s},uv:n,pixel:[Math.floor(n[0]*r),Math.floor(n[1]*s)]},i}disablePickingIndex(){this.setState({disablePicking:!0})}restorePickingColors(){this.setState({disablePicking:!1})}_updateAutoHighlight(e){super._updateAutoHighlight({...e,color:this.encodePickingColor(0)})}_createMesh(){let{bounds:e}=this.props,t=e;return dL(e)&&(t=[[e[0],e[1]],[e[0],e[3]],[e[2],e[3]],[e[2],e[1]]]),function(e,t){if(!t){var i,r,s,n=e;let t=new Float64Array(12);for(let e=0;e<n.length;e++)t[3*e+0]=n[e][0],t[3*e+1]=n[e][1],t[3*e+2]=n[e][2]||0;return{vertexCount:6,positions:t,indices:dk,texCoords:dP}}let a=Math.max(Math.abs(e[0][0]-e[3][0]),Math.abs(e[1][0]-e[2][0])),o=Math.max(Math.abs(e[1][1]-e[0][1]),Math.abs(e[2][1]-e[3][1])),l=Math.ceil(a/t)+1,c=Math.ceil(o/t)+1,u=(l-1)*(c-1)*6,h=new Uint32Array(u),d=new Float32Array(l*c*2),f=new Float64Array(l*c*3),p=0,g=0;for(let t=0;t<l;t++){let n=t/(l-1);for(let a=0;a<c;a++){let o=a/(c-1),l=(i=e,r=n,s=o,rf(rf(i[0],i[1],s),rf(i[3],i[2],s),r));f[3*p+0]=l[0],f[3*p+1]=l[1],f[3*p+2]=l[2]||0,d[2*p+0]=n,d[2*p+1]=1-o,t>0&&a>0&&(h[g++]=p-c,h[g++]=p-c-1,h[g++]=p-1,h[g++]=p-c,h[g++]=p-1,h[g++]=p),p++}}return{vertexCount:u,positions:f,indices:h,texCoords:d}}(t,this.context.viewport.resolution)}_getModel(){return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),topology:"triangle-list",isInstanced:!1})}draw(e){let{shaderModuleProps:t}=e,{model:i,coordinateConversion:r,bounds:s,disablePicking:n}=this.state,{image:a,desaturate:o,transparentColor:l,tintColor:c}=this.props;if((!t.picking.isActive||!n)&&a&&i){let e={bitmapTexture:a,bounds:s,coordinateConversion:r,desaturate:o,tintColor:c.slice(0,3).map(e=>e/255),transparentColor:l.map(e=>e/255)};i.shaderInputs.setProps({bitmap:e}),i.draw(this.context.renderPass)}}_getCoordinateUniforms(){let{LNGLAT:e,CARTESIAN:t,DEFAULT:i}=iX,{_imageCoordinateSystem:r}=this.props;if(r!==i){let{bounds:i}=this.props;if(!dL(i))throw Error("_imageCoordinateSystem only supports rectangular bounds");let s=this.context.viewport.resolution?e:t;if((r=r===e?e:t)===e&&s===t)return{coordinateConversion:-1,bounds:i};if(r===t&&s===e){let e=s2([i[0],i[1]]),t=s2([i[2],i[3]]);return{coordinateConversion:1,bounds:[e[0],e[1],t[0],t[1]]}}}return{coordinateConversion:0,bounds:[0,0,0,0]}}}function dL(e){return Number.isFinite(e[0])}dE.layerName="BitmapLayer",dE.defaultProps=dI;class dO extends dr{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if("function"==typeof e){let t={index:-1,data:this.props.data,target:[]};return(i,r)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,r)}return e}getSubLayerProps(e={}){let{opacity:t,pickable:i,visible:r,parameters:s,getPolygonOffset:n,highlightedObjectIndex:a,autoHighlight:o,highlightColor:l,coordinateSystem:c,coordinateOrigin:u,wrapLongitude:h,positionFormat:d,modelMatrix:f,extensions:p,fetch:g,operation:m,_subLayerProps:y}=this.props,v={id:"",updateTriggers:{},opacity:t,pickable:i,visible:r,parameters:s,getPolygonOffset:n,highlightedObjectIndex:a,autoHighlight:o,highlightColor:l,coordinateSystem:c,coordinateOrigin:u,wrapLongitude:h,positionFormat:d,modelMatrix:f,extensions:p,fetch:g,operation:m},x=y&&e.id&&y[e.id],_=x&&x.updateTriggers,b=e.id||"sublayer";if(x){let t=this.props[nx],i=e.type?e.type._propTypes:{};for(let e in x){let r=i[e]||t[e];r&&"accessor"===r.type&&(x[e]=this.getSubLayerAccessor(x[e]))}}for(let t of(Object.assign(v,e,x),v.id=`${this.props.id}-${b}`,v.updateTriggers={all:this.props.updateTriggers?.all,...e.updateTriggers,..._},p)){let e=t.getSubLayerProps.call(this,t);e&&Object.assign(v,e,{updateTriggers:Object.assign(v.updateTriggers,e.updateTriggers)})}return v}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers,r=!i||this.needsUpdate();for(let e of(r&&(i=nM(this.renderLayers(),Boolean),this.internalState.subLayers=i),nC("compositeLayer.renderLayers",this,r,i),i))e.parent=this}}dO.layerName="CompositeLayer";let dR=dO,dN=`\
uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeBasis;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,dj={name:"icon",vs:dN,fs:dN,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeBasis:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},dD=`\
#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
icon.sizeMinPixels, icon.sizeMaxPixels
);
float iconConstraint = icon.sizeBasis == 0.0 ? iconSize.x : iconSize.y;
float instanceScale = iconConstraint == 0.0 ? 0.0 : sizePixels / iconConstraint;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (icon.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / icon.iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,dz=`\
#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * layer.opacity * vColor.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,dF=()=>{},dB={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},dU={x:0,y:0,width:0,height:0};function d$(e){return e&&(e.id||e.url)}function dV(e,t,i){for(let r=0;r<t.length;r++){let{icon:s,xOffset:n}=t[r];e[d$(s)]={...s,x:n,y:i}}}class dW{constructor(e,{onUpdate:t=dF,onError:i=dF}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=4,this._canvasWidth=1024,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=t,this.onError=i}finalize(){this._texture?.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?d$(e):e;return this._mapping[t]||dU}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:r,textureParameters:s}){e&&(this._loadOptions=e),void 0!==t&&(this._autoPacking=t),r&&(this._mapping=r),i&&(this._texture?.delete(),this._texture=null,this._externalTexture=i),s&&(this._samplerParameters=s)}get isLoaded(){return 0===this._pendingCount}packIcons(e,t){if(!this._autoPacking||"undefined"==typeof document)return;let i=Object.values(function(e,t,i){if(!e||!t)return null;i=i||{};let r={},{iterable:s,objectInfo:n}=lJ(e);for(let e of s){n.index++;let s=t(e,n),a=d$(s);if(!s)throw Error("Icon is missing.");if(!s.url)throw Error("Icon url is missing.");r[a]||i[a]&&s.url===i[a].url||(r[a]={...s,source:e,sourceIndex:n.index})}return r}(e,t,this._mapping)||{});if(i.length>0){let{mapping:e,xOffset:t,yOffset:r,rowHeight:s,canvasHeight:n}=function({icons:e,buffer:t,mapping:i={},xOffset:r=0,yOffset:s=0,rowHeight:n=0,canvasWidth:a}){let o=[];for(let l=0;l<e.length;l++){let c=e[l];if(!i[d$(c)]){let{height:e,width:l}=c;r+l+t>a&&(dV(i,o,s),r=0,s=n+s+t,n=0,o=[]),o.push({icon:c,xOffset:r}),r=r+l+t,n=Math.max(n,e)}}return o.length>0&&dV(i,o,s),{mapping:i,rowHeight:n,xOffset:r,yOffset:s,canvasWidth:a,canvasHeight:Math.pow(2,Math.ceil(Math.log2(n+s+t)))}}({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=s,this._mapping=e,this._xOffset=t,this._yOffset=r,this._canvasHeight=n,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",data:null,width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||dB,mipLevels:this.device.getMipLevelCount(this._canvasWidth,this._canvasHeight)})),this._texture.height!==this._canvasHeight&&(this._texture=function(e,t,i,r){let{width:s,height:n,device:a}=e,o=a.createTexture({format:"rgba8unorm",width:t,height:i,sampler:r,mipLevels:a.getMipLevelCount(t,i)}),l=a.createCommandEncoder();return l.copyTextureToTexture({sourceTexture:e,destinationTexture:o,width:s,height:n}),l.finish(),o.generateMipmapsWebGL(),e.destroy(),o}(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||dB)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i),this._texture?.generateMipmapsWebGL()}}_loadIcons(e){let t=this._canvas.getContext("2d",{willReadFrequently:!0});for(let i of e)this._pendingCount++,aZ(i.url,this._loadOptions).then(e=>{let r=d$(i),s=this._mapping[r],{x:n,y:a,width:o,height:l}=s,{image:c,width:u,height:h}=function(e,t,i,r){let s=Math.min(i/t.width,r/t.height),n=Math.floor(t.width*s),a=Math.floor(t.height*s);return 1===s?{image:t,width:n,height:a}:(e.canvas.height=a,e.canvas.width=n,e.clearRect(0,0,n,a),e.drawImage(t,0,0,t.width,t.height,0,0,n,a),{image:e.canvas,width:n,height:a})}(t,e,o,l);this._texture?.copyExternalImage({image:c,x:n+(o-u)/2,y:a+(l-h)/2,width:u,height:h}),s.width=u,s.height=h,this._texture?.generateMipmapsWebGL(),this.onUpdate()}).catch(e=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:e})}).finally(()=>{this._pendingCount--})}}let dG=[0,0,0,255],dq={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeBasis:"height",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:e=>e.position},getIcon:{type:"accessor",value:e=>e.icon},getColor:{type:"accessor",value:dG},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class dH extends dr{getShaders(){return super.getShaders({vs:dD,fs:dz,modules:[rc,np,dj]})}initializeState(){this.state={iconManager:new dW(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:dG},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);let{props:t,oldProps:i,changeFlags:r}=e,s=this.getAttributeManager(),{iconAtlas:n,iconMapping:a,data:o,getIcon:l,textureParameters:c}=t,{iconManager:u}=this.state;if("string"==typeof n)return;let h=n||this.internalState.isAsyncPropLoading("iconAtlas");u.setProps({loadOptions:t.loadOptions,autoPacking:!h,iconAtlas:n,iconMapping:h?a:null,textureParameters:c}),h?i.iconMapping!==t.iconMapping&&s.invalidate("getIcon"):(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getIcon))&&u.packIcons(o,l),r.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),s.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeBasis:i,sizeMinPixels:r,sizeMaxPixels:s,sizeUnits:n,billboard:a,alphaCutoff:o}=this.props,{iconManager:l}=this.state,c=l.getTexture();if(c){let e=this.state.model,l={iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:iJ[n],sizeScale:t,sizeBasis:+("height"===i),sizeMinPixels:r,sizeMaxPixels:s,billboard:a,alphaCutoff:o};e.shaderInputs.setProps({icon:l}),e.draw(this.context.renderPass)}}_getModel(){return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new dh({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([-1,-1,1,-1,-1,1,1,1])}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){let t=this.getCurrentLayer()?.props.onIconError;t?t(e):is.error(e.error.message)()}getInstanceOffset(e){let{width:t,height:i,anchorX:r=t/2,anchorY:s=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-r,i/2-s]}getInstanceColorMode(e){return+!!this.state.iconManager.getIconMapping(e).mask}getInstanceIconFrame(e){let{x:t,y:i,width:r,height:s}=this.state.iconManager.getIconMapping(e);return[t,i,r,s]}}dH.defaultProps=dq,dH.layerName="IconLayer";let dZ=dH,dY=`\
uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,dX={name:"sdf",vs:dY,fs:dY,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},dK=`\
#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf.enabled) {
float distance = alpha;
alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);
if (sdf.outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
color = mix(sdf.outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * layer.opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,dJ=[];class dQ extends dZ{getShaders(){let e=super.getShaders();return{...e,modules:[...e.modules,dX],fs:dK}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(e,{index:t,target:i})=>this.encodePickingColor(t,i)}})}updateState(e){super.updateState(e);let{props:t,oldProps:i}=e,{outlineColor:r}=t;r!==i.outlineColor&&((r=r.map(e=>e/255))[3]=Number.isFinite(r[3])?r[3]:1,this.setState({outlineColor:r})),!t.sdf&&t.outlineWidth&&is.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){let{sdf:t,smoothing:i,outlineWidth:r}=this.props,{outlineColor:s}=this.state,n=r?Math.max(i,.75*(1-r)):-1,a=this.state.model,o={buffer:.75,outlineBuffer:n,gamma:i,enabled:!!t,outlineColor:s};if(a.shaderInputs.setProps({sdf:o}),super.draw(e),t&&r){let{iconManager:e}=this.state;e.getTexture()&&(a.shaderInputs.setProps({sdf:{...o,outlineBuffer:.75}}),a.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(e=>super.getInstanceOffset(e)):dJ}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(e=>super.getInstanceIconFrame(e)):dJ}}dQ.defaultProps={getIconOffsets:{type:"accessor",value:e=>e.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},dQ.layerName="MultiIconLayer";class d0{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:r=.25,fontFamily:s="sans-serif",fontWeight:n="normal",fontStyle:a="normal",lang:o=null}={}){this.buffer=t,this.cutoff=r,this.radius=i,this.lang=o;const l=this.size=e+4*t,c=this._createCanvas(l),u=this.ctx=c.getContext("2d",{willReadFrequently:!0});u.font=`${a} ${n} ${e}px ${s}`,u.textBaseline="alphabetic",u.textAlign="left",u.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l)}_createCanvas(e){let t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){let{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:r,actualBoundingBoxLeft:s,actualBoundingBoxRight:n}=this.ctx.measureText(e),a=Math.ceil(i),o=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(n-s))),l=Math.min(this.size-this.buffer,a+Math.ceil(r)),c=o+2*this.buffer,u=l+2*this.buffer,h=Math.max(c*u,0),d=new Uint8ClampedArray(h),f={data:d,width:c,height:u,glyphWidth:o,glyphHeight:l,glyphTop:a,glyphLeft:0,glyphAdvance:t};if(0===o||0===l)return f;let{ctx:p,buffer:g,gridInner:m,gridOuter:y}=this;this.lang&&(p.lang=this.lang),p.clearRect(g,g,o,l),p.fillText(e,g,g+a);let v=p.getImageData(g,g,o,l);y.fill(1e20,0,h),m.fill(0,0,h);for(let e=0;e<l;e++)for(let t=0;t<o;t++){let i=v.data[4*(e*o+t)+3]/255;if(0===i)continue;let r=(e+g)*c+t+g;if(1===i)y[r]=0,m[r]=1e20;else{let e=.5-i;y[r]=e>0?e*e:0,m[r]=e<0?e*e:0}}d1(y,0,0,c,u,c,this.f,this.v,this.z),d1(m,g,g,o,l,c,this.f,this.v,this.z);for(let e=0;e<h;e++){let t=Math.sqrt(y[e])-Math.sqrt(m[e]);d[e]=Math.round(255-255*(t/this.radius+this.cutoff))}return f}}function d1(e,t,i,r,s,n,a,o,l){for(let c=t;c<t+r;c++)d2(e,i*n+c,n,s,a,o,l);for(let c=i;c<i+s;c++)d2(e,c*n+t,1,r,a,o,l)}function d2(e,t,i,r,s,n,a){n[0]=0,a[0]=-1e20,a[1]=1e20,s[0]=e[t];for(let o=1,l=0,c=0;o<r;o++){s[o]=e[t+o*i];let r=o*o;do{let e=n[l];c=(s[o]-s[e]+r-e*e)/(o-e)/2}while(c<=a[l]&&--l>-1)n[++l]=o,a[l]=c,a[l+1]=1e20}for(let o=0,l=0;o<r;o++){for(;a[l+1]<o;)l++;let r=n[l],c=o-r;e[t+o*i]=s[r]+c*c}}let d3=[];function d4(e,t,i,r){let s=0;for(let n=t;n<i;n++){let t=e[n];s+=r[t]?.layoutWidth||0}return s}function d6(e,t,i,r,s,n){let a=t,o=0;for(let l=t;l<i;l++){let t=d4(e,l,l+1,s);o+t>r&&(a<l&&n.push(l),a=l,o=0),o+=t}return o}class d5{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?this.delete(e):Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e)}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){let t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}let d8={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:function(){let e=[];for(let t=32;t<128;t++)e.push(String.fromCharCode(t));return e}(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},d7=new d5(3);function d9(e,t,i,r){e.font=`${r} ${i}px ${t}`,e.fillStyle="#000",e.textBaseline="alphabetic",e.textAlign="left"}class fe{constructor(){this.props={...d8}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){let{fontSize:e,buffer:t}=this.props;return(1.2*e+2*t)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();let t=function(e,t){let i;i=new Set("string"==typeof t?Array.from(t):t);let r=d7.get(e);if(!r)return i;for(let e in r.mapping)i.has(e)&&i.delete(e);return i}(this._key,this.props.characterSet),i=d7.get(this._key);if(i&&0===t.size){this._atlas!==i&&(this._atlas=i);return}let r=this._generateFontAtlas(t,i);this._atlas=r,d7.set(this._key,r)}_generateFontAtlas(e,t){let{fontFamily:i,fontWeight:r,fontSize:s,buffer:n,sdf:a,radius:o,cutoff:l}=this.props,c=t&&t.data;c||((c=document.createElement("canvas")).width=1024);let u=c.getContext("2d",{willReadFrequently:!0});d9(u,i,s,r);let{mapping:h,canvasHeight:d,xOffset:f,yOffset:p}=function({characterSet:e,getFontWidth:t,fontHeight:i,buffer:r,maxCanvasWidth:s,mapping:n={},xOffset:a=0,yOffset:o=0}){let l=0,c=a,u=i+2*r;for(let a of e)if(!n[a]){let e=t(a);c+e+2*r>s&&(c=0,l++),n[a]={x:c+r,y:o+l*u+r,width:e,height:u,layoutWidth:e,layoutHeight:i},c+=e+2*r}return{mapping:n,xOffset:c,yOffset:o+l*u,canvasHeight:Math.pow(2,Math.ceil(Math.log2(o+(l+1)*u)))}}({getFontWidth:e=>u.measureText(e).width,fontHeight:1.2*s,buffer:n,characterSet:e,maxCanvasWidth:1024,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(c.height!==d){let e=u.getImageData(0,0,c.width,c.height);c.height=d,u.putImageData(e,0,0)}if(d9(u,i,s,r),a){let t=new d0({fontSize:s,buffer:n,radius:o,cutoff:l,fontFamily:i,fontWeight:`${r}`});for(let i of e){let{data:e,width:r,height:n,glyphTop:a}=t.draw(i);h[i].width=r,h[i].layoutOffsetY=.9*s-a;let o=u.createImageData(r,n);for(let t=0;t<e.length;t++)o.data[4*t+3]=e[t];u.putImageData(o,h[i].x,h[i].y)}}else for(let t of e)u.fillText(t,h[t].x,h[t].y+n+.9*s);return{xOffset:f,yOffset:p,mapping:h,data:c,width:c.width,height:c.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:i,buffer:r,sdf:s,radius:n,cutoff:a}=this.props;return s?`${e} ${t} ${i} ${r} ${n} ${a}`:`${e} ${t} ${i} ${r}`}}let ft=`\
uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 borderRadius;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,fi={name:"textBackground",vs:ft,fs:ft,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",borderRadius:"vec4<f32>",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},fr=`\
#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
textBackground.sizeMinPixels, textBackground.sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (textBackground.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,fs=`\
#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
float round_rect(vec2 p, vec2 size, vec4 radii) {
vec2 pixelPositionCB = (p - 0.5) * size;
vec2 sizeCB = size * 0.5;
float maxBorderRadius = min(size.x, size.y) * 0.5;
vec4 borderRadius = vec4(min(radii, maxBorderRadius));
borderRadius.xy =
(pixelPositionCB.x > 0.0) ? borderRadius.xy : borderRadius.zw;
borderRadius.x = (pixelPositionCB.y > 0.0) ? borderRadius.x : borderRadius.y;
vec2 q = abs(pixelPositionCB) - sizeCB + borderRadius.x;
return -(min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - borderRadius.x);
}
float rect(vec2 p, vec2 size) {
vec2 pixelPosition = p * size;
return min(min(pixelPosition.x, size.x - pixelPosition.x),
min(pixelPosition.y, size.y - pixelPosition.y));
}
vec4 get_stroked_fragColor(float dist) {
float isBorder = smoothedge(dist, vLineWidth);
return mix(vFillColor, vLineColor, isBorder);
}
void main(void) {
geometry.uv = uv;
if (textBackground.borderRadius != vec4(0.0)) {
float distToEdge = round_rect(uv, dimensions, textBackground.borderRadius);
if (textBackground.stroked) {
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
float shapeAlpha = smoothedge(-distToEdge, 0.0);
fragColor.a *= shapeAlpha;
} else {
if (textBackground.stroked) {
float distToEdge = rect(uv, dimensions);
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,fn={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,borderRadius:{type:"object",value:0},padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:e=>e.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class fa extends dr{getShaders(){return super.getShaders({vs:fr,fs:fs,modules:[rc,np,fi]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);let{changeFlags:t}=e;t.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){let{billboard:t,sizeScale:i,sizeUnits:r,sizeMinPixels:s,sizeMaxPixels:n,getLineWidth:a}=this.props,{padding:o,borderRadius:l}=this.props;o.length<4&&(o=[o[0],o[1],o[0],o[1]]),Array.isArray(l)||(l=[l,l,l,l]);let c=this.state.model,u={billboard:t,stroked:!!a,borderRadius:l,padding:o,sizeUnits:iJ[r],sizeScale:i,sizeMinPixels:s,sizeMaxPixels:n};c.shaderInputs.setProps({textBackground:u}),c.draw(this.context.renderPass)}_getModel(){return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new dh({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array([0,0,1,0,0,1,1,1])}}}),isInstanced:!0})}}fa.defaultProps=fn,fa.layerName="TextBackgroundLayer";let fo={start:1,middle:0,end:-1},fl={top:1,center:0,bottom:-1},fc=[0,0,0,255],fu={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:fc},getBorderWidth:{type:"accessor",value:0},backgroundBorderRadius:{type:"object",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:d8.characterSet},fontFamily:d8.fontFamily,fontWeight:d8.fontWeight,lineHeight:1,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:fc},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:e=>e.text},getPosition:{type:"accessor",value:e=>e.position},getColor:{type:"accessor",value:fc},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class fh extends dR{constructor(){super(...arguments),this.getBoundingRect=(e,t)=>{let{size:[i,r]}=this.transformParagraph(e,t),{fontSize:s}=this.state.fontAtlasManager.props;i/=s,r/=s;let{getTextAnchor:n,getAlignmentBaseline:a}=this.props;return[(fo["function"==typeof n?n(e,t):n]-1)*i/2,(fl["function"==typeof a?a(e,t):a]-1)*r/2,i,r]},this.getIconOffsets=(e,t)=>{let{getTextAnchor:i,getAlignmentBaseline:r}=this.props,{x:s,y:n,rowWidth:a,size:[o,l]}=this.transformParagraph(e,t),c=fo["function"==typeof i?i(e,t):i],u=fl["function"==typeof r?r(e,t):r],h=s.length,d=Array(2*h),f=0;for(let e=0;e<h;e++){let t=(1-c)*(o-a[e])/2;d[f++]=(c-1)*o/2+t+s[e],d[f++]=(u-1)*l/2+n[e]}return d}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new fe},this.props.maxWidth>0&&is.once(1,"v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){let{props:t,oldProps:i,changeFlags:r}=e;(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){let{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:r,characterSet:s}=this.state,n={...e,characterSet:s,fontFamily:t,fontWeight:i};if(!r.mapping)return r.setProps(n),!0;for(let e in n)if(n[e]!==r.props[e])return r.setProps(n),!0;return!1}_updateText(){let e,{data:t,characterSet:i}=this.props,r=t.attributes?.getText,{getText:s}=this.props,n=t.startIndices,a="auto"===i&&new Set;if(r&&n){let{texts:i,characterCount:o}=function({value:e,length:t,stride:i,offset:r,startIndices:s,characterSet:n}){let a=e.BYTES_PER_ELEMENT,o=i?i/a:1,l=r?r/a:0,c=s[t]||Math.ceil((e.length-l)/o),u=n&&new Set,h=Array(t),d=e;if(o>1||l>0){d=new e.constructor(c);for(let t=0;t<c;t++)d[t]=e[t*o+l]}for(let e=0;e<t;e++){let t=s[e],i=s[e+1]||c,r=d.subarray(t,i);h[e]=String.fromCodePoint.apply(null,r),u&&r.forEach(u.add,u)}if(u)for(let e of u)n.add(String.fromCodePoint(e));return{texts:h,characterCount:c}}({...ArrayBuffer.isView(r)?{value:r}:r,length:t.length,startIndices:n,characterSet:a});e=o,s=(e,{index:t})=>i[t]}else{let{iterable:i,objectInfo:r}=lJ(t);for(let t of(n=[0],e=0,i)){r.index++;let i=Array.from(s(t,r)||"");a&&i.forEach(a.add,a),e+=i.length,n.push(e)}}this.setState({getText:s,startIndices:n,numInstances:e,characterSet:a||i})}transformParagraph(e,t){let{fontAtlasManager:i}=this.state,r=i.mapping,s=this.state.getText,{wordBreak:n,lineHeight:a,maxWidth:o}=this.props;return function(e,t,i,r,s){let n=Array.from(e),a=n.length,o=Array(a),l=Array(a),c=Array(a),u=("break-word"===i||"break-all"===i)&&isFinite(r)&&r>0,h=[0,0],d=[0,0],f=0,p=0,g=0;for(let e=0;e<=a;e++){let m=n[e];if(("\n"===m||e===a)&&(g=e),g>p){let e=u?function(e,t,i,r,s=0,n){void 0===n&&(n=e.length);let a=[];return"break-all"===t?d6(e,s,n,i,r,a):!function(e,t,i,r,s,n){let a=t,o=t,l=t,c=0;for(let u=t;u<i;u++)if(" "===e[u]?l=u+1:(" "===e[u+1]||u+1===i)&&(l=u+1),l>o){let t=d4(e,o,l,s);c+t>r&&(a<o&&(n.push(o),a=o,c=0),t>r&&(t=d6(e,o,l,r,s,n),a=n[n.length-1])),o=l,c+=t}}(e,s,n,i,r,a),a}(n,i,r,s,p,g):d3;for(let i=0;i<=e.length;i++){let r=0===i?p:e[i-1],a=i<e.length?e[i]:g;!function(e,t,i,r,s,n){let a=0,o=0;for(let n=t;n<i;n++){let t=e[n],i=r[t];i?(o||(o=i.layoutHeight),s[n]=a+i.layoutWidth/2,a+=i.layoutWidth):(is.warn(`Missing character: ${t} (${t.codePointAt(0)})`)(),s[n]=a,a+=32)}n[0]=a,n[1]=o}(n,r,a,s,o,d);for(let e=r;e<a;e++){let t=n[e],i=s[t]?.layoutOffsetY||0;l[e]=f+d[1]/2+i,c[e]=d[0]}f+=d[1]*t,h[0]=Math.max(h[0],d[0])}p=g}"\n"===m&&(o[p]=0,l[p]=0,c[p]=0,p++)}return h[1]=f,{x:o,y:l,rowWidth:c,size:h}}(s(e,t)||"",a,n,o*i.props.fontSize,r)}renderLayers(){let{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:r,atlas:s,mapping:n},styleVersion:a}=this.state,{data:o,_dataDiff:l,getPosition:c,getColor:u,getSize:h,getAngle:d,getPixelOffset:f,getBackgroundColor:p,getBorderColor:g,getBorderWidth:m,backgroundBorderRadius:y,backgroundPadding:v,background:x,billboard:_,fontSettings:b,outlineWidth:w,outlineColor:k,sizeScale:P,sizeUnits:S,sizeMinPixels:T,sizeMaxPixels:C,transitions:M,updateTriggers:A}=this.props,I=this.getSubLayerClass("characters",dQ),E=this.getSubLayerClass("background",fa);return[x&&new E({getFillColor:p,getLineColor:g,getLineWidth:m,borderRadius:y,padding:v,getPosition:c,getSize:h,getAngle:d,getPixelOffset:f,billboard:_,sizeScale:P,sizeUnits:S,sizeMinPixels:T,sizeMaxPixels:C,transitions:M&&{getPosition:M.getPosition,getAngle:M.getAngle,getSize:M.getSize,getFillColor:M.getBackgroundColor,getLineColor:M.getBorderColor,getLineWidth:M.getBorderWidth,getPixelOffset:M.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:A.getPosition,getAngle:A.getAngle,getSize:A.getSize,getFillColor:A.getBackgroundColor,getLineColor:A.getBorderColor,getLineWidth:A.getBorderWidth,getPixelOffset:A.getPixelOffset,getBoundingRect:{getText:A.getText,getTextAnchor:A.getTextAnchor,getAlignmentBaseline:A.getAlignmentBaseline,styleVersion:a}}}),{data:o.attributes&&o.attributes.background?{length:o.length,attributes:o.attributes.background}:o,_dataDiff:l,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new I({sdf:b.sdf,smoothing:Number.isFinite(b.smoothing)?b.smoothing:d8.smoothing,outlineWidth:w/(b.radius||d8.radius),outlineColor:k,iconAtlas:s,iconMapping:n,getPosition:c,getColor:u,getSize:h,getAngle:d,getPixelOffset:f,billboard:_,sizeScale:P*r,sizeUnits:S,sizeMinPixels:T*r,sizeMaxPixels:C*r,transitions:M&&{getPosition:M.getPosition,getAngle:M.getAngle,getColor:M.getColor,getSize:M.getSize,getPixelOffset:M.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:A.getText,getPosition:A.getPosition,getAngle:A.getAngle,getColor:A.getColor,getSize:A.getSize,getPixelOffset:A.getPixelOffset,getIconOffsets:{getTextAnchor:A.getTextAnchor,getAlignmentBaseline:A.getAlignmentBaseline,styleVersion:a}}}),{data:o,_dataDiff:l,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){is.assert(Number.isFinite(e)&&e>=3,"Invalid cache limit"),d7=new d5(e)}}fh.defaultProps=fu,fh.layerName="TextLayer";class fd{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:t={}}=e;this.typedArrayManager=aK,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);let{data:t,buffers:i={},getGeometry:r,geometryBuffer:s,positionFormat:n,dataChanged:a,normalize:o=!0}=this.opts;if(this.data=t,this.getGeometry=r,this.positionSize=s&&s.size||("XY"===n?2:3),this.buffers=i,this.normalize=o,s&&(oh(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(s),o||(i.vertexPositions=s)),this.geometryBuffer=i.vertexPositions,Array.isArray(a))for(let e of a)this._rebuildGeometry(e);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){let t=e.value||e;return ArrayBuffer.isView(t)?l0(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){let{attributes:i,buffers:r,_attributeDefs:s,typedArrayManager:n}=this;for(let a in s)if(a in r)n.release(i[a]),i[a]=null;else{let r=s[a];r.copy=t,i[a]=n.allocate(i[a],e,r)}}_forEachGeometry(e,t,i){let{data:r,getGeometry:s}=this,{iterable:n,objectInfo:a}=lJ(r,t,i);for(let t of n)a.index++,e(s?s(t,a):null,a.index)}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:i,instanceCount:r}=this,{data:s,geometryBuffer:n}=this,{startRow:a=0,endRow:o=1/0}=e||{},l={};if(e||(t=[0],i=[0]),this.normalize||!n)this._forEachGeometry((e,t)=>{let r=e&&this.normalizeGeometry(e);l[t]=r,i[t+1]=i[t]+(r?this.getGeometrySize(r):0)},a,o),r=i[i.length-1];else if(r=(i=s.startIndices)[s.length]||0,ArrayBuffer.isView(n))r=r||n.length/this.positionSize;else if(n instanceof l$.Buffer){let e=4*this.positionSize;r=r||n.byteLength/e}else if(n.buffer){let e=n.stride||4*this.positionSize;r=r||n.buffer.byteLength/e}else if(n.value){let e=n.value,t=n.stride/e.BYTES_PER_ELEMENT||this.positionSize;r=r||e.length/t}this._allocate(r,!!e),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=r;let c={};this._forEachGeometry((e,s)=>{let n=l[s]||e;c.vertexStart=i[s],c.indexStart=t[s],c.geometrySize=(s<i.length-1?i[s+1]:r)-i[s],c.geometryIndex=s,this.updateGeometryAttributes(n,c)},a,o),this.vertexCount=t[t.length-1]}}function ff(e,t,i={}){return function(e,t={}){return Math.sign(function(e,t={}){let{start:i=0,end:r=e.length,plane:s="xy"}=t,n=t.size||2,a=0,o=fp[s[0]],l=fp[s[1]];for(let t=i,s=r-n;t<r;t+=n)a+=(e[t+o]-e[s+o])*(e[t+l]+e[s+l]),s=t;return a/2}(e,t))}(e,i)!==t&&(function(e,t){let{start:i=0,end:r=e.length,size:s=2}=t,n=(r-i)/s,a=Math.floor(n/2);for(let t=0;t<a;++t){let r=i+t*s,a=i+(n-1-t)*s;for(let t=0;t<s;++t){let i=e[r+t];e[r+t]=e[a+t],e[a+t]=i}}}(e,i),!0)}let fp={x:0,y:1,z:2};function fg(e,t){let i=t.length,r=e.length;if(r>0){let s=!0;for(let n=0;n<i;n++)if(e[r-i+n]!==t[n]){s=!1;break}if(s)return!1}for(let s=0;s<i;s++)e[r+s]=t[s];return!0}function fm(e,t){let i=t.length;for(let r=0;r<i;r++)e[r]=t[r]}function fy(e,t,i,r,s=[]){let n=r+t*i;for(let t=0;t<i;t++)s[t]=e[n+t];return s}function fv(e,t,i,r,s=[]){let n,a;if(8&i)n=(r[3]-e[1])/(t[1]-e[1]),a=3;else if(4&i)n=(r[1]-e[1])/(t[1]-e[1]),a=1;else if(2&i)n=(r[2]-e[0])/(t[0]-e[0]),a=2;else{if(!(1&i))return null;n=(r[0]-e[0])/(t[0]-e[0]),a=0}for(let i=0;i<e.length;i++)s[i]=(1&a)===i?r[a]:n*(t[i]-e[i])+e[i];return s}function fx(e,t){let i=0;return e[0]<t[0]?i|=1:e[0]>t[2]&&(i|=2),e[1]<t[1]?i|=4:e[1]>t[3]&&(i|=8),i}function f_(e,t){let i,r,{size:s=2,broken:n=!1,gridResolution:a=10,gridOffset:o=[0,0],startIndex:l=0,endIndex:c=e.length}=t||{},u=(c-l)/s,h=[],d=[h],f=fy(e,0,s,l),p=fk(f,a,o,[]),g=[];fg(h,f);for(let t=1;t<u;t++){for(r=fx(i=fy(e,t,s,l,i),p);r;){var m,y,v;fv(f,i,r,p,g);let e=fx(g,p);e&&(fv(f,g,e,p,g),r=e),fg(h,g),fm(f,g),m=p,y=a,8&(v=r)?(m[1]+=y,m[3]+=y):4&v?(m[1]-=y,m[3]-=y):2&v?(m[0]+=y,m[2]+=y):1&v&&(m[0]-=y,m[2]-=y),n&&h.length>s&&(h=[],d.push(h),fg(h,f)),r=fx(i,p)}fg(h,i),fm(f,i)}return n?d:d[0]}function fb(e,t=null,i){if(!e.length)return[];let{size:r=2,gridResolution:s=10,gridOffset:n=[0,0],edgeTypes:a=!1}=i||{},o=[],l=[{pos:e,types:a?Array(e.length/r).fill(1):null,holes:t||[]}],c=[[],[]],u=[];for(;l.length;){let{pos:e,types:t,holes:i}=l.shift();(function(e,t,i,r){let s=1/0,n=-1/0,a=1/0,o=-1/0;for(let r=0;r<i;r+=t){let t=e[r],i=e[r+1];s=t<s?t:s,n=t>n?t:n,a=i<a?i:a,o=i>o?i:o}r[0][0]=s,r[0][1]=a,r[1][0]=n,r[1][1]=o})(e,r,i[0]||e.length,c),u=fk(c[0],s,n,u);let h=fx(c[1],u);if(h){let s=fw(e,t,r,0,i[0]||e.length,u,h),n={pos:s[0].pos,types:s[0].types,holes:[]},o={pos:s[1].pos,types:s[1].types,holes:[]};l.push(n,o);for(let l=0;l<i.length;l++)(s=fw(e,t,r,i[l],i[l+1]||e.length,u,h))[0]&&(n.holes.push(n.pos.length),n.pos=fP(n.pos,s[0].pos),a&&(n.types=fP(n.types,s[0].types))),s[1]&&(o.holes.push(o.pos.length),o.pos=fP(o.pos,s[1].pos),a&&(o.types=fP(o.types,s[1].types)))}else{let r={positions:e};a&&(r.edgeTypes=t),i.length&&(r.holeIndices=i),o.push(r)}}return o}function fw(e,t,i,r,s,n,a){let o,l,c,u=(s-r)/i,h=[],d=[],f=[],p=[],g=[],m=fy(e,u-1,i,r),y=Math.sign(8&a?m[1]-n[3]:m[0]-n[2]),v=t&&t[u-1],x=0,_=0;for(let s=0;s<u;s++)o=fy(e,s,i,r,o),l=Math.sign(8&a?o[1]-n[3]:o[0]-n[2]),c=t&&t[r/i+s],l&&y&&y!==l&&(fv(m,o,a,n,g),fg(h,g)&&f.push(v),fg(d,g)&&p.push(v)),l<=0?(fg(h,o)&&f.push(c),x-=l):f.length&&(f[f.length-1]=0),l>=0?(fg(d,o)&&p.push(c),_+=l):p.length&&(p[p.length-1]=0),fm(m,o),y=l,v=c;return[x?{pos:h,types:t&&f}:null,_?{pos:d,types:t&&p}:null]}function fk(e,t,i,r){let s=Math.floor((e[0]-i[0])/t)*t+i[0],n=Math.floor((e[1]-i[1])/t)*t+i[1];return r[0]=s,r[1]=n,r[2]=s+t,r[3]=n+t,r}function fP(e,t){for(let i=0;i<t.length;i++)e.push(t[i]);return e}function fS(e,t,i,r){let s,n=e[0];for(let a=i;a<r;a+=t){let t=(s=e[a])-n;(t>180||t<-180)&&(s-=360*Math.round(t/360)),e[a]=n=s}}function fT(e,t){let i,r=e.length/t;for(let s=0;s<r&&((i=e[s*t])+180)%360==0;s++);let s=-(360*Math.round(i/360));if(0!==s)for(let i=0;i<r;i++)e[i*t]+=s}class fC extends fd{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?function(e,t,i,r){let s;if(Array.isArray(e[0])){s=Array(e.length*t);for(let i=0;i<e.length;i++)for(let r=0;r<t;r++)s[i*t+r]=e[i][r]||0}else s=e;return i?f_(s,{size:t,gridResolution:i}):r?function(e,t){let{size:i=2,startIndex:r=0,endIndex:s=e.length,normalize:n=!0}=t||{},a=e.slice(r,s);fS(a,i,0,s-r);let o=f_(a,{size:i,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(n)for(let e of o)fT(e,i);return o}(s,{size:t}):s}(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(fM(e)){let t=0;for(let i of e)t+=this.getGeometrySize(i);return t}let t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(0!==t.geometrySize)if(e&&fM(e))for(let i of e){let e=this.getGeometrySize(i);t.geometrySize=e,this.updateGeometryAttributes(i,t),t.vertexStart+=e}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){let i=this.attributes.segmentTypes,r=!!e&&this.isClosed(e),{vertexStart:s,geometrySize:n}=t;i.fill(0,s,s+n),r?(i[s]=4,i[s+n-2]=4):(i[s]+=1,i[s+n-2]+=2),i[s+n-1]=4}_updatePositions(e,t){let{positions:i}=this.attributes;if(!i||!e)return;let{vertexStart:r,geometrySize:s}=t,n=[,,,];for(let t=r,a=0;a<s;t++,a++)this.getPointOnPath(e,a,n),i[3*t]=n[0],i[3*t+1]=n[1],i[3*t+2]=n[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){let{positionSize:r}=this;t*r>=e.length&&(t+=1-e.length/r);let s=t*r;return i[0]=e[s],i[1]=e[s+1],i[2]=3===r&&e[s+2]||0,i}isClosed(e){if(!this.normalize)return!!this.opts.loop;let{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(2===t||e[2]===e[i+2])}}function fM(e){return Array.isArray(e[0])}let fA=`\
uniform pathUniforms {
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  float jointType;
  float capType;
  float miterLimit;
  bool billboard;
  highp int widthUnits;
} path;
`,fI={name:"path",vs:fA,fs:fA,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},fE=`\
#version 300 es
#define SHADER_NAME path-layer-vertex-shader
in vec2 positions;
in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;
uniform float opacity;
out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;
const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);
float flipIfTrue(bool flag) {
return -(float(flag) * 2. - 1.);
}
vec3 getLineJoinOffset(
vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
vec2 width
) {
bool isEnd = positions.x > 0.0;
float sideOfPath = positions.y;
float isJoint = float(sideOfPath == 0.0);
vec3 deltaA3 = (currPoint - prevPoint);
vec3 deltaB3 = (nextPoint - currPoint);
mat3 rotationMatrix;
bool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);
if (needsRotation) {
deltaA3 = deltaA3 * rotationMatrix;
deltaB3 = deltaB3 * rotationMatrix;
}
vec2 deltaA = deltaA3.xy / width;
vec2 deltaB = deltaB3.xy / width;
float lenA = length(deltaA);
float lenB = length(deltaB);
vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);
vec2 perpA = vec2(-dirA.y, dirA.x);
vec2 perpB = vec2(-dirB.y, dirB.x);
vec2 tangent = dirA + dirB;
tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
vec2 miterVec = vec2(-tangent.y, tangent.x);
vec2 dir = isEnd ? dirA : dirB;
vec2 perp = isEnd ? perpA : perpB;
float L = isEnd ? lenA : lenB;
float sinHalfA = abs(dot(miterVec, perp));
float cosHalfA = abs(dot(dirA, miterVec));
float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
float cornerPosition = sideOfPath * turnDirection;
float miterSize = 1.0 / max(sinHalfA, EPSILON);
miterSize = mix(
min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
miterSize,
step(0.0, cornerPosition)
);
vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
* (sideOfPath + isJoint * turnDirection);
bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
bool isCap = isStartCap || isEndCap;
if (isCap) {
offsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);
vJointType = path.capType;
} else {
vJointType = path.jointType;
}
vPathLength = L;
vCornerOffset = offsetVec;
vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
vMiterLength = isCap ? isJoint : vMiterLength;
vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
vPathPosition = vec2(
dot(offsetFromStartOfPath, perp),
dot(offsetFromStartOfPath, dir)
);
geometry.uv = vPathPosition;
float isValid = step(instanceTypes, 3.5);
vec3 offset = vec3(offsetVec * width * isValid, 0.0);
if (needsRotation) {
offset = rotationMatrix * offset;
}
return offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
if (position.w < EPSILON) {
float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
position = refPosition + (position - refPosition) * r;
}
}
void main() {
geometry.pickingColor = instancePickingColors;
vColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);
float isEnd = positions.x;
vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);
vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);
vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);
geometry.worldPosition = currPosition;
vec2 widthPixels = vec2(clamp(
project_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),
path.widthMinPixels, path.widthMaxPixels) / 2.0);
vec3 width;
if (path.billboard) {
vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);
clipLine(prevPositionScreen, currPositionScreen);
clipLine(nextPositionScreen, currPositionScreen);
clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));
width = vec3(widthPixels, 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(
prevPositionScreen.xyz / prevPositionScreen.w,
currPositionScreen.xyz / currPositionScreen.w,
nextPositionScreen.xyz / nextPositionScreen.w,
project_pixel_size_to_clipspace(width.xy)
);
DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
} else {
prevPosition = project_position(prevPosition, prevPosition64Low);
currPosition = project_position(currPosition, currPosition64Low);
nextPosition = project_position(nextPosition, nextPosition64Low);
width = vec3(project_pixel_size(widthPixels), 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
geometry.position = vec4(currPosition + offset, 1.0);
gl_Position = project_common_position_to_clipspace(geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,fL=`\
#version 300 es
#define SHADER_NAME path-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;
out vec4 fragColor;
void main(void) {
geometry.uv = vPathPosition;
if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
discard;
}
if (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {
discard;
}
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,fO=[0,0,0,255],fR={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:e=>e.path},getColor:{type:"accessor",value:fO},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},fN={enter:(e,t)=>t.length?t.subarray(t.length-e.length):e};class fj extends dr{getShaders(){return super.getShaders({vs:fE,fs:fL,modules:[rc,np,fI]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:fN,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:fN,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:fN,defaultValue:fO},instancePickingColors:{size:4,type:"uint8",accessor:(e,{index:t,target:i})=>this.encodePickingColor(e&&e.__source?e.__source.index:t,i)}}),this.setState({pathTesselator:new fC({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);let{props:t,changeFlags:i}=e,r=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){let{pathTesselator:e}=this.state,s=t.data.attributes||{};e.updateGeometry({data:t.data,geometryBuffer:s.getPath,buffers:s,normalize:!t._pathType,loop:"loop"===t._pathType,getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:e.instanceCount,startIndices:e.vertexStarts}),i.dataChanged||r.invalidateAll()}i.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),r.invalidateAll())}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,r=this.props.data;return r[0]&&r[0].__source&&(t.object=r.find(e=>e.__source.index===i)),t}disablePickingIndex(e){let t=this.props.data;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else super.disablePickingIndex(e)}draw({uniforms:e}){let{jointRounded:t,capRounded:i,billboard:r,miterLimit:s,widthUnits:n,widthScale:a,widthMinPixels:o,widthMaxPixels:l}=this.props,c=this.state.model,u={jointType:Number(t),capType:Number(i),billboard:r,widthUnits:iJ[n],widthScale:a,miterLimit:s,widthMinPixels:o,widthMaxPixels:l};c.shaderInputs.setProps({path:u}),c.draw(this.context.renderPass)}_getModel(){return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new dh({topology:"triangle-list",attributes:{indices:new Uint16Array([0,1,2,1,4,2,1,3,4,3,5,4]),positions:{value:new Float32Array([0,0,0,-1,0,1,1,-1,1,1,1,0]),size:2}}}),isInstanced:!0})}calculatePositions(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}}fj.defaultProps=fR,fj.layerName="PathLayer";var fD=e.i(54008);let fz={isClosed:!0};function fF(e){return"positions"in e?e.positions:e}function fB(e){return"holeIndices"in e?e.holeIndices:null}function fU(e,t,i,r,s){let n,a,o=t,l=i.length;for(let t=0;t<l;t++)for(let s=0;s<r;s++)e[o++]=i[t][s]||0;if(n=i[0],a=i[i.length-1],n[0]!==a[0]||n[1]!==a[1]||n[2]!==a[2])for(let t=0;t<r;t++)e[o++]=i[0][t]||0;return fz.start=t,fz.end=o,fz.size=r,ff(e,s,fz),o}function f$(e,t,i,r,s=0,n,a){let o=(n=n||i.length)-s;if(o<=0)return t;let l=t;for(let t=0;t<o;t++)e[l++]=i[s+t];if(!function(e,t,i,r){for(let s=0;s<t;s++)if(e[i+s]!==e[r-t+s])return!1;return!0}(i,r,s,n))for(let t=0;t<r;t++)e[l++]=i[s+t];return fz.start=t,fz.end=l,fz.size=r,ff(e,a,fz),l}function fV(e,t,i){let r=e.length/3,s=0;for(let n=0;n<r;n++){let a=(n+1)%r;s+=e[3*n+t]*e[3*a+i],s-=e[3*a+t]*e[3*n+i]}return Math.abs(s/2)}function fW(e,t,i,r){let s=e.length/3;for(let n=0;n<s;n++){let s=3*n,a=e[s+0],o=e[s+1],l=e[s+2];e[s+t]=a,e[s+i]=o,e[s+r]=l}}class fG extends fd{constructor(e){const{fp64:t,IndexType:i=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:i,size:1}}})}get(e){let{attributes:t}=this;return"indices"===e?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);let t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){let t=function(e,t){var i,r=e;if(!Array.isArray(r=r&&r.positions||r)&&!ArrayBuffer.isView(r))throw Error("invalid polygon");let s=[],n=[];if("positions"in e){let{positions:i,holeIndices:r}=e;if(r){let e=0;for(let a=0;a<=r.length;a++)e=f$(s,e,i,t,r[a-1],r[a],0===a?1:-1),n.push(e);return n.pop(),{positions:s,holeIndices:n}}e=i}if(!Array.isArray(e[0]))return f$(s,0,e,t,0,s.length,1),s;if(!((i=e).length>=1&&i[0].length>=2&&Number.isFinite(i[0][0]))){let i=0;for(let[r,a]of e.entries())i=fU(s,i,a,t,0===r?1:-1),n.push(i);return n.pop(),{positions:s,holeIndices:n}}return fU(s,0,e,t,1),s}(e,this.positionSize);return this.opts.resolution?fb(fF(t),fB(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?function(e,t=null,i){let{size:r=2,normalize:s=!0,edgeTypes:n=!1}=i||{};t=t||[];let a=[],o=[],l=0,c=0;for(let s=0;s<=t.length;s++){let n=t[s]||e.length,u=c,h=function(e,t,i,r){let s=-1,n=-1;for(let a=i+1;a<r;a+=t){let t=Math.abs(e[a]);t>s&&(s=t,n=a-1)}return n}(e,r,l,n);for(let t=h;t<n;t++)a[c++]=e[t];for(let t=l;t<h;t++)a[c++]=e[t];fS(a,r,u,c),function(e,t,i,r,s=85.051129){let n=e[i],a=e[r-t];if(Math.abs(n-a)>180){let r=fy(e,0,t,i);r[0]+=360*Math.round((a-n)/360),fg(e,r),r[1]=Math.sign(r[1])*s,fg(e,r),r[0]=n,fg(e,r)}}(a,r,u,c,i?.maxLatitude),l=n,o[s]=c}o.pop();let u=fb(a,o,{size:r,gridResolution:360,gridOffset:[-180,-180],edgeTypes:n});if(s)for(let e of u)fT(e.positions,r);return u}(fF(t),fB(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(fq(e)){let t=0;for(let i of e)t+=this.getGeometrySize(i);return t}return fF(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&fq(e))for(let i of e){let e=this.getGeometrySize(i);t.geometrySize=e,this.updateGeometryAttributes(i,t),t.vertexStart+=e,t.indexStart=this.indexStarts[t.geometryIndex+1]}else this._updateIndices(e,t),this._updatePositions(e,t),this._updateVertexValid(e,t)}_updateIndices(e,{geometryIndex:t,vertexStart:i,indexStart:r}){let{attributes:s,indexStarts:n,typedArrayManager:a}=this,o=s.indices;if(!o||!e)return;let l=r,c=function(e,t,i,r){let s=fB(e);s&&(s=s.map(e=>e/t));let n=fF(e),a=r&&3===t;if(i){let e=n.length;n=n.slice();let r=[];for(let s=0;s<e;s+=t){r[0]=n[s],r[1]=n[s+1],a&&(r[2]=n[s+2]);let e=i(r);n[s]=e[0],n[s+1]=e[1],a&&(n[s+2]=e[2])}}if(a){let e=fV(n,0,1),t=fV(n,0,2),r=fV(n,1,2);if(!e&&!t&&!r)return[];e>t&&e>r||(t>r?(i||(n=n.slice()),fW(n,0,2,1)):(i||(n=n.slice()),fW(n,2,0,1)))}return(0,fD.default)(n,s,t)}(e,this.positionSize,this.opts.preproject,this.opts.full3d);o=a.allocate(o,r+c.length,{copy:!0});for(let e=0;e<c.length;e++)o[l++]=c[e]+i;n[t+1]=r+c.length,s.indices=o}_updatePositions(e,{vertexStart:t,geometrySize:i}){let{attributes:{positions:r},positionSize:s}=this;if(!r||!e)return;let n=fF(e);for(let e=t,a=0;a<i;e++,a++){let t=n[a*s],i=n[a*s+1],o=s>2?n[a*s+2]:0;r[3*e]=t,r[3*e+1]=i,r[3*e+2]=o}}_updateVertexValid(e,{vertexStart:t,geometrySize:i}){let{positionSize:r}=this,s=this.attributes.vertexValid,n=e&&fB(e);if(e&&e.edgeTypes?s.set(e.edgeTypes,t):s.fill(1,t,t+i),n)for(let e=0;e<n.length;e++)s[t+n[e]/r-1]=0;s[t+i-1]=0}}function fq(e){return Array.isArray(e)&&e.length>0&&!Number.isFinite(e[0])}let fH=`\
uniform solidPolygonUniforms {
  bool extruded;
  bool isWireframe;
  float elevationScale;
} solidPolygon;
`,fZ={name:"solidPolygon",vs:fH,fs:fH,uniformTypes:{extruded:"f32",isWireframe:"f32",elevationScale:"f32"}},fY=`\
in vec4 fillColors;
in vec4 lineColors;
in vec3 pickingColors;
out vec4 vColor;
struct PolygonProps {
vec3 positions;
vec3 positions64Low;
vec3 normal;
float elevations;
};
vec3 project_offset_normal(vec3 vector) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
return normalize(vector * project.commonUnitsPerWorldUnit);
}
return project_normal(vector);
}
void calculatePosition(PolygonProps props) {
vec3 pos = props.positions;
vec3 pos64Low = props.positions64Low;
vec3 normal = props.normal;
vec4 colors = solidPolygon.isWireframe ? lineColors : fillColors;
geometry.worldPosition = props.positions;
geometry.pickingColor = pickingColors;
if (solidPolygon.extruded) {
pos.z += props.elevations * solidPolygon.elevationScale;
}
gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
if (solidPolygon.extruded) {
#ifdef IS_SIDE_VERTEX
normal = project_offset_normal(normal);
#else
normal = project_normal(normal);
#endif
geometry.normal = normal;
vec3 lightColor = lighting_getLightColor(colors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, colors.a * layer.opacity);
} else {
vColor = vec4(colors.rgb, colors.a * layer.opacity);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,fX=`\
#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader
in vec3 vertexPositions;
in vec3 vertexPositions64Low;
in float elevations;
${fY}
void main(void) {
PolygonProps props;
props.positions = vertexPositions;
props.positions64Low = vertexPositions64Low;
props.elevations = elevations;
props.normal = vec3(0.0, 0.0, 1.0);
calculatePosition(props);
}
`,fK=`\
#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX
in vec2 positions;
in vec3 vertexPositions;
in vec3 nextVertexPositions;
in vec3 vertexPositions64Low;
in vec3 nextVertexPositions64Low;
in float elevations;
in float instanceVertexValid;
${fY}
void main(void) {
if(instanceVertexValid < 0.5){
gl_Position = vec4(0.);
return;
}
PolygonProps props;
vec3 pos;
vec3 pos64Low;
vec3 nextPos;
vec3 nextPos64Low;
#if RING_WINDING_ORDER_CW == 1
pos = vertexPositions;
pos64Low = vertexPositions64Low;
nextPos = nextVertexPositions;
nextPos64Low = nextVertexPositions64Low;
#else
pos = nextVertexPositions;
pos64Low = nextVertexPositions64Low;
nextPos = vertexPositions;
nextPos64Low = vertexPositions64Low;
#endif
props.positions = mix(pos, nextPos, positions.x);
props.positions64Low = mix(pos64Low, nextPos64Low, positions.x);
props.normal = vec3(
pos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),
nextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),
0.0);
props.elevations = elevations * positions.y;
calculatePosition(props);
}
`,fJ=`\
#version 300 es
#define SHADER_NAME solid-polygon-layer-fragment-shader
precision highp float;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
fragColor = vColor;
geometry.uv = vec2(0.);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,fQ=[0,0,0,255],f0={enter:(e,t)=>t.length?t.subarray(t.length-e.length):e};class f1 extends dr{getShaders(e){return super.getShaders({vs:"top"===e?fX:fK,fs:fJ,defines:{RING_WINDING_ORDER_CW:this.props._normalize||"CCW"!==this.props._windingOrder?1:0},modules:[rc,ej,np,fZ]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){let e,{viewport:t}=this.context,{coordinateSystem:i}=this.props,{_full3d:r}=this.props;t.isGeospatial&&i===iX.DEFAULT&&(i=iX.LNGLAT),i===iX.LNGLAT&&(e=r?t.projectPosition.bind(t):t.projectFlat.bind(t)),this.setState({numInstances:0,polygonTesselator:new fG({preproject:e,fp64:this.use64bitPositions(),IndexType:Uint32Array})});let s=this.getAttributeManager();s.remove(["instancePickingColors"]),s.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:!0},vertexPositions:{size:3,type:"float64",stepMode:"dynamic",fp64:this.use64bitPositions(),transition:f0,accessor:"getPolygon",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{nextVertexPositions:{vertexOffset:1}}},instanceVertexValid:{size:1,type:"uint16",stepMode:"instance",update:this.calculateVertexValid,noAlloc:!0},elevations:{size:1,stepMode:"dynamic",transition:f0,accessor:"getElevation"},fillColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:f0,accessor:"getFillColor",defaultValue:fQ},lineColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:f0,accessor:"getLineColor",defaultValue:fQ},pickingColors:{size:4,type:"uint8",stepMode:"dynamic",accessor:(e,{index:t,target:i})=>this.encodePickingColor(e&&e.__source?e.__source.index:t,i)}})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,r=this.props.data;return r[0]&&r[0].__source&&(t.object=r.find(e=>e.__source.index===i)),t}disablePickingIndex(e){let t=this.props.data;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else super.disablePickingIndex(e)}draw({uniforms:e}){let{extruded:t,filled:i,wireframe:r,elevationScale:s}=this.props,{topModel:n,sideModel:a,wireframeModel:o,polygonTesselator:l}=this.state,c={extruded:!!t,elevationScale:s,isWireframe:!1};o&&r&&(o.setInstanceCount(l.instanceCount-1),o.shaderInputs.setProps({solidPolygon:{...c,isWireframe:!0}}),o.draw(this.context.renderPass)),a&&i&&(a.setInstanceCount(l.instanceCount-1),a.shaderInputs.setProps({solidPolygon:c}),a.draw(this.context.renderPass)),n&&i&&(n.setVertexCount(l.vertexCount),n.shaderInputs.setProps({solidPolygon:c}),n.draw(this.context.renderPass))}updateState(e){super.updateState(e),this.updateGeometry(e);let{props:t,oldProps:i,changeFlags:r}=e,s=this.getAttributeManager();(r.extensionsChanged||t.filled!==i.filled||t.extruded!==i.extruded)&&(this.state.models?.forEach(e=>e.destroy()),this.setState(this._getModels()),s.invalidateAll())}updateGeometry({props:e,oldProps:t,changeFlags:i}){if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon)){let{polygonTesselator:t}=this.state,r=e.data.attributes||{};t.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:r.getPolygon,buffers:r,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:i.dataChanged,full3d:e._full3d}),this.setState({numInstances:t.instanceCount,startIndices:t.vertexStarts}),i.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){let e,t,i,{id:r,filled:s,extruded:n}=this.props;if(s){let t=this.getShaders("top");t.defines.NON_INSTANCED_MODEL=1;let i=this.getAttributeManager().getBufferLayouts({isInstanced:!1});e=new hm(this.context.device,{...t,id:`${r}-top`,topology:"triangle-list",bufferLayout:i,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}if(n){let e=this.getAttributeManager().getBufferLayouts({isInstanced:!0});t=new hm(this.context.device,{...this.getShaders("side"),id:`${r}-side`,bufferLayout:e,geometry:new dh({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),i=new hm(this.context.device,{...this.getShaders("side"),id:`${r}-wireframe`,bufferLayout:e,geometry:new dh({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})}return{models:[t,i,e].filter(Boolean),topModel:e,sideModel:t,wireframeModel:i}}calculateIndices(e){let{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){let{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}f1.defaultProps={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:e=>e.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:fQ},getLineColor:{type:"accessor",value:fQ},material:!0},f1.layerName="SolidPolygonLayer";let f2={circle:{type:dx,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:dZ,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:fh,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},f3={type:fj,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},f4={type:f1,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function f6({type:e,props:t}){let i={};for(let r in t)i[r]=e.defaultProps[t[r]];return i}function f5(e,t){let{transitions:i,updateTriggers:r}=e.props,s={updateTriggers:{},transitions:i&&{getPosition:i.geometry}};for(let n in t){let a=t[n],o=e.props[n];n.startsWith("get")&&(o=e.getSubLayerAccessor(o),s.updateTriggers[a]=r[n],i&&(s.transitions[a]=i[n])),s[a]=o}return s}function f8(e,t,i={}){let r={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:s=0,endRow:n=e.length}=i;for(let i=s;i<n;i++){let s=e[i],{geometry:n}=s;if(n)if("GeometryCollection"===n.type){is.assert(Array.isArray(n.geometries),"GeoJSON does not have geometries array");let{geometries:e}=n;for(let n=0;n<e.length;n++)f7(e[n],r,t,s,i)}else f7(n,r,t,s,i)}return r}function f7(e,t,i,r,s){let{type:n,coordinates:a}=e,{pointFeatures:o,lineFeatures:l,polygonFeatures:c,polygonOutlineFeatures:u}=t;if(!function(e,t){let i=f9[e];for(is.assert(i,`Unknown GeoJSON type ${e}`);t&&--i>0;)t=t[0];return t&&Number.isFinite(t[0])}(n,a))return void is.warn(`${n} coordinates are malformed`)();switch(n){case"Point":o.push(i({geometry:e},r,s));break;case"MultiPoint":a.forEach(e=>{o.push(i({geometry:{type:"Point",coordinates:e}},r,s))});break;case"LineString":l.push(i({geometry:e},r,s));break;case"MultiLineString":a.forEach(e=>{l.push(i({geometry:{type:"LineString",coordinates:e}},r,s))});break;case"Polygon":c.push(i({geometry:e},r,s)),a.forEach(e=>{u.push(i({geometry:{type:"LineString",coordinates:e}},r,s))});break;case"MultiPolygon":a.forEach(e=>{c.push(i({geometry:{type:"Polygon",coordinates:e}},r,s)),e.forEach(e=>{u.push(i({geometry:{type:"LineString",coordinates:e}},r,s))})})}}let f9={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function pe(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function pt(e){return e.geometry.coordinates}let pi=["points","linestrings","polygons"],pr={...f6(f2.circle),...f6(f2.icon),...f6(f2.text),...f6(f3),...f6(f4),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:e=>e.properties.icon},getText:{type:"accessor",value:e=>e.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class ps extends dR{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;let{data:i}=this.props,r=i&&"points"in i&&"polygons"in i&&"lines"in i;this.setState({binary:r}),r?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){let i=function(e,t){let i=pe(),{points:r,lines:s,polygons:n}=e,a=function(e,t){let i={points:null,lines:null,polygons:null};for(let r in i){let s=e[r].globalFeatureIds.value;i[r]=new Uint8ClampedArray(4*s.length);let n=[];for(let e=0;e<s.length;e++)t(s[e],n),i[r][4*e+0]=n[0],i[r][4*e+1]=n[1],i[r][4*e+2]=n[2],i[r][4*e+3]=255}return i}(e,t);i.points.data={length:r.positions.value.length/r.positions.size,attributes:{...r.attributes,getPosition:r.positions,instancePickingColors:{size:4,value:a.points}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},i.lines.data={length:s.pathIndices.value.length-1,startIndices:s.pathIndices.value,attributes:{...s.attributes,getPath:s.positions,instancePickingColors:{size:4,value:a.lines}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},i.lines._pathType="open";let o=Array(n.positions.value.length/n.positions.size).fill(1);for(let e of n.primitivePolygonIndices.value)o[e-1]=0;return i.polygons.data={length:n.polygonIndices.value.length-1,startIndices:n.polygonIndices.value,attributes:{...n.attributes,getPolygon:n.positions,instanceVertexValid:{size:1,value:new Uint16Array(o)},pickingColors:{size:4,value:a.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},i.polygons._normalize=!1,n.triangles&&(i.polygons.data.attributes.indices=n.triangles.value),i.polygonsOutline.data={length:n.primitivePolygonIndices.value.length-1,startIndices:n.primitivePolygonIndices.value,attributes:{...n.attributes,getPath:n.positions,instancePickingColors:{size:4,value:a.polygons}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},i.polygonsOutline._pathType="open",i}(e.data,this.encodePickingColor);this.setState({layerProps:i})}_updateStateJSON({props:e,changeFlags:t}){let i=function(e){if(Array.isArray(e))return e;switch(is.assert(e.type,"GeoJSON does not have type"),e.type){case"Feature":return[e];case"FeatureCollection":return is.assert(Array.isArray(e.features),"GeoJSON does not have features array"),e.features;default:return[{geometry:e}]}}(e.data),r=this.getSubLayerRow.bind(this),s={},n={};if(Array.isArray(t.dataChanged)){let e=this.state.features;for(let t in e)s[t]=e[t].slice(),n[t]=[];for(let a of t.dataChanged){let t=f8(i,r,a);for(let i in e)n[i].push(function({data:e,getIndex:t,dataRange:i,replace:r}){let{startRow:s=0,endRow:n=1/0}=i,a=e.length,o=a,l=a;for(let i=0;i<a;i++){let r=t(e[i]);if(o>i&&r>=s&&(o=i),r>=n){l=i;break}}let c=o,u=l-o!==r.length?e.slice(l):void 0;for(let t=0;t<r.length;t++)e[c++]=r[t];if(u){for(let t=0;t<u.length;t++)e[c++]=u[t];e.length=c}return{startRow:o,endRow:o+r.length}}({data:s[i],getIndex:e=>e.__source.index,dataRange:a,replace:t[i]}))}}else s=f8(i,r);let a=function(e,t){let i=pe(),{pointFeatures:r,lineFeatures:s,polygonFeatures:n,polygonOutlineFeatures:a}=e;return i.points.data=r,i.points._dataDiff=t.pointFeatures&&(()=>t.pointFeatures),i.points.getPosition=pt,i.lines.data=s,i.lines._dataDiff=t.lineFeatures&&(()=>t.lineFeatures),i.lines.getPath=pt,i.polygons.data=n,i.polygons._dataDiff=t.polygonFeatures&&(()=>t.polygonFeatures),i.polygons.getPolygon=pt,i.polygonsOutline.data=a,i.polygonsOutline._dataDiff=t.polygonOutlineFeatures&&(()=>t.polygonOutlineFeatures),i.polygonsOutline.getPath=pt,i}(s,n);this.setState({features:s,featuresDiff:n,layerProps:a})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i,sourceLayer:r}=t;return t.featureType=pi.find(e=>r.id.startsWith(`${this.id}-${e}-`)),i>=0&&r.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[i]),t}_updateAutoHighlight(e){let t=`${this.id}-points-`,i="points"===e.featureType;for(let r of this.getSubLayers())r.id.startsWith(t)===i&&r.updateAutoHighlight(e)}_renderPolygonLayer(){let{extruded:e,wireframe:t}=this.props,{layerProps:i}=this.state,r="polygons-fill",s=this.shouldRenderSubLayer(r,i.polygons?.data)&&this.getSubLayerClass(r,f4.type);if(s){let n=f5(this,f4.props),a=e&&t;return a||delete n.getLineColor,n.updateTriggers.lineColors=a,new s(n,this.getSubLayerProps({id:r,updateTriggers:n.updateTriggers}),i.polygons)}return null}_renderLineLayers(){let{extruded:e,stroked:t}=this.props,{layerProps:i}=this.state,r="polygons-stroke",s="linestrings",n=!e&&t&&this.shouldRenderSubLayer(r,i.polygonsOutline?.data)&&this.getSubLayerClass(r,f3.type),a=this.shouldRenderSubLayer(s,i.lines?.data)&&this.getSubLayerClass(s,f3.type);if(n||a){let e=f5(this,f3.props);return[n&&new n(e,this.getSubLayerProps({id:r,updateTriggers:e.updateTriggers}),i.polygonsOutline),a&&new a(e,this.getSubLayerProps({id:s,updateTriggers:e.updateTriggers}),i.lines)]}return null}_renderPointLayers(){let{pointType:e}=this.props,{layerProps:t,binary:i}=this.state,{highlightedObjectIndex:r}=this.props;!i&&Number.isFinite(r)&&(r=t.points.data.findIndex(e=>e.__source.index===r));let s=new Set(e.split("+")),n=[];for(let e of s){let s=`points-${e}`,a=f2[e],o=a&&this.shouldRenderSubLayer(s,t.points?.data)&&this.getSubLayerClass(s,a.type);if(o){let l=f5(this,a.props),c=t.points;if("text"===e&&i){let{instancePickingColors:e,...t}=c.data.attributes;c={...c,data:{...c.data,attributes:t}}}n.push(new o(l,this.getSubLayerProps({id:s,updateTriggers:l.updateTriggers,highlightedObjectIndex:r}),c))}}return n}renderLayers(){let{extruded:e}=this.props,t=this._renderPolygonLayer();return[!e&&t,this._renderLineLayers(),this._renderPointLayers(),e&&t]}getSubLayerAccessor(e){let{binary:t}=this.state;return t&&"function"==typeof e?(t,i)=>{let{data:r,index:s}=i;return e(function(e,t){if(!e)return null;let i="startIndices"in e?e.startIndices[t]:t,r=e.featureIds.value[i];return -1!==i?function(e,t,i){let r={properties:{...e.properties[t]}};for(let t in e.numericProps)r.properties[t]=e.numericProps[t].value[i];return r}(e,r,i):null}(r,s),i)}:super.getSubLayerAccessor(e)}}ps.layerName="GeoJsonLayer",ps.defaultProps=pr;let pn={id:"request-scheduler",throttleRequests:!0,maxRequests:6,debounceTime:0};class pa{props;stats;activeRequestCount=0;requestQueue=[];requestMap=new Map;updateTimer=null;constructor(e={}){this.props={...pn,...e},this.stats=new nA.Stats({id:this.props.id}),this.stats.get("Queued Requests"),this.stats.get("Active Requests"),this.stats.get("Cancelled Requests"),this.stats.get("Queued Requests Ever"),this.stats.get("Active Requests Ever")}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);let i={handle:e,priority:0,getPriority:t},r=new Promise(e=>(i.resolve=e,i));return this.requestQueue.push(i),this.requestMap.set(e,r),this._issueNewRequests(),r}_issueRequest(e){let{handle:t,resolve:i}=e,r=!1,s=()=>{r||(r=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:s}):Promise.resolve({done:s})}_issueNewRequests(){null!==this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this._issueNewRequestsAsync(),this.props.debounceTime)}_issueNewRequestsAsync(){null!==this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=null;let e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(0!==e){this._updateAllRequests();for(let t=0;t<e;++t){let e=this.requestQueue.shift();e&&this._issueRequest(e)}}}_updateAllRequests(){let e=this.requestQueue;for(let t=0;t<e.length;++t){let i=e[t];!this._updateRequest(i)&&(e.splice(t,1),this.requestMap.delete(i.handle),t--)}e.sort((e,t)=>e.priority-t.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),!(e.priority<0)||(e.resolve(null),!1)}}class po{constructor(e){this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get bbox(){return this._bbox}set bbox(e){this._bbox||(this._bbox=e,"west"in e?this.boundingBox=[[e.west,e.south],[e.east,e.north]]:this.boundingBox=[[e.left,e.top],[e.right,e.bottom]])}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return!!this._loader&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){let e=this.content?this.content.byteLength:0;return Number.isFinite(e)||console.error("byteLength not defined in tile data"),e}async _loadData({getData:e,requestScheduler:t,onLoad:i,onError:r}){let s,{index:n,id:a,bbox:o,userData:l,zoom:c}=this,u=this._loaderId;this._abortController=new AbortController;let{signal:h}=this._abortController,d=await t.scheduleRequest(this,e=>e.isSelected?1:-1);if(!d){this._isCancelled=!0;return}if(this._isCancelled)return void d.done();let f=null;try{f=await e({index:n,id:a,bbox:o,userData:l,zoom:c,signal:h})}catch(e){s=e||!0}finally{d.done()}if(u===this._loaderId){if(this._loader=void 0,this.content=f,this._isCancelled&&!f){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,s?r(s,this):i(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){this.isLoaded||(this._isCancelled=!0,this._abortController?.abort())}}var sX=sX,ii=ii;let pl=Math.PI/180,pc=180/Math.PI;class pu extends a7{constructor(e={}){const{longitude:t=0,zoom:i=0,nearZMultiplier:r=.5,farZMultiplier:s=1,resolution:n=10}=e;let{latitude:a=0,height:o,altitude:l=1.5,fovy:c}=e;a=Math.max(Math.min(a,85.051129),-85.051129),o=o||1,c?l=s7(c):c=s8(l);const u=1/Math.PI/Math.cos(a*Math.PI/180)*Math.pow(2,i),h=e.nearZ??r,d=e.farZ??(l+512*u/o)*s,f=new sV().lookAt({eye:[0,-l,0],up:[0,0,1]});f.rotateX(a*pl),f.rotateZ(-t*pl),f.scale(u/o),super({...e,height:o,viewMatrix:f,longitude:t,latitude:a,zoom:i,distanceScales:function(){let e=Math.PI/180*256;return{unitsPerMeter:[4018225162502676e-20,4018225162502676e-20,4018225162502676e-20],unitsPerMeter2:[0,0,0],metersPerUnit:[24886.609375,24886.609375,24886.609375],unitsPerDegree:[e,e,4018225162502676e-20],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,24886.609375]}}(),fovy:c,focalDistance:l,near:h,far:d}),this.scale=u,this.latitude=a,this.longitude=t,this.resolution=n}get projectionMode(){return iK.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,this.height/2],t),r=this.unproject([this.width/2,0],t),s=this.unproject([this.width,this.height/2],t),n=this.unproject([this.width/2,this.height],t);return s[0]<this.longitude&&(s[0]+=360),i[0]>this.longitude&&(i[0]-=360),[Math.min(i[0],s[0],r[0],n[0]),Math.min(i[1],s[1],r[1],n[1]),Math.max(i[0],s[0],r[0],n[0]),Math.max(i[1],s[1],r[1],n[1])]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let r,[s,n,a]=e,o=t?n:this.height-n,{pixelUnprojectionMatrix:l}=this;if(Number.isFinite(a))r=ph(l,[s,o,a,1]);else{let e=ph(l,[s,o,-1,1]),t=ph(l,[s,o,1,1]),n=((i||0)/6370972+1)*256,a=sX.sqrLen(sX.sub([],e,t)),c=sX.sqrLen(e),u=sX.sqrLen(t),h=(4*c*u-(a-c-u)**2)/16*4/a,d=(Math.sqrt(c-h)-Math.sqrt(Math.max(0,n*n-h)))/Math.sqrt(a);r=sX.lerp([],e,t,d)}let[c,u,h]=this.unprojectPosition(r);return Number.isFinite(a)?[c,u,h]:Number.isFinite(i)?[c,u,i]:[c,u]}projectPosition(e){let[t,i,r=0]=e,s=t*pl,n=i*pl,a=Math.cos(n),o=(r/6370972+1)*256;return[Math.sin(s)*a*o,-Math.cos(s)*a*o,Math.sin(n)*o]}unprojectPosition(e){let[t,i,r]=e,s=sX.len(e);return[Math.atan2(t,-i)*pc,Math.asin(r/s)*pc,(s/256-1)*6370972]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){let i=this.unproject(t);return{longitude:e[0]-i[0]+this.longitude,latitude:e[1]-i[1]+this.latitude}}}function ph(e,t){let i=ii.transformMat4([],t,e);return ii.scale(i,i,1/i[3]),i}let pd=new st,pf=new st;class pp{constructor(e=[0,0,0],t=[0,0,0],i){i=i||pd.copy(e).add(t).scale(.5),this.center=new st(i),this.halfDiagonal=new st(t).subtract(this.center),this.minimum=new st(e),this.maximum=new st(t)}clone(){return new pp(this.minimum,this.maximum,this.center)}equals(e){return this===e||!!e&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}transform(e){return this.center.transformAsPoint(e),this.halfDiagonal.transform(e),this.minimum.transform(e),this.maximum.transform(e),this}intersectPlane(e){let{halfDiagonal:t}=this,i=pf.from(e.normal),r=t.x*Math.abs(i.x)+t.y*Math.abs(i.y)+t.z*Math.abs(i.z),s=this.center.dot(i)+e.distance;return s-r>0?1:s+r<0?-1:0}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t,i=pd.from(e).subtract(this.center),{halfDiagonal:r}=this,s=0;return(t=Math.abs(i.x)-r.x)>0&&(s+=t*t),(t=Math.abs(i.y)-r.y)>0&&(s+=t*t),(t=Math.abs(i.z)-r.z)>0&&(s+=t*t),s}}var tE=tE;let pg=new st,pm=new st;class py{constructor(e=[0,0,0],t=0){this.radius=-0,this.center=new st,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=pg.from(t),this.center=new st().from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new py(this.center,this.radius)}union(e){let t=this.center,i=this.radius,r=e.center,s=e.radius,n=pg.copy(r).subtract(t),a=n.magnitude();if(i>=a+s)return this.clone();if(s>=a+i)return e.clone();let o=(i+a+s)*.5;return pm.copy(n).scale((-i+o)/a).add(t),this.center.copy(pm),this.radius=o,this}expand(e){let t=pg.from(e).subtract(this.center).magnitude();return t>this.radius&&(this.radius=t),this}transform(e){this.center.transform(e);let t=tE.getScaling(pg,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){let t=this.distanceTo(e);return t*t}distanceTo(e){return Math.max(0,pg.from(e).subtract(this.center).len()-this.radius)}intersectPlane(e){let t=this.center,i=this.radius,r=e.normal.dot(t)+e.distance;return r<-i?-1:r<i?0:1}}function pv(e,t,i){let r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=i[0],f=i[1],p=i[2],g=i[3],m=i[4],y=i[5],v=i[6],x=i[7],_=i[8];return e[0]=d*r+f*a+p*c,e[1]=d*s+f*o+p*u,e[2]=d*n+f*l+p*h,e[3]=g*r+m*a+y*c,e[4]=g*s+m*o+y*u,e[5]=g*n+m*l+y*h,e[6]=v*r+x*a+_*c,e[7]=v*s+x*o+_*u,e[8]=v*n+x*l+_*h,e}function px(e,t,i){let r=i[0],s=i[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}(S=N||(N={}))[S.COL0ROW0=0]="COL0ROW0",S[S.COL0ROW1=1]="COL0ROW1",S[S.COL0ROW2=2]="COL0ROW2",S[S.COL1ROW0=3]="COL1ROW0",S[S.COL1ROW1=4]="COL1ROW1",S[S.COL1ROW2=5]="COL1ROW2",S[S.COL2ROW0=6]="COL2ROW0",S[S.COL2ROW1=7]="COL2ROW1",S[S.COL2ROW2=8]="COL2ROW2";let p_=Object.freeze([1,0,0,0,1,0,0,0,1]);class pb extends si{static get IDENTITY(){return pw||Object.freeze(pw=new pb),pw}static get ZERO(){return n||Object.freeze(n=new pb([0,0,0,0,0,0,0,0,0])),n}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return N}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),1==arguments.length&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(p_)}fromObject(e){return this.check()}fromQuaternion(e){let t,i,r,s,n,a,o,l,c,u,h,d,f,p,g,m;return t=e[0],i=e[1],r=e[2],s=e[3],n=t+t,a=i+i,o=r+r,l=t*n,c=i*n,u=i*a,h=r*n,d=r*a,f=r*o,p=s*n,g=s*a,m=s*o,this[0]=1-u-f,this[3]=c-m,this[6]=h+g,this[1]=c+m,this[4]=1-l-f,this[7]=d-p,this[2]=h-g,this[5]=d+p,this[8]=1-l-u,this.check()}set(e,t,i,r,s,n,a,o,l){return this[0]=e,this[1]=t,this[2]=i,this[3]=r,this[4]=s,this[5]=n,this[6]=a,this[7]=o,this[8]=l,this.check()}setRowMajor(e,t,i,r,s,n,a,o,l){return this[0]=e,this[1]=r,this[2]=a,this[3]=t,this[4]=s,this[5]=o,this[6]=i,this[7]=n,this[8]=l,this.check()}determinant(){let e,t,i,r,s,n,a,o,l;return e=this[0],t=this[1],i=this[2],r=this[3],s=this[4],n=this[5],a=this[6],o=this[7],e*((l=this[8])*s-n*o)+t*(-l*r+n*a)+i*(o*r-s*a)}transpose(){return!function(e,t){if(e===t){let i=t[1],r=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=r,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(this,this),this.check()}invert(){let e,t,i,r,s,n,a,o,l,c,u,h,d;return e=this[0],t=this[1],i=this[2],r=this[3],s=this[4],n=this[5],a=this[6],o=this[7],c=(l=this[8])*s-n*o,(d=e*c+t*(u=-l*r+n*a)+i*(h=o*r-s*a))&&(d=1/d,this[0]=c*d,this[1]=(-l*t+i*o)*d,this[2]=(n*t-i*s)*d,this[3]=u*d,this[4]=(l*e-i*a)*d,this[5]=(-n*e+i*r)*d,this[6]=h*d,this[7]=(-o*e+t*a)*d,this[8]=(s*e-t*r)*d),this.check()}multiplyLeft(e){return pv(this,e,this),this.check()}multiplyRight(e){return pv(this,this,e),this.check()}rotate(e){let t,i,r,s,n,a,o,l,c,u,h;return t=this[0],i=this[1],r=this[2],s=this[3],n=this[4],a=this[5],o=this[6],l=this[7],c=this[8],u=Math.sin(e),h=Math.cos(e),this[0]=h*t+u*s,this[1]=h*i+u*n,this[2]=h*r+u*a,this[3]=h*s-u*t,this[4]=h*n-u*i,this[5]=h*a-u*r,this[6]=o,this[7]=l,this[8]=c,this.check()}scale(e){return Array.isArray(e)?px(this,this,e):px(this,this,[e,e]),this.check()}translate(e){let t,i,r,s,n,a,o,l,c,u,h;return t=this[0],i=this[1],r=this[2],s=this[3],n=this[4],a=this[5],o=this[6],l=this[7],c=this[8],u=e[0],h=e[1],this[0]=t,this[1]=i,this[2]=r,this[3]=s,this[4]=n,this[5]=a,this[6]=u*t+h*s+o,this[7]=u*i+h*n+l,this[8]=u*r+h*a+c,this.check()}transform(e,t){let i;switch(e.length){case 2:i=sL(t||[-0,-0],e,this);break;case 3:i=rK(t||[-0,-0,-0],e,this);break;case 4:i=r9(t||[-0,-0,-0,-0],e,this);break;default:throw Error("Illegal vector")}return ry(i,e.length),i}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let pw=null;class pk extends rx{static get ZERO(){return a||Object.freeze(a=new pk(0,0,0,0)),a}constructor(e=0,t=0,i=0,r=0){super(-0,-0,-0,-0),rh(e)&&1==arguments.length?this.copy(e):(ru.debug&&(rm(e),rm(t),rm(i),rm(r)),this[0]=e,this[1]=t,this[2]=i,this[3]=r)}set(e,t,i,r){return this[0]=e,this[1]=t,this[2]=i,this[3]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return ru.debug&&(rm(e.x),rm(e.y),rm(e.z),rm(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=rm(e)}get w(){return this[3]}set w(e){this[3]=rm(e)}transform(e){return rX(this,this,e),this.check()}transformByMatrix3(e){return r9(this,this,e),this.check()}transformByMatrix2(e){let t,i;return t=this[0],i=this[1],this[0]=e[0]*t+e[2]*i,this[1]=e[1]*t+e[3]*i,this[2]=this[2],this[3]=this[3],this.check()}transformByQuaternion(e){return rJ(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}}function pP(){let e=new eW(4);return eW!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function pS(e,t,i){let r=Math.sin(i*=.5);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(i),e}function pT(e,t,i){let r=t[0],s=t[1],n=t[2],a=t[3],o=i[0],l=i[1],c=i[2],u=i[3];return e[0]=r*u+a*o+s*c-n*l,e[1]=s*u+a*l+n*o-r*c,e[2]=n*u+a*c+r*l-s*o,e[3]=a*u-r*o-s*l-n*c,e}let pC=(h=r_(),d=rk(1,0,0),f=rk(0,1,0),function(e,t,i){let r=rV(t,i);return r<-.999999?(rW(h,d,t),1e-6>rw(h)&&rW(h,f,t),r$(h,h),pS(e,h,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(rW(h,t,i),e[0]=h[0],e[1]=h[1],e[2]=h[2],e[3]=1+r,t0(e,e))});pP(),pP(),p=new eW(9),eW!=Float32Array&&(p[1]=0,p[2]=0,p[3]=0,p[5]=0,p[6]=0,p[7]=0),p[0]=1,p[4]=1,p[8]=1;let pM=[0,0,0,1];class pA extends rg{constructor(e=0,t=0,i=0,r=1){super(-0,-0,-0,-0),Array.isArray(e)&&1==arguments.length?this.copy(e):this.set(e,t,i,r)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,i,r){return this[0]=e,this[1]=t,this[2]=i,this[3]=r,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return!function(e,t){let i,r=t[0]+t[4]+t[8];if(r>0)i=Math.sqrt(r+1),e[3]=.5*i,i=.5/i,e[0]=(t[5]-t[7])*i,e[1]=(t[6]-t[2])*i,e[2]=(t[1]-t[3])*i;else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);let s=(r+1)%3,n=(r+2)%3;i=Math.sqrt(t[3*r+r]-t[3*s+s]-t[3*n+n]+1),e[r]=.5*i,i=.5/i,e[3]=(t[3*s+n]-t[3*n+s])*i,e[s]=(t[3*s+r]+t[3*r+s])*i,e[n]=(t[3*n+r]+t[3*r+n])*i}}(this,e),this.check()}fromAxisRotation(e,t){return pS(this,e,t),this.check()}identity(){return this[0]=0,this[1]=0,this[2]=0,this[3]=1,this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=rm(e)}get y(){return this[1]}set y(e){this[1]=rm(e)}get z(){return this[2]}set z(e){this[2]=rm(e)}get w(){return this[3]}set w(e){this[3]=rm(e)}len(){return tX(this)}lengthSquared(){return tK(this)}dot(e){return t1(this,e)}rotationTo(e,t){return pC(this,e,t),this.check()}add(e){return tD(this,this,e),this.check()}calculateW(){let e,t,i;return e=this[0],t=this[1],i=this[2],this[0]=e,this[1]=t,this[2]=i,this[3]=Math.sqrt(Math.abs(1-e*e-t*t-i*i)),this.check()}conjugate(){return this[0]=-this[0],this[1]=-this[1],this[2]=-this[2],this[3]=this[3],this.check()}invert(){let e,t,i,r,s,n;return e=this[0],t=this[1],i=this[2],n=(s=e*e+t*t+i*i+(r=this[3])*r)?1/s:0,this[0]=-e*n,this[1]=-t*n,this[2]=-i*n,this[3]=r*n,this.check()}lerp(e,t,i){return void 0===i?this.lerp(this,e,t):(t3(this,e,t,i),this.check())}multiplyRight(e){return pT(this,this,e),this.check()}multiplyLeft(e){return pT(this,e,this),this.check()}normalize(){let e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,0===e&&(this[3]=1),this.check()}rotateX(e){var t;let i,r,s,n,a,o;return t=.5*e,i=this[0],r=this[1],s=this[2],n=this[3],a=Math.sin(t),o=Math.cos(t),this[0]=i*o+n*a,this[1]=r*o+s*a,this[2]=s*o-r*a,this[3]=n*o-i*a,this.check()}rotateY(e){var t;let i,r,s,n,a,o;return t=.5*e,i=this[0],r=this[1],s=this[2],n=this[3],a=Math.sin(t),o=Math.cos(t),this[0]=i*o-s*a,this[1]=r*o+n*a,this[2]=s*o+i*a,this[3]=n*o-r*a,this.check()}rotateZ(e){var t;let i,r,s,n,a,o;return t=.5*e,i=this[0],r=this[1],s=this[2],n=this[3],a=Math.sin(t),o=Math.cos(t),this[0]=i*o+r*a,this[1]=r*o-i*a,this[2]=s*o+n*a,this[3]=n*o-s*a,this.check()}scale(e){return tq(this,this,e),this.check()}slerp(e,t,i){var r,s,n;let a,o,l,c,u,h,d,f,p,g,m,y,v,x,_,b;switch(arguments.length){case 1:({start:a=pM,target:o,ratio:l}=e);break;case 2:a=this,o=e,l=t;break;default:a=e,o=t,l=i}return r=a,s=o,n=l,p=r[0],g=r[1],m=r[2],y=r[3],v=s[0],x=s[1],(c=p*v+g*x+m*(_=s[2])+y*(b=s[3]))<0&&(c=-c,v=-v,x=-x,_=-_,b=-b),1-c>1e-6?(f=Math.sin(u=Math.acos(c)),h=Math.sin((1-n)*u)/f,d=Math.sin(n*u)/f):(h=1-n,d=n),this[0]=h*p+d*v,this[1]=h*g+d*x,this[2]=h*m+d*_,this[3]=h*y+d*b,this.check()}transformVector4(e,t=new pk){return t5(t,e,this),ry(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}}let pI=new st,pE=new st,pL=new st,pO=new st,pR=new st,pN=new st,pj=new st;class pD{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){this.center=new st().from(e),this.halfAxes=new pb(t)}get halfSize(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new st(e).len(),new st(t).len(),new st(i).len()]}get quaternion(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),r=new st(e).normalize(),s=new st(t).normalize(),n=new st(i).normalize();return new pA().fromMatrix3(new pb([...r,...s,...n]))}fromCenterHalfSizeQuaternion(e,t,i){let r=new pA(i),s=new pb().fromQuaternion(r);return s[0]=s[0]*t[0],s[1]=s[1]*t[0],s[2]=s[2]*t[0],s[3]=s[3]*t[1],s[4]=s[4]*t[1],s[5]=s[5]*t[1],s[6]=s[6]*t[2],s[7]=s[7]*t[2],s[8]=s[8]*t[2],this.center=new st().from(e),this.halfAxes=s,this}clone(){return new pD(this.center,this.halfAxes)}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new py){let t=this.halfAxes,i=t.getColumn(0,pL),r=t.getColumn(1,pO),s=t.getColumn(2,pR),n=pI.copy(i).add(r).add(s);return e.center.copy(this.center),e.radius=n.magnitude(),e}intersectPlane(e){let t=this.center,i=e.normal,r=this.halfAxes,s=i.x,n=i.y,a=i.z,o=Math.abs(s*r[0]+n*r[1]+a*r[2])+Math.abs(s*r[3]+n*r[4]+a*r[5])+Math.abs(s*r[6]+n*r[7]+a*r[8]),l=i.dot(t)+e.distance;return l<=-o?-1:1*!!(l>=o)}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t,i=pE.from(e).subtract(this.center),r=this.halfAxes,s=r.getColumn(0,pL),n=r.getColumn(1,pO),a=r.getColumn(2,pR),o=s.magnitude(),l=n.magnitude(),c=a.magnitude();s.normalize(),n.normalize(),a.normalize();let u=0;return(t=Math.abs(i.dot(s))-o)>0&&(u+=t*t),(t=Math.abs(i.dot(n))-l)>0&&(u+=t*t),(t=Math.abs(i.dot(a))-c)>0&&(u+=t*t),u}computePlaneDistances(e,t,i=[-0,-0]){let r=1/0,s=-1/0,n=this.center,a=this.halfAxes,o=a.getColumn(0,pL),l=a.getColumn(1,pO),c=a.getColumn(2,pR),u=pN.copy(o).add(l).add(c).add(n),h=pj.copy(u).subtract(e),d=t.dot(h);return r=Math.min(d,r),s=Math.max(d,s),u.copy(n).add(o).add(l).subtract(c),h.copy(u).subtract(e),r=Math.min(d=t.dot(h),r),s=Math.max(d,s),u.copy(n).add(o).subtract(l).add(c),h.copy(u).subtract(e),r=Math.min(d=t.dot(h),r),s=Math.max(d,s),u.copy(n).add(o).subtract(l).subtract(c),h.copy(u).subtract(e),r=Math.min(d=t.dot(h),r),s=Math.max(d,s),n.copy(u).subtract(o).add(l).add(c),h.copy(u).subtract(e),r=Math.min(d=t.dot(h),r),s=Math.max(d,s),n.copy(u).subtract(o).add(l).subtract(c),h.copy(u).subtract(e),r=Math.min(d=t.dot(h),r),s=Math.max(d,s),n.copy(u).subtract(o).subtract(l).add(c),h.copy(u).subtract(e),r=Math.min(d=t.dot(h),r),s=Math.max(d,s),n.copy(u).subtract(o).subtract(l).subtract(c),h.copy(u).subtract(e),r=Math.min(d=t.dot(h),r),s=Math.max(d,s),i[0]=r,i[1]=s,i}transform(e){this.center.transformAsPoint(e);let t=this.halfAxes.getColumn(0,pL);t.transformAsPoint(e);let i=this.halfAxes.getColumn(1,pO);i.transformAsPoint(e);let r=this.halfAxes.getColumn(2,pR);return r.transformAsPoint(e),this.halfAxes=new pb([...t,...i,...r]),this}getTransform(){throw Error("not implemented")}}let pz=new st,pF=new st;class pB{constructor(e=[0,0,1],t=0){this.normal=new st,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return rv(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=pz.from(e),this.normal.from(t).normalize();let i=-this.normal.dot(e);return this.distance=i,this}fromCoefficients(e,t,i,r){return this.normal.set(e,t,i),rv(rp(this.normal.len(),1)),this.distance=r,this}clone(){return new pB(this.normal,this.distance)}equals(e){return rp(this.distance,e.distance)&&rp(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){let t=pF.copy(this.normal).transformAsVector(e).normalize(),i=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(i,t)}projectPointOntoPlane(e,t=[0,0,0]){let i=pz.from(e),r=this.getPointDistance(i),s=pF.copy(this.normal).scale(r);return i.subtract(s).to(t)}}let pU=[new st([1,0,0]),new st([0,1,0]),new st([0,0,1])],p$=new st,pV=new st;class pW{constructor(e=[]){this.planes=e}fromBoundingSphere(e){this.planes.length=2*pU.length;let t=e.center,i=e.radius,r=0;for(let e of pU){let s=this.planes[r],n=this.planes[r+1];s||(s=this.planes[r]=new pB),n||(n=this.planes[r+1]=new pB);let a=p$.copy(e).scale(-i).add(t);s.fromPointNormal(a,e);let o=p$.copy(e).scale(i).add(t),l=pV.copy(e).negate();n.fromPointNormal(o,l),r+=2}return this}computeVisibility(e){let t=1;for(let i of this.planes)switch(e.intersectPlane(i)){case -1:return -1;case 0:t=0}return t}computeVisibilityWithPlaneMask(e,t){if(rv(Number.isFinite(t),"parentPlaneMask is required."),t===pW.MASK_OUTSIDE||t===pW.MASK_INSIDE)return t;let i=pW.MASK_INSIDE,r=this.planes;for(let s=0;s<this.planes.length;++s){let n=s<31?1<<s:0;if(s<31&&(t&n)==0)continue;let a=r[s],o=e.intersectPlane(a);if(-1===o)return pW.MASK_OUTSIDE;0===o&&(i|=n)}return i}}pW.MASK_OUTSIDE=0xffffffff,pW.MASK_INSIDE=0,pW.MASK_INDETERMINATE=0x7fffffff,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st,new st;let pG=Math.PI/2,pq=Math.PI/4,pH=Math.PI/6,pZ=2*Math.PI;e.s(["EPSILON1",0,.1,"EPSILON10",0,1e-10,"EPSILON11",0,1e-11,"EPSILON12",0,1e-12,"EPSILON13",0,1e-13,"EPSILON14",0,1e-14,"EPSILON15",0,1e-15,"EPSILON16",0,1e-16,"EPSILON17",0,1e-17,"EPSILON18",0,1e-18,"EPSILON19",0,1e-19,"EPSILON2",0,.01,"EPSILON20",0,1e-20,"EPSILON3",0,.001,"EPSILON4",0,1e-4,"EPSILON5",0,1e-5,"EPSILON6",0,1e-6,"EPSILON7",0,1e-7,"EPSILON8",0,1e-8,"EPSILON9",0,1e-9,"PI_OVER_FOUR",0,pq,"PI_OVER_SIX",0,pH,"PI_OVER_TWO",0,pG,"TWO_PI",0,pZ],94069);var pY=e.i(94069),pY=pY;let pX=new pb,pK=new pb,pJ=new pb,pQ=new pb,p0=new pb,p1=[1,0,0],p2=[2,2,1],p3=new st,p4=new st,p6=new st,p5=new st,p8=new st,p7=new pb,p9={diagonal:new pb,unitary:new pb},ge=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],gt=ge.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),gi=gt.concat([[.25,.5],[.75,.5]]);class gr{constructor(e,t,i){this.x=e,this.y=t,this.z=i}get children(){if(!this._children){let e=2*this.x,t=2*this.y,i=this.z+1;this._children=[new gr(e,t,i),new gr(e,t+1,i),new gr(e+1,t,i),new gr(e+1,t+1,i)]}return this._children}update(e){let{viewport:t,cullingVolume:i,elevationBounds:r,minZ:s,maxZ:n,bounds:a,offset:o,project:l}=e,c=this.getBoundingVolume(r,o,l);if(a&&!this.insideBounds(a)||0>i.computeVisibility(c))return!1;if(!this.childVisible){let{z:e}=this;if(e<n&&e>=s&&(e+=Math.floor(Math.log2(c.distanceTo(t.cameraPosition)*t.scale/t.height))),e>=n)return this.selected=!0,!0}for(let t of(this.selected=!1,this.childVisible=!0,this.children))t.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(let t of this._children)t.getSelected(e);return e}insideBounds([e,t,i,r]){let s=512/Math.pow(2,this.z);return this.x*s<i&&this.y*s<r&&(this.x+1)*s>e&&(this.y+1)*s>t}getBoundingVolume(e,t,i){if(i){let t=this.z<1?gi:this.z<2?gt:ge,r=[];for(let s of t){let t=gl(this.x+s[0],this.y+s[1],this.z);t[2]=e[0],r.push(i(t)),e[0]!==e[1]&&(t[2]=e[1],r.push(i(t)))}return function(e,t=new pD){if(!e||0===e.length)return t.halfAxes=new pb([0,0,0,0,0,0,0,0,0]),t.center=new st,t;let i=e.length,r=new st(0,0,0);for(let t of e)r.add(t);let s=1/i;r.multiplyByScalar(s);let n=0,a=0,o=0,l=0,c=0,u=0;for(let t of e){let e=p3.copy(t).subtract(r);n+=e.x*e.x,a+=e.x*e.y,o+=e.x*e.z,l+=e.y*e.y,c+=e.y*e.z,u+=e.z*e.z}n*=s,a*=s,o*=s,l*=s,c*=s,u*=s,p7[0]=n,p7[1]=a,p7[2]=o,p7[3]=a,p7[4]=l,p7[5]=c,p7[6]=o,p7[7]=c,p7[8]=u;let{unitary:h}=function(e,t={}){let i=pY.EPSILON20,r=0,s=0;pK.identity(),pJ.copy(e);let n=i*function(e){let t=0;for(let i=0;i<9;++i){let r=e[i];t+=r*r}return Math.sqrt(t)}(pJ);for(;s<10&&function(e){let t=0;for(let i=0;i<3;++i){let r=e[pX.getElementIndex(p2[i],p1[i])];t+=2*r*r}return Math.sqrt(t)}(pJ)>n;)(function(e,t){let i=pY.EPSILON15,r=0,s=1;for(let t=0;t<3;++t){let i=Math.abs(e[pX.getElementIndex(p2[t],p1[t])]);i>r&&(s=t,r=i)}let n=p1[s],a=p2[s],o=1,l=0;if(Math.abs(e[pX.getElementIndex(a,n)])>i){let t,i=(e[pX.getElementIndex(a,a)]-e[pX.getElementIndex(n,n)])/2/e[pX.getElementIndex(a,n)];o=1/Math.sqrt(1+(t=i<0?-1/(-i+Math.sqrt(1+i*i)):1/(i+Math.sqrt(1+i*i)))*t),l=t*o}pb.IDENTITY.to(t),t[pX.getElementIndex(n,n)]=t[pX.getElementIndex(a,a)]=o,t[pX.getElementIndex(a,n)]=l,t[pX.getElementIndex(n,a)]=-l})(pJ,pQ),p0.copy(pQ).transpose(),pJ.multiplyRight(pQ),pJ.multiplyLeft(p0),pK.multiplyRight(pQ),++r>2&&(++s,r=0);return t.unitary=pK.toTarget(t.unitary),t.diagonal=pJ.toTarget(t.diagonal),t}(p7,p9),d=t.halfAxes.copy(h),f=d.getColumn(0,p6),p=d.getColumn(1,p5),g=d.getColumn(2,p8),m=-Number.MAX_VALUE,y=-Number.MAX_VALUE,v=-Number.MAX_VALUE,x=Number.MAX_VALUE,_=Number.MAX_VALUE,b=Number.MAX_VALUE;for(let t of e)p3.copy(t),m=Math.max(p3.dot(f),m),y=Math.max(p3.dot(p),y),v=Math.max(p3.dot(g),v),x=Math.min(p3.dot(f),x),_=Math.min(p3.dot(p),_),b=Math.min(p3.dot(g),b);f=f.multiplyByScalar(.5*(x+m)),p=p.multiplyByScalar(.5*(_+y)),g=g.multiplyByScalar(.5*(b+v)),t.center.copy(f).add(p).add(g);let w=p4.set(m-x,y-_,v-b).multiplyByScalar(.5),k=new pb([w[0],0,0,0,w[1],0,0,0,w[2]]);return t.halfAxes.multiplyRight(k),t}(r)}let r=512/Math.pow(2,this.z),s=this.x*r+512*t,n=512-(this.y+1)*r;return new pp([s,n,e[0]],[s+r,n+r,e[1]])}}let gs=[-1/0,-1/0,1/0,1/0];function gn(e,t){let i=[t.transformAsPoint([e[0],e[1]]),t.transformAsPoint([e[2],e[1]]),t.transformAsPoint([e[0],e[3]]),t.transformAsPoint([e[2],e[3]])];return[Math.min(...i.map(e=>e[0])),Math.min(...i.map(e=>e[1])),Math.max(...i.map(e=>e[0])),Math.max(...i.map(e=>e[1]))]}function ga({viewport:e,z:t,cullRect:i}){return(e.subViewports||[e]).map(e=>(function e(t,i,r){if(!Array.isArray(i)){let e=r.x-t.x,s=r.y-t.y,{width:n,height:a}=r,o={targetZ:i},l=t.unproject([e,s],o),c=t.unproject([e+n,s],o),u=t.unproject([e,s+a],o),h=t.unproject([e+n,s+a],o);return[Math.min(l[0],c[0],u[0],h[0]),Math.min(l[1],c[1],u[1],h[1]),Math.max(l[0],c[0],u[0],h[0]),Math.max(l[1],c[1],u[1],h[1])]}let s=e(t,i[0],r),n=e(t,i[1],r);return[Math.min(s[0],n[0]),Math.min(s[1],n[1]),Math.max(s[2],n[2]),Math.max(s[3],n[3])]})(e,t||0,i))}function go(e,t){return 512*Math.pow(2,e)/t}function gl(e,t,i){let r=go(i,512),s=Math.PI-2*Math.PI*t/r;return[e/r*360-180,180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))]}function gc(e,t,i,r){let s=go(i,r);return[e/s*512,t/s*512]}let gu="best-available",gh={[gu]:function(e){for(let t of e)t.state=0;for(let t of e)t.isSelected&&!gf(t)&&gp(t);for(let t of e)t.isVisible=!!(2&t.state)},"no-overlap":function(e){for(let t of e)t.state=0;for(let t of e)t.isSelected&&gf(t);for(let t of Array.from(e).sort((e,t)=>e.zoom-t.zoom))if(t.isVisible=!!(2&t.state),t.children&&(t.isVisible||1&t.state))for(let e of t.children)e.state=1;else t.isSelected&&gp(t)},never:()=>{}},gd={extent:null,tileSize:512,maxZoom:null,minZoom:null,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:"best-available",zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{}};function gf(e){let t=e;for(;t;){if(t.isLoaded||t.content)return t.state|=2,!0;t=t.parent}return!1}function gp(e){for(let t of e.children)t.isLoaded||t.content?t.state|=2:gp(t)}class gg extends dR{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){this.state?.tileset?.finalize()}get isLoaded(){return!!this.state?.tileset?.selectedTiles?.every(e=>e.isLoaded&&e.layers&&e.layers.every(e=>e.isLoaded))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state,i=e.propsOrDataChanged||e.updateTriggersChanged,r=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?i&&(t.setOptions(this._getTilesetOptions()),r?t.reloadAll():t.tiles.forEach(e=>{e.layers=null})):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){let{tileSize:e,maxCacheSize:t,maxCacheByteSize:i,refinementStrategy:r,extent:s,maxZoom:n,minZoom:a,maxRequests:o,debounceTime:l,zoomOffset:c}=this.props;return{maxCacheSize:t,maxCacheByteSize:i,maxZoom:n,minZoom:a,tileSize:e,refinementStrategy:r,extent:s,maxRequests:o,debounceTime:l,zoomOffset:c,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){let e=this.state.tileset,{zRange:t,modelMatrix:i}=this.props,r=e.update(this.context.viewport,{zRange:t,modelMatrix:i}),{isLoaded:s}=e,n=this.state.isLoaded!==s,a=this.state.frameNumber!==r;s&&(n||a)&&this._onViewportLoad(),a&&this.setState({frameNumber:r}),this.state.isLoaded=s}_onViewportLoad(){let{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){let{data:t,getTileData:i,fetch:r}=this.props,{signal:s}=e;return(e.url="string"==typeof t||Array.isArray(t)?function(e,t){if(!e||!e.length)return null;let{index:i,id:r}=t;if(Array.isArray(e)){let t=Math.abs(r.split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0))%e.length;e=e[t]}let s=e;for(let e of Object.keys(i)){let t=RegExp(`{${e}}`,"g");s=s.replace(t,String(i[e]))}return Number.isInteger(i.y)&&Number.isInteger(i.z)&&(s=s.replace(/\{-y\}/g,String(Math.pow(2,i.z)-i.y-1))),s}(t,e):null,i)?i(e):r&&e.url?r(e.url,{propName:"data",layer:this,signal:s}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo(e){let t=e.sourceLayer,i=t.props.tile,r=e.info;return r.picked&&(r.tile=i),r.sourceTile=i,r.sourceTileSubLayer=t,r}_updateAutoHighlight(e){e.sourceTileSubLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{let t=this.getSubLayerPropsByTile(e);if(e.isLoaded||e.content)if(e.layers)t&&e.layers[0]&&Object.keys(t).some(i=>e.layers[0].props[i]!==t[i])&&(e.layers=e.layers.map(e=>e.clone(t)));else{let i=this.renderSubLayers({...this.props,...this.getSubLayerProps({id:e.id,updateTriggers:this.props.updateTriggers}),data:e.content,_offset:0,tile:e});e.layers=nM(i,Boolean).map(i=>i.clone({tile:e,...t}))}return e.layers})}filterSubLayer({layer:e,cullRect:t}){let{tile:i}=e.props,{modelMatrix:r}=this.props;return this.state.tileset.isTileVisible(i,t,r?new sV(r):null)}}gg.defaultProps={TilesetClass:class{constructor(e){this._getCullBounds=function(e){let t,i={};return r=>{for(let s in r)if(!function(e,t){if(e===t)return!0;if(Array.isArray(e)){let i=e.length;if(!t||t.length!==i)return!1;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0}return!1}(r[s],i[s])){t=e(r),i=r;break}return t}}(ga),this.opts={...gd,...e},this.setOptions(this.opts),this.onTileLoad=e=>{this.opts.onTileLoad?.(e),null!==this.opts.maxCacheByteSize&&(this._cacheByteSize+=e.byteLength,this._resizeCache())},this._requestScheduler=new pa({throttleRequests:this.opts.maxRequests>0||this.opts.debounceTime>0,maxRequests:this.opts.maxRequests,debounceTime:this.opts.debounceTime}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._zRange=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new sV,this._modelMatrixInverse=new sV}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return null!==this._selectedTiles&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return null!==this._selectedTiles&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(let e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(let e of this._cache.keys()){let t=this._cache.get(e);this._selectedTiles&&this._selectedTiles.includes(t)?t.setNeedsReload():this._cache.delete(e)}}update(e,{zRange:t,modelMatrix:i}={zRange:null,modelMatrix:null}){let r=i?new sV(i):new sV,s=!r.equals(this._modelMatrix);if(this._viewport&&e.equals(this._viewport)&&rp(this._zRange,t)&&!s)this.needsReload&&(this._selectedTiles=this._selectedTiles.map(e=>this._getTile(e.index,!0)));else{s&&(this._modelMatrixInverse=r.clone().invert(),this._modelMatrix=r),this._viewport=e,this._zRange=t;let i=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=i.map(e=>this._getTile(e,!0)),this._dirty&&this._rebuildTree()}let n=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),n&&this._frameNumber++,this._frameNumber}isTileVisible(e,t,i){if(!e.isVisible)return!1;if(t&&this._viewport){let r=this._getCullBounds({viewport:this._viewport,z:this._zRange,cullRect:t}),{bbox:s}=e;for(let[e,t,n,a]of r){let r;if("west"in s)r=s.west<n&&s.east>e&&s.south<a&&s.north>t;else{if(i&&!sV.IDENTITY.equals(i)){let[e,t,r,n]=gn([s.left,s.top,s.right,s.bottom],i);s={left:e,top:t,right:r,bottom:n}}let o=Math.min(s.top,s.bottom),l=Math.max(s.top,s.bottom);r=s.left<n&&s.right>e&&o<a&&l>t}if(r)return!0}return!1}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:i,zRange:r,modelMatrix:s,modelMatrixInverse:n}){let{tileSize:a,extent:o,zoomOffset:l}=this.opts;return function({viewport:e,maxZoom:t,minZoom:i,zRange:r,extent:s,tileSize:n=512,modelMatrix:a,modelMatrixInverse:o,zoomOffset:l=0}){let c=e.isGeospatial?Math.round(e.zoom+Math.log2(512/n))+l:Math.ceil(e.zoom)+l;if("number"==typeof i&&Number.isFinite(i)&&c<i){if(!s)return[];c=i}"number"==typeof t&&Number.isFinite(t)&&c>t&&(c=t);let u=s;return a&&o&&s&&!e.isGeospatial&&(u=gn(s,a)),e.isGeospatial?function(e,t,i,r){let s=e instanceof pu&&e.resolution?e.projectPosition:null,n=new pW(Object.values(e.getFrustumPlanes()).map(({normal:e,distance:t})=>new pB(e.clone().negate(),t))),a=e.distanceScales.unitsPerMeter[2],o=i&&i[0]*a||0,l=i&&i[1]*a||0,c=e instanceof oa&&e.pitch<=60?t:0;if(r){let[e,t,i,s]=r,n=s2([e,s]),a=s2([i,t]);r=[n[0],512-n[1],a[0],512-a[1]]}let u=new gr(0,0,0),h={viewport:e,project:s,cullingVolume:n,elevationBounds:[o,l],minZ:c,maxZ:t,bounds:r,offset:0};if(u.update(h),e instanceof oa&&e.subViewports&&e.subViewports.length>1){for(h.offset=-1;u.update(h)&&!(--h.offset<-3););for(h.offset=1;u.update(h)&&!(++h.offset>3););}return u.getSelected()}(e,c,r,s):function(e,t,i,r,s){var n,a,o;let l,c=(n=e,a=0,o=r,l=n.getBounds(),n.isGeospatial?[Math.max(l[0],o[0]),Math.max(l[1],o[1]),Math.min(l[2],o[2]),Math.min(l[3],o[3])]:[Math.max(Math.min(l[0],o[2]),o[0]),Math.max(Math.min(l[1],o[3]),o[1]),Math.min(Math.max(l[2],o[0]),o[2]),Math.min(Math.max(l[3],o[1]),o[3])]),u=go(t,i),[h,d,f,p]=s?gn(c,s).map(e=>e*u/512):c.map(e=>e*u/512),g=[];for(let e=Math.floor(h);e<f;e++)for(let i=Math.floor(d);i<p;i++)g.push({x:e,y:i,z:t});return g}(e,c,n,u||gs,o)}({viewport:e,maxZoom:t,minZoom:i,zRange:r,tileSize:a,extent:o,modelMatrix:s,modelMatrixInverse:n,zoomOffset:l})}getTileId(e){return`${e.x}-${e.y}-${e.z}`}getTileZoom(e){return e.z}getTileMetadata(e){let{tileSize:t}=this.opts;return{bbox:function(e,t,i,r,s=512){if(e.isGeospatial){let[e,s]=gl(t,i,r),[n,a]=gl(t+1,i+1,r);return{west:e,north:s,east:n,south:a}}let[n,a]=gc(t,i,r,s),[o,l]=gc(t+1,i+1,r,s);return{left:n,top:a,right:o,bottom:l}}(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){let t=Math.floor(e.x/2);return{x:t,y:Math.floor(e.y/2),z:e.z-1}}updateTileStates(){let e=this.opts.refinementStrategy||gu,t=Array(this._cache.size),i=0;for(let e of this._cache.values())t[i++]=e.isVisible,e.isSelected=!1,e.isVisible=!1;for(let e of this._selectedTiles)e.isSelected=!0,e.isVisible=!0;for(let r of(("function"==typeof e?e:gh[e])(Array.from(this._cache.values())),i=0,this._cache.values()))if(t[i++]!==r.isVisible)return!0;return!1}_pruneRequests(){let{maxRequests:e=0}=this.opts,t=[],i=0;for(let e of this._cache.values())e.isLoading&&(i++,e.isSelected||e.isVisible||t.push(e));for(;e>0&&i>e&&t.length>0;)t.shift().abort(),i--}_rebuildTree(){let{_cache:e}=this;for(let t of e.values())t.parent=null,t.children&&(t.children.length=0);for(let t of e.values()){let e=this._getNearestAncestor(t);t.parent=e,e?.children&&e.children.push(t)}}_resizeCache(){let{_cache:e,opts:t}=this,i=t.maxCacheSize??(null!==t.maxCacheByteSize?1/0:5*this.selectedTiles.length),r=t.maxCacheByteSize??1/0;if(e.size>i||this._cacheByteSize>r){for(let[s,n]of e)if(n.isVisible||n.isSelected||(this._cacheByteSize-=null!==t.maxCacheByteSize?n.byteLength:0,e.delete(s),this.opts.onTileUnload?.(n)),e.size<=i&&this._cacheByteSize<=r)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((e,t)=>e.zoom-t.zoom),this._dirty=!1)}_getTile(e,t){let i=this.getTileId(e),r=this._cache.get(i),s=!1;return!r&&t?(Object.assign(r=new po(e),this.getTileMetadata(r.index)),Object.assign(r,{id:i,zoom:this.getTileZoom(r.index)}),s=!0,this._cache.set(i,r),this._dirty=!0):r&&r.needsReload&&(s=!0),r&&s&&r.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),r}_getNearestAncestor(e){let{_minZoom:t=0}=this,i=e.index;for(;this.getTileZoom(i)>t;){i=this.getParentIndex(i);let e=this._getTile(i);if(e)return e}return null}},data:{type:"data",value:[]},dataComparator:(e,t)=>{if(e===t)return!0;if(!Array.isArray(e)||!Array.isArray(t))return!1;let i=e.length;if(i!==t.length)return!1;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0},renderSubLayers:{type:"function",value:e=>new ps(e)},getTileData:{type:"function",optional:!0,value:null},onViewportLoad:{type:"function",optional:!0,value:null},onTileLoad:{type:"function",value:e=>{}},onTileUnload:{type:"function",value:e=>{}},onTileError:{type:"function",value:e=>console.error(e)},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:gu,zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0},gg.layerName="TileLayer";let gm={longitude:-73.9777,latitude:40.7527,zoom:10.6,minZoom:8.5,maxZoom:16,pitch:5,bearing:-4},gy=new oW({ambientLight:new oL({color:[255,255,255],intensity:.65}),directionalLights:[new class extends oj{constructor(e){super(e),this.timestamp=e.timestamp}getProjectedLight({layer:e}){let{viewport:t}=e.context;if(t.resolution&&t.resolution>0){let[e,t,i]=dw(this.timestamp,0,0);this.direction=[e,-i,t]}else{let{latitude:e,longitude:i}=t;this.direction=dw(this.timestamp,e,i)}return this}}({timestamp:Date.UTC(2024,4,18,20),color:[253,186,116],intensity:1.1,direction:[-.7,-.6,-.5]})]});function gv({scenario:e,focus:t,highlights:i=[]}){let[r,s]=(0,D.useState)(gm),[n,a]=(0,D.useState)("supported"),o=(0,D.useMemo)(()=>.55+t/100*.55,[t]),l=(0,D.useMemo)(()=>new gg({id:"osm-base-tiles",data:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",minZoom:0,maxZoom:19,tileSize:256,refinementStrategy:"best-available",renderSubLayers:e=>{let{tile:t,data:i}=e;if(!t||!t.bbox||!i)return null;let{west:r,south:s,east:n,north:a}=t.bbox;return new dE(e,{data:null,image:i,bounds:[r,s,n,a]})}}),[]),c=(0,D.useMemo)(()=>e.layers.flatMap(e=>(function(e,t){switch(e.visualization){case"choropleth":case"flow":default:return[];case"point":{let i=gb(3+4*t,3,12);return[new dx({id:`scenario-${e.id}-points`,data:e.dataset.features,pickable:!0,parameters:{depthTest:!1},getPosition:e=>e.geometry.coordinates,radiusUnits:"pixels",getRadius:()=>i,getFillColor:()=>g_(e.style.color,.65+.25*t),getLineColor:()=>g_(e.style.secondaryColor??e.style.color,.9),lineWidthUnits:"pixels",lineWidthMinPixels:1.8,updateTriggers:{getRadius:i}})]}}})(e,o)).filter(e=>!!e),[e.layers,o]),u=(0,D.useMemo)(()=>{if(0===i.length)return null;let e=gb(5+8*o,5,18);return new dx({id:"scenario-highlights",data:i.slice(0,6),pickable:!0,parameters:{depthTest:!1},getPosition:e=>e.coordinates,radiusUnits:"pixels",getRadius:()=>e,getFillColor:[14,165,233,210],getLineColor:[236,254,255,240],lineWidthUnits:"pixels",lineWidthMinPixels:2,updateTriggers:{getRadius:e}})},[i,o]);(0,D.useEffect)(()=>{requestAnimationFrame(()=>{let e=document.createElement("canvas");a(["webgl2","webgl","experimental-webgl"].some(t=>null!==e.getContext(t))?"supported":"unsupported")})},[]);let h=(0,D.useMemo)(()=>{let e=[l,...c];return u&&e.push(u),e},[l,c,u]),d=(0,D.useMemo)(()=>e=>{let{object:t,layer:i}=e;if(!t||!i)return null;if("scenario-highlights"===i.id)return{html:[`<div class="font-semibold text-slate-900">${t.sensorId}</div>`,`<div class="text-[12px] text-slate-500">${t.sensorType}${t.district?` \xb7 ${t.district}`:""}</div>`,`<div class="mt-1 text-[12px] text-slate-600">Score ${t.anomalyScore.toFixed(2)}</div>`,t.health?`<div class="mt-1 inline-flex rounded-full bg-slate-100 px-2 py-[2px] text-[11px] font-medium text-slate-600">${t.health}</div>`:""].join(""),style:gx};let r="properties"in t?t.properties??void 0:void 0;if(!r)return null;let s=r.district??r.program??r.indicator??r.name;if(!s)return null;let n=[r.priority,r.status,r.stage,r.leadTheme,r.leadAgency,r.borough].map(e=>"string"==typeof e?e:null).filter(Boolean).join("  "),a=function(e){for(let[t,i]of[["sdgComposite",e=>`${(100*e).toFixed(0)} index`],["impactScore",e=>`${Math.round(100*e)} impact`],["progressIndex",e=>`${Math.round(100*e)} progress`],["householdsReached",e=>`${Math.round(e/1e3)}k households`],["wellbeingScore",e=>`${Math.round(e)} wellbeing`],["resilienceScore",e=>`${Math.round(100*e)} resilience`],["score",e=>e.toFixed(2)],["percentage",e=>`${Math.round(e)}%`],["height",e=>`${Math.round(e)} m`]]){let r=e[t];if("number"==typeof r&&Number.isFinite(r))return i(r)}return null}(r);return{html:[`<div class="font-semibold text-slate-900">${s}</div>`,n?`<div class="text-[12px] text-slate-500">${n}</div>`:"",null!==a?`<div class="mt-1 text-[12px] text-slate-600">Metric ${a}</div>`:""].join(""),style:gx}},[]),f=(0,D.useCallback)(e=>{s(t=>({...t,zoom:gb(t.zoom+e,t.minZoom??4,t.maxZoom??18)}))},[]),p=(0,D.useCallback)(e=>{let t=e?.viewState;t&&"object"==typeof t&&"longitude"in t&&"latitude"in t&&"zoom"in t&&s(e=>({...e,longitude:Number(t.longitude)||e.longitude,latitude:Number(t.latitude)||e.latitude,zoom:Number(t.zoom)||e.zoom,minZoom:"minZoom"in t&&"number"==typeof t.minZoom?t.minZoom:e.minZoom,maxZoom:"maxZoom"in t&&"number"==typeof t.maxZoom?t.maxZoom:e.maxZoom,pitch:"pitch"in t&&"number"==typeof t.pitch?t.pitch:e.pitch,bearing:"bearing"in t&&"number"==typeof t.bearing?t.bearing:e.bearing}))},[]);return(0,j.jsxs)("div",{className:"relative h-[360px] w-full overflow-hidden rounded-[32px] bg-gradient-to-br from-slate-100 via-slate-200/90 to-slate-100 sm:h-[440px] lg:h-[520px] xl:h-[560px]",children:["supported"===n?(0,j.jsx)(du,{viewState:r,controller:{dragPan:!0,scrollZoom:!0,dragRotate:!1,doubleClickZoom:!0,touchZoom:!0},onViewStateChange:p,layers:h,effects:[gy],getTooltip:d,parameters:{clearColor:[.94,.97,.99,1]}}):"unsupported"===n?(0,j.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-gradient-to-br from-slate-100 via-slate-200/90 to-slate-100 text-sm font-medium text-slate-500",children:"Interactive map unavailable on this device."}):(0,j.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-gradient-to-br from-slate-100 via-slate-200/90 to-slate-100 text-sm font-medium text-slate-500",children:"Preparing interactive map"}),(0,j.jsx)("div",{className:"pointer-events-none absolute left-6 top-6 rounded-full bg-white/90 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-500 shadow-sm ring-1 ring-slate-900/5",children:"New York City"}),(0,j.jsxs)("div",{className:"absolute right-6 top-6 flex flex-col gap-2",children:[(0,j.jsx)("button",{type:"button",className:"rounded-full bg-white/95 p-2 shadow-md ring-1 ring-slate-900/10 transition hover:scale-105 hover:bg-white",onClick:()=>f(.6),"aria-label":"Zoom in",children:(0,j.jsx)("span",{className:"block text-base font-semibold text-slate-600",children:"+"})}),(0,j.jsx)("button",{type:"button",className:"rounded-full bg-white/95 p-2 shadow-md ring-1 ring-slate-900/10 transition hover:scale-105 hover:bg-white",onClick:()=>f(-.6),"aria-label":"Zoom out",children:(0,j.jsx)("span",{className:"block text-base font-semibold text-slate-600",children:"-"})})]})]})}let gx={backgroundColor:"rgba(255,255,255,0.95)",borderRadius:"12px",padding:"10px 12px",boxShadow:"0 18px 32px -20px rgba(15,23,42,0.35)",border:"1px solid rgba(148, 163, 184, 0.2)",color:"#0f172a"};function g_(e,t=1){let i=e.replace("#",""),r=3===i.length?i.split("").map(e=>`${e}${e}`).join(""):i,s=Number.parseInt(r,16);return Number.isNaN(s)||6!==r.length?[30,64,175,Math.round(255*t)]:[s>>16&255,s>>8&255,255&s,Math.round(255*gb(t,0,1))]}function gb(e,t,i){return Math.min(i,Math.max(t,e))}var gw=e.i(20688),gk=e.i(97265);let gP=[{id:"ingestion",title:"Telemetry Ingestion",status:"complete",etaMinutes:0,completion:100,summary:"64 feeds cleaned and aligned with the twin.",insights:["Duplicate curb sensors removed before features load."],kpis:[{id:"ingestion-latency",label:"Pipeline latency",value:"84 s",deltaLabel:"-18%",direction:"down",narrative:"GPU streaming keeps weather feeds under 90 seconds."}],compliance:[{id:"gdpr",label:"GDPR",status:"pass",description:"PII removed across mobility surveys."}],artifacts:[{id:"feature-store",label:"Feature store snapshot",detail:"118 features ready for modeling."}],auditTrail:[{timestamp:"07:42",actor:"Pipeline bot",message:"All connectors returned healthy responses."},{timestamp:"07:48",actor:"Ops analyst",message:"Flagged EV charger feed for follow-up."}],trend:{id:"ingestion-throughput",title:"Feeds cleared",metricLabel:"per 15 min",points:[{label:"07:00",value:28},{label:"07:15",value:31},{label:"07:30",value:34},{label:"07:45",value:36},{label:"08:00",value:38}],baselineLabel:"Target",baselineValue:32,summary:"Running 18% faster than last week's pull."}},{id:"classification",title:"SDG Classification",status:"active",etaMinutes:6,completion:68,summary:"Models tag telemetry with SDG codes and policy context.",insights:["Equity scan flagged a subsidy gap in East Dock."],kpis:[{id:"classification-precision",label:"Classification precision",value:"97.4%",deltaLabel:"+2.1%",direction:"up",narrative:"Active learning used the latest permit checks."}],compliance:[{id:"undp",label:"UN SDG taxonomy",status:"pass",description:"Indicators mapped with source evidence."},{id:"equity-scan",label:"Equity scan",status:"attention",description:"Needs fresh census microdata for East Dock."}],artifacts:[{id:"taxonomy-crosswalk",label:"Taxonomy crosswalk",detail:"SDG to city KPI table with confidence scores."}],auditTrail:[{timestamp:"08:03",actor:"Model ops",message:"Scaled GPU nodes to 3 for inference."},{timestamp:"08:05",actor:"Policy engine",message:"Loaded 2025 VLR guidance update."}],trend:{id:"classification-confidence",title:"Model confidence",metricLabel:"precision",unit:"%",points:[{label:"07:30",value:94.2},{label:"07:45",value:95.6},{label:"08:00",value:96.1},{label:"08:15",value:97.4}],baselineLabel:"Floor",baselineValue:92,summary:"Active learning lifted precision above the 95% floor."}},{id:"scoring",title:"KPI Scoring",status:"pending",etaMinutes:12,completion:24,summary:"Simulator checks live KPIs against last year.",insights:["Micromobility share is 12 points above last year."],kpis:[{id:"mobility-delta",label:"Mobility uplift",value:"+12.6 pts",deltaLabel:"+12.6 pts",direction:"up",narrative:"Curb pilots boosting throughput in Innovation Corridor."}],compliance:[{id:"audit-readiness",label:"Audit readiness",status:"pass",description:"Variance explanations link to twin snapshots."},{id:"kpi-governance",label:"KPI governance",status:"attention",description:"Waiting on budget sign-off for affordability metric."}],artifacts:[{id:"scenario-sheets",label:"Scenario sheets",detail:"Baseline vs. improved comparison for 2023-2025."}],auditTrail:[{timestamp:"08:12",actor:"Twin simulator",message:"Monte Carlo batch #2 at 70% completion."},{timestamp:"08:15",actor:"Finance liaison",message:"Budget office notified for affordability review."}],trend:{id:"scoring-uplift",title:"Mobility uplift",metricLabel:"vs baseline",unit:"pts",points:[{label:"Baseline",value:0},{label:"Week 1",value:4.5},{label:"Week 2",value:7.3},{label:"Week 3",value:9.8},{label:"Week 4",value:12.6}],baselineLabel:"Goal",baselineValue:8,summary:"Mobility plan is already four points above the quarterly goal."}},{id:"narrative",title:"Narrative Assembly",status:"pending",etaMinutes:18,completion:12,summary:"Writer bot turns KPIs into clear VLR stories.",insights:["Executive summary waits for SDG 9 evidence."],kpis:[{id:"draft-speed",label:"Draft speed",value:"4m 28s",deltaLabel:"-1.9 min",direction:"down",narrative:"Template tuning trimmed drafting time this week."}],compliance:[{id:"language-pack",label:"Language pack",status:"pass",description:"Multilingual glossary validated."},{id:"sensitivity",label:"Sensitivity review",status:"risk",description:"Human review needed for coastal displacement section."}],artifacts:[{id:"briefing-deck",label:"Briefing deck",detail:"Slides with twin heatmaps ready for export."}],auditTrail:[{timestamp:"08:20",actor:"Narrative bot",message:"Drafted climate resilience chapter v1.4."},{timestamp:"08:23",actor:"Sensitivity reviewer",message:"Requested community quotes for Harbor District."}],trend:{id:"narrative-cycle",title:"Draft cycle time",metricLabel:"per chapter",unit:"min",points:[{label:"Kickoff",value:9.4},{label:"Climate",value:6.2},{label:"Equity",value:5.5},{label:"Mobility",value:4.8}],baselineLabel:"Target",baselineValue:6,summary:"Playbooks keep chapters under the six minute target."}}],gS=[{id:"heat-strategy",severity:"warning",message:"Heat plan pending for two waterfront schools.",suggestedAction:"Trigger the cooling shelter protocol."},{id:"der-incentives",severity:"critical",message:"DER incentives need council approval before the Q4 vote.",suggestedAction:"Book a finance briefing with the innovation committee."},{id:"equity-gap",severity:"info",message:"Mobility subsidy data missing for East Dock.",suggestedAction:"Request census microdata and fare card reports."}],gT={type:"FeatureCollection",name:"ImpactCorridors",features:[{type:"Feature",properties:{program:"Civic Learning Spine",sdgTarget:"SDG 4.3  Lifelong Learning Access",impactScore:.91,stage:"Scaling",leadAgency:"Department of Learning Innovation"},geometry:{type:"LineString",coordinates:[[-74.012,40.704],[-74.002,40.716],[-73.989,40.73],[-73.977,40.744]]}},{type:"Feature",properties:{program:"Coastal Resilience Walk",sdgTarget:"SDG 13.1  Climate Preparedness",impactScore:.84,stage:"Pilot",leadAgency:"Urban Coast Office"},geometry:{type:"LineString",coordinates:[[-74.018,40.708],[-74.009,40.721],[-73.995,40.732],[-73.984,40.741]]}},{type:"Feature",properties:{program:"Innovation Commons Stroll",sdgTarget:"SDG 11.7  Public Space Equity",impactScore:.79,stage:"Discovery",leadAgency:"Civic Commons Lab"},geometry:{type:"LineString",coordinates:[[-73.982,40.768],[-73.971,40.778],[-73.959,40.785],[-73.947,40.793]]}}]},gC={type:"FeatureCollection",name:"DistrictSnapshots",features:[{type:"Feature",properties:{district:"Harbor Resilience Loop",sdgComposite:.86,leadTheme:"Climate Adaptation",householdsReached:186e3,priority:"Accelerate"},geometry:{type:"Polygon",coordinates:[[[-74.018,40.699],[-74.002,40.712],[-73.996,40.706],[-74.01,40.693],[-74.018,40.699]]]}},{type:"Feature",properties:{district:"Innovation Basin Studio",sdgComposite:.72,leadTheme:"Skills & Jobs",householdsReached:94e3,priority:"Stabilize"},geometry:{type:"Polygon",coordinates:[[[-73.999,40.741],[-73.985,40.748],[-73.973,40.739],[-73.988,40.733],[-73.999,40.741]]]}},{type:"Feature",properties:{district:"Northern Commons Network",sdgComposite:.9,leadTheme:"Housing Inclusion",householdsReached:158e3,priority:"Monitor"},geometry:{type:"Polygon",coordinates:[[[-73.972,40.795],[-73.958,40.803],[-73.946,40.792],[-73.96,40.784],[-73.972,40.795]]]}}]},gM={type:"FeatureCollection",name:"IndicatorSites",features:[{type:"Feature",properties:{id:"SDG-204",indicator:"Affordable Housing Access",sdgTarget:"SDG 11.1",status:"On Track",progressIndex:.82,refreshMinutesAgo:4,district:"Aurora District"},geometry:{type:"Point",coordinates:[-73.995,40.734]}},{type:"Feature",properties:{id:"SDG-441",indicator:"Green Schoolyards Coverage",sdgTarget:"SDG 3.4",status:"Watch",progressIndex:.63,refreshMinutesAgo:2,district:"Harbor Resilience Loop"},geometry:{type:"Point",coordinates:[-74.006,40.715]}},{type:"Feature",properties:{id:"SDG-109",indicator:"Clean Energy Retrofits",sdgTarget:"SDG 7.2",status:"On Track",progressIndex:.74,refreshMinutesAgo:1,district:"Aurora Medical Campus"},geometry:{type:"Point",coordinates:[-73.958,40.79]}},{type:"Feature",properties:{id:"SDG-512",indicator:"Community Health Access",sdgTarget:"SDG 3.8",status:"Delayed",progressIndex:.41,refreshMinutesAgo:17,district:"Care Corridor Spine"},geometry:{type:"Point",coordinates:[-73.981,40.758]}},{type:"Feature",properties:{id:"SDG-317",indicator:"Urban Cooling Canopies",sdgTarget:"SDG 13.1",status:"Watch",progressIndex:.58,refreshMinutesAgo:3,district:"Innovation Basin Studio"},geometry:{type:"Point",coordinates:[-73.973,40.743]}},{type:"Feature",properties:{id:"SDG-204B",indicator:"Resilient Infrastructure Upgrades",sdgTarget:"SDG 9.1",status:"Watch",progressIndex:.69,refreshMinutesAgo:6,district:"Harbor Resilience Loop"},geometry:{type:"Point",coordinates:[-74.01,40.706]}},{type:"Feature",properties:{id:"SDG-626",indicator:"Civic Wi-Fi Coverage",sdgTarget:"SDG 9.c",status:"On Track",progressIndex:.77,refreshMinutesAgo:5,district:"Civic Learning Spine"},geometry:{type:"Point",coordinates:[-73.948,40.772]}}]},gA=Object.fromEntries(gk.citywideKpis.map(e=>[e.id,e]));function gI(e){return e.map(e=>gA[e]).filter(e=>!!e).map(e=>({...e}))}let gE={"sdg-localization":{key:"sdg-localization",name:"SDG Localization",tagline:"District SDG scorecards update in real time.",narrative:"Census, budget, and survey feeds flag which districts fall behind so crews can move before targets slip.",command:"Resolve the two districts slipping before the daily stand-up.",liveSignals:[{label:"Districts on track",value:"12 of 18",delta:"+1 today",tone:"positive"},{label:"Data refresh",value:"98%",delta:"Live",tone:"positive"}],aiInsights:[{title:"Send the tutoring crew back to Innovation Basin.",detail:"Attendance dipped in two schools; a mobile team lifts SDG 4 back on track within five days.",confidence:.82}],kpis:gI(["sdg-progress"]),layers:[{id:"district-sdg-composite",label:"District SDG Composite",legend:"Blue shows overall SDG score for each district.",visualization:"choropleth",dataset:gC,style:{color:"#38bdf8",secondaryColor:"#0ea5e9",intensity:.78}},{id:"indicator-observatories",label:"Indicator Observatories",legend:"Pins mark indicators drifting from plan.",visualization:"point",dataset:gM,style:{color:"#7c3aed",secondaryColor:"#a855f7",intensity:.62}},{id:"impact-corridors",label:"Impact Corridors",legend:"Lines show active programs boosting SDG delivery.",visualization:"flow",dataset:gT,style:{color:"#0ea5e9",secondaryColor:"#22d3ee",intensity:.7}}],actions:["Deploy the mobile tutoring team to Innovation Basin.","Add Harbor Loops climate win to tomorrows VLR brief."]},"vlr-automation":{key:"vlr-automation",name:"VLR Automation Console",tagline:"AI keeps the voluntary local review on schedule.",narrative:"Evidence from finance, climate, and community teams syncs automatically so drafts stay ready for sign-off.",command:"Publish the executive summary by Friday.",liveSignals:[{label:"Sections ready",value:"7 / 9",delta:"+2 today",tone:"positive"},{label:"Evidence cleared",value:"92%",delta:"+6%",tone:"positive"}],aiInsights:[{title:"SDG 9 packet still waits on invoice tags.",detail:"Finance is missing two project codes; approve the fetch and the automation will reconcile them.",confidence:.9}],kpis:gI(["vlr-ready"]),layers:[{id:"evidence-corridors",label:"Evidence Corridors",legend:"Lines show which programs feed the VLR workspace.",visualization:"flow",dataset:gT,style:{color:"#14b8a6",secondaryColor:"#22c55e",intensity:.68}},{id:"evidence-sites",label:"Evidence Sites",legend:"Pins highlight packets waiting for review.",visualization:"point",dataset:gM,style:{color:"#f97316",secondaryColor:"#fb923c",intensity:.58}}],actions:["Nudge finance to clear the SDG 9 invoices.","Publish the SDG 11 public space story after quotes land."]},"city-profiling":{key:"city-profiling",name:"City Profiling Studio",tagline:"Compare wellbeing lift by district.",narrative:"The twin blends demographics, capital plans, and sentiment to show which projects move wellbeing fastest.",command:"Select the next three districts for council funding.",liveSignals:[{label:"Wellbeing score",value:"74 index",delta:"+4 pts",tone:"positive"},{label:"Capital on track",value:"81% funded",delta:"-3%",tone:"warning"}],aiInsights:[{title:"Northern Commons still delivers the biggest lift.",detail:"A $14M streetscape bundle lifts wellbeing six points without raising displacement risk.",confidence:.88}],kpis:gI(["wellbeing-score","capital-ready"]),layers:[{id:"profile-districts",label:"District Profiles",legend:"Purple shows overall wellbeing score.",visualization:"choropleth",dataset:gC,style:{color:"#a855f7",secondaryColor:"#6366f1",intensity:.74}},{id:"investment-corridors",label:"Investment Corridors",legend:"Lines trace priority capital programs.",visualization:"flow",dataset:gT,style:{color:"#38bdf8",secondaryColor:"#22d3ee",intensity:.65}},{id:"wellbeing-sentinels",label:"Wellbeing Sentinels",legend:"Pins pulse if wellbeing deviates from forecast.",visualization:"point",dataset:gM,style:{color:"#22c55e",secondaryColor:"#4ade80",intensity:.6}}],actions:["Advance the Northern Commons package to the council agenda.","Share Harbor Loop shoreline options with the budget office."]}};gk.demandForecast,gk.resilienceForecast,gk.anomalyClusters;var gL=e.i(75157),gO=e.i(98298);let gR=[{id:"digital-twin",label:"GIS City Analysis",description:"City map with SDG signals.",icon:U},{id:"vlr",label:"VLR Automation",description:"Track the review workflow.",icon:$},{id:"pipelines",label:"AI Pipelines",description:"See forecasts and model health.",icon:B},{id:"policy-insights",label:"Policy Insights",description:"Executive-ready directives.",icon:z.Gavel}],gN={"digital-twin":"sdg-localization",vlr:"vlr-automation",pipelines:"city-profiling"},gj={ingestion:"Data check",classification:"Tag evidence",scoring:"Score outcomes",narrative:"Draft stories"},gD={warning:"bg-amber-100 text-amber-700",critical:"bg-rose-100 text-rose-700",info:"bg-sky-100 text-sky-700"},gz={warning:"Attention",critical:"Urgent",info:"Info"};function gF(){let[e,t]=(0,D.useState)("digital-twin"),[i,r]=(0,D.useState)(55),s=gN[e],n=s?gE[s]:null;if(s&&!n)throw Error(`Scenario not found for key ${s}`);let a=(0,D.useMemo)(()=>{let e;if(!s)return{signals:[],aiInsights:[],kpis:[],actions:[]};let t=(e=gE[s])?{signals:e.liveSignals,aiInsights:e.aiInsights,kpis:e.kpis,actions:e.actions}:[];return Array.isArray(t)?{signals:[],aiInsights:[],kpis:[],actions:[]}:t},[s]),o=(0,D.useMemo)(()=>{let e;return n?(e=[],n.layers.filter(e=>"point"===e.visualization).forEach(t=>{t.dataset.features.forEach((i,r)=>{if(i.geometry?.type!=="Point")return;let s=i.geometry.coordinates;if(!Array.isArray(s)||s.length<2)return;let[n,a]=s;if("number"!=typeof n||"number"!=typeof a)return;let o=i.properties??{},l="number"==typeof o.progressIndex?o.progressIndex:null,c="number"==typeof o.anomalyScore?o.anomalyScore:null!==l?1-Math.min(Math.max(l,0),1):.45;e.push({id:String(o.id??i.id??`${t.id}-${r}`),sensorId:"string"==typeof o.id?o.id:`Node-${r+1}`,sensorType:"string"==typeof o.indicator?o.indicator:t.label,layerLabel:t.label,district:"string"==typeof o.district?o.district:null,health:"string"==typeof o.status?o.status:null,anomalyScore:Math.min(Math.max(c,0),1),lastReadingMinutes:"number"==typeof o.refreshMinutesAgo?o.refreshMinutesAgo:"number"==typeof o.lastReadingMinutesAgo?o.lastReadingMinutesAgo:null,coordinates:[n,a]})})}),e.slice(0,6)):[]},[n]);return(0,j.jsxs)("div",{className:"min-h-screen bg-slate-50 text-slate-900",children:[(0,j.jsx)(gO.TopBar,{}),(0,j.jsx)("main",{className:"mx-auto w-full max-w-7xl px-4 pb-16 pt-6 sm:px-6 lg:px-8",children:(0,j.jsxs)("div",{className:"flex flex-col gap-6 lg:flex-row lg:items-start",children:[(0,j.jsx)(g$,{activeModule:e,onSelect:t}),(0,j.jsxs)("div",{className:"flex-1 space-y-8",children:["policy-insights"!==e?(0,j.jsx)(gB,{}):null,(0,j.jsx)(gU,{activeModule:e,onSelect:t,className:"lg:hidden"}),"digital-twin"===e&&n?(0,j.jsx)(gV,{scenario:n,insights:a,focus:i,onFocusChange:r,highlights:o}):null,"vlr"===e&&n?(0,j.jsx)(gG,{scenario:n}):null,"pipelines"===e?(0,j.jsx)(gZ,{}):null,"policy-insights"===e?(0,j.jsx)(gw.PolicyInsightsExperience,{variant:"embedded"}):null]})]})})]})}function gB(){let e=gk.citywideKpis.filter(e=>"sdg-progress"===e.id||"vlr-ready"===e.id);return(0,j.jsx)("section",{className:"mb-8 grid gap-3 sm:grid-cols-2",children:e.map(e=>{let t="up"===e.change.direction?"text-emerald-600":"text-rose-600",i=e.changeLabel??`${"up"===e.change.direction?"+":""}${e.change.percentage.toFixed(1)}% vs last ${e.change.period}`;return(0,j.jsxs)("article",{className:"flex flex-col justify-between rounded-3xl border border-slate-200 bg-white p-4 shadow-sm sm:p-5",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("h2",{className:"text-sm font-medium text-slate-600",children:e.label}),(0,j.jsxs)("p",{className:"mt-3 flex items-baseline gap-2 text-slate-900",children:[(0,j.jsx)("span",{className:"text-3xl font-semibold",children:e.value}),(0,j.jsx)("span",{className:"text-sm font-medium text-slate-500",children:e.unit})]})]}),(0,j.jsx)("p",{className:(0,gL.cn)("mt-4 text-xs font-medium",t),children:i})]},e.id)})})}function gU({activeModule:e,onSelect:t,className:i}){return(0,j.jsx)("nav",{className:(0,gL.cn)("mb-6 flex flex-wrap gap-2",i),children:gR.map(i=>{let r=e===i.id;return(0,j.jsxs)("button",{type:"button",onClick:()=>t(i.id),className:(0,gL.cn)("flex items-center gap-3 rounded-2xl border px-3 py-2 text-left text-sm transition-colors",r?"border-slate-300 bg-white text-slate-900 shadow-sm":"border-transparent bg-slate-100 text-slate-500 hover:border-slate-200 hover:bg-white"),children:[(0,j.jsx)("span",{className:(0,gL.cn)("flex h-8 w-8 items-center justify-center rounded-xl text-sky-600",r?"bg-sky-100":"bg-slate-200/70"),children:(0,j.jsx)(i.icon,{className:"h-4 w-4"})}),(0,j.jsxs)("span",{children:[(0,j.jsx)("span",{className:"block text-sm font-semibold",children:i.label}),(0,j.jsx)("span",{className:"block text-xs text-slate-400",children:i.description})]})]},i.id)})})}function g$({activeModule:e,onSelect:t}){return(0,j.jsx)("aside",{className:"hidden shrink-0 lg:block lg:w-60 xl:w-64",children:(0,j.jsxs)("nav",{className:"sticky top-24 flex flex-col gap-1 rounded-3xl border border-slate-200 bg-white px-3 py-4 shadow-sm",children:[(0,j.jsx)("p",{className:"px-2 pb-2 text-xs font-semibold uppercase tracking-wide text-slate-400",children:"Modules"}),gR.map(i=>{let r=e===i.id;return(0,j.jsxs)("button",{type:"button",onClick:()=>t(i.id),className:(0,gL.cn)("flex items-start gap-3 rounded-2xl px-3 py-3 text-left transition-colors",r?"bg-sky-50 text-slate-900 shadow-[0_12px_32px_-24px_rgba(14,165,233,0.65)]":"text-slate-500 hover:bg-slate-100 hover:text-slate-800"),"aria-current":r?"page":void 0,children:[(0,j.jsx)("span",{className:(0,gL.cn)("mt-0.5 flex h-9 w-9 items-center justify-center rounded-xl border text-sky-600",r?"border-sky-200 bg-white":"border-transparent bg-slate-200/60 text-slate-500"),children:(0,j.jsx)(i.icon,{className:"h-4 w-4"})}),(0,j.jsxs)("span",{className:"flex-1",children:[(0,j.jsx)("span",{className:"block text-sm font-semibold",children:i.label}),(0,j.jsx)("span",{className:"mt-1 block text-xs text-slate-400",children:i.description})]})]},i.id)})]})})}function gV({scenario:e,insights:t,focus:i,highlights:r}){let s=t.signals.slice(0,3),n=t.aiInsights[0],a=t.actions.slice(0,2),o=t.kpis.slice(0,2),l=r.slice(0,3),c=gk.demandForecast.points.slice(0,6).map(e=>({periodLabel:gY(e.timestamp),percentage:Math.round(100*e.value)})),u=c.length>0?c[c.length-1]?.percentage??null:null,h=c.length>0?c[0]?.percentage??null:null,d=null!==u&&null!==h?u-h:null,f=null!==d?`${d>=0?"+":""}${d.toFixed(0)} pts`:null,p=null!==d?d>=0?"text-emerald-600":"text-rose-600":"text-slate-400",g=[...s.map(e=>({id:`signal-${e.label}`,label:e.label,value:e.value,helper:e.delta})),...o.map(e=>({id:`kpi-${e.id}`,label:e.label,value:`${e.value} ${e.unit}`.trim(),helper:e.changeLabel??null}))];return(0,j.jsx)("section",{children:(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6 lg:p-7",children:[(0,j.jsxs)("header",{className:"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("h2",{className:"text-lg font-semibold text-slate-900 sm:text-xl",children:e.name}),(0,j.jsx)("p",{className:"text-sm text-slate-500",children:e.tagline})]}),(0,j.jsxs)("p",{className:"text-xs text-slate-400",children:["Brief  ",e.command]})]}),(0,j.jsxs)("div",{className:"mt-6 grid gap-6 lg:grid-cols-[minmax(0,8.5fr)_minmax(0,3.5fr)] xl:gap-10",children:[(0,j.jsx)("div",{className:"space-y-4",children:(0,j.jsxs)("div",{className:"relative h-[400px] w-full overflow-hidden rounded-[36px] border border-slate-200 bg-slate-100/40 sm:h-[460px] lg:h-[560px] xl:h-[600px]",children:[(0,j.jsx)(gv,{scenario:e,focus:i,highlights:r}),(0,j.jsx)(gW,{highlights:l})]})}),(0,j.jsxs)("aside",{className:"space-y-4",children:[l.length?(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-4 shadow-sm",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-700",children:"Active hotspots"}),(0,j.jsx)("ul",{className:"mt-3 space-y-2",children:l.map(e=>{let t=`${Math.round(100*e.anomalyScore)}% watch`,i="Delayed"===e.health?"text-rose-600":"Watch"===e.health?"text-amber-600":"text-emerald-600";return(0,j.jsxs)("li",{className:"rounded-2xl bg-slate-50 px-3 py-2 text-sm text-slate-600",children:[(0,j.jsxs)("p",{className:"flex items-center justify-between text-sm font-semibold text-slate-900",children:[(0,j.jsx)("span",{children:e.sensorType}),(0,j.jsx)("span",{className:"text-xs font-medium text-slate-400",children:t})]}),(0,j.jsx)("p",{className:"mt-1 text-xs text-slate-500",children:[e.district??"Citywide",e.sensorId].filter(Boolean).join("  ")}),(0,j.jsx)("p",{className:(0,gL.cn)("mt-1 text-xs font-medium",i),children:e.health??"On track"})]},e.id)})})]}):null,g.length?(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-4 shadow-sm",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-700",children:"Live numbers"}),(0,j.jsx)("ul",{className:"mt-3 space-y-2",children:g.map(e=>(0,j.jsxs)("li",{className:"flex items-baseline justify-between gap-3 rounded-2xl bg-slate-50 px-3 py-2",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:e.value}),(0,j.jsx)("p",{className:"text-xs text-slate-500",children:e.label})]}),e.helper?(0,j.jsx)("span",{className:"text-xs font-medium text-slate-400",children:e.helper}):null]},e.id))})]}):null,c.length?(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-4 shadow-sm",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-700",children:"Gender parity outlook"}),(0,j.jsxs)("div",{className:"mt-2 flex items-baseline gap-2",children:[(0,j.jsx)("span",{className:"text-2xl font-semibold text-slate-900",children:null!==u?`${u.toFixed(0)}% SDG 5 achieved`:""}),f?(0,j.jsx)("span",{className:(0,gL.cn)("text-xs font-medium",p),children:f}):null]}),(0,j.jsx)("p",{className:"mt-1 text-xs text-slate-400",children:"Updated monthly from the gender equity index"}),(0,j.jsx)("div",{className:"mt-4 h-24 w-full",children:(0,j.jsx)(Z.ResponsiveContainer,{width:"100%",height:"100%",children:(0,j.jsxs)(H.LineChart,{data:c,children:[(0,j.jsx)(K.YAxis,{hide:!0}),(0,j.jsx)(X.XAxis,{dataKey:"periodLabel",hide:!0}),(0,j.jsx)(q.Line,{type:"monotone",dataKey:"percentage",stroke:"#0ea5e9",strokeWidth:2,dot:!1})]})})})]}):null,n||a.length?(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-4 shadow-sm",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-700",children:"AI playbook"}),n?(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"mt-2 text-base font-semibold text-slate-900",children:n.title}),n.detail?(0,j.jsx)("p",{className:"mt-1 text-sm text-slate-500",children:n.detail}):null,(0,j.jsxs)("span",{className:"mt-3 inline-flex rounded-full bg-sky-100 px-3 py-1 text-xs font-medium text-sky-700",children:[Math.round(100*n.confidence),"% confidence"]})]}):null,a.length?(0,j.jsx)("ol",{className:"mt-4 space-y-2 text-sm text-slate-600",children:a.map((e,t)=>(0,j.jsxs)("li",{className:"flex gap-2",children:[(0,j.jsxs)("span",{className:"font-medium text-sky-500",children:[t+1,"."]}),(0,j.jsx)("span",{className:"leading-6",children:e})]},e))}):null]}):null]})]})]})})}function gW({highlights:e}){return e.length?(0,j.jsx)("div",{className:"pointer-events-none absolute right-4 top-4 flex max-w-xs flex-col gap-2",children:e.map(e=>(0,j.jsxs)("div",{className:"pointer-events-auto rounded-2xl border border-slate-200 bg-white/85 px-4 py-3 text-xs text-slate-600 shadow-[0_20px_50px_-32px_rgba(15,23,42,0.45)] backdrop-blur",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:e.sensorType}),(0,j.jsxs)("p",{className:"mt-1 text-[11px] text-slate-500",children:[e.district??"Citywide","  ",e.sensorId]}),(0,j.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[(0,j.jsxs)("span",{className:"inline-flex items-center rounded-full bg-sky-100 px-2 py-1 text-[10px] font-medium text-sky-700",children:[Math.round(100*e.anomalyScore),"% watch"]}),null!==e.lastReadingMinutes?(0,j.jsxs)("span",{className:"text-[10px] text-slate-400",children:[e.lastReadingMinutes,"m ago"]}):null]})]},e.id))}):null}function gG({scenario:e}){let[t,i]=(0,D.useState)(gP[0].id),r=gP.find(e=>e.id===t)??gP[0],s=gS.slice(0,3),n=r.kpis.slice(0,2),a=r.artifacts.slice(0,3),o=r.trend?`vlr-trend-${r.trend.id}`:null;return(0,j.jsxs)("section",{className:"grid gap-6 lg:grid-cols-[minmax(0,1.35fr)_minmax(0,1fr)]",children:[(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6 lg:p-7",children:[(0,j.jsxs)("header",{className:"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("h2",{className:"text-lg font-semibold text-slate-900 sm:text-xl",children:"VLR automation"}),(0,j.jsx)("p",{className:"text-sm text-slate-500",children:"Follow each automated pass."})]}),(0,j.jsxs)("span",{className:"text-xs uppercase tracking-wide text-slate-400",children:["Scenario  ",e.name]})]}),(0,j.jsx)("div",{className:"mt-5 space-y-2",children:gP.map(e=>{let r=gj[e.id]??e.title,s=e.id===t;return(0,j.jsxs)("button",{type:"button",onClick:()=>i(e.id),className:(0,gL.cn)("w-full rounded-2xl border border-slate-200 bg-white p-4 text-left transition hover:border-slate-300",s&&"border-sky-200 bg-sky-50 shadow-[0_18px_42px_-30px_rgba(14,165,233,0.55)]"),children:[(0,j.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,j.jsxs)("div",{className:"space-y-1",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:r}),(0,j.jsx)("p",{className:"text-xs text-slate-500",children:e.summary})]}),(0,j.jsx)(gq,{status:e.status})]}),(0,j.jsxs)("div",{className:"mt-3 flex items-center gap-3",children:[(0,j.jsx)("div",{className:"h-1.5 w-full flex-1 overflow-hidden rounded-full bg-slate-200",children:(0,j.jsx)("div",{className:(0,gL.cn)("h-full rounded-full transition-all","complete"===e.status&&"bg-emerald-400","active"===e.status&&"bg-sky-400","pending"===e.status&&"bg-slate-400"),style:{width:`${Math.max(e.completion,"pending"===e.status?12:6)}%`}})}),(0,j.jsxs)("span",{className:"text-xs text-slate-400",children:[e.etaMinutes,"m"]})]})]},e.id)})})]}),(0,j.jsxs)("div",{className:"space-y-5",children:[(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-700",children:"Stage snapshot"}),(0,j.jsxs)("div",{className:"mt-4 flex flex-col gap-5",children:[(0,j.jsx)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:(0,j.jsxs)("div",{className:"flex items-center gap-4",children:[(0,j.jsx)(gH,{completion:r.completion}),(0,j.jsxs)("div",{className:"space-y-1 text-sm text-slate-600",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:gj[r.id]??r.title}),(0,j.jsx)("p",{children:r.summary}),(0,j.jsxs)("p",{className:"text-xs text-slate-400",children:["ETA ",r.etaMinutes," min"]})]})]})}),r.trend?(0,j.jsxs)("section",{className:"rounded-2xl border border-slate-200 bg-slate-50/60 p-4",children:[(0,j.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:r.trend.title}),(0,j.jsx)("p",{className:"text-xs text-slate-500",children:r.trend.metricLabel})]}),r.trend.baselineLabel&&void 0!==r.trend.baselineValue?(0,j.jsxs)("span",{className:"text-xs font-medium text-slate-400",children:[r.trend.baselineLabel," ",`${r.trend.baselineValue}${r.trend.unit??""}`]}):null]}),(0,j.jsx)("div",{className:"mt-3 h-36 w-full sm:h-40",children:(0,j.jsx)(Z.ResponsiveContainer,{width:"100%",height:"100%",children:(0,j.jsxs)(W.AreaChart,{data:r.trend.points,children:[o?(0,j.jsx)("defs",{children:(0,j.jsxs)("linearGradient",{id:o,x1:"0",y1:"0",x2:"0",y2:"1",children:[(0,j.jsx)("stop",{offset:"5%",stopColor:"#0ea5e9",stopOpacity:.35}),(0,j.jsx)("stop",{offset:"95%",stopColor:"#0ea5e9",stopOpacity:.05})]})}):null,(0,j.jsx)(G.CartesianGrid,{strokeDasharray:"3 3",stroke:"#e2e8f0",vertical:!1}),(0,j.jsx)(X.XAxis,{dataKey:"label",stroke:"#94a3b8",tickLine:!1,axisLine:!1}),(0,j.jsx)(K.YAxis,{hide:!0,domain:[0,"auto"]}),(0,j.jsx)(Y.Tooltip,{contentStyle:{borderRadius:12,borderColor:"#e2e8f0",backgroundColor:"white",boxShadow:"0 20px 40px -32px rgba(15,23,42,0.24)"},formatter:e=>{let t=r.trend?.unit??"",i=Number.isInteger(e)?String(e):e.toFixed(1);return[`${i}${t}`,r.trend?.title??"Value"]},labelFormatter:e=>e}),(0,j.jsx)(V.Area,{type:"monotone",dataKey:"value",stroke:"#0ea5e9",strokeWidth:2,fill:o?`url(#${o})`:"#bae6fd",fillOpacity:o?1:.4})]})})}),(0,j.jsx)("p",{className:"mt-3 text-xs text-slate-500",children:r.trend.summary})]}):null,n.length?(0,j.jsx)("ul",{className:"grid gap-3 sm:grid-cols-2",children:n.map(e=>{let t="up"===e.direction?"text-emerald-600":"text-rose-600";return(0,j.jsxs)("li",{className:"rounded-2xl bg-slate-50 p-3",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:e.value}),(0,j.jsx)("p",{className:"mt-1 text-xs text-slate-500",children:e.label}),(0,j.jsx)("p",{className:(0,gL.cn)("mt-2 text-xs font-medium",t),children:e.deltaLabel}),(0,j.jsx)("p",{className:"mt-1 text-[11px] text-slate-500",children:e.narrative})]},e.id)})}):null,r.compliance.length?(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-400",children:"Checks"}),(0,j.jsx)("div",{className:"mt-2 flex flex-wrap gap-2",children:r.compliance.map(e=>(0,j.jsx)("span",{className:(0,gL.cn)("inline-flex items-center rounded-full px-3 py-1 text-xs font-medium","pass"===e.status?"bg-emerald-100 text-emerald-700":"attention"===e.status?"bg-amber-100 text-amber-700":"bg-rose-100 text-rose-700"),title:e.description,children:e.label},e.id))})]}):null,a.length?(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-400",children:"Artifacts"}),(0,j.jsx)("ul",{className:"mt-2 space-y-2",children:a.map(e=>(0,j.jsxs)("li",{className:"rounded-2xl border border-slate-200 bg-white px-3 py-2",children:[(0,j.jsx)("p",{className:"text-xs font-semibold text-slate-700",children:e.label}),(0,j.jsx)("p",{className:"mt-1 text-xs text-slate-500",children:e.detail})]},e.id))})]}):null]})]}),(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-700",children:"Workflow log"}),r.insights.length?(0,j.jsx)("ul",{className:"mt-3 space-y-2 text-sm text-slate-600",children:r.insights.map(e=>(0,j.jsx)("li",{className:"rounded-2xl bg-slate-50 px-3 py-2",children:e},e))}):null,(0,j.jsx)("p",{className:"mt-4 text-xs font-semibold uppercase tracking-wide text-slate-400",children:"Recent events"}),(0,j.jsx)("ul",{className:"mt-2 space-y-2 text-xs text-slate-500",children:r.auditTrail.map(e=>(0,j.jsxs)("li",{className:"flex items-start gap-3",children:[(0,j.jsx)("span",{className:"font-medium text-slate-400",children:e.timestamp}),(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"font-medium text-slate-600",children:e.actor}),(0,j.jsx)("p",{children:e.message})]})]},`${e.timestamp}-${e.actor}`))})]}),(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-700",children:"Alerts to clear"}),(0,j.jsx)("ul",{className:"mt-3 space-y-3",children:s.map(e=>{var t;let i="warning"===(t=e.severity)||"critical"===t||"info"===t?t:"info";return(0,j.jsxs)("li",{className:"rounded-2xl border border-slate-200 bg-slate-50 p-4",children:[(0,j.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,j.jsx)("p",{className:"text-sm font-medium text-slate-900",children:e.message}),(0,j.jsx)("span",{className:(0,gL.cn)("inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",gD[i]),children:gz[i]})]}),(0,j.jsx)("p",{className:"mt-2 text-xs text-slate-500",children:e.suggestedAction})]},e.id)})})]})]})]})}function gq({status:e}){return(0,j.jsx)("span",{className:(0,gL.cn)("inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium","complete"===e?"bg-emerald-100 text-emerald-700":"active"===e?"bg-sky-100 text-sky-700":"bg-slate-100 text-slate-600"),children:"complete"===e?"Done":"active"===e?"In progress":"pending"===e?"Queued":""})}function gH({completion:e}){let t=Math.min(100,Math.max(0,Math.round(e))),i=3.6*t,r=`conic-gradient(#0ea5e9 ${i}deg, rgba(14,165,233,0.12) ${i}deg)`;return(0,j.jsxs)("div",{className:"relative h-20 w-20",children:[(0,j.jsx)("div",{className:"absolute inset-0 rounded-full",style:{backgroundImage:r}}),(0,j.jsxs)("div",{className:"absolute inset-2 flex items-center justify-center rounded-full border border-slate-200 bg-white text-sm font-semibold text-slate-700 shadow-sm",children:[t,"%"]})]})}function gZ(){let[e,t]=(0,D.useState)(gk.scenarioComparisons[0]?.id??""),i=gk.demandForecast.points.map(e=>({...e,periodLabel:gY(e.timestamp),percentage:Number((100*e.value).toFixed(1))})),r=gk.resilienceForecast.points.map(e=>{let t,i,r;return{...e,quarterLabel:(i=Math.floor((t=new Date(e.timestamp)).getUTCMonth()/3)+1,r=String(t.getUTCFullYear()).slice(-2),`Q${i} '${r}`)}}),s=gk.scenarioComparisons,n=s.find(t=>t.id===e)??s[0],a=n?.unit??"",o=n?n.optimized-n.baseline:0,l=s.reduce((e,t)=>Math.max(e,t.optimized),0),c=l>0?l:1,u=i.length?Math.max(...i.map(e=>e.percentage)):0,h=i.length?Math.min(...i.map(e=>e.percentage)):0,d=i.length>1?i[i.length-1].percentage-i[0].percentage:0,f=d>0?"text-emerald-600":d<0?"text-rose-600":"text-slate-500",p=gk.riskCells.slice(0,4).map(e=>({...e,percentage:Math.round(100*e.score)})),g=gk.anomalyClusters.slice(0,3),m=gk.explainabilitySnippets.slice(0,3),y=i.length?i[i.length-1].periodLabel:null,v=r.length?r[0].value:null,x=r.length?r[r.length-1].value:null,_=null!==v&&null!==x?x-v:null,b="number"==typeof _&&0!==_?_>0?"text-emerald-600":"text-rose-600":"text-slate-500";return(0,j.jsxs)("section",{className:"space-y-6",children:[(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6 lg:p-7",children:[(0,j.jsxs)("header",{className:"flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("h2",{className:"text-lg font-semibold text-slate-900 sm:text-xl",children:"SDG & VLR progress board"}),(0,j.jsx)("p",{className:"text-sm text-slate-500",children:"Monthly and quarterly indicators show how planners are closing priority SDG gaps and VLR actions."})]}),y?(0,j.jsxs)("span",{className:"text-xs text-slate-400",children:["Latest monthly update  ",y]}):null]}),(0,j.jsx)("div",{className:"mt-4 grid gap-3 sm:grid-cols-3",children:gk.modelPerformanceStats.map(e=>{let t="up"===e.tone?"text-emerald-600":"text-rose-600";return(0,j.jsxs)("div",{className:"rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3",children:[(0,j.jsx)("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:e.metric}),(0,j.jsx)("p",{className:"mt-2 text-lg font-semibold text-slate-900",children:e.value}),(0,j.jsx)("p",{className:(0,gL.cn)("mt-1 text-xs font-medium",t),children:e.change})]},e.id)})})]}),(0,j.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[minmax(0,1.6fr)_minmax(0,1fr)]",children:[(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsxs)("header",{className:"flex flex-col gap-1 sm:flex-row sm:items-end sm:justify-between",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("h3",{className:"text-lg font-semibold text-slate-900",children:"Gender equity projection"}),(0,j.jsx)("p",{className:"text-sm text-slate-500",children:gk.demandForecast.horizon})]}),(0,j.jsxs)("span",{className:"text-xs text-slate-400",children:["Model  ",gk.demandForecast.metric]})]}),(0,j.jsx)("div",{className:"mt-4 h-64 w-full",children:(0,j.jsx)(Z.ResponsiveContainer,{width:"100%",height:"100%",children:(0,j.jsxs)(H.LineChart,{data:i,children:[(0,j.jsx)(G.CartesianGrid,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),(0,j.jsx)(X.XAxis,{dataKey:"periodLabel",stroke:"#94a3b8",tickLine:!1,axisLine:!1}),(0,j.jsx)(K.YAxis,{stroke:"#94a3b8",tickLine:!1,axisLine:!1,unit:"%"}),(0,j.jsx)(Y.Tooltip,{contentStyle:{borderRadius:12,borderColor:"#e2e8f0",backgroundColor:"white",boxShadow:"0 20px 40px -32px rgba(15,23,42,0.24)"},formatter:e=>[`${e.toFixed(1)}%`,"Gender equity index"],labelFormatter:e=>`Month ${e}`}),(0,j.jsx)(q.Line,{type:"monotone",dataKey:"percentage",stroke:"#0ea5e9",strokeWidth:3,dot:!1,activeDot:{r:5}})]})})}),(0,j.jsxs)("div",{className:"mt-4 grid gap-3 sm:grid-cols-3",children:[(0,j.jsxs)("div",{className:"rounded-2xl bg-slate-50 px-3 py-2",children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Highest monthly score"}),(0,j.jsxs)("p",{className:"text-sm font-semibold text-slate-900",children:[u.toFixed(1),"%"]})]}),(0,j.jsxs)("div",{className:"rounded-2xl bg-slate-50 px-3 py-2",children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Starting point"}),(0,j.jsxs)("p",{className:"text-sm font-semibold text-slate-900",children:[h.toFixed(1),"%"]})]}),(0,j.jsxs)("div",{className:"rounded-2xl bg-slate-50 px-3 py-2",children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Change since start"}),(0,j.jsxs)("p",{className:(0,gL.cn)("text-sm font-semibold",f),children:[d>0?"+":"",d.toFixed(1)," pts"]})]})]})]}),(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsxs)("header",{children:[(0,j.jsx)("h3",{className:"text-lg font-semibold text-slate-900",children:"Program impact scenarios"}),(0,j.jsx)("p",{className:"text-sm text-slate-500",children:"Compare baseline vs coordinated programs to see how SDG and VLR goals advance."})]}),s.length?(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)("div",{className:"mt-3 flex flex-wrap gap-2",children:s.map(i=>{let r=i.id===e;return(0,j.jsx)("button",{type:"button",onClick:()=>t(i.id),className:(0,gL.cn)("rounded-2xl border px-3 py-1.5 text-sm font-medium transition-colors",r?"border-sky-200 bg-sky-50 text-sky-700":"border-transparent bg-slate-100 text-slate-500 hover:border-slate-200 hover:bg-white"),children:i.scenario},i.id)})}),n?(0,j.jsxs)("div",{className:"mt-5 space-y-3 text-sm text-slate-600",children:[(0,j.jsxs)("div",{className:"rounded-2xl bg-slate-50 px-3 py-2",children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Baseline"}),(0,j.jsxs)("p",{className:"mt-1 text-base font-semibold text-slate-900",children:[n.baseline.toLocaleString("en")," ",a]})]}),(0,j.jsxs)("div",{className:"rounded-2xl bg-sky-50 px-3 py-2",children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Automation"}),(0,j.jsxs)("p",{className:"mt-1 text-base font-semibold text-slate-900",children:[n.optimized.toLocaleString("en")," ",a]})]}),(0,j.jsxs)("div",{className:"rounded-2xl bg-emerald-50 px-3 py-2 text-emerald-700",children:[(0,j.jsx)("p",{className:"text-xs font-semibold uppercase tracking-wide",children:"Lift"}),(0,j.jsxs)("p",{className:"mt-1 text-base font-semibold",children:[o>0?"+":"",o.toFixed(0)," ",a]})]}),(0,j.jsxs)("div",{className:"relative mt-4 h-2 w-full rounded-full bg-slate-200",children:[(0,j.jsx)("div",{className:"absolute inset-y-0 left-0 rounded-full bg-slate-400/40",style:{width:`${Math.min(n.baseline/c*100,100)}%`}}),(0,j.jsx)("div",{className:"absolute inset-y-0 left-0 rounded-full bg-sky-500",style:{width:`${Math.min(n.optimized/c*100,100)}%`}})]}),(0,j.jsx)("p",{className:"text-xs text-slate-400",children:"Scaling against the strongest lift in this board."}),(0,j.jsx)("p",{className:"text-sm leading-6 text-slate-600",children:n.narrative})]}):null]}):(0,j.jsx)("p",{className:"mt-4 text-sm text-slate-500",children:"Scenario comparisons will appear here once they are set."})]})]}),(0,j.jsxs)("div",{className:"grid gap-6",children:[(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsxs)("header",{className:"flex flex-col gap-1 sm:flex-row sm:items-end sm:justify-between",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("h3",{className:"text-lg font-semibold text-slate-900",children:"Wellbeing outlook"}),(0,j.jsx)("p",{className:"text-sm text-slate-500",children:gk.resilienceForecast.horizon})]}),(0,j.jsx)("span",{className:"text-xs text-slate-400",children:"Model  wellbeing index"})]}),(0,j.jsx)("div",{className:"mt-4 h-64 w-full",children:(0,j.jsx)(Z.ResponsiveContainer,{width:"100%",height:"100%",children:(0,j.jsxs)(W.AreaChart,{data:r,children:[(0,j.jsx)("defs",{children:(0,j.jsxs)("linearGradient",{id:"resilienceGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[(0,j.jsx)("stop",{offset:"5%",stopColor:"#6366f1",stopOpacity:.35}),(0,j.jsx)("stop",{offset:"95%",stopColor:"#6366f1",stopOpacity:.05})]})}),(0,j.jsx)(G.CartesianGrid,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),(0,j.jsx)(X.XAxis,{dataKey:"quarterLabel",stroke:"#94a3b8",tickLine:!1,axisLine:!1}),(0,j.jsx)(K.YAxis,{stroke:"#94a3b8",tickLine:!1,axisLine:!1}),(0,j.jsx)(Y.Tooltip,{contentStyle:{borderRadius:12,borderColor:"#e2e8f0",backgroundColor:"white",boxShadow:"0 20px 40px -32px rgba(15,23,42,0.24)"},formatter:e=>[`${e.toFixed(0)} index`,"Wellbeing"]}),(0,j.jsx)(V.Area,{type:"monotone",dataKey:"value",stroke:"#6366f1",strokeWidth:2,fill:"url(#resilienceGradient)",fillOpacity:1})]})})}),(0,j.jsxs)("div",{className:"mt-4 flex flex-wrap gap-4 text-sm text-slate-600",children:[(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Now"}),(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:"number"==typeof x?`${x.toFixed(0)} index`:""})]}),(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Six-quarter change"}),(0,j.jsx)("p",{className:(0,gL.cn)("text-sm font-semibold",b),children:"number"==typeof _?`${_>0?"+":""}${_.toFixed(0)} pts`:""})]}),(0,j.jsxs)("div",{children:[(0,j.jsx)("p",{className:"text-xs text-slate-500",children:"Confidence"}),(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:"Model uses census & labor data"})]})]})]}),(0,j.jsxs)("div",{className:"grid gap-6 md:grid-cols-2",children:[(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsx)("h3",{className:"text-lg font-semibold text-slate-900",children:"Watch list"}),(0,j.jsx)("p",{className:"mt-1 text-sm text-slate-500",children:"AI flags the districts that need attention before the monthly coordination meeting."}),(0,j.jsx)("ul",{className:"mt-4 space-y-3",children:p.map(e=>(0,j.jsxs)("li",{className:"rounded-2xl bg-slate-50 px-4 py-3",children:[(0,j.jsxs)("p",{className:"flex items-center justify-between text-sm font-semibold text-slate-900",children:[(0,j.jsx)("span",{children:e.district}),(0,j.jsxs)("span",{children:[e.percentage,"%"]})]}),(0,j.jsx)("p",{className:"mt-1 text-xs text-slate-500",children:e.driver}),(0,j.jsx)("div",{className:"mt-2 h-1.5 w-full rounded-full bg-slate-200",children:(0,j.jsx)("div",{className:"h-1.5 rounded-full bg-sky-500",style:{width:`${Math.min(e.percentage,100)}%`}})})]},e.id))}),g.length?(0,j.jsxs)("div",{className:"mt-5 border-t border-slate-200 pt-4",children:[(0,j.jsx)("h4",{className:"text-sm font-semibold text-slate-700",children:"Automation queue"}),(0,j.jsx)("ul",{className:"mt-3 space-y-2 text-sm text-slate-600",children:g.map(e=>(0,j.jsxs)("li",{className:"rounded-2xl bg-slate-50 px-3 py-2",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:e.cluster}),(0,j.jsxs)("p",{className:"mt-1 text-xs text-slate-500",children:[e.affectedAssets," VLR packets  resolves in ",e.expectedResolutionDays," days"]})]},e.id))})]}):null]}),(0,j.jsxs)("article",{className:"rounded-3xl border border-slate-200 bg-white p-5 sm:p-6",children:[(0,j.jsx)("h3",{className:"text-lg font-semibold text-slate-900",children:"Explainable by design"}),(0,j.jsx)("p",{className:"mt-1 text-sm text-slate-500",children:"Every insight carries the evidence trail city auditors expect."}),(0,j.jsx)("ul",{className:"mt-4 space-y-3",children:m.map(e=>(0,j.jsxs)("li",{className:"rounded-2xl bg-slate-50 px-4 py-3",children:[(0,j.jsx)("p",{className:"text-sm font-semibold text-slate-900",children:e.title}),(0,j.jsx)("p",{className:"mt-1 text-xs text-slate-500",children:e.detail})]},e.id))})]})]})]})]})}function gY(e){return new Intl.DateTimeFormat("en",{month:"short",year:"2-digit"}).format(new Date(e))}e.s(["default",()=>gF],52683)}]);